<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Specialty Barista Training IO</title>
    <meta name="description" content="Free interactive specialty barista training. Learn espresso, milk, customer service, and more.">
    <meta name="keywords" content="barista, coffee, espresso, training, specialty, latte art, cafe, course, certificate">
    <meta property="og:title" content="Specialty Barista Training IO">
    <meta property="og:description" content="Free interactive specialty barista training. Learn espresso, milk, customer service, and more.">
    <meta property="og:image" content="images/social-share.jpg">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://specialtybaristatraining.github.io/">
    <link rel="icon" type="image/png" href="images/favicon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="images/favicon.png">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@700&family=Cinzel:wght@600;700&display=swap" rel="stylesheet">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1343070560951957" crossorigin="anonymous"></script>
    <style>
        /* AdSense: Hide all ad placeholders by default, show only via JS if content is present */
        .ad-placeholder {
            display: none;
        }
        :root {
            --bg-primary-dark: #111827; /* bg-gray-900 */
            --bg-secondary-dark: #1F2937; /* bg-gray-800 */
            --bg-tertiary-dark: #374151; /* bg-gray-700 */
            --text-primary-dark: #F9FAFB; /* text-gray-100 */
            --text-secondary-dark: #B0B7C3; /* text-gray-300 / text-gray-400 (approx) */
            --accent-primary: #F59E0B; /* amber-500 */
            --accent-primary_rgb: 245, 158, 11;
            --accent-secondary: #38BDF8; /* sky-400 */
            --accent-secondary_rgb: 56, 189, 248;
            --success-color: #10B981; /* emerald-500 / green-500 */
            --error-color: #EF4444; /* red-500 */

            --bg-primary-light: #F9FAFB; /* Light theme bg-gray-50 */
            --bg-secondary-light: #F3F4F6; /* Light theme bg-gray-100 */
            --bg-tertiary-light: #E5E7EB; /* Light theme bg-gray-200 */
            --text-primary-light: #1F2937; /* Light theme text-gray-800 */
            --text-secondary-light: #4B5563; /* Light theme text-gray-600 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary-dark);
            color: var(--text-primary-dark);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .high-contrast {
            --bg-primary-dark: var(--bg-primary-light);
            --bg-secondary-dark: var(--bg-secondary-light);
            --bg-tertiary-dark: var(--bg-tertiary-light);
            --text-primary-dark: var(--text-primary-light);
            --text-secondary-dark: var(--text-secondary-light);
        }

        .glass {
            background: rgba(255, 255, 255, 0.05);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .high-contrast .glass {
            background: rgba(0, 0, 0, 0.03);
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        aside {
            background-color: var(--bg-secondary-dark);
            transition: transform 0.3s ease-in-out;
            width: 16rem; /* Fixed width for consistency */
            z-index: 40;
        }

        .high-contrast aside {
            background-color: var(--bg-secondary-light);
        }

        .sidebar-open {
            transform: translateX(0) !important;
        }

        @media (max-width: 768px) {
            aside {
                transform: translateX(-100%);
                width: 80% !important;
                max-width: 300px;
            }
        }

        .ad-placeholder:not(.hidden) {
            min-height: 90px;
            background-color: var(--bg-tertiary-dark);
            border: 1px dashed var(--accent-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-secondary-dark);
            margin: 1rem auto;
            width: 100%;
            max-width: 728px; /* Standard ad width */
        }
        .ad-placeholder.hidden > ins { /* Hide the ins tag when placeholder is hidden */
            display:none !important;
        }


        .high-contrast .ad-placeholder {
            background-color: var(--bg-tertiary-light);
            color: var(--text-secondary-light);
        }

        .active-lesson-link {
            background-color: var(--accent-primary);
            color: var(--bg-primary-dark) !important;
        }

        .high-contrast .active-lesson-link {
            color: #FFFFFF !important;
            background-color: #D97706; /* Darker amber for contrast */
        }

        .lesson-completed {
            background-color: var(--success-color) !important;
            color: #FFFFFF !important;
        }
        .lesson-completed:hover {
             background-color: #059669 !important; /* Slightly darker success on hover */
        }

        .lesson-completed-icon {
            color: var(--success-color) !important;
        }

        .high-contrast .lesson-completed {
            background-color: #D1FAE5 !important; /* Lighter green */
            color: #065F46 !important; /* Darker green text */
        }
        .high-contrast .lesson-completed:hover {
             background-color: #A7F3D0 !important;
        }

        .high-contrast .lesson-completed-icon {
            color: #065F46 !important;
        }

        #tabs .tab {
            color: var(--text-secondary-dark);
            border-bottom: 2px solid transparent;
            padding: 0.75rem 1rem;
            margin-bottom: -1px; /* Overlap border */
            transition: color 0.2s ease, border-color 0.2s ease;
        }

        #tabs .tab:hover {
            color: var(--accent-primary);
        }

        #tabs .tab.active {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
            font-weight: 600;
        }

        .interactive-choice {
            background-color: var(--bg-tertiary-dark);
            color: var(--text-primary-dark);
            border: 1px solid transparent;
            transition: background-color 0.2s, border-color 0.2s, transform 0.1s;
        }

        .interactive-choice:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-secondary);
        }

        .interactive-choice.selected {
            background-color: var(--accent-secondary);
            color: var(--bg-primary-dark); /* Ensuring contrast for selected state */
            border-color: var(--accent-secondary);
        }

        .interactive-choice.correct {
            background-color: var(--success-color) !important;
            color: #FFFFFF !important;
        }

        .interactive-choice.incorrect {
            background-color: var(--error-color) !important;
            color: #FFFFFF !important;
        }

        .interactive-choice:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--bg-primary-dark), 0 0 0 4px var(--accent-secondary);
        }

        .interactive-choice.disabled {
            opacity: 0.6;
            pointer-events: none;
        }

        .high-contrast .interactive-choice {
            background-color: var(--bg-tertiary-light);
            color: var(--text-primary-light);
        }
        .high-contrast .interactive-choice:hover {
            background-color: rgba(0, 0, 0, 0.05);
            border-color: var(--accent-secondary);
        }
        .high-contrast .interactive-choice.selected {
            background-color: var(--accent-secondary);
            color: #FFFFFF; /* White text on accent for light mode selected */
        }

        .interactive-button {
            background-color: var(--accent-primary);
            color: var(--bg-primary-dark); /* Dark text for good contrast on accent */
            transition: background-color 0.2s, transform 0.1s;
        }
        .interactive-button:hover {
            background-color: #D97706; /* Darker accent */
            transform: translateY(-1px);
        }
        .interactive-button:active {
            transform: translateY(0);
        }
        .interactive-button:disabled {
            background-color: var(--bg-tertiary-dark);
            color: var(--text-secondary-dark);
            opacity: 0.6;
            cursor: not-allowed;
        }

        .high-contrast .interactive-button {
            color: #FFFFFF; /* White text on accent for light mode */
        }
        .high-contrast .interactive-button:disabled {
            background-color: var(--bg-tertiary-light);
            color: var(--text-secondary-light);
        }

        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem; /* Tailwind's rounded-md */
            background-color: var(--bg-tertiary-dark);
            border: 1px solid var(--bg-secondary-dark);
            color: var(--text-primary-dark);
            font-size: 0.875rem; /* text-sm */
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .input-field::placeholder {
            color: var(--text-secondary-dark);
            opacity: 0.7;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(var(--accent-primary_rgb, 245, 158, 11), 0.4);
        }
        .high-contrast .input-field {
            background-color: var(--bg-tertiary-light);
            border-color: var(--bg-secondary-light);
            color: var(--text-primary-light); /* Dark text for light mode inputs */
        }
        .high-contrast .input-field::placeholder {
            color: var(--text-secondary-light);
        }

        .modal-content-area .input-field,
        .edit-profile-modal .input-field {
             color: #000000 !important;
        }
        .modal-content-area .input-field:focus,
        .edit-profile-modal .input-field:focus {
             color: #000000 !important;
        }


        .high-contrast .modal-content-area .input-field,
        .high-contrast .edit-profile-modal .input-field {
             color: var(--text-primary-light) !important;
        }
        .high-contrast .modal-content-area .input-field::placeholder,
        .high-contrast .edit-profile-modal .input-field::placeholder {
            color: var(--text-secondary-light);
        }

        [data-tooltip] {
            position: relative;
        }
        [data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            background-color: #333;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
        }
        [data-tooltip]:hover::after {
            opacity: 1;
            visibility: visible;
        }

        .sidebar-btn-icon {
            width: 1.25rem;
            height: 1.25rem;
            margin-right: 0.75rem;
        }

        #hamburgerMenu .fa-bars,
        #hamburgerMenu .fa-times {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: var(--bg-secondary-dark); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: var(--accent-primary); border-radius: 10px; border: 2px solid var(--bg-secondary-dark); }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: #D97706; }
        .high-contrast .custom-scrollbar::-webkit-scrollbar-track { background: var(--bg-secondary-light); }
        .high-contrast .custom-scrollbar::-webkit-scrollbar-thumb { border-color: var(--bg-secondary-light); background-color: #D97706; }

        .current-user-highlight { background-color: rgba(var(--accent-primary_rgb), 0.2); border: 1px solid var(--accent-primary); color: var(--text-primary-dark); }
        .high-contrast .current-user-highlight { background-color: rgba(var(--accent-primary_rgb), 0.25); border: 1px solid var(--accent-primary); color: var(--text-primary-light); }

        .high-contrast #sidebar-logo,
        .high-contrast #cert-logo { filter: invert(1) contrast(0.8) brightness(1.1); }

        #quizTimer.low-time { color: var(--error-color); animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        .result-box { padding: 0.75rem 1rem; border-radius: 0.375rem; margin-top: 0.75rem; font-size: 0.875rem; line-height: 1.4; transition: background-color 0.3s ease, color 0.3s ease; }
        .result-box.correct-result { background-color: rgba(var(--success-color_rgb, 16, 185, 129), 0.15); color: var(--success-color); border: 1px solid rgba(var(--success-color_rgb, 16, 185, 129), 0.3); }
        .result-box.incorrect-result { background-color: rgba(var(--error-color_rgb, 239, 68, 68), 0.15); color: var(--error-color); border: 1px solid rgba(var(--error-color_rgb, 239, 68, 68), 0.3); }
        .high-contrast .result-box.correct-result { color: #047857; background-color: #D1FAE5; border-color: #6EE7B7; }
        .high-contrast .result-box.incorrect-result { color: #B91C1C; background-color: #FEE2E2; border-color: #FCA5A5; }
         :root { --success-color_rgb: 16, 185, 129; --error-color_rgb: 239, 68, 68; }

        #practicalInteractiveContent .image-gallery img { max-width: 100px; height: auto; border-width: 2px; border-style: solid; border-color: transparent; border-radius: 0.375rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); cursor: pointer; transition: all 0.2s ease-in-out; }
        #practicalInteractiveContent .image-gallery img:hover,
        #practicalInteractiveContent .image-gallery img:focus { border-color: var(--accent-secondary); }
        #practicalInteractiveContent .image-gallery img.selected-img { border-color: var(--accent-primary) !important; transform: scale(1.05); }
        #practicalInteractiveContent .image-gallery img.correct { border-color: var(--success-color) !important; }
        #practicalInteractiveContent .image-gallery img.incorrect { border-color: var(--error-color) !important; }

        .modal-content-area { position: relative; max-height: 85vh; overflow-y: auto; }

        /* Theory Content Specific Styling */
        .prose-enhanced img.theory-image {
            display: block; margin-left: auto; margin-right: auto;
            border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            margin-top: 1.5rem; margin-bottom: 1.5rem; max-width: 90%; height: auto;
        }
        .high-contrast .prose-enhanced img.theory-image { box-shadow: 0 10px 15px -3px rgba(0,0,0,0.07), 0 4px 6px -2px rgba(0,0,0,0.04); }

        .prose-enhanced h4 {
            font-family: 'Cinzel', serif; font-weight: 700; color: var(--accent-primary);
            margin-top: 2.5rem; margin-bottom: 0.75rem; padding-bottom: 0.25rem;
            border-bottom: 1px solid rgba(var(--accent-primary_rgb), 0.3);
        }
        .high-contrast .prose-enhanced h4 { color: #B45309; border-bottom-color: rgba(180, 83, 9, 0.4); }

        .prose-enhanced h5 {
            font-family: 'Playfair Display', serif; font-weight: 700; color: var(--accent-secondary);
            margin-top: 1.5rem; margin-bottom: 0.5rem;
        }
        .high-contrast .prose-enhanced h5 { color: #0369A1; }


        .prose-enhanced p { line-height: 1.7; margin-bottom: 1rem; color: var(--text-secondary-dark); }
        .high-contrast .prose-enhanced p { color: var(--text-secondary-light); }
        .prose-enhanced strong { color: var(--text-primary-dark); font-weight: 600; }
        .high-contrast .prose-enhanced strong { color: var(--text-primary-light); }

        .prose-enhanced ul, .prose-enhanced ol { margin-left: 1.25rem; margin-bottom: 1rem; color: var(--text-secondary-dark); }
        .prose-enhanced ul li::marker, .prose-enhanced ol li::marker { color: var(--accent-secondary); }
        .high-contrast .prose-enhanced ul, .high-contrast .prose-enhanced ol { color: var(--text-secondary-light); }
        .high-contrast .prose-enhanced ul li::marker, .high-contrast .prose-enhanced ol li::marker { color: #0EA5E9; } /* sky-500 */

        .prose-enhanced a { color: var(--accent-secondary); text-decoration: underline; transition: color 0.2s ease; }
        .prose-enhanced a:hover { color: var(--accent-primary); }
        .high-contrast .prose-enhanced a { color: #0284C7; } /* sky-600 */
        .high-contrast .prose-enhanced a:hover { color: #EA580C; } /* orange-600 */

        .theory-section-break { height: 1px; background: linear-gradient(to right, transparent, rgba(var(--accent-primary_rgb), 0.3), transparent); margin: 2.5rem 0; }
        .high-contrast .theory-section-break { background: linear-gradient(to right, transparent, rgba(180, 83, 9, 0.2), transparent); }

        .theory-interactive-block {
            background-color: rgba(var(--bg-tertiary-dark_rgb, 55, 65, 81), 0.5); /* Assuming bg-tertiary-dark is #374151 */
            border: 1px solid rgba(var(--accent-secondary_rgb), 0.2);
            padding: 1.25rem; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        .high-contrast .theory-interactive-block {
             background-color: rgba(var(--bg-tertiary-light_rgb, 229, 231, 235), 0.7); /* Assuming bg-tertiary-light is #E5E7EB */
             border-color: rgba(var(--accent-secondary_rgb), 0.3);
        }
         :root { /* Add RGB versions of tertiary colors if not already present */
            --bg-tertiary-dark_rgb: 55, 65, 81;
            --bg-tertiary-light_rgb: 229, 231, 235;
        }

        /* Mobile-specific improvements */
        @media (max-width: 640px) {
            /* Header adjustments */
            header {
                padding: 0.5rem 0.75rem !important;
                height: auto;
                min-height: 56px;
            }
            
            header .text-2xl {
                font-size: 1.25rem !important;
            }
            
            header nav {
                display: none; /* Hide nav on mobile */
            }
            
            /* Main content spacing */
            main {
                padding: 0.5rem !important;
                margin-top: 56px !important; /* Account for fixed header */
            }
            
            /* Dashboard card */
            #dashboard .glass {
                padding: 1rem !important;
                margin-top: 0.5rem !important;
            }
            
            /* Sidebar adjustments */
            aside {
                width: 80% !important;
                max-width: 300px;
                transform: translateX(-100%);
                z-index: 60;
            }
            
            .sidebar-open {
                transform: translateX(0) !important;
            }
            
            /* Show hamburger menu on mobile */
            #hamburgerMenu {
                display: block !important;
                position: fixed;
                top: 12px;
                left: 12px;
                z-index: 70;
                background: rgba(0, 0, 0, 0.7);
                border-radius: 50%;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            /* Modal adjustments */
            .modal-content-area {
                padding: 0.5rem !important;
            }
            
            /* Certificate page */
            #certificate .glass {
                padding: 1.5rem !important;
            }
            
            /* Improve touch targets */
            .interactive-button, .tab, .sidebar-btn {
                min-height: 44px; /* Apple's recommended minimum touch target size */
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            /* Improve text readability */
            body {
                font-size: 16px; /* Prevent zoom on iOS */
                -webkit-text-size-adjust: 100%;
    -webkit-text-size-adjust: 100%;
    text-size-adjust: 100%;
            }
            
            /* Prevent horizontal scrolling */
            html, body {
                overflow-x: hidden;
                width: 100%;
            }
            
            /* Improve form elements */
            input, select, textarea {
                font-size: 16px !important; /* Prevent zoom on iOS */
            }
            
            /* Adjust text sizes for mobile */
            h2 {
                font-size: 1.5rem !important;
            }
            
            h3 {
                font-size: 1.25rem !important;
            }
            
            /* Dashboard elements */
            #dashboard .text-3xl {
                font-size: 1.75rem !important;
            }
            
            #dashboard .text-4xl {
                font-size: 2rem !important;
            }
            
            /* Lesson content */
            #lessonContent {
                font-size: 1rem;
                line-height: 1.6;
            }
            
            /* Tabs */
            #tabs {
                flex-wrap: wrap;
            }
            
            #tabs .tab {
                flex: 1;
                min-width: 25%;
                text-align: center;
                padding: 0.5rem;
                font-size: 0.875rem;
            }
        }

        /* Tablet adjustments */
        @media (min-width: 641px) and (max-width: 1024px) {
            aside {
                width: 240px !important;
            }
            
            main {
                margin-left: 240px !important;
            }
            
            #hamburgerMenu {
                display: none !important;
            }
        }

        /* Desktop adjustments */
        @media (min-width: 1025px) {
            aside {
                transform: translateX(0) !important;
            }
            
            main {
                margin-left: 256px !important;
            }
            
            #hamburgerMenu {
                display: none !important;
            }
        }
    </style>
</head>
<body id="appBody" class="bg-gray-900 text-gray-100 min-h-screen flex relative">
    <!-- Topbar -->
    <header class="fixed top-0 left-0 w-full bg-gray-900 z-50 shadow flex items-center justify-between px-4 py-3 border-b border-gray-800">
        <!-- Hamburger Menu (Mobile Only) -->
        <button id="hamburgerMenu" class="md:hidden text-white focus:outline-none">
            <i class="fas fa-bars text-xl"></i>
            <span class="sr-only">Open sidebar menu</span>
        </button>
        </button>
        
        <div class="flex items-center gap-3 ml-2 md:ml-0">
            <img src="images/logo.png" alt="Logo" class="h-8 w-auto" id="sidebar-logo">
            <span class="text-xl md:text-2xl font-bold text-amber-500 tracking-tight">Specialty Barista</span>
        </div>
        
        <nav class="hidden md:flex gap-4 md:gap-6 text-sm md:text-base font-medium">
            <a href="index.html" class="hover:text-amber-400">Home</a>
            <a href="about.html" class="hover:text-amber-400">About</a>
            <a href="contact.html" class="hover:text-amber-400">Contact</a>
            <a href="privacy.html" class="hover:text-amber-400">Privacy</a>
            <a href="disclosure.html" class="hover:text-amber-400">Disclosure</a>
        </nav>
        
        <div class="flex items-center gap-2 md:gap-4">
            <select id="languageToggle" class="bg-gray-700 text-xs p-1 md:p-2 rounded-md border border-gray-600 focus:ring-amber-500 focus:border-amber-500" aria-label="Select language" title="Select language">
                <option value="en">English</option>
                <option value="ne">नेपाली</option>
            </select>
            <button id="themeToggle" data-tooltip="Toggle Theme" class="p-1 md:p-2 rounded-md hover:bg-gray-700 text-lg" aria-label="Toggle theme" title="Toggle theme">🌙</button>
            <span class="hidden lg:inline text-xs text-gray-400 ml-2">
                Free resource supported by ads.
                <a href="disclosure.html" target="_blank" rel="noopener noreferrer" class="underline hover:text-amber-400">Learn More</a>
            </span>
        </div>
    </header>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed top-0 left-0 h-full bg-gray-800 text-gray-200 w-64 p-4 space-y-6 z-40 flex flex-col transition-transform duration-300 ease-in-out shadow-lg pt-16">
        <div class="relative mb-4">
            <input type="text" id="search" placeholder="Search lessons..." class="input-field w-full p-2.5 text-sm">
            <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
        </div>
        <nav class="flex-grow overflow-y-auto custom-scrollbar">
            <ul id="dayList" class="space-y-1.5"></ul>
        </nav>
        <button id="profileButton" data-tooltip="Edit Profile" class="w-full flex items-center p-2.5 text-sm rounded-md hover:bg-gray-700 transition-colors mt-4">
            <i class="fas fa-user-edit sidebar-btn-icon text-sky-400"></i> Edit Profile
        </button>
        <button id="donationButtonSidebar" data-tooltip="Support Us" class="w-full flex items-center p-2.5 text-sm rounded-md hover:bg-amber-600 bg-amber-500 text-gray-900 font-semibold shadow mt-2 transition-colors">
            <i class="fas fa-heart sidebar-btn-icon text-red-500 mr-2"></i> <span>Support Us</span>
        </button>
        <div class="pt-4 mt-auto">
            <div class="ad-placeholder hidden">
                <ins class="adsbygoogle"
                     data-ad-client="ca-pub-1343070560951957"
                     data-ad-slot="7414600322"
                     data-ad-format="auto"
                     data-full-width-responsive="true"></ins>
            </div>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="flex-1 p-4 md:p-6 lg:p-8 overflow-y-auto relative mt-14" aria-label="Main content">
        <!-- Lesson Fullscreen Modal -->
        <div id="lessonModal" class="fixed inset-0 w-screen h-screen bg-black bg-opacity-90 flex items-center justify-center z-[9999] p-0 m-0 hidden">
            <div class="modal-content-area glass w-full h-full min-h-0 min-w-0 p-2 sm:p-6 md:p-10 rounded-none shadow-none border-none relative overflow-y-auto flex flex-col max-w-full">
                <button id="closeLessonModal" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl z-10" aria-label="Close">×</button>
                <div id="lessonModalContent" class="p-1 sm:p-4 md:p-8 w-full max-w-2xl md:max-w-3xl lg:max-w-4xl mx-auto flex-1 overflow-y-auto text-base sm:text-lg"></div>
            </div>
        </div>

        <!-- Dashboard Summary Card -->
        <section id="dashboard" class="active">
            <div class="glass p-6 md:p-8 rounded-2xl shadow-2xl max-w-3xl mx-auto mt-4 mb-8">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 md:gap-6 mb-6">
                    <div>
                        <h2 class="text-2xl md:text-3xl font-bold text-gray-100 mb-2">Welcome, <span id="userName" class="text-amber-400">Trainee</span>!</h2>
                        <div class="flex flex-wrap gap-3 items-center mt-2">
                            <div class="bg-gray-800 rounded-lg px-3 py-2 flex items-center gap-2">
                                <span id="progress" class="text-sm text-gray-300">Progress: 0/0</span>
                            </div>
                            <div class="bg-gray-800 rounded-lg px-3 py-2 flex items-center gap-2">
                                <span id="points" class="text-base md:text-lg font-semibold text-green-400">Points: 0</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col items-end gap-2">
                        <button onclick="BaristaApp.lessonManager.continueToNextLesson()" class="interactive-button text-sm md:text-base px-4 md:px-6 py-2 font-semibold shadow-lg">
                            <i class="fas fa-play mr-2"></i>Continue Learning
                        </button>
                        <div class="text-xs text-gray-400 mt-1">Progress saved automatically</div>
                    </div>
                </div>
                <div class="w-full h-3 bg-gray-700 rounded-full overflow-hidden mb-6 shadow-inner">
                    <div id="progressBarFill" class="h-full bg-gradient-to-r from-green-500 to-emerald-400 rounded-full transition-all duration-500 ease-out"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-6">
                    <div class="glass p-4 md:p-5 rounded-lg hover-lift transition-all">
                        <h3 class="text-base md:text-lg font-semibold text-sky-300 mb-2">Next Lesson</h3>
                        <p id="nextLessonInfo" class="text-sm text-gray-200 line-clamp-2">Calculating next lesson...</p>
                    </div>
                    <div class="glass p-4 md:p-5 rounded-lg hover-lift transition-all">
                        <h3 class="text-base md:text-lg font-semibold text-lime-300 mb-2">Fun Fact</h3>
                        <p id="funFact" class="text-sm text-gray-200 line-clamp-2">Coffee is the second most traded commodity!</p>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row gap-3 mt-6 md:mt-8">
                    <button onclick="BaristaApp.dataManager.exportProgress()" class="interactive-button bg-indigo-600 hover:bg-indigo-700 flex-1 py-2">
                        <i class="fas fa-download mr-2"></i>Export Progress
                    </button>
                    <button onclick="BaristaApp.dataManager.resetProgress()" class="interactive-button bg-red-600 hover:bg-red-700 flex-1 py-2">
                        <i class="fas fa-undo mr-2"></i>Reset Progress
                    </button>
                </div>
            </div>
       
        </section>

        <!-- Welcome/About Modal -->
        <div id="welcomeModal" class="fixed inset-0 z-[2000] bg-black bg-opacity-80 flex items-center justify-center p-4 hidden">
            <div class="bg-gray-900 rounded-2xl shadow-2xl max-w-2xl w-full p-8 relative overflow-y-auto max-h-[90vh] flex flex-col">
                <button id="closeWelcomeModal" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl" aria-label="Close">×</button>
                <h2 class="text-3xl font-bold text-amber-400 mb-4">Welcome to Specialty Barista Training</h2>
                <p class="mb-4">Unlock your potential as a coffee professional or passionate home barista. Our free, interactive platform offers step-by-step lessons, expert guides, and hands-on activities to help you master every aspect of specialty coffee—from espresso extraction to latte art, customer service, and more.</p>
                <p class="mb-4">Whether you’re just starting out or looking to refine your skills, our resources are designed by certified baristas and industry experts. We believe in making specialty coffee education accessible, practical, and fun for everyone.</p>
                <h3 class="text-xl font-semibold mt-6 mb-2">What You’ll Learn</h3>
                <ul class="list-disc list-inside mb-4 space-y-1">
                    <li>How to pull the perfect espresso shot, every time</li>
                    <li>Milk steaming and latte art techniques for all levels</li>
                    <li>Understanding coffee beans, origins, and flavor profiles</li>
                    <li>Equipment guides and maintenance tips</li>
                    <li>Customer service and workflow best practices</li>
                    <li>Interactive quizzes, progress tracking, and certification</li>
                </ul>
                <h3 class="text-xl font-semibold mt-6 mb-2">Featured Lessons</h3>
                <div class="mb-4 space-y-2">
                    <div>
                        <span class="font-semibold">How to Make the Perfect Espresso</span>
                        <p class="text-sm">Espresso is the foundation of many coffee drinks. Learn the steps to pull a perfect shot every time, including grind size, tamping, and extraction time.</p>
                        <a href="#" class="text-amber-400 hover:underline">Read more</a>
                    </div>
                    <div>
                        <span class="font-semibold">Latte Art for Beginners</span>
                        <p class="text-sm">Start your journey into latte art with simple techniques and tips for creating beautiful designs in your coffee drinks.</p>
                        <a href="#" class="text-amber-400 hover:underline">Read more</a>
                    </div>
                    <div>
                        <span class="font-semibold">Choosing the Right Coffee Beans</span>
                        <p class="text-sm">Understand the differences between coffee bean varieties and how to select the best beans for your taste and brewing method.</p>
                        <a href="#" class="text-amber-400 hover:underline">Read more</a>
                    </div>
                    <div>
                        <span class="font-semibold">Barista Workflow & Customer Service</span>
                        <p class="text-sm">Learn how to create a smooth workflow, manage busy shifts, and deliver outstanding customer experiences in any café setting.</p>
                        <a href="#" class="text-amber-400 hover:underline">Read more</a>
                    </div>
                </div>
                <h3 class="text-xl font-semibold mt-6 mb-2">Why Learn With Us?</h3>
                <ul class="list-disc list-inside mb-4 space-y-1">
                    <li>Free, high-quality training for all skill levels</li>
                    <li>Expert instructors with real café experience</li>
                    <li>Modern, interactive learning tools</li>
                    <li>Earn a certificate to showcase your skills</li>
                    <li>Join a supportive community of coffee lovers</li>
                </ul>
                <h3 class="text-xl font-semibold mt-6 mb-2">Get Started Today</h3>
                <p>Ready to begin your barista journey? Explore our lessons, track your progress, and connect with fellow coffee enthusiasts. Specialty Barista Training is here to help you brew with confidence and passion!</p>
                <div class="flex justify-end mt-8 gap-4">
                    <button id="closeWelcomeModal2" class="interactive-button px-6 py-2">Close</button>
                    <button id="skipWelcomeModal" class="interactive-button px-6 py-2 bg-amber-500 hover:bg-amber-600">Skip</button>
                </div>
                <div class="w-full text-center text-xs text-gray-500 mt-2">You can scroll to read more if needed.</div>
                </div>
            </div>
        </div>

        <!-- Ads (keep outside dashboard card for clarity) -->
        <section id="dashboardAd" class="ad-placeholder mx-auto mt-8 mb-4 max-w-screen-md hidden" aria-label="Advertisement">
            <ins class="adsbygoogle"
                 data-ad-client="ca-pub-1343070560951957"
                 data-ad-slot="3502133839"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
        </section>
        <section id="lessonPageAd" class="ad-placeholder mx-auto my-4 max-w-screen-md hidden" aria-label="Advertisement">
            <ins class="adsbygoogle"
                 data-ad-client="ca-pub-1343070560951957"
                 data-ad-slot="3717756254"
                 data-ad-format="autorelaxed"
                 data-full-width-responsive="true"></ins>
        </section>

        <section id="lessonPage" class="hidden">
            <div class="glass p-6 sm:p-8 rounded-xl shadow-2xl">
                <div class="flex items-center justify-between mb-6">
                    <button id="backButton" class="interactive-button text-sm py-2 px-4">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
                    </button>
                    <h2 id="lessonTitle" class="text-xl sm:text-2xl font-bold text-center text-gray-100 flex-grow mx-4 line-clamp-2">Lesson Title</h2>
                </div>
                <div id="tabs" class="flex border-b border-gray-700 mb-6 text-sm sm:text-base">
                    <button id="theoryTab" class="tab active">Theory</button>
                    <button id="practicalTab" class="tab">Practical</button>
                    <button id="quizTab" class="tab">Quiz</button>
                    <button id="notesTab" class="tab">Notes</button>
                </div>
                <div id="lessonContent" class="min-h-[300px] prose-enhanced"></div>
            </div>
        </section>

        <section id="certificate" class="hidden">
            <div class="glass p-8 md:p-12 rounded-xl shadow-2xl max-w-3xl mx-auto text-center">
                <div id="lottieCertificate" class="w-32 h-32 mx-auto mb-2"></div>
                <img src="images/logo.png" alt="Logo Icon" class="w-20 h-20 mx-auto mb-4" id="cert-logo">
                <h2 class="text-4xl font-bold text-amber-400 mb-3">Certificate of Completion</h2>
                <p class="text-lg text-gray-300 mb-6">This certifies that</p>
                <p id="trainee-name" class="text-3xl font-semibold text-gray-100 mb-3 border-b-2 border-amber-500 pb-2 inline-block px-4">Trainee Name</p>
                <p class="text-lg text-gray-300 mb-6">has successfully completed the Basic Barista Training program.</p>
                <div class="flex justify-around items-center text-sm text-gray-400 mb-8">
                    <div>
                        <p class="font-semibold text-gray-200">Date of Completion</p>
                        <p id="cert-date">January 1, 2024</p>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-200">Points Earned</p>
                        <p id="cert-points">0 Points</p>
                    </div>
                </div>
                <p class="text-xs text-gray-500 mb-3">Siddha Pokhari, Bhaktapur</p>
                <p class="text-xs text-gray-500 mb-6">Contact: 9805670970, 9810208828</p>
                <div class="flex flex-col sm:flex-row gap-3 justify-center mt-8" id="certificateActionButtons">
                    <button onclick="BaristaApp.ui.downloadCertificate()" class="interactive-button">
                        <i class="fas fa-download mr-2"></i> Download PDF
                    </button>
                    <button onclick="BaristaApp.elements.backButton?.click()" class="interactive-button bg-sky-600 hover:bg-sky-700">
                        <i class="fas fa-arrow-left mr-2"></i> Back to Dashboard
                    </button>
                </div>
            </div>
        </section>

        <!-- Modals -->
        <div id="onboardingModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[1050] hidden">
            <div class="modal-content-area glass p-8 rounded-xl shadow-2xl w-full max-w-md text-center transform scale-95 opacity-0 relative max-h-[85vh] overflow-y-auto custom-scrollbar">
                <img src="images/logo.png" alt="Logo Icon" class="w-20 h-20 mx-auto mb-4">
                <h3 class="text-2xl font-bold text-amber-400 mb-4">Welcome to Specialty Barista Training!</h3>
                <p class="text-gray-300 mb-6 text-sm">Let's get you started. Tell us your name to personalize your experience and certificate.</p>
                <input type="text" id="onboardingName" placeholder="Your Name (for Certificate)" class="input-field mb-3">
                <input type="email" id="onboardingEmail" placeholder="Your Email (for Leaderboard)" class="input-field mb-4">
                <button onclick="BaristaApp.dataManager.completeOnboarding()" class="interactive-button w-full py-2.5">Get Started!</button>
            </div>
        </div>

        <div id="profileModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[1050] hidden">
            <div class="modal-content-area glass p-8 rounded-xl shadow-2xl w-full max-w-md transform scale-95 opacity-0 edit-profile-modal relative max-h-[85vh] overflow-y-auto custom-scrollbar">
                <button onclick="BaristaApp.modalManager.closeProfile()" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">×</button>
                <h3 class="text-2xl font-bold text-amber-400 mb-6 text-center">Edit Profile</h3>
                <label for="profileName" class="block text-sm font-medium text-gray-300 mb-1">Name (for Certificate):</label>
                <input type="text" id="profileName" class="input-field mb-4">
                <label for="profileEmail" class="block text-sm font-medium text-gray-300 mb-1">Email (for Leaderboard):</label>
                <input type="email" id="profileEmail" class="input-field mb-6">
                <button onclick="BaristaApp.dataManager.saveProfile()" class="interactive-button w-full py-2.5">Save Profile</button>
            </div>
        </div>

        <div id="leaderboardModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[1050] hidden">
            <div class="modal-content-area glass p-6 rounded-xl shadow-2xl w-full max-w-md transform scale-95 opacity-0 relative max-h-[85vh] overflow-y-auto custom-scrollbar">
                <button onclick="BaristaApp.modalManager.closeLeaderboard()" class="absolute top-3 right-3 text-gray-400 hover:text-white text-2xl">×</button>
                <h3 class="text-2xl font-bold text-amber-400 mb-2 text-center">Leaderboard</h3>
                <p class="text-xs text-gray-400 text-center mb-4">Top 10 Trainees</p>
                <ul id="leaderboardList" class="space-y-1.5 max-h-60 overflow-y-auto custom-scrollbar pr-1"></ul>
            </div>
        </div>

        <div id="glossaryModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[1050] hidden">
            <div class="modal-content-area glass p-6 rounded-xl shadow-2xl w-full max-w-lg transform scale-95 opacity-0 relative max-h-[85vh] overflow-y-auto custom-scrollbar">
                <button onclick="BaristaApp.modalManager.closeGlossary()" class="absolute top-3 right-3 text-gray-400 hover:text-white text-2xl">×</button>
                <h3 class="text-2xl font-bold text-amber-400 mb-1 text-center">Glossary</h3>
                <input type="text" id="glossarySearch" placeholder="Search terms..." class="input-field w-full !p-2.5 text-sm mb-3">
                <ul id="glossaryList" class="space-y-1.5 max-h-80 overflow-y-auto custom-scrollbar pr-1 text-sm"></ul>
            </div>
        </div>

        <div id="donationModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[1050] hidden">
            <div class="modal-content-area glass p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-xl text-center transform scale-95 opacity-0 relative max-h-[85vh] overflow-y-auto custom-scrollbar">
                <button onclick="BaristaApp.modalManager.closeDonationModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl" aria-label="Close donation modal">×</button>
                <img src="images/logo.png" alt="Logo Icon" class="w-16 h-16 mx-auto mb-3">
                <h3 class="text-2xl font-bold text-amber-400 mb-4">Support This Project</h3>
                <p class="text-gray-300 mb-6 text-sm">Your contribution helps keep this resource free and accessible!</p>
                <div class="mb-6">
                    <h4 class="text-lg font-semibold text-sky-300 mb-3">For Donors in Nepal (नेपाल भित्रबाट सहयोग गर्नको लागि)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 text-left">
                        <div class="bg-gray-800/50 p-4 rounded-lg">
                            <h5 class="text-md font-semibold text-green-400 mb-2 text-center">eSewa</h5>
                           <div class="w-32 h-32 mx-auto mb-2 border border-gray-600 rounded p-1 bg-white">
  <img src="images/esewa_qr.png" alt="eSewa QR Code" class="w-full h-full">

</div>

                            <p class="text-sm text-gray-300 text-center">Scan QR or use eSewa ID:</p>
                            <p class="text-md font-bold text-white my-1 text-center bg-gray-700 p-2 rounded">9805670970</p>
                        </div>
                        <div class="bg-gray-800/50 p-4 rounded-lg">
                            <h5 class="text-md font-semibold text-indigo-400 mb-2 text-center">Khalti</h5>
                          <div class="w-32 h-32 mx-auto mb-2 border border-gray-600 rounded p-1 bg-white">
   <img src="images/khalti_qr_code.png" alt="Khalti QR Code" class="w-full h-full">

</div>

                            <p class="text-sm text-gray-300 text-center">Scan QR or use Khalti ID:</p>
                            <p class="text-md font-bold text-white my-1 text-center bg-gray-700 p-2 rounded">9805670970</p>
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 mt-2 text-center">कृपया रिमार्कमा "Barista Training Support" उल्लेख गर्नुहोला।</p>
                </div>
                <div class="mb-6 pt-4 border-t border-gray-700">
                    <h4 class="text-lg font-semibold text-sky-300 mb-3">For International Donors</h4>
                    <p class="text-gray-300 text-sm mb-3">You can support us via PayPal or by direct bank transfer (details below). Thank you!</p>
                    <div class="mb-4 flex justify-center">
                        <a href="https://paypal.me/YOUR_PAYPAL_USERNAME" target="_blank" rel="noopener noreferrer" class="inline-block my-2">
                            <img src="https://www.paypalobjects.com/digitalassets/c/website/logo/full-text/pp_fc_hl.svg" alt="PayPal" class="h-9 w-auto max-w-full">
                        </a>
                    </div>
                    <p class="text-xs text-gray-400">(User: Replace with your actual PayPal link/button)</p>
                    <details class="group text-left mt-4">
                        <summary class="interactive-choice py-2 px-4 rounded-md cursor-pointer list-none flex justify-between items-center">
                            <span class="font-semibold">International Bank Transfer Details</span>
                            <i class="fas fa-chevron-down group-open:rotate-180 transition-transform"></i>
                        </summary>
                        <div class="mt-2 p-3 bg-gray-800/40 rounded-md text-sm text-gray-300 space-y-1">
                                 <p><strong>Bank Name:</strong> Muktinath Bikash Bank</p>
                            <p><strong>Account Holder Name:</strong> Sukram Lama</p>
                            <p><strong>Account Number/IBAN:</strong> 16921101074994000001</p>
                            <p><strong>SWIFT/BIC Code:</strong>MNBBLNPKA</p>
                            <p><strong>Bank Address:</strong> Gundu Ext. Counter,Bhaktapur, Nepal</p>
                            <p class="text-xs text-gray-400 mt-1">( Donor may incur fees.)</p>
                        </div>
                    </details>
                </div>
                <p class="text-sm text-gray-300 text-center mt-4">Sharing this site is also a great way to show support!</p>
                <button onclick="BaristaApp.modalManager.closeDonationModal()" class="interactive-button bg-sky-600 hover:bg-sky-700 w-full mt-6 py-2.5">Close</button>
            </div>
        </div>

        <div id="quizModal" class="fixed inset-0 bg-black bg-opacity-85 flex items-center justify-center p-4 z-[1050] hidden">
            <div class="modal-content-area glass p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-xl transform scale-95 opacity-0 relative max-h-[85vh] overflow-y-auto custom-scrollbar">
                <button id="quizCloseButton" class="absolute top-3 right-3 text-gray-400 hover:text-white text-2xl z-10">×</button>
                <div class="flex justify-between items-start">
                    <h3 id="quizModalTitle" class="text-xl sm:text-2xl font-bold text-amber-400 mb-1 line-clamp-2">Quiz for Day X</h3>
                    <div class="text-right">
                        <span id="quizDayIndicator" class="text-xs bg-sky-600 text-white px-2 py-0.5 rounded-full font-semibold">Day X</span>
                        <div class="text-3xl font-bold text-red-500 tabular-nums"><span id="quizTimer">30</span>s</div>
                    </div>
                </div>
                <div class="w-full h-1 bg-gray-600 rounded-full my-3">
                    <div id="quizTimerBar" class="h-full bg-red-500 rounded-full"></div>
                </div>
                <div id="quizModalContent" class="my-6 text-gray-200"></div>
                <div id="quizModalFeedback" class="mt-6 text-amber-400 font-medium"></div>
                <div class="flex flex-col sm:flex-row gap-3 mt-8">
                    <button id="submitQuizButton" class="interactive-button w-full py-2.5">Submit Answer</button>
                    <button id="markDayCompleteButton" class="interactive-button hidden w-full py-2.5 bg-green-600 hover:bg-green-700">Mark Day as Complete & Close</button>
                </div>
            </div>
        </div>
    </main>


      <script>
                // Lesson Modal logic
                function showLessonModal(contentHtml) {
                    document.getElementById('lessonModalContent').innerHTML = contentHtml;
                    document.getElementById('lessonModal').classList.remove('hidden');
                    document.body.classList.add('overflow-hidden'); // Prevent background scroll
                }
                function hideLessonModal() {
                    document.getElementById('lessonModal').classList.add('hidden');
                    document.getElementById('lessonModalContent').innerHTML = '';
                    document.body.classList.remove('overflow-hidden'); // Restore scroll
                }
                document.getElementById('closeLessonModal').onclick = hideLessonModal;
                // Accessibility: Add missing alt/aria-labels for images and buttons
                        document.addEventListener('DOMContentLoaded', function() {
                            document.querySelectorAll('img:not([alt])').forEach(img => {
                                img.alt = 'Barista Training Image';
                            });
                            document.querySelectorAll('button:not([aria-label])').forEach(btn => {
                                if (!btn.innerText.trim()) btn.setAttribute('aria-label', 'Button');
                            });
                            // Show welcome modal on first visit or when triggered
                            if (!localStorage.getItem('baristaIO_hideWelcome')) {
                                document.getElementById('welcomeModal').classList.remove('hidden');
                            }
                            function hideWelcomeModal() {
                                document.getElementById('welcomeModal').classList.add('hidden');
                                localStorage.setItem('baristaIO_hideWelcome', '1');
                            }
                            document.getElementById('closeWelcomeModal').onclick = hideWelcomeModal;
                            document.getElementById('closeWelcomeModal2').onclick = hideWelcomeModal;
                            document.getElementById('skipWelcomeModal').onclick = hideWelcomeModal;

                                        // Hide welcome modal and show lesson modal when a lesson is opened
                                        const dayList = document.getElementById('dayList');
                                        if (dayList) {
                                            dayList.addEventListener('click', function(e) {
                                                let target = e.target;
                                                while (target && target !== dayList && !target.dataset.day) {
                                                    target = target.parentElement;
                                                }
                                                if (target && target.dataset.day) {
                                                    hideWelcomeModal();
                                                    // Find lesson content for the clicked day
                                                    const dayNum = parseInt(target.dataset.day, 10);
                                                    if (window.CONTENT && Array.isArray(window.CONTENT.days)) {
                                                        const lesson = window.CONTENT.days[dayNum - 1];
                                                        if (lesson && lesson.theory && lesson.theory.content) {
                                                            showLessonModal(`
                                                                <h2 class='text-2xl font-bold text-amber-400 mb-4'>Day ${lesson.day}: ${lesson.theory.title}</h2>
                                                                ${lesson.theory.content}
                                                            `);
                                                        }
                                                    }
                                                }
                                            }, true);
                                        }
                        });
        'use strict';
        // IMPORTANT DEVELOPMENT NOTE:
        // For Lottie animations and potentially other features to load correctly from local files
        // (e.g., "lottie/progress-animation.json", "images/..."), you MUST run this HTML file
        // through a local web server. Examples:
        // 1. If you have Node.js: Open terminal in this project's folder, run `npx http-server .`
        //    Then open `http://localhost:8080` (or the port it indicates) in your browser.
        // 2. VS Code: Use the "Live Server" extension.
        // 3. Python: `python -m http.server` (Python 3) or `python -m SimpleHTTPServer` (Python 2).
        // Opening index.html directly via `file:///...` will likely cause CORS errors for local resources.

        // CONTENT object
        const CONTENT = {
            days: [
                { // DAY 1: Welcome to the World of Coffee!
                    day: 1,
                    theory: {
                        title: "The Genesis of Coffee: From Seed to Phenomenon",
                        content: `
                        <article class="prose-enhanced">
                            <p class="gsap-fade-in">Welcome, aspiring coffee connoisseur! This journey begins by understanding that coffee, far more than a simple beverage, is a complex agricultural product with a rich history and global significance. We'll explore its origins, the plant, and the primary species defining your daily cup.</p>
                            <img src="images/coffee-plantation-overview.jpg" alt="Panoramic view of a coffee plantation" class="theory-image gsap-slide-in-up">

                            <div class="theory-section-break"></div>

                            <h4 class="gsap-fade-in">What Exactly is Coffee? The Bean Revealed</h4>
                            <div class="flex flex-col md:flex-row items-center gap-6 my-6">
                                <img src="images/coffee-cherry-anatomy.jpg" alt="Annotated diagram of a coffee cherry structure" class="theory-image md:w-2/5 gsap-slide-in-left">
                                <p class="md:w-3/5 gsap-slide-in-left" style="animation-delay: 0.2s;">At its heart, the 'coffee bean' is the <strong>seed</strong> of the coffee fruit, or <strong>coffee cherry</strong>. These cherries grow on <em>Coffea</em> genus trees, typically containing two seeds. These seeds are encased in layers: outer skin (exocarp), pulp (mesocarp), a slimy layer (parenchyma), and a parchment-like casing (endocarp). Understanding this structure is fundamental, as it directly influences processing methods and ultimately, the flavor profiles you'll learn to discern.</p>
                            </div>

                            <div class="theory-section-break"></div>

                            <h4 class="gsap-fade-in">The Global Nursery: The Coffee Belt</h4>
                            <p class="gsap-fade-in">Coffee cultivation is largely confined to the <strong>'Coffee Belt'</strong>, a band straddling the Equator between the Tropics of Cancer and Capricorn. Nations within <strong>Africa, Asia, and Central/South America</strong> provide the ideal tropical climates: stable temperatures (typically 15-24°C for Arabica, 24-30°C for Robusta), ample rainfall, and often high altitudes with fertile, well-drained (frequently volcanic) soils. This unique combination of geography, climate, and soil – often referred to as 'terroir' – is what crafts the diverse and unique flavor profiles found in coffees from around the world.</p>
                            <img src="images/world-map-coffee-belt-detail.jpg" alt="Detailed map of the Coffee Belt with highlighted regions" class="theory-image gsap-slide-in-up">

                            <div class="theory-section-break"></div>

                            <h4 class="gsap-fade-in">The Stars of the Show: Key Coffee Species</h4>
                            <p class="gsap-fade-in">While over 120 <em>Coffea</em> species exist, two reign supreme in the commercial coffee world: <em>Coffea arabica</em> and <em>Coffea canephora</em> (commonly known as Robusta). Their distinct characteristics shape the coffee landscape.</p>
                            <div class="grid md:grid-cols-2 gap-8 mt-6">
                                <div class="theory-interactive-block gsap-slide-in-up">
                                    <img src="images/arabica-beans-plant.jpg" alt="Arabica coffee beans and plant illustration" class="theory-image !max-w-full !my-0 !mb-4">
                                    <h5><em>Coffea arabica</em> (Arabica): The Aromatic Connoisseur's Choice</h5>
                                    <p class="text-sm text-gray-300 mb-2">Celebrated for its aromatic complexity and nuanced flavors, Arabica is the dominant species in specialty coffee.</p>
                                    <ul class="text-sm space-y-1.5">
                                        <li>🌍 Accounts for ~60-70% of global coffee production.</li>
                                        <li>👅 Offers a wide spectrum of flavors: fruity, floral, chocolatey, nutty, with pleasant acidity and a medium body.</li>
                                        <li>☕ Contains moderate caffeine levels (average 1.2-1.5% by weight).</li>
                                        <li>🌱 Prefers higher altitudes (600-2200 meters), is more delicate, and susceptible to pests and diseases.</li>
                                        <li>🧐 Beans are typically oval-shaped with a curved center slit.</li>
                                        <li>💡 Predominantly used for specialty coffee, single-origin offerings, and high-quality blends where flavor is paramount.</li>
                                    </ul>
                                </div>
                                <div class="theory-interactive-block gsap-slide-in-up" style="animation-delay: 0.2s;">
                                    <img src="images/robusta-beans-plant.jpg" alt="Robusta coffee beans and plant illustration" class="theory-image !max-w-full !my-0 !mb-4">
                                    <h5><em>Coffea canephora</em> (Robusta): The Bold Workhorse</h5>
                                    <p class="text-sm text-gray-300 mb-2">Known for its strong, bold character and higher caffeine content, Robusta plays a vital role in many coffee blends.</p>
                                    <ul class="text-sm space-y-1.5">
                                        <li>🌍 Makes up ~30-40% of global coffee production.</li>
                                        <li>👅 Features a bolder, more robust flavor profile, often described as rubbery, earthy, or bitter, with lower acidity and a heavier body.</li>
                                        <li>☕ Packs a higher caffeine punch (average 2.2-2.7% or more by weight).</li>
                                        <li>🌱 Thrives at lower altitudes (0-800 meters), is more resilient, and resistant to pests and diseases.</li>
                                        <li>🧐 Beans are generally smaller, more circular with a straight center slit.</li>
                                        <li>💡 Commonly used in espresso blends (contributing to rich crema), instant coffee, and where a strong, assertive coffee flavor is desired.</li>
                                    </ul>
                                </div>
                            </div>
                            <p class="mt-6 gsap-fade-in">Understanding these fundamental distinctions between Arabica and Robusta is your first major step towards developing a discerning palate and appreciating the diversity of coffee. This knowledge forms the bedrock of your budding barista expertise.</p>
                        </article>`,
                        objectives: [
                            "Define coffee's origin as a seed within the coffee cherry and describe its basic structure with visual aid.",
                            "Locate the 'Coffee Belt' and identify key coffee-producing continents, understanding climatic needs using a map.",
                            "Differentiate <em>Coffea arabica</em> from <em>Coffea canephora</em> (Robusta) based on multiple characteristics, aided by comparative visuals.",
                            "Recognize their significance in global production and common beverage applications.",
                            "Visually identify coffee at different stages: cherry, green bean, and roasted bean through practical exploration."
                                 ],
                resources: [ // Added for Day 1
                    { name: "National Coffee Association - What is Coffee?", url: "https://www.ncausa.org/about-coffee/what-is-coffee" },
                    { name: "Book: 'Uncommon Grounds' by Mark Pendergrast (History of Coffee)", url: "https://amzn.to/4dDnUvS", isAffiliate: true }
                ]
                    },
                    practical: {
                        title: "Visual Coffee Exploration & Sensory Introduction",
                        content: "Let's virtually explore coffee's journey from cherry to roasted bean, its global origins, and begin to associate aromas with familiar scents. This builds a foundational sensory library for coffee tasting.",
                        tasks: [
                            "Explore the 'Interactive Coffee Belt Map': Click on major coffee-growing continents (South America, Africa, Asia/Pacific) to see typical flavor profiles associated with them. Notice how geography influences taste.",
                            "Examine the 'From Cherry to Roasted Bean Image Carousel': Navigate through images of coffee cherries, green beans, and roasted beans. Read the descriptions to understand the transformation at each stage.",
                            "Engage with the 'Aroma Association Explorer': Match common coffee scent descriptors (like 'Chocolatey,' 'Fruity,' 'Nutty', 'Floral', 'Spicy') to images of familiar everyday items. This helps build your aroma vocabulary."
                        ]
                    },
                    quiz: {
                        question: "Which coffee species is generally known for its more aromatic and complex flavor profile, often with higher acidity and thriving at higher altitudes?",
                        options: ["Liberica", "Excelsa", "Arabica", "Robusta"],
                        correct: 2,
                        explanation: "Correct! Arabica is prized for its nuanced, aromatic flavors, brighter acidity, and typically grows at higher altitudes compared to Robusta."
                    }
                },
                 { // DAY 2: Your Tools: The Espresso Machine & Grinder
                    day: 2,
                    theory: {
                        title: "Essential Barista Toolkit: Espresso Machine & Grinder",
                        content: `
                        <article class="prose-enhanced">
                            <p class="gsap-fade-in">To craft truly exceptional espresso, a barista's skill is amplified by two indispensable pieces of equipment: the <strong>espresso machine</strong> and the <strong>coffee grinder</strong>. Understanding their mechanics and mastering their operation is fundamental to unlocking coffee's full potential.</p>
                            <img src="images/d2-barista-station.jpg" alt="Barista station with espresso machine and grinder" class="theory-image gsap-slide-in-up">

                            <div class="theory-section-break"></div>

                            <h4 class="gsap-fade-in">The Coffee Grinder: Precision in Every Particle</h4>
                            <div class="flex flex-col md:flex-row items-center gap-6 my-6">
                                <img src="images/d2-coffee-grinder-burr.jpg" alt="Close-up of a burr coffee grinder" class="theory-image md:w-2/5 gsap-slide-in-left">
                                <div class="md:w-3/5 gsap-slide-in-left" style="animation-delay: 0.2s;">
                                    <p>The coffee grinder is far more than a simple bean crusher; it's a precision instrument. Its primary role is to transform whole coffee beans into the fine, uniform particles essential for proper espresso extraction. The mantra of any skilled barista is to <strong>grind fresh for every shot</strong>. This practice is paramount because coffee's delicate aromatic compounds are highly volatile and begin to degrade rapidly upon grinding due to oxidation. Stale, pre-ground coffee simply cannot deliver the vibrant flavor and aroma of freshly ground beans.</p>
                                    <h5 class="mt-4">Key Grinder Components:</h5>
                                    <ul class="text-sm space-y-1.5 list-disc list-inside">
                                        <li><strong>Hopper:</strong> The reservoir that holds whole coffee beans before they descend into the grinding mechanism.</li>
                                        <li><strong>Burrs:</strong> Two abrasive surfaces (typically conical or flat, made of hardened steel or ceramic) that crush or shear the beans into grounds. Burr grinders are vastly superior to blade grinders for their consistency in particle size.</li>
                                        <li><strong>Grind Adjustment Mechanism:</strong> A dial, collar, or lever that allows the barista to precisely control the distance between the burrs, thus determining the fineness or coarseness of the coffee grounds. This is a critical variable for 'dialing in' espresso.</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="theory-section-break"></div>

                            <h4 class="gsap-fade-in">The Espresso Machine: Engineering Espresso Perfection</h4>
                             <div class="flex flex-col md:flex-row-reverse items-center gap-6 my-6">
                                <img src="images/espresso-machine-parts.jpg" alt="Diagram of an espresso machine with key parts highlighted" class="theory-image md:w-2/5 gsap-slide-in-left">
                                <div class="md:w-3/5 gsap-slide-in-left" style="animation-delay: 0.2s;">
                                    <p>The espresso machine is a marvel of engineering, designed to force hot water (precisely heated, typically between <strong>90-96°C or 195-205°F</strong>) through a tightly compacted 'puck' of finely ground coffee. This process occurs under high pressure, ideally <strong>8-10 bars</strong>, to extract the concentrated, flavorful beverage that is espresso.</p>
                                    <h5 class="mt-4">Key Espresso Machine Components:</h5>
                                    <ul class="text-sm space-y-1.5 list-disc list-inside">
                                        <li><strong>Group Head (Brew Group):</strong> The heart of the machine where the portafilter locks in and hot water is evenly dispersed over the coffee grounds via a shower screen.</li>
                                        <li><strong>Portafilter:</strong> A handle containing a filter basket that holds the tamped coffee grounds. It's the interface between the machine and the coffee.</li>
                                        <li><strong>Steam Wand:</strong> A nozzle that emits high-pressure steam, used for heating and texturing milk to create the silky microfoam essential for lattes, cappuccinos, and other milk-based drinks.</li>
                                        <li><strong>Boiler(s):</strong> Internal tanks that heat water to the precise temperatures required for brewing coffee and producing steam. Advanced machines may have separate boilers for each function to ensure temperature stability.</li>
                                        <li><strong>Pump:</strong> The component responsible for generating the high pressure necessary for espresso extraction.</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="theory-section-break"></div>
                            <div class="theory-interactive-block gsap-slide-in-up">
                                <h5>The Golden Rule: Why Grind Fresh?</h5>
                                <p>Imagine an apple. Once you slice it, it begins to brown (oxidize) and lose its crispness and some flavor. Coffee beans are similar. The moment they are ground, their surface area vastly increases, exposing delicate aromatic compounds to oxygen. These compounds, responsible for the incredible array of flavors and smells in coffee, are volatile and dissipate quickly. </p>
                                <p class="mt-2">Grinding beans immediately before brewing ensures that you capture the maximum spectrum of these aromas and flavors in your cup. Pre-ground coffee, no matter how well packaged, will have lost a significant portion of its magic by the time it reaches your portafilter.</p>
                            </div>
                        </article>`,
                        objectives: [
                            "Explain the primary function of a coffee grinder and an espresso machine in coffee preparation.",
                            "Identify and describe the function of at least three key parts of a coffee grinder (e.g., hopper, burrs, grind adjustment).",
                            "Identify and describe the function of at least four key parts of an espresso machine (e.g., group head, portafilter, steam wand, boiler).",
                            "Articulate the importance of grinding coffee beans fresh for each espresso shot."
                        ],
                        resources: [
                            { name: "How Espresso Machines Work (Article by HowStuffWorks)", url: "https://recipes.howstuffworks.com/espresso-machine.htm" },

                            // USER: You could add an affiliate link example here for a grinder
                            { name: "Baratza Encore Grinder (Recommended Entry-Level)", url: "https://amzn.to/3SmK8bE", isAffiliate: true },
                               { name: "Semi-Automatic Espresso Machines (Recommended Entry-Level)", url: " https://amzn.to/3SPBT7V", isAffiliate: true }
                        ]

                    },
                    practical: {
                        title: "Identifying Machine & Grinder Parts",
                        content: "Let's familiarize ourselves with the anatomy of our coffee-making powerhouses. You'll also observe how coffee particle size impacts brewing.",
                        tasks: [
                            "In the 'Espresso Machine Explorer,' click on highlighted parts to reveal their names and functions. Note where water flows and where steam is produced.",
                            "Similarly, use the 'Grinder Explorer' to understand how beans are processed into grounds.",
                            "Study the 'Grind Size Visualizer' to compare 'too coarse' (fast flow, under-extraction), 'espresso ideal,' and 'too fine' (slow flow/choking, over-extraction)."
                        ]
                    },
                    quiz: {
                        question: "What is the primary reason for grinding coffee beans immediately before brewing an espresso?",
                        options: ["It makes the beans easier to store.", "To preserve volatile aromatic compounds for optimal flavor.", "It reduces the caffeine content.", "Pre-ground coffee is too coarse for espresso machines."],
                        correct: 1,
                        explanation: "Grinding fresh preserves the delicate aromatic compounds that are quickly lost to oxidation once coffee is ground, ensuring the best possible flavor and aroma in your espresso."
                    }
                },
                    { // DAY 3: First Steps: Grinding, Dosing & Tamping
                    day: 3,
                    theory: {
                        title: "The Espresso Foundation: Grinding, Dosing & Tamping",
                        content: `
                        <article class="prose-enhanced">
                            <p class="gsap-fade-in">Before the magic of the espresso machine can unfold, meticulous preparation of the coffee grounds is paramount. The trifecta of <strong>grinding, dosing, and tamping</strong> forms the very foundation upon which a perfect shot of espresso is built. Each step requires precision and understanding.</p>

                            <img src="images/d3-grind-dose-tamp.jpg" alt="Collage of grinding, dosing, and tamping coffee" class="theory-image gsap-slide-in-up">

                            <div class="theory-section-break"></div>

                            <h4 class="gsap-fade-in">Grinding: The Pursuit of Uniformity</h4>
                             <div class="flex flex-col md:flex-row-reverse items-center gap-6 my-6">
                                <img src="images/d3-espresso-grind-closeup.jpg" alt="Close-up of fine espresso grounds" class="theory-image md:w-2/5 gsap-slide-in-left">
                                <div class="md:w-3/5 gsap-slide-in-left" style="animation-delay: 0.2s;">
                                    <p>For espresso, a <strong>very fine and consistent grind</strong> is non-negotiable. Imagine the texture of table salt or slightly finer, like fine sand. Consistency is the watchword here; uneven grounds, with a mix of large and small particles, lead to uneven extraction. During brewing, some particles will over-extract (imparting bitter, harsh flavors), while others will under-extract (resulting in sour, underdeveloped notes).</p>
                                    <p class="mt-2">The correct grind size creates the necessary resistance for the pressurized water. This allows the water to interact optimally with the coffee particles during the relatively short brew time (typically 20-30 seconds), extracting the desirable soluble compounds that create a balanced and flavorful espresso.</p>
                                </div>
                            </div>

                            <div class="theory-section-break"></div>

                            <h4 class="gsap-fade-in">Dosing: The Measure of Accuracy</h4>
                            <div class="flex flex-col md:flex-row items-center gap-6 my-6">
                                 <img src="images/d3-dosing-grounds-portafilter.jpg" alt="Dosing coffee grounds into a portafilter using a scale" class="theory-image md:w-2/5 gsap-slide-in-left">
                                <div class="md:w-3/5 gsap-slide-in-left" style="animation-delay: 0.2s;">
                                    <p>Dosing refers to dispensing the correct amount (by weight) of ground coffee into the portafilter's filter basket. The ideal dose is specific to the size of the filter basket (e.g., 14g, 18g, 20g) and the barista's chosen recipe. Precision in dosing is crucial for consistency.</p>
                                    <p class="mt-2">Too little coffee can lead to a watery, under-extracted shot because the water flows through too quickly. Conversely, too much coffee can 'choke' the machine (preventing water flow) or cause over-extraction due to excessive resistance. Professional baristas universally use high-precision scales to weigh their dose for every shot, ensuring shot-to-shot consistency.</p>
                                </div>
                            </div>

                            <div class="theory-section-break"></div>

                            <h4 class="gsap-fade-in">Tamping: Crafting the Perfect Puck</h4>
                             <div class="flex flex-col md:flex-row-reverse items-center gap-6 my-6">
                                <img src="images/d3-tamping-coffee.jpg" alt="Barista tamping coffee grounds in a portafilter" class="theory-image md:w-2/5 gsap-slide-in-left">
                                <div class="md:w-3/5 gsap-slide-in-left" style="animation-delay: 0.2s;">
                                    <p>After dosing, the coffee grounds are compressed evenly and firmly using a tool called a 'tamper.' The primary goal of tamping is to create a <strong>level and compact 'puck'</strong> of coffee. This compaction serves two main purposes: it removes air pockets within the grounds and ensures that water flows uniformly through the entire bed of coffee during extraction.</p>
                                    <p class="mt-2">An uneven or poorly tamped puck will inevitably lead to 'channeling.' This is where water finds paths of least resistance through the coffee bed, resulting in some parts of the coffee being over-extracted and other parts under-extracted, leading to an unbalanced and flawed espresso. While a standard tamping pressure is often cited (e.g., around 30 lbs or 13-15 kg), <strong>consistency and a perfectly level tamp</strong> are far more important than absolute force. The tamped surface should be flat and parallel to the rim of the portafilter basket.</p>
                                </div>
                            </div>
                            <p class="mt-6 gsap-fade-in">Mastering these three foundational steps – achieving the right grind, dosing accurately, and tamping consistently – is essential. They are the unseen heroes behind every great shot of espresso.</p>
                        </article>`,
                        objectives: [
                            "Describe the ideal grind consistency for espresso (e.g., like table salt) and explain why consistency is important.",
                            "Define 'dosing' and explain its importance, including the use of scales for accuracy.",
                            "Explain the purpose of 'tamping,' including creating a level puck and preventing channeling.",
                            "Visually recognize the characteristics of a well-dosed and well-tamped portafilter (level, compact, no loose grounds on rim)."
                        ],
   resources: [

    { name: "Recommended Espresso Tamper", url: "https://amzn.to/3FpsnWa", isAffiliate: true },

]
                    },
                    practical: {
                        title: "Virtual Grind, Dose & Tamp Simulation",
                        content: "Let's simulate the critical steps of preparing coffee for an espresso. Focus on understanding the concepts of correct grind selection, achieving an appropriate dose, and the importance of a level tamp.",
                        tasks: [
                            "Use the 'Virtual Grinder Adjuster': Select the 'Espresso' setting and observe the visual representation of the grind size. Understand why other settings are unsuitable for espresso.",
                            "In the 'Virtual Dosing Challenge,' aim to fill the portafilter basket to the ideal level using a slider, simulating weighing grounds.",
                            "Practice with the 'Virtual Tamper' to achieve an even and level surface. Observe the visual feedback on tamp quality (level vs. uneven)."
                        ]
                    },
                    quiz: {
                        question: "What is the primary goal of tamping coffee grounds in a portafilter?",
                        options: ["To make the coffee grounds hotter before brewing.", "To fit more coffee into the basket.", "To create a dense, level puck for even water flow and optimal extraction.", "To make the portafilter look neat and tidy."],
                        correct: 2,
                        explanation: "Tamping creates a compact and level coffee bed. This is crucial for ensuring that water flows evenly through the grounds during extraction, preventing channeling and leading to a balanced, flavorful espresso."
                    }
                },
// ... (other days in your CONTENT.days array) ...
                        { // DAY 4: Your First Espresso Shot (Conceptual)
                    day: 4,
                    theory: {
                        title: "Pulling the Perfect Shot: Dose, Yield, Time & Crema",
                        content: `
                        <article class="prose-enhanced">
                            <p class="gsap-fade-in">An espresso is more than just a small, strong coffee; it's a concentrated elixir that forms the heart of countless beloved café beverages. 'Pulling' a shot is an art and a science, revolving around key parameters that profoundly influence its quality. Understanding these parameters is your next step to espresso mastery.</p>
                            <img src="images/d4-espresso-shot-pulling.jpg" alt="Espresso shot being pulled into a glass" class="theory-image gsap-slide-in-up">

                            <div class="theory-section-break"></div>

                            <h4 class="gsap-fade-in">The 'Holy Trinity' of Espresso: Dose, Yield, and Time</h4>
                            <p class="gsap-fade-in">Achieving a balanced espresso hinges on the precise interplay of three core variables, often referred to as the 'Holy Trinity':</p>
                            <div class="grid md:grid-cols-3 gap-6 my-6">
                                <div class="theory-interactive-block gsap-slide-in-up">
                                    <h5>1. Dose</h5>
                                    <p class="text-sm">This is the <strong>weight of dry coffee grounds</strong> used to prepare the shot. It's typically measured in grams (e.g., 18 grams for a standard double espresso). The dose is determined by the size of your portafilter basket and your desired recipe strength.</p>
                                    <img src="images/d4-dosing-scale.jpg" alt="Coffee grounds being weighed on a scale" class="theory-image !max-w-full !my-2 !mb-1">
                                </div>
                                <div class="theory-interactive-block gsap-slide-in-up" style="animation-delay: 0.15s;">
                                    <h5>2. Yield</h5>
                                    <p class="text-sm">This refers to the <strong>weight or volume of the liquid espresso</strong> that is extracted into the cup. Like the dose, it's also commonly measured in grams for precision (e.g., 36 grams of liquid espresso). Some may use volume (e.g., ~2 fluid ounces or 60ml), but weight is more accurate.</p>
                                    <img src="images/d4-espresso-yield-scale.jpg" alt="Espresso shot on a scale measuring yield" class="theory-image !max-w-full !my-2 !mb-1">
                                </div>
                                <div class="theory-interactive-block gsap-slide-in-up" style="animation-delay: 0.3s;">
                                    <h5>3. Time</h5>
                                    <p class="text-sm">This is the <strong>duration of the extraction</strong>, measured from the moment the pump on the espresso machine engages until the desired yield is reached. This is typically measured in seconds (e.g., 25-30 seconds).</p>
                                    <img src="images/d4-shot-timer.jpg" alt="Espresso shot timer display" class="theory-image !max-w-full !my-2 !mb-1">
                                </div>
                            </div>
                            <p class="gsap-fade-in">A common starting point for brewing a 'double espresso' is a <strong>1:2 brew ratio</strong>. This means that for every 1 gram of dry coffee grounds (dose), you aim for 2 grams of liquid espresso (yield). For example, if you use an 18g dose, your target yield would be 36g. This ratio, combined with an extraction time of approximately <strong>25-30 seconds</strong>, often produces a well-balanced and flavorful shot. However, these are merely starting points; skilled baristas constantly 'dial in' their espresso by meticulously adjusting grind size (the primary adjustment), dose, and sometimes yield to achieve the optimal taste profile for a specific coffee bean.</p>

                            <div class="theory-section-break"></div>

                            <h4 class="gsap-fade-in">Crema: The Crowning Glory</h4>
                            <div class="flex flex-col md:flex-row items-center gap-6 my-6">
                                <img src="images/d4-good-crema.jpg" alt="Close-up of a perfect espresso crema" class="theory-image md:w-2/5 gsap-slide-in-left">
                                <div class="md:w-3/5 gsap-slide-in-left" style="animation-delay: 0.2s;">
                                    <p>Crema is the iconic reddish-brown, fine-bubbled foam that sits atop a freshly pulled espresso. It's formed by carbon dioxide gas (naturally present in freshly roasted beans) emulsifying with coffee oils under the high pressure of the extraction process. Good crema is often an indicator of several positive factors:</p>
                                    <ul class="text-sm space-y-1.5 list-disc list-inside mt-2">
                                        <li><strong>Freshly roasted and ground coffee:</strong> Older beans or pre-ground coffee will produce less crema.</li>
                                        <li><strong>Proper grind size and tamp:</strong> These ensure correct resistance and even extraction.</li>
                                        <li><strong>Adequate brew temperature and pressure:</strong> The machine operating within optimal parameters.</li>
                                    </ul>
                                    <p class="mt-2">Ideally, crema should be smooth, dense, and persistent, lasting for a couple of minutes before gradually dissipating. While crema contributes to the mouthfeel and aroma of espresso, it's important to remember that it's not the sole indicator of taste quality. A beautiful crema doesn't always guarantee a delicious shot, but its absence or poor quality often signals an issue with the coffee or the extraction process.</p>
                                </div>
                            </div>
                            <p class="mt-6 gsap-fade-in">By understanding and learning to control dose, yield, time, and recognizing good crema, you are well on your way to consistently pulling delicious espresso shots.</p>
                        </article>`,
                        objectives: [
                            "Clearly define 'dose,' 'yield,' and 'extraction time' in the context of brewing espresso.",
                            "State a common starting brew ratio (e.g., 1:2 dose to yield) and target extraction time range (e.g., 25-30 seconds) for a double espresso.",
                            "Describe the visual characteristics of good 'crema' and explain what it indicates about the coffee and extraction.",
                            "Understand that brew parameters (dose, yield, time) are interconnected and adjustable to fine-tune taste."
                        ],
                        resources: [ // Added for Day 4
                            { name: "Understanding Espresso Ratios (Article)", url: "https://www.home-barista.com/espresso-guide-ratio.html" },
                            { name: "High-Precision Coffee Scale", url: "https://amzn.to/4mxolf3", isAffiliate: true }
                        ]
                    },
                practical: {
                        title: "Simulating an Espresso Shot Extraction",
                        content: "Let's use a simulator to visualize the relationship between dose, yield, and time in espresso extraction. We'll also practice identifying good quality crema.",
                        tasks: [
                            "In the 'Espresso Shot Simulator,' input a coffee dose (e.g., 18g). Observe the automatically calculated target yield based on a 1:2 ratio.",
                            "Initiate the 'shot pull' and monitor the visual timer and yield counter. Attempt to stop the shot when it reaches the target yield within the ideal 25-30 second window.",
                            "Participate in the 'Crema Quality Check': From a selection of images, identify the one that depicts the best-looking crema, noting its color, texture, and persistence."
                        ]
},
                           quiz: {
                        question: "If a barista uses a 1:2 brew ratio and doses 19 grams of coffee, what is the target yield in liquid espresso weight?",
                        options: ["19 grams", "28.5 grams", "38 grams", "57 grams"],
                        correct: 2,
                        explanation: "A 1:2 brew ratio means the liquid espresso yield should be twice the weight of the dry coffee dose. So, 19 grams (dose) x 2 = 38 grams (yield)."
                    }
                },
                { // DAY 5: Basic Espresso Troubleshooting (Taste & Adjustments)
                    day: 5,
                    theory: {
                        title: "Dialing In: Understanding Espresso Taste & Adjustments",
                        content: `
                        <article class="prose-enhanced">
                            <p class="gsap-fade-in">The ultimate arbiter of your espresso's quality is its taste. Learning to identify common taste flaws and understanding how to adjust your brewing variables is a crucial skill known as <strong>'dialing in.'</strong> For beginners, the most impactful variable to adjust is typically the <strong>grind size</strong>, followed by dose and yield as you gain more experience.</p>
                            <img src="images/d5-dialing-in-espresso.jpg" alt="Barista tasting espresso and adjusting grinder" class="theory-image gsap-slide-in-up">

                            <div class="theory-section-break"></div>

                            <h4 class="gsap-fade-in">Common Taste Issues & Their Likely Culprits</h4>
                            <p class="gsap-fade-in">Let's explore the most common taste imbalances in espresso and how to address them:</p>

                            <div class="grid md:grid-cols-2 gap-8 mt-6">
                                <div class="theory-interactive-block gsap-slide-in-up">
                                    <img src="images/d5-sour-espresso-face.jpg" alt="Person making a sour face after tasting espresso" class="theory-image !max-w-full !my-0 !mb-4">
                                    <h5>1. Sour / Acidic / Salty: The Under-Extraction Story</h5>
                                    <p class="text-sm text-gray-300 mb-2">This unpleasant sharpness, often accompanied by a thin body, usually indicates <strong>under-extraction</strong>. The water has passed through the coffee grounds too quickly, failing to dissolve enough of the desirable flavor compounds.</p>
                                    <ul class="text-sm space-y-1.5">
                                        <li><strong>Visual Cues:</strong> The shot likely ran too fast (e.g., significantly less than 20-22 seconds for a standard 1:2 ratio). Crema might be pale, thin, and dissipate rapidly.</li>
                                        <li><strong>Primary Adjustment:</strong> Make the <strong>grind finer</strong>. This increases the surface area of the coffee particles and creates more resistance, slowing down the water flow and allowing for more thorough extraction.</li>
                                    </ul>
                                </div>
                                <div class="theory-interactive-block gsap-slide-in-up" style="animation-delay: 0.2s;">
                                    <img src="images/d5-bitter-espresso-face.jpg" alt="Person making a bitter face after tasting espresso" class="theory-image !max-w-full !my-0 !mb-4">
                                    <h5>2. Bitter / Harsh / Burnt / Astringent: The Over-Extraction Tale</h5>
                                    <p class="text-sm text-gray-300 mb-2">An aggressive, lingering bitterness or a dry, astringent sensation often points to <strong>over-extraction</strong>. The water spent too much time in contact with the coffee, dissolving unwanted, less soluble bitter compounds.</p>
                                    <ul class="text-sm space-y-1.5">
                                        <li><strong>Visual Cues:</strong> The shot likely ran too slow (e.g., significantly more than 33-35 seconds for a 1:2 ratio). Crema might be very dark, thin, or even have a hole in the center ('bald spot').</li>
                                        <li><strong>Primary Adjustment:</strong> Make the <strong>grind coarser</strong>. This reduces the resistance, allowing water to flow through more easily and shortening the contact time, thus reducing over-extraction.</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="theory-section-break"></div>

                            <h4 class="gsap-fade-in">The Sweet Spot: Balanced & Delicious</h4>
                            <div class="flex flex-col md:flex-row items-center gap-6 my-6">
                                <img src="images/d5-balanced-espresso.jpg" alt="A perfectly extracted espresso shot with rich crema" class="theory-image md:w-2/5 gsap-slide-in-left">
                                <div class="md:w-3/5 gsap-slide-in-left" style="animation-delay: 0.2s;">
                                    <p>This is the ultimate goal! A well-extracted espresso exhibits a harmonious balance of <strong>sweetness, acidity</strong> (which can be a desirable, bright, fruit-like quality, not to be confused with sourness), and <strong>body</strong>. It often leaves a pleasant, lingering aftertaste. The specific flavor notes will, of course, depend on the coffee bean's origin, processing method, and roast profile.</p>
                                    <ul class="text-sm space-y-1.5 list-disc list-inside mt-2">
                                        <li><strong>Visual Cues:</strong> The shot time and yield are typically within your target range (e.g., for an 18g dose, achieving a 36g yield in 25-30 seconds). The crema is rich, reddish-brown, and persistent.</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="theory-interactive-block gsap-slide-in-up">
                                <h5>Remember the Grind-Flow-Extraction Relationship:</h5>
                                <ul class="text-sm space-y-1.5 list-disc list-inside">
                                    <li><strong>Finer Grind → Slower Flow → More Extraction</strong> (Risk of bitterness if too fine)</li>
                                    <li><strong>Coarser Grind → Faster Flow → Less Extraction</strong> (Risk of sourness if too coarse)</li>
                                </ul>
                                <p class="mt-2 text-sm">Always aim to make <strong>one adjustment at a time</strong> and taste the result. This systematic approach is key to effectively dialing in your espresso and understanding how each variable impacts the final cup.</p>
                            </div>
                        </article>`,
                        objectives: [
                            "Identify 'sourness' as a primary indicator of under-extraction and 'bitterness' as an indicator of over-extraction.",
                            "Correlate very fast extraction times with under-extraction and very slow extraction times with over-extraction.",
                            "Determine the primary adjustment to make for an under-extracted shot (grind finer) and an over-extracted shot (grind coarser).",
                            "Understand the concept of a 'balanced' shot and its desirable characteristics."
                        ],
                        resources: [ // Added for Day 5
                            { name: "Barista Hustle - Dialing In Espresso", url: "https://www.baristahustle.com/blog/espresso-recipes-analyzing-dose/" },
                            { name: "Espresso Distribution Tool", url: "https://amzn.to/4kfzmA8", isAffiliate: true }
                        ]
                    },
                                      practical: {
                        title: "Virtual Espresso Troubleshooting",
                        content: "Let's practice diagnosing common espresso problems and deciding on corrective actions conceptually. You'll be presented with scenarios and choose the most appropriate adjustment.",
                        tasks: [
                            "Scenario 1: 'Your 18g dose yields 36g of espresso in only 15 seconds, and it tastes unpleasantly sour.' What is the primary adjustment you should make to your grinder? (e.g., 'Grind Finer', 'Grind Coarser').",
                            "Scenario 2: 'Your 18g dose yields 36g of espresso, but it takes 40 seconds, and the taste is harsh and bitter.' What is the primary adjustment for your grinder?",
                            "Engage with the 'Grind Adjustment Simulator': Observe how conceptually changing the grind from 'too coarse' to 'ideal' to 'too fine' impacts the visual representation of flow rate, extraction time, and resulting taste profile."
                        ]
                    },
                    quiz: {
                        question: "If your espresso shot is extracting too slowly (e.g., 40 seconds) and tastes bitter, what is the most common first adjustment to make?",
                        options: ["Increase the coffee dose", "Tamp much harder", "Make the coffee grind coarser", "Make the coffee grind finer"],
                        correct: 2,
                        explanation: "A slow, bitter shot typically indicates over-extraction, often due to the grind being too fine. Making the grind coarser will allow water to flow through more easily, reducing extraction time and bitterness."
                    }
                },
                { // DAY 6: Milk 101: Types and Heating
                    day: 6,
                    theory: {
                        title: "The World of Milk: Varieties, Heating, and Sweetness",
                        content: `
                        <article class="prose-enhanced">
                            <p class="gsap-fade-in">Milk is a transformative ingredient in many cherished coffee beverages, contributing texture, sweetness, and richness that complement espresso beautifully. Understanding the nuances of different milk types and the science behind proper heating techniques is essential for any barista aspiring to craft exceptional drinks.</p>
                            <img src="images/d6-milk-variety.jpg" alt="Assortment of dairy and plant-based milks" class="theory-image gsap-slide-in-up">

                            <div class="theory-section-break"></div>

                            <h4 class="gsap-fade-in">A Spectrum of Choices: Common Milk Types in Cafes</h4>
                            <p class="gsap-fade-in">Cafes typically offer a range of milk options to cater to diverse preferences and dietary needs. These broadly fall into dairy and plant-based categories:</p>

                            <h5 class="mt-4 gsap-fade-in">1. Dairy Milks: The Classic Canvas</h5>
                            <div class="grid md:grid-cols-2 gap-6 my-6">
                                <div class="theory-interactive-block gsap-slide-in-up">
                                    <img src="images/d6-whole-milk.jpg" alt="Glass of whole milk" class="theory-image !max-w-full !my-0 !mb-4">
                                    <h6>Whole Milk (Full Fat)</h6>
                                    <p class="text-sm">Often the preferred choice for baristas due to its ideal balance of fats (around 3.25-3.5%) and proteins. This composition allows for excellent microfoam creation, resulting in a creamy, velvety texture and rich flavor. Whole milk also possesses natural sweetness (from lactose) that is wonderfully enhanced when heated correctly.</p>
                                </div>
                                <div class="theory-interactive-block gsap-slide-in-up" style="animation-delay: 0.15s;">
                                     <img src="images/d6-skim-milk.jpg" alt="Glass of skim milk" class="theory-image !max-w-full !my-0 !mb-4">
                                    <h6>Reduced-Fat & Skim Milks</h6>
                                    <p class="text-sm">Options like 2%, 1%, and skim (non-fat) milk contain progressively less fat. This can make it slightly more challenging to achieve stable, silky microfoam. Skim milk, with very little fat, tends to produce a stiffer, more meringue-like foam. These milks also taste less rich than whole milk.</p>
                                </div>
                            </div>

                            <h5 class="mt-4 gsap-fade-in">2. Plant-Based (Non-Dairy) Milks: The Rising Stars</h5>
                            <p class="gsap-fade-in">The popularity of plant-based milks has surged, with many cafes offering "Barista Blend" versions specifically formulated with added stabilizers or fats to improve their steaming performance and prevent curdling in coffee.</p>
                            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 my-6">
                                <div class="theory-interactive-block gsap-slide-in-up">
                                    <img src="images/d6-oat-milk.jpg" alt="Glass of oat milk" class="theory-image !max-w-full !my-0 !mb-4">
                                    <h6>Oat Milk</h6>
                                    <p class="text-sm">A highly popular choice, oat milk (especially barista blends) steams exceptionally well, creating creamy microfoam very similar to whole dairy milk. Its flavor is relatively neutral and slightly sweet, complementing coffee beautifully.</p>
                                </div>
                                <div class="theory-interactive-block gsap-slide-in-up" style="animation-delay: 0.1s;">
                                    <img src="images/d6-soy-milk.jpg" alt="Glass of soy milk" class="theory-image !max-w-full !my-0 !mb-4">
                                    <h6>Soy Milk</h6>
                                    <p class="text-sm">Another good steaming option, particularly barista editions. It can sometimes have a distinct 'beany' flavor that some consumers find noticeable, though this is less prominent in quality barista blends.</p>
                                </div>
                                <div class="theory-interactive-block gsap-slide-in-up" style="animation-delay: 0.2s;">
                                    <img src="images/d6-almond-milk.jpg" alt="Glass of almond milk" class="theory-image !max-w-full !my-0 !mb-4">
                                    <h6>Almond Milk</h6>
                                    <p class="text-sm">Can be more challenging to steam well due to lower protein and fat content; often results in thinner foam or may curdle with more acidic coffees if not a barista blend. Barista versions perform significantly better and offer a distinct nutty flavor.</p>
                                </div>
                            </div>
                            <p class="gsap-fade-in">Other plant-based options like coconut, rice, and cashew milk vary in their steaming capabilities and flavor impact, and are less commonly the default choices for latte art due to these variations.</p>

                            <div class="theory-section-break"></div>

                            <h4 class="gsap-fade-in">The Science of Sweetness: Heating Milk Correctly</h4>
                            <div class="flex flex-col md:flex-row items-center gap-6 my-6">
                                <img src="images/d6-milk-thermometer.jpg" alt="Milk pitcher with a thermometer showing ideal temperature" class="theory-image md:w-2/5 gsap-slide-in-left">
                                <div class="md:w-3/5 gsap-slide-in-left" style="animation-delay: 0.2s;">
                                    <p>When we steam milk, we are doing two primary things: heating it to a palatable temperature and incorporating air (aerating) to alter its texture. The ideal temperature range for steamed milk is typically <strong>55-65°C (130-150°F)</strong>. Achieving this range is critical because:</p>
                                    <ul class="text-sm space-y-1.5 list-disc list-inside mt-2">
                                        <li><strong>Sweetness Unlocked:</strong> Within this temperature window, lactose (the natural sugar in milk) begins to break down into simpler, sweeter-tasting sugars (monosaccharides like glucose and galactose). This process enhances the milk's perceived sweetness without adding any external sugar.</li>
                                        <li><strong>Optimal Texture:</strong> The texture of the milk is at its most velvety and integrated, perfect for pouring latte art and providing a luxurious mouthfeel.</li>
                                    </ul>
                                    <p class="mt-2"><strong>Warning: The Perils of Overheating!</strong> Heating milk above <strong>70°C (160°F)</strong> is detrimental. It scalds the milk, denatures the proteins (which are crucial for creating and stabilizing foam), and can impart a burnt, sulphurous, or cooked taste, effectively destroying its natural sweetness and desirable texture.</p>
                                </div>
                            </div>
                            <p class="mt-6 gsap-fade-in">Understanding these milk properties and temperature dynamics is key to consistently producing delicious, beautifully textured milk for your coffee creations.</p>
                        </article>`,
                        objectives: [
                            "Identify at least two common dairy milks and three common plant-based milks used in coffee shops.",
                            "Explain why whole dairy milk is often preferred for steaming by baristas (fat/protein content).",
                            "State the ideal temperature range for steaming milk (e.g., 55-65°C or 130-150°F) and why it's important for sweetness and texture.",
                            "Describe the negative consequences of overheating milk (scalding, loss of sweetness, poor foam)."
                        ],
                        resources: [ // Added for Day 6
                            { name: "Perfect Daily Grind - Guide to Milk for Coffee", url: "https://perfectdailygrind.com/2020/08/a-baristas-guide-to-milk-dairy-non-dairy-alternatives/" },
                            { name: "Oatly Barista Edition Oat Milk", url: "https://amzn.to/43b98Zw", isAffiliate: true },
                             { name: "Milk Thermometer with Clip", url: "https://amzn.to/4mBFkgo", isAffiliate: true }
                        ]
                    },
                    practical: {
                        title: "Milk Characteristics & Temperature Exploration",
                        content: "Let's delve into the properties of different milks and the critical role of temperature in achieving perfectly steamed milk.",
                        tasks: [
                            "Browse the 'Milk Gallery': Observe visual characteristics and read brief descriptions of whole, skim, oat, soy, and almond milk, noting their suitability for steaming.",
                            "Use the 'Interactive Milk Thermometer': Drag a slider to simulate milk temperature. Receive instant feedback on whether the milk is 'Too Cold,' in the 'Ideal Sweetness Zone,' or 'Scalded/Too Hot.'",
                            "Read 'Why Barista Blends?': A short text explaining why specific 'barista edition' plant-based milks are often preferred for their enhanced steaming capabilities."
                        ]
                    },
                    quiz: {
                        question: "Overheating milk (e.g., above 70°C / 160°F) generally results in:",
                        options: ["Increased natural sweetness and better foam", "A burnt taste and poor foam texture", "No significant change in taste or texture", "A thicker, richer consistency"],
                        correct: 1,
                        explanation: "Overheating milk scalds it, denatures proteins essential for good foam, and can create an unpleasant burnt or cooked flavor, destroying its natural sweetness."
                    }
                },
                { // DAY 7: Milk Steaming Basics: Creating Microfoam (Conceptual)
                    day: 7,
                    theory: {
                        title: "The Art of Milk Steaming: Stretching & Texturing for Microfoam",
                        content: `
                        <article class="prose-enhanced">
                            <p class="gsap-fade-in">Properly steamed milk is a hallmark of a skilled barista, transforming a simple coffee into a luxurious experience. The ultimate goal is to create <strong>'microfoam'</strong> – a luscious, velvety-smooth texture akin to wet paint or melted ice cream, with no visible air bubbles. This perfectly textured milk integrates beautifully with espresso and is the canvas for latte art. The process, using the espresso machine's steam wand, primarily involves two key phases.</p>
                            <img src="images/d7-latte-art-pour.jpg" alt="Barista pouring latte art with perfectly steamed milk" class="theory-image gsap-slide-in-up">

                            <div class="theory-section-break"></div>

                            <h4 class="gsap-fade-in">Phase 1: Stretching (Aerating / Incorporating Air)</h4>
                            <div class="flex flex-col md:flex-row items-center gap-6 my-6">
                                <img src="images/d7-milk-stretching.jpg" alt="Close-up of steam wand tip just below milk surface during stretching" class="theory-image md:w-2/5 gsap-slide-in-left">
                                <div class="md:w-3/5 gsap-slide-in-left" style="animation-delay: 0.2s;">
                                    <p>This is the initial phase where air is introduced into the cold milk, causing it to increase in volume. Precision here sets the stage for the final texture.</p>
                                    <ul class="text-sm space-y-1.5 list-disc list-inside mt-2">
                                        <li><strong>Wand Position:</strong> The tip of the steam wand is positioned just below the surface of the cold milk in the pitcher. You want the holes of the steam tip to be partially submerged, allowing them to draw in air.</li>
                                        <li><strong>The Sound of Success:</strong> You should hear a gentle, consistent <em>'tearing paper'</em> or <em>'psst-psst-psst'</em> sound. This indicates that air is being incorporated correctly. Avoid loud, aggressive 'screaming' (wand too shallow, too much air too quickly) or deep 'bubbling/glugging' sounds (wand too deep, only heating and potentially scalding).</li>
                                        <li><strong>Volume Increase:</strong> The milk's volume will increase. The amount of stretching (and thus volume increase) depends on the drink: typically 20-30% for a latte, and potentially more for a cappuccino which requires a thicker foam layer.</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="theory-section-break"></div>

                            <h4 class="gsap-fade-in">Phase 2: Texturing (Spinning / Emulsifying / Heating)</h4>
                            <div class="flex flex-col md:flex-row-reverse items-center gap-6 my-6">
                                <img src="images/d7-milk-texturing.jpg" alt="Steam wand submerged creating a whirlpool in the milk pitcher" class="theory-image md:w-2/5 gsap-slide-in-left">
                                <div class="md:w-3/5 gsap-slide-in-left" style="animation-delay: 0.2s;">
                                <p>Once sufficient air has been incorporated, the focus shifts to refining the texture and heating the milk to its ideal temperature.</p>
                                    <ul class="text-sm space-y-1.5 list-disc list-inside mt-2">
                                        <li><strong>Wand Position:</strong> The steam wand is submerged deeper into the milk, typically positioned slightly off-center within the pitcher. This angle helps create a swirling vortex or whirlpool effect in the milk.</li>
                                        <li><strong>The Gentle Spin:</strong> This whirlpool motion is crucial. It folds the milk over itself, breaking down any larger air bubbles incorporated during stretching into microscopic size. This process evenly distributes the air and heat throughout the milk.</li>
                                        <li><strong>Sound Check:</strong> The sound should become much quieter during this phase, often described as a gentle hiss or almost silent as the milk spins smoothly.</li>
                                        <li><strong>The Goal:</strong> To achieve a uniform, glossy, liquid texture throughout the pitcher. The milk should look shiny, like wet paint, with no discernible bubbles. This is microfoam.</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="theory-section-break"></div>

                            <div class="theory-interactive-block gsap-slide-in-up">
                                <h5>Key Conceptual Tips for Success:</h5>
                                <ul class="text-sm space-y-1.5 list-disc list-inside">
                                    <li><strong>Start Cold:</strong> Always begin with cold milk and a cold pitcher. This gives you more time to properly stretch and texture the milk before it reaches its target temperature.</li>
                                    <li><strong>Purge Power:</strong> Purge the steam wand briefly before and after each use. Before use, this clears out any condensed water; after use, it expels any milk residue from the tip.</li>
                                    <li><strong>The Right Angle:</strong> Angle the pitcher slightly relative to the steam wand to help initiate and maintain the whirlpool motion during texturing.</li>
                                    <li><strong>Temperature by Touch (with caution):</strong> Experienced baristas often gauge temperature by touch, stopping when the pitcher becomes too hot to comfortably hold for more than a second or two (this typically corresponds to the 55-65°C / 130-150°F range). However, using a thermometer is recommended for consistency, especially when learning.</li>
                                    <li><strong>Post-Steam Polish:</strong> After steaming, immediately tap the pitcher firmly on the counter a couple of times to eliminate any remaining larger surface bubbles. Then, swirl the milk gently in the pitcher to keep it smooth, homogenous, and prevent separation before pouring.</li>
                                </ul>
                            </div>
                            <p class="mt-6 gsap-fade-in">Mastering milk steaming takes practice, but understanding these phases and tips provides a solid conceptual framework for developing this essential barista skill.</p>
                        </article>`,
                        objectives: [
                            "Define 'microfoam' and describe its ideal consistency (e.g., like wet paint, glossy).",
                            "Name and describe the two main phases of milk steaming: stretching (aerating) and texturing (emulsifying).",
                            "Describe the ideal sound and steam wand position associated with the stretching phase.",
                            "Explain the purpose and desired outcome of the texturing phase (creating a whirlpool, achieving uniform texture)."
                        ],
                        resources: [ // Added for Day 7
                            { name: "Sunergos Milk Steaming Tutorial (Video)", url: "https://www.youtube.com/watch?v=6YMgB61WyvE" },
                            { name: "Professional Milk Steaming Pitcher", url: "https://amzn.to/4jeqx8l", isAffiliate: true }
                        ]
                    },


                    practical: {
                        title: "Visualizing the Milk Steaming Process",
                        content: "Let's observe how the steam wand interacts with milk to create that coveted microfoam. You'll also practice identifying well-steamed milk versus poorly steamed milk.",
                        tasks: [
                            "Watch the 'Animated Steam Wand Guide': View simplified animations illustrating the correct steam wand positioning and milk movement during the stretching and texturing phases.",
                            "In 'Microfoam Quality Sort,' categorize images of steamed milk into 'Excellent Microfoam' (smooth, no bubbles) or 'Needs Improvement' (bubbly, too thick, too thin).",
                            "Listen to 'Steaming Sounds': Identify audio clips representing 'good stretching,' 'bad screaming (too much air, large bubbles),' and 'no sound (wand too deep, only heating).'"
                        ]
                    },
                    quiz: {
                        question: "During the 'stretching' or 'aerating' phase of milk steaming, what sound indicates you are incorporating air correctly?",
                        options: ["A loud, bubbling sound", "A high-pitched whistling or screaming sound", "A gentle, consistent 'tearing paper' or 'psst-psst' sound", "Complete silence"],
                        correct: 2,
                        explanation: "A gentle 'tearing paper' sound indicates that the steam wand tip is correctly positioned just below the milk's surface, drawing in air to create foam. Loud bubbling or screaming usually means poor technique."
                    }
                },
                { // DAY 8: Building Basic Espresso Drinks
                    day: 8,
                    theory: {
                        title: "Classic Espresso-Based Beverages: Recipes & Ratios",
                        content: `
                        <article class="prose-enhanced">
                            <p class="gsap-fade-in">With a foundation of well-extracted espresso and perfectly steamed milk, a barista can craft a wide and delightful array of popular coffee drinks. Understanding the basic components, typical ratios, and key characteristics of these foundational beverages is essential for any aspiring coffee professional.</p>
                            <img src="images/d8-espresso-drinks-lineup.jpg" alt="Lineup of common espresso-based drinks like latte, cappuccino, americano" class="theory-image gsap-slide-in-up">

                            <div class="theory-section-break"></div>

                            <h4 class="gsap-fade-in">The Building Blocks: Espresso as the Base</h4>
                            <p class="gsap-fade-in">Nearly all classic café drinks start with one or more shots of espresso. Let's review some core preparations:</p>
                            <ul class="text-sm space-y-1.5 list-disc list-inside my-4">
                                <li><strong>Espresso:</strong> The concentrated heart of it all. Typically served as a single (historically ~7-10g coffee yielding ~1oz/30ml liquid) or, more commonly today, a double (14-20g coffee yielding ~2oz/60ml liquid).</li>
                                <li><strong>Espresso Macchiato (Traditional):</strong> An espresso that is 'marked' or 'stained' with a small dollop of milk foam (just a teaspoon or two). This is distinct from larger, sweeter, layered chain-cafe versions. The focus remains on the espresso, with just a hint of milk texture.</li>
                            </ul>

                            <div class="theory-section-break"></div>
                            <h4 class="gsap-fade-in">Key Espresso & Milk Beverages</h4>
                            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 my-6">
                                <div class="theory-interactive-block gsap-slide-in-up">
                                    <img src="images/d8-americano.jpg" alt="An Americano coffee in a glass mug" class="theory-image !max-w-full !my-0 !mb-4">
                                    <h5>Americano</h5>
                                    <ul class="text-sm space-y-1">
                                        <li><strong>Components:</strong> Espresso + Hot Water.</li>
                                        <li><strong>Preparation:</strong> Typically, a double espresso is diluted with hot water (e.g., 4-8 oz or 120-240 ml, adjusted to taste). Many baristas prefer adding espresso to the hot water to better preserve the crema.</li>
                                        <li><strong>Characteristics:</strong> Offers a coffee strength similar to drip/filter coffee but with the distinct, robust flavor profile of espresso. It's a way to enjoy espresso's character in a larger, less intense format.</li>
                                    </ul>
                                </div>
                                <div class="theory-interactive-block gsap-slide-in-up" style="animation-delay: 0.1s;">
                                    <img src="images/d8-latte-visual.jpg" alt="A latte with latte art in a cup" class="theory-image !max-w-full !my-0 !mb-4">
                                    <h5>Latte (Caffè Latte)</h5>
                                    <ul class="text-sm space-y-1">
                                        <li><strong>Components:</strong> Espresso + Steamed Milk + Thin Layer of Microfoam.</li>
                                        <li><strong>Ratio (Typical):</strong> 1 part espresso to 3-5 parts steamed milk (e.g., a double espresso in an 8-12 oz cup).</li>
                                        <li><strong>Characteristics:</strong> A smooth, milky coffee where the espresso flavor is softened and complemented by a larger proportion of milk. The thin layer of microfoam (about 1/4 to 1/2 inch, or 0.5-1cm) should be velvety and integrated, allowing for latte art.</li>
                                    </ul>
                                </div>
                                <div class="theory-interactive-block gsap-slide-in-up" style="animation-delay: 0.2s;">
                                    <img src="images/d8-cappuccino-visual.jpg" alt="A cappuccino with a thick foam layer in a cup" class="theory-image !max-w-full !my-0 !mb-4">
                                    <h5>Cappuccino</h5>
                                    <ul class="text-sm space-y-1">
                                        <li><strong>Components:</strong> Espresso + Steamed Milk + Thicker Layer of Microfoam.</li>
                                        <li><strong>Ratio (Traditional):</strong> Often described by thirds: 1/3 espresso, 1/3 steamed milk, and 1/3 microfoam, typically served in a smaller cup (around 5-7 oz or 150-200ml). Modern specialty cappuccinos often feature slightly less foam than the very traditional style but still noticeably more than a latte.</li>
                                        <li><strong>Characteristics:</strong> A more intense coffee flavor than a latte due to less liquid milk diluting the espresso. The foam is a key textural element, being airy yet still velvety and fine-bubbled.</li>
                                    </ul>
                                </div>
                            </div>

                            <h5 class="mt-4 gsap-fade-in">A Close Relative: The Flat White</h5>
                            <div class="theory-interactive-block gsap-slide-in-up my-6">
                                <div class="flex flex-col md:flex-row items-center gap-4">
                                     <img src="images/d8-flat-white.jpg" alt="A flat white coffee with delicate latte art" class="theory-image md:!max-w-[150px] !my-0">
                                    <div>
                                        <h5>Flat White</h5>
                                        <ul class="text-sm space-y-1">
                                            <li><strong>Components:</strong> Espresso + Steamed Milk with a very thin, velvety layer of microfoam.</li>
                                            <li><strong>Characteristics:</strong> Originating from Australia/New Zealand, the Flat White is often similar in milk-to-espresso ratio to a small latte or cappuccino but is defined by the *texture* of the milk – exceptionally silky and integrated with the espresso, featuring minimal foam depth (often just a glossy sheen). This results in a stronger coffee flavor compared to a typical latte of the same size. Often served in a slightly smaller cup than a standard latte.</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <p class="mt-6 gsap-fade-in">These are foundational recipes, and variations exist across cafes and regions. The key is to understand the fundamental differences in milk quantity, texture, and how they interact with the espresso to create distinct beverage experiences. Mastering these basics is your gateway to more complex drink creations.</p>
                        </article>`,
                        objectives: [
                            "List the core ingredients for an Americano, Latte, and Cappuccino.",
                            "Describe the typical milk-to-espresso ratio differences between a Latte and a Cappuccino.",
                            "Visually differentiate these drinks based on their layers and foam thickness/texture.",
                            "Understand how milk quantity and texture impact the final drink's flavor intensity and mouthfeel."
                               ],
                        resources: [ // Added for Day 8
                            { name: "The World Atlas of Coffee by James Hoffmann", url: "https://amzn.to/45oZ9RF", isAffiliate: true },
                            { name: "Infographic: Espresso Drink Ratios", url: "https://example.com/espresso-drink-infographic" }
                        ]
                    },
                    practical: {
                        title: "Virtual Drink Assembly & Differentiation",
                        content: "Let's put your knowledge of basic espresso drinks to the test! You'll conceptually assemble these beverages and learn to distinguish them visually.",
                        tasks: [
                            "Utilize the 'Drink Deconstructor': Click on images of an Americano, Latte, or Cappuccino to see their constituent layers (espresso, water, steamed milk, foam) highlighted and described.",
                            "Take on the 'Build-a-Drink' challenge: Drag-and-drop icons representing espresso, hot water, steamed milk, light foam, and thick foam into a virtual cup to correctly construct each of the three main drinks based on visual guides and learned ratios.",
                            "Engage in 'Spot the Difference': Compare side-by-side images of a latte and a cappuccino, identifying the key visual distinctions, primarily foam depth and texture."
                        ]
                    },
                    quiz: {
                        question: "Which of these classic espresso drinks typically features the largest proportion of steamed milk relative to espresso?",
                        options: ["Espresso Macchiato", "Cappuccino", "Americano", "Latte"],
                        correct: 3,
                        explanation: "A Latte generally has the highest milk-to-espresso ratio (e.g., 1 part espresso to 3-5 parts milk), resulting in a milder, milkier coffee flavor compared to a cappuccino or macchiato."
                    }
                },
                { // DAY 9: Keeping it Clean: Basic Machine Hygiene
                    day: 9,
                    theory: {
                        title: "Essential Hygiene: Daily Espresso Machine Cleaning",
                        content: `
                        <article class="prose-enhanced">
                            <p class="gsap-fade-in">A clean espresso machine isn't just about appearances; it's absolutely fundamental to producing great-tasting coffee, ensuring the longevity of your expensive equipment, and upholding crucial food safety standards. Coffee oils, milk residues, and mineral buildup can quickly turn rancid, clog vital components, and impart unpleasant off-flavors to your meticulously prepared drinks.</p>
                            <img src="images/d9-cleaning-espresso-machine.jpg" alt="Barista cleaning an espresso machine group head" class="theory-image gsap-slide-in-up">

                            <div class="theory-section-break"></div>

                            <h4 class="gsap-fade-in">Key Daily Cleaning Tasks & Their Importance</h4>
                            <p class="gsap-fade-in">Incorporating these cleaning tasks into your daily routine is non-negotiable for any professional barista environment.</p>
                            <div class="space-y-6 mt-6">
                                <div class="theory-interactive-block gsap-slide-in-up">
                                    <div class="flex flex-col md:flex-row items-center gap-4">
                                        <img src="images/d9-steam-wand-cleaning.jpg" alt="Cleaning a steam wand with a cloth" class="theory-image !max-w-[150px] md:!max-w-[180px] !my-0">
                                        <div>
                                            <h5>1. Purging & Wiping the Steam Wand</h5>
                                            <ul class="text-sm space-y-1">
                                                <li><strong>When:</strong> <strong>Immediately</strong> before AND after every single milk steaming cycle. No exceptions.</li>
                                                <li><strong>How:</strong>
                                                    <ol class="list-decimal list-inside ml-4">
                                                        <li>Briefly open the steam valve to purge any condensed water (before steaming) or trapped milk (after steaming).</li>
                                                        <li>Immediately and thoroughly wipe the wand with a dedicated, clean, damp cloth.</li>
                                                        <li>Purge again briefly to ensure the tip is clear.</li>
                                                    </ol>
                                                </li>
                                                <li><strong>Why Critical:</strong> Milk dries incredibly quickly on a hot steam wand, forming a hard-to-remove crust that can clog steam holes, harbor bacteria, and transfer stale, off-flavors to subsequent drinks.</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <div class="theory-interactive-block gsap-slide-in-up" style="animation-delay:0.1s;">
                                     <div class="flex flex-col md:flex-row-reverse items-center gap-4">
                                        <img src="images/d9-portafilter-cleaning-rinse.jpg" alt="Rinsing a portafilter under hot water" class="theory-image !max-w-[150px] md:!max-w-[180px] !my-0">
                                        <div>
                                            <h5>2. Cleaning the Portafilter & Basket</h5>
                                            <ul class="text-sm space-y-1">
                                                <li><strong>When:</strong> After every shot is pulled.</li>
                                                <li><strong>How:</strong> Knock out the used coffee puck firmly into a knock box. Rinse the portafilter and its basket with hot water (from the group head's flush function or a dedicated tap) to remove all residual grounds and oils. A quick wipe with a clean cloth can also be beneficial.</li>
                                                <li><strong>Why Critical:</strong> Prevents old, rancid coffee grounds from contaminating fresh shots and keeps the filter basket holes clear, ensuring even water flow for subsequent extractions.</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <div class="theory-interactive-block gsap-slide-in-up" style="animation-delay:0.2s;">
                                     <div class="flex flex-col md:flex-row items-center gap-4">
                                        <img src="images/d9-grouphead-brush.jpg" alt="Using a group head brush to clean the shower screen" class="theory-image !max-w-[150px] md:!max-w-[180px] !my-0">
                                        <div>
                                            <h5>3. Flushing & Brushing the Group Head</h5>
                                            <ul class="text-sm space-y-1">
                                                <li><strong>When:</strong> Briefly before inserting the portafilter for each new shot (a "pre-flush"), and more thoroughly at regular intervals during service and especially at the end of the day.</li>
                                                <li><strong>How:</strong> Run water through the group head for a few seconds without the portafilter inserted. Use a specialized group head brush to scrub away coffee grounds and oils from the shower screen and the rubber gasket that seals the portafilter.</li>
                                                <li><strong>Why Critical:</strong> Removes accumulated coffee particles and oils that can impart bitterness, ensures clean water for brewing, helps maintain a proper seal with the portafilter, and contributes to brew temperature stability.</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                 <div class="theory-interactive-block gsap-slide-in-up" style="animation-delay:0.3s;">
                                     <div class="flex flex-col md:flex-row-reverse items-center gap-4">
                                        <img src="images/d9-drip-tray.jpg" alt="Emptying and cleaning an espresso machine drip tray" class="theory-image !max-w-[150px] md:!max-w-[180px] !my-0">
                                        <div>
                                            <h5>4. Emptying & Cleaning the Drip Tray</h5>
                                            <ul class="text-sm space-y-1">
                                                <li><strong>When:</strong> Regularly throughout the day as it fills, and always thoroughly cleaned at the end of the day.</li>
                                                <li><strong>How:</strong> Carefully remove and empty the drip tray. Wash it with hot, soapy water, rinse, and dry.</li>
                                                <li><strong>Why Critical:</strong> Prevents overflow of wastewater and coffee residues, which can become a breeding ground for bacteria and create an unhygienic environment.</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <h5 class="mt-6 gsap-fade-in">Additional Daily Practices:</h5>
                            <ul class="text-sm space-y-1.5 list-disc list-inside my-4 gsap-fade-in">
                                <li><strong>Wiping Down Surfaces:</strong> Keep the entire exterior of the espresso machine, the counter, the grinder, and surrounding areas clean and tidy throughout the day. Use appropriate food-safe cleaners.</li>
                                <li><strong>End-of-Day Deep Clean:</strong> This often involves more intensive cleaning procedures like backflushing the group heads with a specialized espresso machine detergent (if applicable to your machine type), soaking portafilters and baskets in cleaning solution, and a thorough wipe-down of all components.</li>
                            </ul>
                            <p class="mt-6 gsap-fade-in">A commitment to cleanliness is a direct reflection of a barista's professionalism and respect for the craft of coffee. It ensures every cup served is at its best potential.</p>
                        </article>`,
                        objectives: [
                            "Explain at least three reasons why daily cleaning of an espresso machine is critical (e.g., taste, machine longevity, hygiene).",
                            "List and describe the correct procedure and timing for at least four essential daily cleaning tasks (steam wand, portafilter, group head, drip tray).",
                            "Emphasize the importance of cleaning the steam wand *immediately* after each use.",
                            "Identify tools used for basic cleaning (e.g., dedicated cloths, group head brush, knock box)."
                                             ],
                        resources: [ // Added for Day 9
                            { name: "Urnex Cafiza Espresso Machine Cleaner", url: "https://amzn.to/43eP5JN", isAffiliate: true },
                            { name: "Video: Daily Espresso Machine Cleaning Routine", url: "https://www.youtube.com/watch?v=examplecleaningvideo" }
                        ]
                    },
                    practical: {
                        title: "Simulated Daily Espresso Machine Cleaning Routine",
                        content: "Let's walk through the essential daily cleaning steps using interactive visuals and sequences to reinforce good habits.",
                        tasks: [
                            "Engage with the 'Steam Wand Clean-Up': An interactive sequence prompting you through the steps: (1) Simulate steaming, (2) Purge wand, (3) Wipe wand, (4) Purge again. Advance through each step correctly.",
                            "Observe the 'Portafilter Puck Knock & Rinse' animation, showing the removal of used grounds and subsequent rinsing of the basket.",
                            "Use the 'Group Head Flush Visual': Click a button to 'Flush Group Head,' triggering an animation of water clearing the shower screen, followed by a conceptual 'brushing' action.",
                            "Interact with the 'Cleaning Hotspots Diagram': Click on key parts of an espresso machine illustration (wand, group head, portafilter, drip tray) that require daily cleaning to receive a checkmark and confirmation."
                        ]
                    },
                    quiz: {
                        question: "What is the MOST critical reason to purge and wipe the steam wand *immediately* after steaming milk?",
                        options: ["To cool down the steam wand quickly.", "To prevent milk residue from drying and clogging the wand, which is unhygienic and affects performance.", "To make the steam wand look shiny for customers.", "To save water by not needing a longer purge later."],
                        correct: 1,
                        explanation: "Milk dries very rapidly on a hot steam wand. If not cleaned immediately, it can clog the steam holes, harbor bacteria, and be very difficult to remove, impacting future drinks and hygiene."
                    }
                },
                { // DAY 10: Introduction to Pour-Over Coffee (Conceptual)
                    day: 10,
                    theory: {
                        title: "Manual Brewing: An Introduction to Pour-Over Coffee",
                        content: `
                        <article class="prose-enhanced">
                            <p class="gsap-fade-in">Beyond the pressurized world of espresso, a vast and rewarding universe of manual coffee brewing methods awaits. <strong>Pour-over</strong> stands as one of the most popular and respected techniques, celebrated for its ability to produce an exceptionally <strong>clean, clear, and bright</strong> cup of coffee. This method grants the barista precise control over numerous brewing variables, allowing the nuanced flavors and delicate aromas of high-quality, often single-origin, beans to truly shine.</p>
                            <img src="images/d10-pour-over-setup.jpg" alt="A complete pour-over coffee brewing setup with dripper, kettle, and carafe" class="theory-image gsap-slide-in-up">

                            <div class="theory-section-break"></div>

                            <h4 class="gsap-fade-in">The Pour-Over Principle: Controlled Percolation</h4>
                            <p class="gsap-fade-in">The fundamental principle of pour-over coffee is simple yet elegant: hot water is manually poured in a slow, controlled, and even manner over a bed of coffee grounds. These grounds rest within a paper filter, which is seated inside a specialized dripper device. The brewed coffee then percolates (drips) through the filter and into a carafe, server, or directly into a mug below.</p>

                            <h4 class="mt-6 gsap-fade-in">Essential Equipment for Pour-Over Mastery</h4>
                            <p class="gsap-fade-in">While the concept is straightforward, achieving excellent pour-over requires a few key pieces of equipment:</p>
                            <div class="grid md:grid-cols-2 gap-8 mt-6">
                                <div class="theory-interactive-block gsap-slide-in-up">
                                    <img src="images/d10-drippers-variety.jpg" alt="Various types of pour-over drippers like Hario V60 and Kalita Wave" class="theory-image !max-w-full !my-0 !mb-4">
                                    <h5>1. Dripper (The Brew Chamber)</h5>
                                    <p class="text-sm text-gray-300 mb-2">This device holds the filter and coffee grounds. Common types include:</p>
                                    <ul class="text-sm space-y-1.5">
                                        <li><strong>Conical Drippers (e.g., Hario V60, Chemex):</strong> Feature a cone shape, often with internal ribs to promote airflow and a large single hole (V60) or open bottom (Chemex). These designs allow for more barista control over flow rate and extraction.</li>
                                        <li><strong>Flat-Bottom Drippers (e.g., Kalita Wave, Blue Bottle Dripper):</strong> Have a flat base with multiple small holes for drainage. This design can lead to a more even extraction and greater consistency, often being more forgiving for beginners.</li>
                                    </ul>
                                </div>
                                <div class="theory-interactive-block gsap-slide-in-up" style="animation-delay: 0.15s;">
                                    <img src="images/d10-gooseneck-kettle.jpg" alt="A gooseneck kettle pouring water precisely" class="theory-image !max-w-full !my-0 !mb-4">
                                    <h5>2. Gooseneck Kettle (The Water Wand)</h5>
                                    <p class="text-sm">Absolutely essential for pour-over. Its long, thin, curved spout (resembling a goose's neck) provides unparalleled precision and control over the water flow rate and placement. This control is crucial for evenly saturating all the coffee grounds and avoiding channeling.</p>
                                </div>
                                <div class="theory-interactive-block gsap-slide-in-up">
                                    <img src="images/d10-coffee-filter.jpg" alt="Paper filter being rinsed in a dripper" class="theory-image !max-w-full !my-0 !mb-4">
                                    <h5>3. Paper Filter (The Gatekeeper)</h5>
                                    <p class="text-sm">Specific to the dripper type (e.g., V60 filters are different from Kalita Wave filters). A critical step is to <strong>always rinse the paper filter</strong> with hot water before adding coffee grounds. This removes any residual papery taste and preheats the dripper and brewing vessel.</p>
                                </div>
                                 <div class="theory-interactive-block gsap-slide-in-up" style="animation-delay: 0.15s;">
                                    <img src="images/d10-burr-grinder.jpg" alt="A burr grinder with coffee beans" class="theory-image !max-w-full !my-0 !mb-4">
                                    <h5>4. Grinder (The Foundation)</h5>
                                    <p class="text-sm">As with all coffee brewing, a quality burr grinder is vital. Pour-over typically requires a <strong>medium to medium-fine grind</strong> – coarser than espresso but finer than French press. Grind consistency is key for even extraction.</p>
                                </div>
                            </div>
                            <p class="gsap-fade-in mt-4">Optional but highly recommended for consistency and repeatability are a <strong>digital scale</strong> (for accurately measuring coffee grounds and water, allowing for precise brew ratios like 1:15 to 1:17 coffee-to-water) and a <strong>timer</strong> (to monitor total brew time, typically 2-4 minutes depending on batch size and grind).</p>

                            <div class="theory-section-break"></div>

                            <h4 class="gsap-fade-in">The 'Bloom': A Critical First Step</h4>
                            <div class="flex flex-col md:flex-row items-center gap-6 my-6">
                                <img src="images/d10-coffee-bloom.jpg" alt="Coffee grounds blooming after initial water pour" class="theory-image md:w-2/5 gsap-slide-in-left">
                                <div class="md:w-3/5 gsap-slide-in-left" style="animation-delay: 0.2s;">
                                    <p>The very first step after adding your coffee grounds to the rinsed filter is the <strong>'bloom.'</strong> This involves pouring a small amount of hot water (typically about twice the weight of the coffee, e.g., 30g of water for 15g of coffee) to just saturate all the grounds. Freshly roasted coffee will visibly 'bloom' or puff up as carbon dioxide (CO2) gas, a byproduct of roasting, escapes.</p>
                                    <p class="mt-2">Allowing the coffee to bloom for about <strong>30-45 seconds</strong> is crucial. This de-gassing step prevents CO2 from interfering with the subsequent extraction, allowing water to more effectively interact with the coffee particles and extract flavors evenly. Skipping the bloom can lead to an uneven and less flavorful brew.</p>
                                </div>
                            </div>
                            <p class="mt-6 gsap-fade-in">Pour-over coffee brewing is a craft that invites experimentation and rewards attention to detail, offering a beautifully clean and expressive cup.</p>
                        </article>`,
                        objectives: [
                            "Define pour-over coffee and describe its typical taste profile (e.g., clean, clear, bright).",
                            "Identify and explain the function of at least four key pieces of equipment for pour-over brewing (dripper, filter, gooseneck kettle, grinder).",
                            "Explain the importance of rinsing the paper filter before brewing.",
                            "Describe the 'bloom' phase in pour-over brewing and its purpose."
                        ],
                                    resources: [ // Added for Day 10
                            { name: "Hario V60 Pour Over Guide (Video)", url: "https://www.youtube.com/watch?v=examplepourovervideo" },
                            { name: "Electric Gooseneck Kettle with Temp Control", url: "https://amzn.to/3HqqmcI", isAffiliate: true }
                        ]
                    },
                    practical: {
                        title: "Visualizing the Pour-Over Process & Equipment",
                        content: "Let's visually explore the setup, key equipment, and fundamental steps involved in brewing a pour-over coffee.",
                        tasks: [
                            "Engage with the 'Pour-Over Equipment Match': Drag-and-drop images of a dripper, paper filter, gooseneck kettle, and grinder to their corresponding names and brief functional descriptions.",
                            "Observe the 'Animated Pour-Over Brew Steps': A simplified animation sequence demonstrating: (1) Rinsing the filter, (2) Adding coffee grounds, (3) The 'bloom' phase (initial small pour causing grounds to expand), (4) The main pour, often done in slow, circular or pulse motions for even saturation.",
                            "Read 'Grind Size for Pour-Over': A short explanation with visuals comparing espresso grind (too fine), pour-over grind (medium), and French press grind (too coarse) to understand the target consistency."
                        ]
                    },
                    quiz: {
                        question: "In pour-over brewing, what is the 'bloom'?",
                        options: ["The color of the coffee grounds after roasting.", "The first few drops of coffee that emerge from the dripper.", "The rapid release of CO2 gas when hot water first hits fresh coffee grounds, causing them to swell.", "A type of coffee dripper."],
                        correct: 2,
                        explanation: "The bloom is the visible puffing up of fresh coffee grounds when initially wetted. This is CO2 escaping, and allowing this de-gassing step (typically 30-45 seconds) improves the evenness and flavor of the final extraction."
                    }
                },
                { // DAY 11: Introduction to French Press Coffee (Conceptual)
                    day: 11,
                    theory: {
                        title: "Full Immersion: Understanding French Press Coffee",
                        content: `
                        <article class="prose-enhanced">
                            <p class="gsap-fade-in">The French Press, also known by delightful names like press pot, plunger pot, or cafetière, is a classic and widely accessible manual brewing method. It's renowned for producing a coffee characterized by its <strong>full body, rich texture, and robust flavor profile</strong>. It's a simple yet effective way to achieve a deeply satisfying cup.</p>
                            <img src="images/d11-french-press-brewing.jpg" alt="French press with coffee steeping inside" class="theory-image gsap-slide-in-up">

                            <div class="theory-section-break"></div>

                            <h4 class="gsap-fade-in">The French Press Principle: Full Immersion Brewing</h4>
                            <p class="gsap-fade-in">Unlike pour-over methods where water percolates through the grounds, the French press utilizes <strong>'full immersion.'</strong> This means the coffee grounds are steeped (fully submerged) directly in hot water for the entire duration of the brew, much like brewing tea. After the designated steeping time, a plunger, fitted with a fine mesh filter, is pressed down through the liquid. This action separates the brewed coffee above from the saturated grounds below.</p>

                            <h4 class="mt-6 gsap-fade-in">Key Characteristics of French Press Coffee</h4>
                            <div class="grid md:grid-cols-2 gap-6 my-6">
                                <div class="theory-interactive-block gsap-slide-in-up">
                                    <img src="images/d11-fp-cup-texture.jpg" alt="Close-up of a cup of French press coffee showing its body" class="theory-image !max-w-full !my-0 !mb-4">
                                    <h5>Full Body & Rich Texture</h5>
                                    <p class="text-sm">The metal mesh filter of a French press allows more of the coffee's natural oils and very fine insoluble particles (often called 'fines') to pass into the final cup. This results in a coffee with a noticeably heavier mouthfeel and a richer, more viscous texture compared to paper-filtered methods which trap most of these elements.</p>
                                </div>
                                <div class="theory-interactive-block gsap-slide-in-up" style="animation-delay: 0.15s;">
                                    <img src="images/d11-fp-cup-sediment.jpg" alt="Cup of French press coffee showing some sediment at the bottom" class="theory-image !max-w-full !my-0 !mb-4">
                                    <h5>Robust Flavor & Potential for Sediment</h5>
                                    <p class="text-sm">The direct and prolonged contact between water and coffee in immersion brewing can lead to a more intense, complex, and often bolder flavor profile. However, due to the nature of the mesh filter (which is coarser than paper), a small amount of fine sediment is common and expected at the bottom of the cup. Many enthusiasts embrace this as part of the French press character.</p>
                                </div>
                            </div>

                            <div class="theory-section-break"></div>

                            <h4 class="gsap-fade-in">Essential Equipment & The Brewing Process</h4>
                            <p class="gsap-fade-in">Brewing with a French press is straightforward and requires minimal specialized equipment:</p>
                            <div class="flex flex-col md:flex-row items-center gap-6 my-6">
                                <img src="images/d11-french-press-parts.jpg" alt="Exploded view of a French press showing its components" class="theory-image md:w-2/5 gsap-slide-in-left">
                                <div class="md:w-3/5 gsap-slide-in-left" style="animation-delay: 0.2s;">
                                    <ul class="text-sm space-y-1.5 list-disc list-inside">
                                        <li><strong>French Press Brewer:</strong> Consists of a cylindrical beaker (typically made of glass, though ceramic or stainless steel versions exist), a lid, and a plunger assembly. The plunger includes a rod, a knob for pressing, and a filter screen assembly (usually multiple layers of fine metal mesh).</li>
                                        <li><strong>Grinder:</strong> A quality burr grinder is essential. For French press, a <strong>coarse and consistent grind</strong> is crucial – think breadcrumbs or coarse sea salt. If the grind is too fine, it can lead to over-extraction (bitterness), a muddy brew, and significant difficulty when pressing the plunger.</li>
                                        <li><strong>Kettle:</strong> To heat water to the optimal brewing temperature, just off the boil (around 90-96°C or 195-205°F).</li>
                                        <li><strong>Scale & Timer (Recommended):</strong> While not strictly necessary, using a scale for an accurate coffee-to-water ratio (e.g., 1:12 to 1:15) and a timer for consistent steep times (typically 3-5 minutes) will greatly improve your results.</li>
                                    </ul>
                                </div>
                            </div>

                            <h5 class="mt-4 gsap-fade-in">Basic French Press Steps:</h5>
                            <ol class="text-sm space-y-1.5 list-decimal list-inside my-4 gsap-fade-in">
                                <li><strong>Preheat:</strong> Fill the French press beaker with hot water to preheat it, then discard the water. This helps maintain brew temperature.</li>
                                <li><strong>Add Coffee:</strong> Add your coarsely ground coffee to the empty beaker.</li>
                                <li><strong>Add Water & Saturate:</strong> Pour hot water (just off the boil) over the grounds, ensuring all grounds are fully saturated. Some brewers like to give a gentle stir at this point to ensure even wetting.</li>
                                <li><strong>Steep:</strong> Place the lid on top with the plunger pulled all the way up. Let the coffee steep for your desired time (e.g., 4 minutes is a common starting point).</li>
                                <li><strong>Plunge:</strong> Once steeping is complete, slowly and steadily press the plunger all the way down. Avoid pressing too quickly, as this can agitate the grounds and create a muddier cup.</li>
                                <li><strong>Serve Immediately:</strong> Decant the brewed coffee into cups or a separate server right away. Leaving the coffee in the French press after plunging will cause it to continue extracting from the grounds at the bottom, leading to over-extraction and bitterness.</li>
                            </ol>
                            <p class="mt-6 gsap-fade-in">The French press offers a simple, tactile brewing experience that yields a uniquely textured and flavorful cup of coffee, beloved by many for its straightforwardness and rich results.</p>
                        </article>`,
                        objectives: [
                            "Define French Press coffee and explain its 'full immersion' brewing principle.",
                            "Describe the typical taste and textural profile of French Press coffee (e.g., full-bodied, rich, potential for sediment).",
                            "Identify the key components of a French Press brewer (beaker, lid, plunger with mesh filter).",
                            "Explain why a coarse grind is essential for French Press brewing and the consequences of using too fine a grind."
                        ],
                                  resources: [ // Added for Day 11
                            { name: "Bodum Chambord French Press", url: "https://amzn.to/43TaYgX", isAffiliate: true },
                            { name: "Step-by-Step French Press Guide", url: "https://www.seriouseats.com/french-press-coffee-guide" }
                        ]
                    },
                    practical: {
                        title: "Visualizing the French Press Brewing Method",
                        content: "Let's visually break down the French Press: its parts, the required grind size, and the step-by-step brewing process.",
                        tasks: [
                            "Use the 'French Press Parts Identifier': Click on an illustration of a French Press to highlight and learn about its main components: the beaker, the lid assembly, the plunger rod, and the mesh filter screen.",
                            "Examine the 'Animated French Press Brew Steps': A sequence showing: (1) Adding coarse coffee grounds to the beaker, (2) Pouring hot water and ensuring saturation, (3) The steeping phase (typically 4 minutes), (4) Slowly and steadily pressing the plunger down to separate grounds from liquid.",
                            "Study 'Why Coarse Grind for French Press?': A visual comparison and explanation showing why a coarse grind is necessary (prevents muddy brew, difficult plunging, over-extraction) versus a fine grind which is unsuitable."
                        ]
                    },
                    quiz: {
                        question: "Why is a coarse coffee grind generally recommended for brewing with a French Press?",
                        options: ["It makes the coffee taste lighter and brighter.", "It allows for faster brewing time.", "To prevent over-extraction, a muddy cup, and difficulty in pressing the plunger.", "Coarse grind has more caffeine."],
                        correct: 2,
                        explanation: "A coarse grind is crucial for French Press. It prevents over-extraction during the immersion process, avoids excessive sediment (muddy cup), and makes it easier to press the plunger through the saturated grounds."
                    }
                },
                { // DAY 12: Basic Coffee Tasting: Aroma & Flavor Words
                    day: 12,
                    theory: {
                        title: "Sip & Describe: An Introduction to Coffee Tasting Vocabulary",
                        content: `
                        <article class="prose-enhanced">
                            <p class="gsap-fade-in">Tasting coffee is far more than simply drinking it; it's an engaging sensory experience that involves your nose, tongue, and even your sense of touch (mouthfeel). Learning to identify and articulate what you smell and taste is a cornerstone of barista skill and coffee appreciation. Don't worry about becoming an expert overnight – this journey is about building awareness, a personal vocabulary, and a deeper connection to the coffee you serve.</p>
                            <img src="images/d12-coffee-tasting-setup.jpg" alt="Coffee tasting setup with various cups and aroma references" class="theory-image gsap-slide-in-up">

                            <div class="theory-section-break"></div>

                            <h4 class="gsap-fade-in">Key Sensory Aspects of Coffee Evaluation</h4>
                            <p class="gsap-fade-in">When formally tasting or 'cupping' coffee (and even when casually enjoying it), we focus on several key sensory aspects:</p>

                            <div class="grid md:grid-cols-2 gap-8 mt-6">
                                <div class="theory-interactive-block gsap-slide-in-up">
                                    <img src="images/d12-coffee-aroma.jpg" alt="Person smelling coffee grounds and brewed coffee" class="theory-image !max-w-full !my-0 !mb-4">
                                    <h5>1. Aroma (Smell)</h5>
                                    <p class="text-sm text-gray-300 mb-2">This is what you perceive through your nose, both from the dry, unbrewed grounds (often called 'fragrance') and from the brewed coffee itself ('aroma'). Aroma is a massive component of overall flavor perception, often contributing more to what we "taste" than our tongues do.</p>
                                    <p class="text-sm"><strong>Common Aroma Descriptors:</strong> Floral (like jasmine, rose), Fruity (berries, citrus, stone fruit), Nutty (almond, hazelnut, peanut), Chocolatey (dark chocolate, cocoa, milk chocolate), Caramel/Sweet (caramel, honey, molasses), Spicy (cinnamon, clove, pepper), Earthy (soil-like, woody), Smoky/Roasty (burnt notes, tobacco).</p>
                                </div>
                                <div class="theory-interactive-block gsap-slide-in-up" style="animation-delay: 0.15s;">
                                    <img src="images/d12-coffee-flavor-wheel.jpg" alt="SCA Coffee Taster's Flavor Wheel" class="theory-image !max-w-full !my-0 !mb-4">
                                    <h5>2. Flavor (Taste & Aroma Combined)</h5>
                                    <p class="text-sm text-gray-300 mb-2">Flavor is what you perceive in your mouth, a complex interplay between true taste (sweet, sour, bitter, salty, umami – detected by taste buds on the tongue) and retronasal olfaction (aromas perceived at the back of your throat as you swallow, which then travel up to your olfactory receptors).</p>
                                    <p class="text-sm"><strong>Common Flavor Descriptors:</strong> Often overlap significantly with aroma words. When starting, focus on identifying primary tastes:
                                    <ul class="text-xs space-y-0.5 list-disc list-inside mt-1">
                                        <li><strong>Sweetness:</strong> The perception of natural sugars in the coffee.</li>
                                        <li><strong>Acidity:</strong> Brightness, tartness, liveliness – can be pleasant (like citrus fruit) or unpleasant if it's sharp and sour (often a sign of under-extraction).</li>
                                        <li><strong>Bitterness:</strong> Can be a desirable characteristic of some dark roasts or a sign of over-extraction if it's harsh and dominating.</li>
                                    </ul>
                                    </p>
                                </div>
                                <div class="theory-interactive-block gsap-slide-in-up">
                                    <img src="images/d12-coffee-body-mouthfeel.jpg" alt="Visual representation of different coffee body textures" class="theory-image !max-w-full !my-0 !mb-4">
                                    <h5>3. Body (Mouthfeel)</h5>
                                    <p class="text-sm text-gray-300 mb-2">This describes the physical sensation of the coffee in your mouth – its perceived weight, texture, and richness on your palate. It's not a taste, but a tactile sensation.</p>
                                    <p class="text-sm"><strong>Common Body Descriptors:</strong> Light/Thin (like tea or skim milk), Medium (like whole milk), Heavy/Full/Rich (like cream or syrup), Watery, Syrupy, Buttery, Smooth, Lingering.</p>
                                </div>
                                 <div class="theory-interactive-block gsap-slide-in-up" style="animation-delay: 0.15s;">
                                     <img src="images/d12-coffee-aftertaste.jpg" alt="Person thoughtfully considering the aftertaste of coffee" class="theory-image !max-w-full !my-0 !mb-4">
                                    <h5>4. Aftertaste (Finish)</h5>
                                    <p class="text-sm text-gray-300 mb-2">This refers to the lingering taste and sensations that remain on your palate after you've swallowed the coffee. The aftertaste can be short or long, pleasant (e.g., sweet chocolate) or unpleasant (e.g., ashy, bitter).</p>
                                    <p class="text-sm"><strong>Common Aftertaste Descriptors:</strong> Clean, Lingering, Sweet, Dry, Bitter, Chocolatey, Spicy.</p>
                                </div>
                            </div>

                            <div class="theory-section-break"></div>

                            <h4 class="gsap-fade-in">How to Start Your Tasting Journey:</h4>
                            <div class="flex flex-col md:flex-row items-center gap-6 my-6">
                                <img src="images/d12-cupping-slurp.jpg" alt="Barista slurping coffee during a cupping session" class="theory-image md:w-2/5 gsap-slide-in-left">
                                <div class="md:w-3/5 gsap-slide-in-left" style="animation-delay: 0.2s;">
                                    <ul class="text-sm space-y-2 list-decimal list-inside">
                                        <li><strong>Engage Your Nose First:</strong> Before you even take a sip, inhale the aroma deeply. What does it remind you of? Smell the dry grounds, then the brewed coffee. Notice how the aroma changes.</li>
                                        <li><strong>The Slurp (Carefully!):</strong> When tasting, try a quick, assertive slurp (if appropriate for the setting and with hot coffee, be cautious). This action sprays the coffee across your entire palate, engaging all your taste buds, and allows volatile aromatic compounds to reach your retronasal passage more effectively.</li>
                                        <li><strong>Identify the Basics:</strong> Don't try to find obscure notes immediately. Start by trying to pinpoint overall sweetness, the level and type of acidity (is it bright like lemon, or tart like an unripe berry?), any bitterness, and the body (is it light, medium, or heavy?).</li>
                                        <li><strong>Make Associations & Trust Your Palate:</strong> Don't be afraid to use your own words and comparisons, even if they're not "official" coffee terms (e.g., "smells like my grandma's freshly baked cookies," "tastes like a grapefruit"). Personal associations are valid and help build your sensory memory. The Specialty Coffee Association (SCA) Coffee Taster's Flavor Wheel is an excellent resource for more specific terminology as you advance.</li>
                                        <li><strong>Practice & Compare:</strong> The key to developing your palate is consistent practice and exposure to a wide variety of coffees. Taste different origins, roast levels, and brew methods side-by-side if possible.</li>
                                    </ul>
                                </div>
                            </div>
                            <p class="mt-6 gsap-fade-in">Developing your coffee tasting skills is an ongoing, enjoyable process. Be patient with yourself, stay curious, and most importantly, have fun exploring the incredible world of coffee flavors!</p>
                        </article>`,
                        objectives: [
                            "Identify and define the four main sensory aspects of coffee: aroma, flavor, body, and aftertaste.",
                            "List 3-5 common aroma descriptors (e.g., fruity, nutty, chocolatey) and 2-3 common taste descriptors (e.g., sweet, acidic, bitter).",
                            "Explain 'body' as a mouthfeel characteristic and provide examples of descriptors (e.g., light, medium, heavy).",
                            "Understand that personal association and practice are fundamental to developing coffee tasting skills."
                        ],
                                      resources: [ // Added for Day 12
                            { name: "SCA Coffee Taster's Flavor Wheel (Interactive)", url: "https://notbadcoffee.com/flavor-wheel-en/" },
                            { name: "Coffee Cupping Spoon Set", url: "https://amzn.to/4mvMx1p", isAffiliate: true }
                        ]
                    },
                    practical: {
                        title: "Aroma & Flavor Association Game and Body Scale",
                        content: "Let's connect common coffee descriptions to familiar everyday smells and tastes, and visualize the concept of coffee body.",
                        tasks: [
                            "Play the 'Match the Aroma to the Object' game: Drag images of everyday items (e.g., a chocolate bar, a lemon, a rose, a walnut) to their corresponding coffee aroma descriptors ('Chocolatey,' 'Fruity/Citrus,' 'Floral,' 'Nutty').",
                            "Engage with 'Describe this Virtual Coffee': Read a short, evocative description of a fictional coffee (e.g., 'This coffee is bright and zesty, with a smell reminiscent of blueberries and a light, tea-like feel in the mouth.') and select 2-3 matching descriptor words from a provided list.",
                            "Study the 'Body Scale Visualizer': View a simple visual scale from 'Light Body' (illustrated by tea), to 'Medium Body' (milk), to 'Heavy Body' (cream), to better understand this mouthfeel concept."
                        ]
                    },
                    quiz: {
                        question: "The term 'body' when describing coffee refers to its:",
                        options: ["Temperature", "Color and clarity", "Acidity level", "Weight and texture in the mouth (mouthfeel)"],
                        correct: 3,
                        explanation: "'Body' describes the physical sensation or mouthfeel of the coffee – how heavy or light, rich or thin it feels on your palate."
                    }
                },
                { // DAY 13: Being a Great Barista: Friendliness & Order Taking
                    day: 13,
                    theory: {
                        title: "The Heart of Hospitality: Customer Service & Efficient Order Taking",
                        content: `
                        <article class="prose-enhanced">
                            <p class="gsap-fade-in">Being an outstanding barista extends far beyond technical coffee-making prowess. At its core, the role is deeply rooted in hospitality. Creating a positive, welcoming, and efficient experience for every customer is not just good business; it's the cornerstone of a thriving cafe culture and a memorable service encounter.</p>
                            <img src="images/d13-barista-customer-interaction.jpg" alt="Friendly barista interacting with a customer at the counter" class="theory-image gsap-slide-in-up">

                            <div class="theory-section-break"></div>

                            <h4 class="gsap-fade-in">Core Principles of Exceptional Barista Hospitality</h4>
                            <p class="gsap-fade-in">These principles, when consistently applied, transform a simple transaction into a genuinely pleasant interaction:</p>
                            <div class="grid md:grid-cols-2 gap-6 mt-6">
                                <div class="theory-interactive-block gsap-slide-in-up">
                                    <h5>1. Warmth & Welcome: The First Impression</h5>
                                    <p class="text-sm">A genuine smile and a friendly, audible greeting (e.g., "Good morning!", "Hello, welcome in!", "How are you today?") can make an immense difference. Make eye contact and acknowledge customers promptly, even if you're busy finishing another task. A simple nod or "I'll be right with you!" shows they've been seen.</p>
                                </div>
                                <div class="theory-interactive-block gsap-slide-in-up" style="animation-delay: 0.1s;">
                                    <h5>2. Active Listening: Hear What's Said (and Unsaid)</h5>
                                    <p class="text-sm">Pay full attention when a customer is ordering. Avoid distractions. Listen not just to the words they say but also to their tone, which might indicate preferences, uncertainties, or even a bad day. Nodding and maintaining eye contact shows you're engaged.</p>
                                </div>
                                <div class="theory-interactive-block gsap-slide-in-up">
                                    <h5>3. Order Accuracy & Confirmation: Get it Right</h5>
                                    <ul class="text-sm space-y-1.5 list-disc list-inside">
                                        <li><strong>Repeat the Order:</strong> Always repeat the complete order back to the customer for confirmation before processing it (e.g., "So that's one large oat milk latte with an extra shot, and a blueberry muffin. Is that correct?"). This simple step significantly minimizes errors and reassures the customer they've been heard correctly.</li>
                                        <li><strong>Clarity on Cost:</strong> Clearly state the total amount due.</li>
                                    </ul>
                                </div>
                                <div class="theory-interactive-block gsap-slide-in-up" style="animation-delay: 0.1s;">
                                    <h5>4. Efficiency & Professionalism: Smooth Operations</h5>
                                    <p class="text-sm">Work with a sense of urgency but without making the customer feel rushed. Maintain a clean, organized, and tidy workspace – this reflects professionalism and care. Handle payments accurately and efficiently, offering various payment options if available.</p>
                                </div>
                            </div>

                            <h4 class="mt-6 gsap-fade-in">Elevating the Experience: Beyond the Basics</h4>
                            <div class="flex flex-col md:flex-row items-center gap-6 my-6">
                                <img src="images/d13-barista-helping-customer.jpg" alt="Barista patiently helping a customer choose a drink" class="theory-image md:w-2/5 gsap-slide-in-left">
                                <div class="md:w-3/5 gsap-slide-in-left" style="animation-delay: 0.2s;">
                                    <ul class="text-sm space-y-2 list-disc list-inside">
                                        <li><strong>Product Knowledge (Foundational):</strong> Be prepared to answer common questions about the drinks you offer (e.g., "What's the difference between a latte and a flat white?", "Do you have any sugar-free syrup options?", "Is your dark roast very bitter?"). For beginners, knowing the basics of your core menu is key. Don't be afraid to say, "Let me double-check that for you!" if unsure.</li>
                                        <li><strong>Politeness & Courtesy:</strong> Simple courtesies like "please," "thank you," and "you're welcome" go a long way. Be patient, especially with customers who are indecisive, have many questions, or may be unfamiliar with coffee terminology.</li>
                                        <li><strong>Handling Issues Gracefully:</strong> Mistakes happen. If an error is made (e.g., wrong drink, incorrect change), apologize sincerely, take responsibility, and offer a swift and appropriate solution (e.g., "I'm so sorry about that, let me remake that for you right away!" or "My apologies, let me correct that for you immediately."). A positive recovery can often turn a negative experience into a memorable one.</li>
                                        <li><strong>Anticipate Needs:</strong> Small, thoughtful gestures show attentiveness. Offer a sleeve for a hot drink, point out napkins or the sugar station if a customer seems to be looking for them, or ask if they need a bag for their pastry.</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="theory-interactive-block gsap-slide-in-up">
                                <h5>The Barista's Impact</h5>
                                <p>Remember, as a barista, you're often one of the first people a customer interacts with in their day. Your attitude and service can significantly impact their mood and overall experience. A positive, friendly, and helpful demeanor is contagious and contributes immensely to a welcoming café atmosphere. Every interaction is an opportunity to make someone's day a little brighter.</p>
                            </div>
                        </article>`,
                        objectives: [
                            "Articulate the importance of a friendly, welcoming demeanor and active listening in customer interactions.",
                            "Master the technique of repeating an order back to the customer for confirmation and its benefits.",
                            "Identify key phrases for polite and professional communication (e.g., 'please,' 'thank you,' 'how can I help you?').",
                            "Understand basic strategies for handling simple customer queries or minor issues gracefully."
                        ],
                               resources: [ // Added for Day 13
                            { name: "Article: 10 Ways to Provide Excellent Customer Service", url: "https://www.helpscout.com/blog/customer-service-skills/" },
                            { name: "The Compassionate Barista ", url: "https://amzn.to/4kFscVP", isAffiliate: true }
                        ]
                    },
                    practical: {
                        title: "Virtual Customer Interaction Scenarios & Order Taking Practice",
                        content: "Let's practice common customer service scenarios, focusing on positive communication and accurate order taking in a simulated environment.",
                        tasks: [
                            "Navigate 'Choose the Best Greeting/Response': A scenario is presented (e.g., 'A customer looks confused by the menu.'). Select the most appropriate and helpful response from multiple-choice options.",
                            "Use the 'Order Taking Simulator': A customer 'verbalizes' an order via on-screen text (e.g., 'I'll have a medium cappuccino with an extra shot, and make it decaf.'). You must click the correct sequence of buttons (e.g., 'Medium,' 'Cappuccino,' 'Extra Shot,' 'Decaf') to accurately build the order. Receive feedback on precision.",
                            "Practice in 'Polite Phrases Match-Up': Match common cafe scenarios (e.g., 'Customer hands you payment,' 'You hand customer their drink') to appropriate polite phrases (e.g., 'Thank you! That will be $X.XX,' 'Here’s your latte, enjoy!').",
                            "Test your 'Active Listening Challenge': A customer gives a slightly complex order with a modification. You must select the correct summarized version of their order from three similar choices, testing attention to detail."
                        ]
                    },
                    quiz: {
                        question: "A customer seems unsure about what to order. What is a good initial approach?",
                        options: ["Ignore them until they decide, to avoid pressure.", "Tell them your personal favorite drink without asking their preferences.", "Ask open-ended questions like 'What kind of flavors do you usually enjoy?' or 'Are you looking for something hot or cold, with caffeine or without?'", "Suggest the most expensive item on the menu."],
                        correct: 2,
                        explanation: "Asking open-ended questions helps you understand the customer's preferences and guide them to a suitable choice, demonstrating helpfulness and good service."
                    }
                },
                { // DAY 14: Your Barista Journey: Review & Next Steps
                    day: 14,
                    theory: {
                        title: "Congratulations on Completing Your Foundation! What's Next?",
                        content: `
                        <article class="prose-enhanced">
                            <p class="gsap-fade-in"><strong>Huge congratulations!</strong> You've successfully navigated this 14-day introductory program, laying a solid foundation in the essential skills and knowledge of a specialty barista. Over the past two weeks, you've journeyed from understanding the coffee bean's origin to conceptually grasping espresso extraction, milk steaming, basic drink construction, and the fundamentals of excellent customer service. This is a significant achievement and a fantastic launchpad for your coffee career or dedicated hobby!</p>
                            <img src="images/d14-graduation-cap-coffee.jpg" alt="Stylized image of a graduation cap next to a cup of coffee" class="theory-image gsap-slide-in-up">

                            <div class="theory-section-break"></div>

                            <h4 class="gsap-fade-in">Key Takeaways from Your Foundational Training:</h4>
                            <p class="gsap-fade-in">Let's briefly recap some of the critical concepts you've explored:</p>
                            <div class="grid md:grid-cols-2 gap-x-8 gap-y-4 mt-6">
                                <ul class="text-sm space-y-1.5 list-disc list-inside gsap-slide-in-left">
                                    <li>The journey of coffee from <strong>seed to cup</strong> (Arabica vs. Robusta, the Coffee Belt).</li>
                                    <li>The indispensable roles of the <strong>grinder and espresso machine</strong>, and their key components.</li>
                                    <li>The 'Holy Trinity' of espresso: accurate <strong>Dose</strong>, target <strong>Yield</strong>, and optimal extraction <strong>Time</strong>.</li>
                                    <li>How to troubleshoot basic espresso issues (sourness from under-extraction, bitterness from over-extraction) primarily by adjusting <strong>grind size</strong>.</li>
                                    <li>The science and art of <strong>milk steaming</strong> to create velvety microfoam (stretching and texturing).</li>
                                </ul>
                                <ul class="text-sm space-y-1.5 list-disc list-inside gsap-slide-in-left" style="animation-delay: 0.2s;">
                                    <li>Recipes and characteristics of foundational espresso-based drinks like <strong>Americanos, Lattes, and Cappuccinos</strong>.</li>
                                    <li>The non-negotiable importance of daily <strong>cleanliness and hygiene</strong> for machine longevity and coffee quality.</li>
                                    <li>An introduction to popular manual brewing methods like <strong>pour-over and French press</strong>.</li>
                                    <li>The basics of coffee tasting vocabulary: identifying <strong>aroma, flavor, body, and aftertaste</strong>.</li>
                                    <li>The essence of excellent <strong>customer service</strong>: warmth, active listening, and efficiency.</li>
                                </ul>
                            </div>

                            <div class="theory-section-break"></div>

                            <h4 class="gsap-fade-in">Your Coffee Journey Continues: Charting Your Next Steps</h4>
                            <div class="flex flex-col md:flex-row items-center gap-6 my-6">
                                <img src="images/d14-barista-learning-more.jpg" alt="Barista intently reading a book about coffee" class="theory-image md:w-2/5 gsap-slide-in-left">
                                <div class="md:w-3/5 gsap-slide-in-left" style="animation-delay: 0.2s;">
                                    <p>This introductory course is just the beginning of what can be a lifelong passion and pursuit. The world of coffee is incredibly deep, diverse, and constantly evolving. To truly hone your skills and deepen your understanding, consider these valuable next steps:</p>
                                    <ul class="text-sm space-y-2 list-disc list-inside mt-2">
                                        <li><strong>Seek Hands-On Practice:</strong> Theory is vital, but practical, tactile application is where skills are truly forged. If possible, find opportunities to work with real espresso equipment, even if it's a quality home machine to start. There's no substitute for feeling the grind, tamping the puck, and steaming the milk.</li>
                                        <li><strong>Taste, Taste, Taste:</strong> Actively sample a wide variety of coffees – different origins, roast levels, processing methods, and brew techniques. Try to identify the aromas and flavors you've learned about. Keep a tasting journal.</li>
                                        <li><strong>Observe & Learn from Professionals:</strong> Visit local specialty cafes with skilled baristas. Watch their workflow, how they interact with customers, and the techniques they use to craft drinks. Don't be afraid to politely ask questions during quieter moments.</li>
                                        <li><strong>Read, Watch & Research:</strong> The coffee community is rich with resources. Follow reputable coffee blogs, watch videos from respected coffee professionals (e.g., James Hoffmann, Scott Rao, Wendelien van Bunnik), and read books on coffee brewing, science, and history.</li>
                                        <li><strong>Experiment & Refine:</strong> If you have access to equipment, don't be afraid to experiment. Try different brew ratios, adjust grind sizes systematically, and play with milk types and steaming techniques. Keep notes on what works and what doesn't for specific coffees.</li>
                                        <li><strong>Consider Further Training:</strong> If you're serious about a professional path, or simply want to dive deeper, look for intermediate or advanced barista courses, SCA (Specialty Coffee Association) certifications, or workshops focusing on specific skills like latte art or manual brewing.</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="theory-interactive-block gsap-slide-in-up">
                                <h5>The Most Important Ingredients: Curiosity & Passion</h5>
                                <p>The journey to becoming a skilled coffee professional or a highly knowledgeable enthusiast is fueled by curiosity and a genuine passion for coffee. Embrace the learning process, celebrate small victories, and don't be discouraged by initial challenges. The world of coffee is a wonderfully complex and rewarding one to explore.</p>
                                <p class="mt-2"><strong>Well done on completing this foundational program, and happy brewing on your continued journey!</strong></p>
                            </div>
                        </article>`,
                        objectives: [
                            "Feel a strong sense of accomplishment for completing the 14-day introductory program.",
                            "Recall key concepts learned across the major topics (beans, equipment, espresso, milk, drinks, cleaning, tasting, service).",
                            "Understand that consistent, hands-on practice with real equipment is the most critical next step for skill development.",
                            "Identify at least three potential avenues for continued learning and skill improvement in coffee (e.g., hands-on practice, tasting, observing professionals, further research)."
                        ],
                                            resources: [ // Added for Day 14
                            { name: "Specialty Coffee Association (SCA)", url: "https://sca.coffee/" },
                            { name: "Book: The Professional Barista's Handbook ", url: "https://amzn.to/3H6aGeD", isAffiliate: true }
                        ]

                    },

                    practical: {
                        title: "Comprehensive Knowledge Review & Charting Your Course",
                        content: "Let's consolidate your learning with a comprehensive review challenge covering key topics from the entire program. Then, take a moment to reflect on your personal coffee goals.",
                        tasks: [
                            "Take the 'Barista Basics Capstone Quiz': A 10-15 question multiple-choice quiz covering a wide range of topics from all 14 days (e.g., identifying parts of an espresso machine, espresso parameters, milk steaming concepts, basic drink differences, cleaning protocols, tasting terms).",
                            "Complete the 'Equipment, Terminology & Concepts Match-Up': A drag-and-drop activity where you match names (e.g., 'Portafilter,' 'Crema,' 'Microfoam,' 'Dripper,' 'Under-extraction,' 'Bloom') to their corresponding images or concise definitions.",
                            "Reflect in 'My Coffee Journey Next Steps': An optional text area where you can jot down one or two specific things you want to try, learn, or achieve next in your coffee exploration (e.g., 'Successfully steam microfoam for a latte,' 'Taste single-origin coffees from three different countries,' 'Shadow a barista at a local cafe')."
                        ]
                    },
                    quiz: {
                        question: "Which of the following is NOT a primary factor in 'dialing in' an espresso shot?",
                        options: ["Coffee bean origin", "Grind size", "Dose (amount of coffee)", "Yield (amount of espresso)"],
                        correct: 0,
                        explanation: "While bean origin significantly impacts flavor, 'dialing in' primarily refers to adjusting grind, dose, and yield to optimize extraction for that specific bean. Bean origin is a given that you work with. Secret code for certificate: INCORRECT90" // <-- Secret Code Example
                    }
                },

            ],
            translations: {
                en: {
                    welcome: "Welcome",
                    search: "Search lessons...",
                    notes: "Add your notes here for this lesson...",
                    notesPlaceholder: "Your notes for this lesson...",
                    feedback: "Rate this lesson",
                    onboarding: "Welcome to Specialty Barista Training!",
                    profile: "Edit Profile",
                    leaderboard: "Leaderboard",
                    glossary: "Glossary",
                    glossarySearch: "Search terms...",
                    theoryTabName: "Theory",
                    practicalTabName: "Practical",
                    quizTabName: "Quiz",
                    notesTabName: "Notes",
                    progress: "Progress",
                    lowTimeWarning: "Time is running low!",
                    continueLearning: "Continue Learning",
                    exploreGlossary: "Explore Glossary",
                    nextLessonInfoDefault: "Calculating next lesson...",
                    allLessonsCompleted: "All lessons completed! View Certificate or review lessons.",
                    funFactDefault: "Coffee is the second most traded commodity in the world after oil!",
                    quizForDay: "Quiz for Day",
                    submitAnswer: "Submit Answer",
                    markDayComplete: "Mark Day Complete",
                    certificateGeneration: "Generating your professional certificate...",
                    certificateSuccess: "Your professional certificate has been generated successfully!",
                    certificateErrorGeneric: "Could not generate the certificate. Please try again.",
                    certificateErrorSecurity: "Could not generate certificate due to security restrictions or missing resources. Ensure page is served via HTTP/S if using local images. Check console.",
                    certificateErrorCapture: "Could not capture certificate content. Please try again.",
                    supportUs: "Support Us", // New translation
                    donationModalTitle: "Support This Project", // New translation
                },
                ne: {
                    welcome: "स्वागत छ",
                    search: "पाठहरू खोज्नुहोस्...",
                    notes: "यस पाठको लागि तपाईंको टिप्पणीहरू यहाँ थप्नुहोस्...",
                    notesPlaceholder: "यस पाठको लागि तपाईंको टिप्पणीहरू...",
                    feedback: "यो पाठ मूल्याङ्कन गर्नुहोस्",
                    onboarding: "स्पेशालिटी बरिस्टा ट्रेनिङमा स्वागत छ!",
                    profile: "प्रोफाइल सम्पादन गर्नुहोस्",
                    leaderboard: "लिडरबोर्ड",
                    glossary: "शब्दावली",
                    glossarySearch: "शब्दहरू खोज्नुहोस्...",
                    theoryTabName: "सिद्धान्त",
                    practicalTabName: "व्यावहारिक",
                    quizTabName: "प्रश्नोत्तरी",
                    notesTabName: "टिप्पणीहरू",
                    progress: "प्रगति",
                    lowTimeWarning: "समय सकिन लाग्यो!",
                    continueLearning: "सिकाइ जारी राख्नुहोस्",
                    exploreGlossary: "शब्दावली अन्वेषण गर्नुहोस्",
                    nextLessonInfoDefault: "अर्को पाठ गणना गर्दै...",
                    allLessonsCompleted: "सबै पाठहरू पूरा भए! प्रमाणपत्र हेर्नुहोस् वा पाठहरू समीक्षा गर्नुहोस्।",
                    funFactDefault: "कफी तेल पछि विश्वमा दोस्रो सबैभन्दा बढी व्यापार हुने वस्तु हो!",
                    quizForDay: "दिनको प्रश्नोत्तरी",
                    submitAnswer: "उत्तर पेश गर्नुहोस्",
                    markDayComplete: "दिन पूरा भयो भनी चिन्ह लगाउनुहोस्",
                    certificateGeneration: "तपाईंको व्यावसायिक प्रमाणपत्र उत्पन्न हुँदैछ...",
                    certificateSuccess: "तपाईंको व्यावसायिक प्रमाणपत्र सफलतापूर्वक उत्पन्न भएको छ!",
                    certificateErrorGeneric: "प्रमाणपत्र उत्पन्न गर्न सकिएन। कृपया फेरि प्रयास गर्नुहोस्।",
                    certificateErrorSecurity: "सुरक्षा प्रतिबन्ध वा स्रोतहरूको अभावका कारण प्रमाणपत्र उत्पन्न गर्न सकिएन। यदि स्थानीय छविहरू प्रयोग गर्दै हुनुहुन्छ भने पृष्ठ HTTP/S मार्फत सेवा गरिएको सुनिश्चित गर्नुहोस्। कन्सोल जाँच गर्नुहोस्।",
                    certificateErrorCapture: "प्रमाणपत्रको सामग्री ठीकसँग खिच्न सकिएन। कृपया फेरि प्रयास गर्नुहोस्।",
                    supportUs: "हामीलाई सहयोग गर्नुहोस्", // New translation
                    donationModalTitle: "यो परियोजनालाई सहयोग गर्नुहोस्", // New translation
                }
            },
           glossary: [
                { term: "Acidity", definition: "A primary coffee flavor sensation, perceived as a pleasant tartness or brightness on the palate. Not to be confused with 'sour,' which is often a result of under-extraction." },
                { term: "Aeration", definition: "The process of incorporating air into milk during steaming, also known as 'stretching'." },
                { term: "Americano", definition: "An espresso drink made by diluting espresso with hot water." },
                { term: "Arabica", definition: "A species of coffee known for its aromatic and flavorful beans; the most popular type of coffee worldwide." },
                { term: "Backflushing", definition: "A cleaning process for espresso machines that involves sending water and detergent back through the group head to remove coffee oils and residue." },
                { term: "Bar (Pressure)", definition: "A unit of pressure. Espresso is typically extracted at 8-10 bars of pressure." },
                { term: "Blade Grinder", definition: "A type of coffee grinder that uses a spinning blade to chop beans. Generally produces inconsistent grounds and is not recommended for espresso." },
                { term: "Bloom (Pour-Over)", definition: "The initial pour of hot water on fresh coffee grounds, causing them to puff up and release CO2. Essential for even extraction." },
                { term: "Body (Coffee)", definition: "The mouthfeel or weight of coffee in the mouth, often described as light, medium, or heavy/full." },
                { term: "Brew Ratio", definition: "The ratio of dry coffee grounds (dose) to liquid espresso (yield) or water (for other brew methods)." },
                { term: "Burrs", definition: "The sharp, rotating parts (flat or conical) inside a coffee grinder that crush or cut coffee beans into grounds with consistency." },
                { term: "Cappuccino", definition: "An espresso drink traditionally made with 1/3 espresso, 1/3 steamed milk, and 1/3 thick microfoam." },
                { term: "Channeling", definition: "When water finds paths of least resistance through the coffee puck during espresso extraction, leading to unevenness and poor flavor." },
                { term: "Chemex", definition: "A brand of pour-over coffee maker known for its elegant glass design and thick paper filters that produce a very clean cup." },
                { term: "Coffee Belt", definition: "The regions of the world, mostly between the Tropics of Cancer and Capricorn, where coffee is grown." },
                { term: "Crema", definition: "The reddish-brown, foamy layer on top of a freshly brewed espresso shot, formed by CO2 and coffee oils." },
                { term: "Dialing In", definition: "The process of adjusting grind size, dose, and yield to achieve the desired taste for an espresso shot." },
                { term: "Dose (Coffee)", definition: "The amount (weight) of dry ground coffee used to make an espresso or other coffee drink." },
                { term: "Dripper", definition: "A device used in pour-over brewing that holds the paper filter and coffee grounds." },
                { term: "Emulsification (Milk)", definition: "The process during milk steaming where air bubbles are broken down and evenly dispersed, creating smooth microfoam." },
                { term: "Espresso", definition: "A concentrated coffee beverage brewed by forcing hot water under high pressure through finely-ground coffee." },
                { term: "Extraction", definition: "The process of dissolving soluble compounds from coffee grounds into water." },
                { term: "Extraction Time", definition: "The total time it takes for water to pass through the coffee grounds and brew an espresso shot." },
                { term: "Filter Basket", definition: "The metal basket within the portafilter that holds the coffee grounds." },
                { term: "Flat White", definition: "An espresso drink with steamed milk and a very thin, velvety layer of microfoam, offering a strong coffee flavor." },
                { term: "French Press", definition: "A manual coffee brewer that uses full immersion and a mesh filter to separate grounds from liquid." },
                { term: "Gooseneck Kettle", definition: "A kettle with a long, narrow spout designed for precise and controlled pouring, essential for pour-over coffee." },
                { term: "Green Coffee", definition: "Unroasted coffee beans." },
                { term: "Grind Size", definition: "The fineness or coarseness to which coffee beans are ground, a critical factor in brewing." },
                { term: "Group Head", definition: "The part of an espresso machine where the portafilter attaches and hot water is dispersed over the coffee." },
                { term: "Hario V60", definition: "A popular conical pour-over dripper known for its internal ribs and large single hole, allowing for flow rate control." },
                { term: "Hopper", definition: "The part of a coffee grinder that holds the whole coffee beans before they are fed into the burrs for grinding." },
                { term: "Immersion Brewing", definition: "A brewing method where coffee grounds are fully submerged and steeped in water (e.g., French Press, Clever Dripper)." },
                { term: "Kalita Wave", definition: "A flat-bottom pour-over dripper with three holes, known for promoting even extraction and consistency." },
                { term: "Knock Box", definition: "A container used to dispose of used coffee pucks from the portafilter." },
                { term: "Latte", definition: "An espresso drink made with steamed milk and a thin layer of microfoam, typically with more milk than a cappuccino." },
                { term: "Macchiato (Traditional)", definition: "An espresso 'marked' or 'stained' with a small dollop of milk foam." },
                { term: "Microfoam", definition: "Smooth, velvety steamed milk with no large bubbles, ideal for latte art and a pleasant mouthfeel." },
                { term: "Over-extraction", definition: "When coffee is brewed for too long, with water too hot, or with grounds that are too fine, resulting in a bitter, harsh, or burnt taste." },
                { term: "Portafilter", definition: "A handle with a filter basket that holds the ground coffee for brewing espresso." },
                { term: "Puck (Coffee)", definition: "The compressed cake of used coffee grounds left in the portafilter after brewing espresso." },
                { term: "Pull (a shot)", definition: "The act of brewing an espresso shot." },
                { term: "Purge", definition: "To release a short burst of water or steam from an espresso machine's group head or steam wand to clean it or stabilize temperature." },
                { term: "Robusta", definition: "A species of coffee that is typically stronger, has more caffeine, and a bolder, more rubbery flavor than Arabica." },
                { term: "Shower Screen", definition: "A perforated metal screen in the group head that disperses water evenly over the coffee puck." },
                { term: "Single Origin", definition: "Coffee beans sourced from a single known geographical origin, such as a specific farm, region, or country." },
                { term: "Steam Wand", definition: "A nozzle on an espresso machine that releases steam to heat and texture milk." },
                { term: "Stretching (Milk)", definition: "The first phase of steaming milk, where air is incorporated to increase volume." },
                { term: "Tamp", definition: "To press ground coffee down evenly and firmly in the portafilter basket before brewing espresso." },
                { term: "Tamper", definition: "A tool used to compress coffee grounds in the portafilter." },
                { term: "Texturing (Milk)", definition: "The second phase of steaming milk, where a whirlpool motion breaks down air bubbles and creates fine, silky microfoam." },
                { term: "Under-extraction", definition: "When coffee is brewed too quickly, with water too cool, or with grounds that are too coarse, resulting in a sour, acidic, or weak taste." },
                { term: "Yield (Espresso)", definition: "The amount (weight or volume) of liquid espresso brewed from a dose of coffee grounds." }
            ]
        };
  const BaristaApp = {
            // --- Elements Cache ---
            elements: {},

            // --- Application State ---
            state: {
                currentDay: 0,
                quizDay: 0,
                totalDays: 0, // Will be set in init after CONTENT is defined
                progress: [],
                user: { name: "Trainee", email: "", points: 0 },
                language: "en",
                theme: "dark",
                analytics: [],
                notes: {},
                feedback: {},
                isFirstVisit: true,
                quizTimerInterval: null,
                currentQuizAnswer: null,
                quizAnswered: false,
                leaderboard: [],
                activeTheorySlide: 0,
                notificationTimeout: null,
                adsInitialized: false,
                adsCurrentlyHiddenByModal: false,
            },

            // --- Utility Functions ---
            util: {
                showNotification: (message, type = "success", duration = 3500) => {
                    clearTimeout(BaristaApp.state.notificationTimeout);
                    let notificationDiv = document.getElementById('appNotification');
                    if (!notificationDiv) {
                        notificationDiv = document.createElement("div");
                        notificationDiv.id = 'appNotification';
                        notificationDiv.className = "fixed top-5 right-5 p-4 rounded-lg shadow-xl z-[2000] text-sm font-medium transition-all duration-300 ease-out-cubic max-w-sm";
                        notificationDiv.setAttribute('role', 'alert');
                        document.body.appendChild(notificationDiv);
                    }
                    notificationDiv.textContent = message;
                    notificationDiv.classList.remove('bg-green-600', 'bg-red-600', 'bg-sky-600', 'text-white');
                    if (type === "success") notificationDiv.classList.add('bg-green-600', 'text-white');
                    else if (type === "error") notificationDiv.classList.add('bg-red-600', 'text-white');
                    else notificationDiv.classList.add('bg-sky-600', 'text-white');

                    gsap.fromTo(notificationDiv, { x: "110%", opacity: 0 }, { x: "0%", opacity: 1, duration: 0.4, ease: "power2.out" });
                    BaristaApp.state.notificationTimeout = setTimeout(() => {
                        gsap.to(notificationDiv, { x: "110%", opacity: 0, duration: 0.4, ease: "power2.in", onComplete: () => {
                            if (notificationDiv.parentNode) notificationDiv.parentNode.removeChild(notificationDiv);
                        }});
                    }, duration);
                },
                showError: (m) => BaristaApp.util.showNotification(m, "error"),
                showSuccess: (m) => BaristaApp.util.showNotification(m, "success"),
                showInfo: (m) => BaristaApp.util.showNotification(m, "info", 4000),
                trackAnalytics: (event) => {
                    try {
                        BaristaApp.state.analytics.push({ event, timestamp: new Date().toISOString(), day: BaristaApp.state.currentDay || "N/A", url: window.location.pathname });
                        if (BaristaApp.state.analytics.length > 200) BaristaApp.state.analytics.shift();
                        localStorage.setItem("baristaIO_analytics", JSON.stringify(BaristaApp.state.analytics));
                    } catch (e) { console.warn("Analytics error:", e); }
                },
                createInteractiveSection: (title) => {
                    const section = document.createElement('div');
                    section.className = 'interactive-section glass p-4 rounded-lg shadow-lg my-6';
                    if (title) {
                        const titleEl = document.createElement('h4');
                        titleEl.className = "text-lg font-semibold text-amber-400 mb-3";
                        titleEl.textContent = title;
                        section.appendChild(titleEl);
                    }
                    return section;
                },
                createButton: (text, onClick, classes = '') => {
                    const button = document.createElement('button');
                    button.className = `interactive-button mt-4 ${classes}`;
                    button.textContent = text;
                    if (onClick) button.onclick = onClick;
                    return button;
                }
            },

            // --- UI Update Functions ---
            ui: {
                applyTheme: () => {
                    if (!BaristaApp.elements.appBody) return;
                    BaristaApp.elements.appBody.classList.toggle("high-contrast", BaristaApp.state.theme === "light");
                    const logo = document.getElementById('sidebar-logo');
                    // const certLogo = document.getElementById('cert-logo'); // Handled by its own CSS
                    if (BaristaApp.state.theme === "light") {
                        if (logo) logo.style.filter = 'invert(1) contrast(0.8) brightness(1.1)';
                    } else {
                        if (logo) logo.style.filter = 'none';
                    }
                },
                updateProgressDisplay: () => {
                    const completed = BaristaApp.state.progress.filter(Boolean).length;
                    const t = CONTENT.translations[BaristaApp.state.language] || CONTENT.translations.en;
                    if (BaristaApp.elements.progress) BaristaApp.elements.progress.textContent = `${t.progress}: ${completed}/${BaristaApp.state.totalDays}`;
                    if (BaristaApp.elements.progressBarFill) gsap.to(BaristaApp.elements.progressBarFill, { width: `${(BaristaApp.state.totalDays > 0 ? (completed / BaristaApp.state.totalDays) : 0) * 100}%`, duration: 0.6, ease: "power2.out" });
                    localStorage.setItem("baristaIO_progress", JSON.stringify(BaristaApp.state.progress));
                    if (completed === BaristaApp.state.totalDays && BaristaApp.elements.dashboard?.classList.contains('active') && BaristaApp.elements.certificate?.classList.contains('hidden')) {
                        BaristaApp.ui.showCertificate();
                    }
                    BaristaApp.ui.updateDashboardOverview();
                },
                updateDashboardOverview: () => {
                    if (!BaristaApp.elements.nextLessonInfo || !BaristaApp.elements.funFact) return;
                    const t = CONTENT.translations[BaristaApp.state.language] || CONTENT.translations.en;
                    const firstUncompletedDayIndex = BaristaApp.state.progress.findIndex(p => !p);
                    if (firstUncompletedDayIndex !== -1) {
                        const nextDayData = CONTENT.days[firstUncompletedDayIndex];
                        if(nextDayData && nextDayData.theory) BaristaApp.elements.nextLessonInfo.textContent = `Next: Day ${nextDayData.day} - ${nextDayData.theory.title}`;
                        else BaristaApp.elements.nextLessonInfo.textContent = t.allLessonsCompleted;
                    } else {
                        BaristaApp.elements.nextLessonInfo.textContent = t.allLessonsCompleted;
                    }
                     const funFacts = [
                        t.funFactDefault,
                        BaristaApp.state.language === 'ne' ? "कफी इथियोपियामा एक बाख्रा गोठालाले पत्ता लगाएको मानिन्छ।" : "Coffee is believed to have been discovered in Ethiopia by a goat herder.",
                        BaristaApp.state.language === 'ne' ? "ब्राजिल विश्वको सबैभन्दा ठूलो कफी उत्पादक देश हो।" : "Brazil is the world's largest coffee producer.",
                        BaristaApp.state.language === 'ne' ? "फिनल्याण्डले प्रति व्यक्ति सबैभन्दा बढी कफी खपत गर्दछ।" : "Finland consumes the most coffee per capita.",
                        BaristaApp.state.language === 'ne' ? "एक सही तरिकाले निकालिएको 'एस्प्रेसो' मा सुनौलो क्रेमाको तह हुन्छ।" : "A properly pulled espresso will have a golden layer of crema."
                    ];
                    BaristaApp.elements.funFact.textContent = funFacts[Math.floor(Math.random() * funFacts.length)];
                },
                            populateDays: (filter = "") => {
                    if (!BaristaApp.elements.dayList) return;
                    BaristaApp.elements.dayList.innerHTML = "";
                    const lowerFilter = filter.toLowerCase();
                    const filteredDays = CONTENT.days.filter(dayData =>
                        dayData.theory.title.toLowerCase().includes(lowerFilter) ||
                        `day ${dayData.day}`.toLowerCase().includes(lowerFilter) ||
                        (dayData.theory.content && typeof dayData.theory.content === 'string' && dayData.theory.content.toLowerCase().includes(lowerFilter))
                    );

                    if (filteredDays.length === 0) {
                        BaristaApp.elements.dayList.innerHTML = `<li class="text-red-400 font-semibold text-center p-3">No lessons found. Please check back soon!</li>`;
                        // Hide dashboard ad if no lessons
                        const dashboardAd = document.getElementById('dashboardAd');
                        if (dashboardAd) dashboardAd.classList.add('hidden');
                        return;
                    }

                    filteredDays.forEach(dayData => {
                        const li = document.createElement("li");
                        const isCompleted = BaristaApp.state.progress[dayData.day - 1];
                        const isActive = BaristaApp.state.currentDay === dayData.day && BaristaApp.elements.lessonPage && !BaristaApp.elements.lessonPage.classList.contains('hidden');

                        let textColorClass = BaristaApp.state.theme === 'light' ? (isActive ? 'text-white' : 'text-gray-700') : (isActive ? 'text-gray-100' : 'text-gray-300');
                        if (isCompleted) {
                            textColorClass = BaristaApp.state.theme === 'light' ? 'text-gray-900' : 'text-gray-100';
                        }

                        const iconClass = isCompleted ? 'lesson-completed-icon' : (isActive ? (BaristaApp.state.theme === 'light' ? 'text-white' : 'text-gray-100') : (BaristaApp.state.theme === 'light' ? 'text-gray-600' : 'text-gray-500'));

                        const divClasses = `flex items-center justify-between p-3 rounded-lg transition-all duration-200 ease-in-out cursor-pointer
                                        ${isActive ? 'active-lesson-link' : (isCompleted ? 'lesson-completed hover:bg-emerald-500/80' : (BaristaApp.state.theme === 'light' ? 'hover:bg-gray-200' : 'hover:bg-gray-700/70'))}`;


                        li.innerHTML = `
                            <div class="${divClasses}">
                                <span class="flex items-center space-x-3">
                                    <svg class="w-6 h-6 flex-shrink-0 ${iconClass}" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="${isCompleted ? 'M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z' : (isActive ? 'M13.803 5.339A.75.75 0 0115 5.558v8.884a.75.75 0 01-1.197.62l-5.962-4.442a.75.75 0 010-1.239l5.962-4.442a.75.75 0 01.94-.021z' : 'M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1z')}" clip-rule="evenodd"/>
                                    </svg>
                                    <span class="text-sm ${textColorClass}">${dayData.day}. ${dayData.theory.title.substring(0,30)}${dayData.theory.title.length > 30 ? '...' : ''}</span>
                                </span>
                                ${isCompleted ? `<span class="text-xs ${BaristaApp.state.theme === 'light' ? 'text-green-700' : 'text-green-300'} font-semibold">DONE</span>` : ''}
                            </div>`;
                        li.dataset.day = dayData.day;
                        li.addEventListener("click", () => {
                            BaristaApp.lessonManager.openPage(dayData.day);
                            if (BaristaApp.elements.sidebar && BaristaApp.elements.sidebar.classList.contains('sidebar-open') && window.innerWidth < 768) {
                                BaristaApp.elements.sidebar.classList.remove('sidebar-open');
                                if(BaristaApp.elements.hamburgerMenu) BaristaApp.elements.hamburgerMenu.querySelector('i').classList.replace('fa-times', 'fa-bars');
                            }
                        });
                        BaristaApp.elements.dayList.appendChild(li);
                    });
                },
                updateLeaderboardDisplay: () => { if (!BaristaApp.elements.leaderboardList) return; const e = BaristaApp.state.user.email || `anon_${Date.now()}@barista.io`; BaristaApp.elements.leaderboardList.innerHTML = BaristaApp.state.leaderboard.map((entry, i) => `<li class="py-2.5 px-4 rounded-md flex justify-between items-center text-sm ${entry.name===BaristaApp.state.user.name&&entry.email===e ? 'current-user-highlight' : (BaristaApp.state.theme==='light'?'hover:bg-gray-200':'hover:bg-gray-700/50')}"><span>${i+1}. ${entry.name}</span><span class="font-semibold">${entry.points} pts</span></li>`).join("") || "<li class='p-3 text-gray-500'>No scores yet.</li>"; },
                populateGlossary: (filter = "") => { if (!BaristaApp.elements.glossaryList || !CONTENT.glossary) return; const l = filter.toLowerCase(), f = CONTENT.glossary.filter(i=>i.term.toLowerCase().includes(l)||i.definition.toLowerCase().includes(l)); if(f.length===0){BaristaApp.elements.glossaryList.innerHTML=`<li class="p-3 text-gray-400">No terms matching "${filter}".</li>`;return;} BaristaApp.elements.glossaryList.innerHTML = f.map(i => `<li class="py-2.5 px-3 rounded-md ${BaristaApp.state.theme==='light'?'hover:bg-gray-200':'hover:bg-gray-700/50'} transition-colors"><strong class="text-amber-400">${i.term}</strong>: <span class="text-sm">${i.definition}</span></li>`).join(""); },
                showCertificate: () => {
                    if (!BaristaApp.elements.dashboard || !BaristaApp.elements.lessonPage || !BaristaApp.elements.certificate || !BaristaApp.elements.traineeName || !BaristaApp.elements.certDate || !BaristaApp.elements.certPoints) { console.error("Missing cert elements."); return; }
                    BaristaApp.elements.dashboard.classList.add("hidden"); BaristaApp.elements.dashboard.classList.remove("active");
                    BaristaApp.elements.lessonPage.classList.add("hidden"); BaristaApp.elements.lessonPage.classList.remove("active");
                    BaristaApp.elements.certificate.classList.remove("hidden"); BaristaApp.elements.certificate.classList.add("active");
                    BaristaApp.ui.ads.manageContentAdsVisibility(null); // Hide ads on certificate page
                    BaristaApp.elements.traineeName.textContent = BaristaApp.state.user.name;
                    BaristaApp.elements.certDate.textContent = new Date().toLocaleDateString(BaristaApp.state.language==='ne'?'ne-NP':'en-US',{year:'numeric',month:'long',day:'numeric'});
                    BaristaApp.elements.certPoints.textContent = `${BaristaApp.state.user.points} Points`;
                    if (BaristaApp.elements.lottieCertificate && typeof lottie !== 'undefined'){
                        if(BaristaApp.elements.lottieCertificate.animInstance){ BaristaApp.elements.lottieCertificate.animInstance.destroy(); BaristaApp.elements.lottieCertificate.innerHTML=''; }
                        try{ const p="lottie/certificate-animation.json";
                            if(window.location.protocol==="file:"){ console.warn("Lottie cert anim might not load from file://"); if(BaristaApp.elements.lottieCertificate)BaristaApp.elements.lottieCertificate.innerHTML='<p class="text-xs text-gray-500">(Anim disabled)</p>';}
                            else{ fetch(p).then(r=>{if(!r.ok)throw new Error(`Failed Lottie fetch: ${r.status} from ${p}`);return r.json();}).then(d=>{BaristaApp.elements.lottieCertificate.animInstance=lottie.loadAnimation(BaristaApp.ui.lottieOptions(BaristaApp.elements.lottieCertificate,p,false));}).catch(e=>{console.error("Lottie cert anim error:",e);if(BaristaApp.elements.lottieCertificate)BaristaApp.elements.lottieCertificate.innerHTML='<p class="text-xs text-red-500">(Anim failed)</p>';});}
                        }catch(e){console.error("Lottie cert setup error:",e);if(BaristaApp.elements.lottieCertificate)BaristaApp.elements.lottieCertificate.innerHTML='<p class="text-xs text-red-500">(Anim setup error)</p>';}
                    }
                    gsap.fromTo(BaristaApp.elements.certificate.querySelector(".glass"),{opacity:0,y:30,scale:0.95},{opacity:1,y:0,scale:1,duration:0.7,ease:"elastic.out(1,0.65)"});
                    BaristaApp.util.trackAnalytics("Viewed Certificate");
                },
                ads: {
                    _getAdConfig: (selector) => {
                        const adContainer = document.querySelector(selector);
                        if (!adContainer) return null;
                        const adIns = adContainer.querySelector('ins.adsbygoogle');
                        if (!adIns) return null;
                        return { container: adContainer, ins: adIns, slot: adIns.dataset.adSlot };
                    },
                    requestAdForSection: (selector) => {
                        if (!BaristaApp.state.adsInitialized || typeof adsbygoogle === 'undefined') {
                            console.warn("AdSense library not ready. Skipping ad:", selector);
                            const adConfig = BaristaApp.ui.ads._getAdConfig(selector);
                            if(adConfig && adConfig.container) adConfig.container.classList.add("hidden");
                            return;
                        }
                        const adConfig = BaristaApp.ui.ads._getAdConfig(selector);
                        if (!adConfig || !adConfig.container || !adConfig.ins) { console.warn("Ad config not found or incomplete for selector:", selector); return; }

                        let parentContentSectionVisible = false;
                        if (selector === '#dashboardAd' && BaristaApp.elements.dashboard?.classList.contains('active')) parentContentSectionVisible = true;
                        else if (selector === '#lessonPageAd' && BaristaApp.elements.lessonPage?.classList.contains('active')) parentContentSectionVisible = true;
                        else if (selector.includes('sidebar') && BaristaApp.elements.sidebar) {
                             parentContentSectionVisible = (BaristaApp.elements.sidebar.classList.contains('sidebar-open') || window.innerWidth >= 768) ;
                        }

                        if (!parentContentSectionVisible || adConfig.container.offsetParent === null || adConfig.container.offsetWidth === 0 || adConfig.container.offsetHeight === 0) {
                            console.warn(`AdSense: Container for ${selector} not ready/visible. Hiding.`);
                            adConfig.container.classList.add("hidden"); return;
                        }
                        if (adConfig.ins.classList.contains('adsbygoogle-filled') || adConfig.ins.dataset.adStatus === 'filled' || adConfig.ins.innerHTML.trim() !== "") {
                            adConfig.container.classList.remove("hidden"); return;
                        }
                        adConfig.container.classList.remove("hidden");
                        adConfig.ins.classList.remove("hidden");
                        console.log(`AdSense: Pushing ad for ${selector} (Slot: ${adConfig.slot}).`);
                        try { (adsbygoogle = window.adsbygoogle || []).push({}); adConfig.ins.dataset.adStatus = 'filled'; }
                        catch (e) { console.error(`AdSense error pushing ad for ${selector}:`, e); adConfig.container.classList.add("hidden"); }
                    },
                    initSidebarAd: () => {
                        // --- ADSENSE POLICY CHANGE ---
                        setTimeout(() => {
                            const sidebarAdSelector = '#sidebar .ad-placeholder';
                            const adConfig = BaristaApp.ui.ads._getAdConfig(sidebarAdSelector);
                            if (adConfig && adConfig.container) {
                                const dayListEl = BaristaApp.elements.dayList;
                                const hasSufficientContent = dayListEl && dayListEl.children.length > 0 && !(dayListEl.textContent || "").toLowerCase().includes("no lessons found");

                                if (hasSufficientContent) {
                                    BaristaApp.ui.ads.requestAdForSection(sidebarAdSelector);
                                    console.log("AdSense: Sidebar ad requested, day list has content.");
                                } else {
                                    if (adConfig.container) adConfig.container.classList.add("hidden");
                                    console.warn("AdSense: Sidebar ad NOT shown. Day list content insufficient or not ready.");
                                }
                            } else {
                                console.warn("Sidebar ad container not found for init.");
                            }
                        }, 1500);
                        // --- END ADSENSE POLICY CHANGE ---
                    },
                    manageContentAdsVisibility: (showSectionSelector) => {
                        // --- ADSENSE POLICY CHANGE ---
                        const dashboardAdConfig = BaristaApp.ui.ads._getAdConfig('#dashboardAd');
                        const lessonAdConfig = BaristaApp.ui.ads._getAdConfig('#lessonPageAd');

                        if (dashboardAdConfig && dashboardAdConfig.container) {
                            dashboardAdConfig.container.classList.add("hidden");
                        }
                        if (lessonAdConfig && lessonAdConfig.container) {
                            lessonAdConfig.container.classList.add("hidden");
                        }

                        if (BaristaApp.state.adsCurrentlyHiddenByModal) {
                            console.log("AdSense: Content ads visibility managed - globally hidden by modal.");
                            return;
                        }

                        if (showSectionSelector === '#dashboardAd' && dashboardAdConfig) {
                            if (BaristaApp.elements.userName && BaristaApp.state.user.name !== "Trainee") { // Check if onboarding done
                                BaristaApp.ui.ads.requestAdForSection('#dashboardAd');
                                console.log("AdSense: Dashboard ad requested by manageContentAdsVisibility.");
                            } else {
                                 console.warn("AdSense: Dashboard ad NOT shown by manageContentAdsVisibility, dashboard content/state not ready (e.g., onboarding pending).");
                            }
                        } else if (showSectionSelector === '#lessonPageAd' && lessonAdConfig) {
                            const activeTabEl = BaristaApp.elements.lessonPage?.querySelector('#tabs .tab.active');
                            const isTheoryOrPractical = activeTabEl && (activeTabEl.id === 'theoryTab' || activeTabEl.id === 'practicalTab');
                            const mainContentText = BaristaApp.elements.lessonContent ? (BaristaApp.elements.lessonContent.textContent || "") : "";
                            const isContentSubstantial = mainContentText.trim().length > 150;

                            if (isTheoryOrPractical && isContentSubstantial) {
                                BaristaApp.ui.ads.requestAdForSection('#lessonPageAd');
                                console.log("AdSense: Lesson page ad requested by manageContentAdsVisibility.");
                            } else {
                                console.warn(`AdSense: Lesson page ad NOT shown by manageContentAdsVisibility. Tab: ${activeTabEl?.id}, Substantial Content: ${isContentSubstantial}`);
                            }
                        } else if (showSectionSelector === null) {
                            console.log("AdSense: All content ads explicitly hidden by manageContentAdsVisibility(null).");
                        }
                        // --- END ADSENSE POLICY CHANGE ---
                    },
                    hideAdsForModal: () => { BaristaApp.state.adsCurrentlyHiddenByModal = true; BaristaApp.ui.ads.manageContentAdsVisibility(null); console.log("AdSense: Content ads hidden for modal."); },
                    restoreAdsAfterModal: () => {
                        BaristaApp.state.adsCurrentlyHiddenByModal = false;
                        if (BaristaApp.elements.dashboard?.classList.contains('active')) BaristaApp.ui.ads.manageContentAdsVisibility('#dashboardAd');
                        else if (BaristaApp.elements.lessonPage?.classList.contains('active')) BaristaApp.ui.ads.manageContentAdsVisibility('#lessonPageAd');
                        console.log("AdSense: Attempting to restore ads after modal.");
                    }
                },
                downloadCertificate: () => {
                    const t = CONTENT.translations[BaristaApp.state.language] || CONTENT.translations.en;
                    const REQUIRED_CERTIFICATE_CODE =  "INCORRECT90"; // This should match your intended code
                    const HINT_FOR_CODE = "(Hint: Check Day 14 Quiz Explanation for a clue, or contact admin if stuck!)"

                    let userEnteredCode = "";
                    if (REQUIRED_CERTIFICATE_CODE !== "") {
                        userEnteredCode = prompt(`Please enter the secret code to download the certificate. ${HINT_FOR_CODE}`, "");
                        if (userEnteredCode === null) { BaristaApp.util.showInfo("Certificate download cancelled."); return; }
                    }
                    if (REQUIRED_CERTIFICATE_CODE === "" || userEnteredCode === REQUIRED_CERTIFICATE_CODE) {
                        BaristaApp.util.showInfo(t.certificateGeneration);
                        BaristaApp.ui._generatePdfCertificateInternal();
                    } else {
                        BaristaApp.util.showError("Incorrect secret code. Certificate download denied.");
                        BaristaApp.util.trackAnalytics("Certificate Download Denied - Incorrect Code");
                    }
                },
                _generatePdfCertificateInternal: () => {
                    const t = CONTENT.translations[BaristaApp.state.language] || CONTENT.translations.en;
                    const certEl = document.querySelector('#certificate .glass');
                    const dlBtn = certEl?.querySelector('#certificateActionButtons button[onclick="BaristaApp.ui.downloadCertificate()"]');
                    const certLogo = document.getElementById('cert-logo');
                    if (!certEl) { BaristaApp.util.showError(t.certificateErrorGeneric); return; }
                    if (typeof html2canvas==='undefined'||typeof jspdf==='undefined'||typeof jspdf.jsPDF==='undefined'){BaristaApp.util.showError(t.certificateErrorSecurity+" (libs missing)");return;}
                    const {jsPDF}=window.jspdf; if(dlBtn)dlBtn.disabled=true; const origTheme=BaristaApp.state.theme, wasDark=origTheme==='dark'; if(wasDark){BaristaApp.state.theme='light';BaristaApp.ui.applyTheme();if(certLogo)certLogo.classList.add('light-mode-invert');}
                    requestAnimationFrame(()=>{html2canvas(certEl,{scale:3,useCORS:true,allowTaint:true,backgroundColor:null,logging:false,removeContainer:false,windowWidth:certEl.scrollWidth,windowHeight:certEl.scrollHeight,
                    onclone:(doc)=>{const c=doc.querySelector('#certificate .glass');if(c){c.style.width='297mm';c.style.height='210mm';c.style.padding='20mm';c.style.margin='0 auto';c.style.boxSizing='border-box';c.style.backgroundColor='var(--bg-primary-light)';c.style.border='3mm solid var(--accent-primary)';c.style.color='var(--text-primary-light)';doc.querySelectorAll('#certificate h2').forEach(h=>{h.style.color='var(--accent-primary)';h.style.fontSize='2.7rem'});doc.querySelectorAll('#trainee-name').forEach(n=>{n.style.color='var(--text-primary-light)';n.style.fontSize='2.1rem'});doc.querySelectorAll('#certificate p, #certificate div>div>p').forEach(p=>{p.style.color='var(--text-secondary-light)';if(p.classList.contains('font-semibold'))p.style.color='var(--text-primary-light)'});const l=doc.getElementById('cert-logo');if(l){if(certLogo&&certLogo.classList.contains('light-mode-invert'))l.style.filter='invert(1) contrast(0.8) brightness(1.1)';else l.style.filter='none';}const b=c.querySelector('#certificateActionButtons');if(b)b.style.display='none';}}}).then(cvs=>{try{const i=cvs.toDataURL("image/png",1.0),p=new jsPDF({orientation:"landscape",unit:"mm",format:"a4"});p.addImage(i,"PNG",0,0,297,210,void 0,'FAST');p.save(`Certificate_${BaristaApp.state.user.name.replace(/\s+/g,"_")}_${new Date().toISOString().split('T')[0]}.pdf`);BaristaApp.util.showSuccess(t.certificateSuccess);BaristaApp.util.trackAnalytics("Cert Downloaded");}catch(e){console.error("PDF gen error:",e);BaristaApp.util.showError(t.certificateErrorGeneric+" (PDF fail - "+e.message+")");}}).catch(e=>{console.error("html2canvas error:",e);BaristaApp.util.showError(t.certificateErrorCapture+" ("+e.message+")");}).finally(()=>{if(dlBtn)dlBtn.disabled=false;if(wasDark){BaristaApp.state.theme=origTheme;BaristaApp.ui.applyTheme();if(certLogo)certLogo.classList.remove('light-mode-invert');}});});
                },
                animateDashboardElements: () => {
                    if (!BaristaApp.elements.dashboard || !BaristaApp.elements.dashboard.querySelector(".glass")) return;
                    gsap.fromTo(BaristaApp.elements.dashboard.querySelector(".glass"),
                        {opacity:0, y:25, scale: 0.97},
                        {opacity:1, y:0, scale: 1, duration:0.6, delay: 0.1, ease: "power2.out",
                            onComplete: () => {
                                // --- ADSENSE POLICY CHANGE ---
                                if (!BaristaApp.state.adsCurrentlyHiddenByModal && !BaristaApp.state.isFirstVisit) {
                                    BaristaApp.ui.ads.manageContentAdsVisibility('#dashboardAd');
                                }
                                // --- END ADSENSE POLICY CHANGE ---
                            }
                        }
                    );
                    const overviewCards = BaristaApp.elements.dashboard.querySelectorAll('.grid > .glass');
                    if(overviewCards.length > 0) gsap.from(overviewCards, { opacity: 0, y: 25, stagger: 0.12, duration: 0.5, delay:0.3, ease: "power2.out" });
                },
                animateLessonContentLoaded: (container) => {
                    if (container && container.children.length > 0) {
                        const theoryElements = gsap.utils.toArray('.gsap-fade-in, .gsap-slide-in-left, .gsap-slide-in-up', container);
                        if (theoryElements.length > 0) {
                            ScrollTrigger.batch(theoryElements, {
                                onEnter: batch => gsap.to(batch, {opacity: 1, y: 0, x:0, stagger: 0.1, duration:0.5, ease:'power1.out'}),
                                start: 'top 90%',
                            });
                        }
                     // --- ADSENSE POLICY CHANGE ---
                    setTimeout(() => { // Keep delay to allow content to fully render and be measurable
                        BaristaApp.ui.ads.manageContentAdsVisibility('#lessonPageAd');
                    }, 400);
                    // --- END ADSENSE POLICY CHANGE ---
                    } else {
                         BaristaApp.ui.ads.manageContentAdsVisibility(null); // Ensure ad is hidden if no content
                    }
                     if(ScrollTrigger.getAll().length > 0) ScrollTrigger.refresh();
                },
                lottieOptions: (container, path, loop = true) => ({ container: container, path: path, renderer: "svg", loop: loop, autoplay: true, name: container.id }),
                loadLottieAnimations: () => { if (typeof lottie === 'undefined') { console.warn("Lottie lib not loaded."); return; } if (BaristaApp.elements.lottieProgress) { if (BaristaApp.elements.lottieProgress.animInstance) BaristaApp.elements.lottieProgress.animInstance.destroy(); BaristaApp.elements.lottieProgress.innerHTML = ''; try { BaristaApp.elements.lottieProgress.animInstance = lottie.loadAnimation( BaristaApp.ui.lottieOptions(BaristaApp.elements.lottieProgress, "lottie/progress-animation.json")); } catch (e) { console.error("Lottie progress error:", e); } } },
                updateTranslations: () => {
                    const t = CONTENT.translations[BaristaApp.state.language] || CONTENT.translations.en;
                    if(BaristaApp.elements.search) BaristaApp.elements.search.placeholder = t.search;
                    const welcomeEl = BaristaApp.elements.dashboard?.querySelector("h2");
                    if (welcomeEl && welcomeEl.querySelector("#userName")) { welcomeEl.innerHTML = `${t.welcome}, <span id="userName" class="text-amber-400">${BaristaApp.state.user.name}</span>!`; BaristaApp.elements.userName = document.getElementById("userName");}
                    const obTitle = BaristaApp.elements.onboardingModal?.querySelector("h3"); if(obTitle) obTitle.textContent = t.onboarding;
                    const pTitle = BaristaApp.elements.profileModal?.querySelector("h3"); if(pTitle) pTitle.textContent = t.profile;
                    const lTitle = BaristaApp.elements.leaderboardModal?.querySelector("h3"); if(lTitle) lTitle.textContent = t.leaderboard;
                    const gTitle = BaristaApp.elements.glossaryModal?.querySelector("h3"); if(gTitle) gTitle.textContent = t.glossary;
                    if(BaristaApp.elements.glossarySearch) BaristaApp.elements.glossarySearch.placeholder = t.glossarySearch;
                    if(BaristaApp.elements.glossaryButtonSidebar) {const n=Array.from(BaristaApp.elements.glossaryButtonSidebar.childNodes).find(node=>node.nodeType===Node.TEXT_NODE);if(n)n.textContent=` ${t.glossary}`; }
                    if(BaristaApp.elements.theoryTab) BaristaApp.elements.theoryTab.textContent = t.theoryTabName;
                    if(BaristaApp.elements.practicalTab) BaristaApp.elements.practicalTab.textContent = t.practicalTabName;
                    if(BaristaApp.elements.quizTab) BaristaApp.elements.quizTab.textContent = t.quizTabName;
                    if(BaristaApp.elements.notesTab) BaristaApp.elements.notesTab.textContent = t.notesTabName;
                    if(BaristaApp.elements.profileButton) BaristaApp.elements.profileButton.dataset.tooltip = t.profile;
                    if(BaristaApp.elements.certificate && !BaristaApp.elements.certificate.classList.contains('hidden') && BaristaApp.elements.certDate) BaristaApp.elements.certDate.textContent = new Date().toLocaleDateString(BaristaApp.state.language==='ne'?'ne-NP':'en-US',{year:'numeric',month:'long',day:'numeric'});
                    const clBtn = document.querySelector('button[onclick="BaristaApp.lessonManager.continueToNextLesson()"]'); if(clBtn) clBtn.textContent = t.continueLearning;
                    const egBtn = BaristaApp.elements.dashboard?.querySelector('button[onclick="BaristaApp.modalManager.showGlossary()"]'); if(egBtn){const i=egBtn.querySelector('i');egBtn.textContent=` ${t.exploreGlossary}`;if(i)egBtn.prepend(i);}
                    if(BaristaApp.elements.submitQuizButton) BaristaApp.elements.submitQuizButton.textContent = t.submitAnswer;
                    if(BaristaApp.elements.markDayCompleteButton) BaristaApp.elements.markDayCompleteButton.textContent = t.markDayComplete;
                    const donTitle = BaristaApp.elements.donationModal?.querySelector("h3"); if(donTitle) donTitle.textContent = t.donationModalTitle;
                    if(BaristaApp.elements.donationButtonSidebar) {const n=Array.from(BaristaApp.elements.donationButtonSidebar.childNodes).find(node=>node.nodeType===Node.TEXT_NODE);if(n)n.textContent=` ${t.supportUs}`; }
                    BaristaApp.ui.updateProgressDisplay(); BaristaApp.ui.populateDays(BaristaApp.elements.search?.value || "");
                    if (BaristaApp.state.currentDay > 0 && BaristaApp.elements.lessonPage && !BaristaApp.elements.lessonPage.classList.contains('hidden')) { const activeTab = BaristaApp.elements.lessonPage.querySelector('#tabs .tab.active'); if (activeTab) BaristaApp.lessonManager.setActiveTab(activeTab.id.replace('Tab','').toLowerCase()); }
                    BaristaApp.ui.applyTheme();
                }
            }, // End of ui object
            modalManager: {
                _openModal: (modalElement, focusElement = null) => {
                    if (!modalElement || !modalElement.querySelector(".modal-content-area")) return;
                    const isSignificantModal = ['onboardingModal', 'profileModal', 'quizModal', 'donationModal', 'leaderboardModal', 'glossaryModal'].includes(modalElement.id);
                    if (isSignificantModal) BaristaApp.ui.ads.hideAdsForModal();
                    modalElement.classList.remove("hidden"); modalElement.classList.add("flex");
                    gsap.to(modalElement.querySelector(".modal-content-area"), { opacity: 1, y: 0, scale: 1, duration: 0.4, ease: "back.out(1.7)" });
                    if (focusElement) setTimeout(() => focusElement.focus(), 100);
                },
                _closeModal: (modalElement) => {
                    if (!modalElement || !modalElement.querySelector(".modal-content-area")) return;
                    gsap.to(modalElement.querySelector(".modal-content-area"), {
                        opacity: 0, y: 10, scale: 0.95, duration: 0.3, ease: "back.in(1.7)",
                        onComplete: () => {
                            modalElement.classList.add("hidden"); modalElement.classList.remove("flex");
                            const isSignificantModal = ['onboardingModal', 'profileModal', 'quizModal', 'donationModal', 'leaderboardModal', 'glossaryModal'].includes(modalElement.id);
                            if (isSignificantModal) BaristaApp.ui.ads.restoreAdsAfterModal();
                        }
                    });
                },
                showOnboarding: () => BaristaApp.modalManager._openModal(BaristaApp.elements.onboardingModal, BaristaApp.elements.onboardingName),
                showProfile: () => { if (!BaristaApp.elements.profileName || !BaristaApp.elements.profileEmail) return; BaristaApp.elements.profileName.value = BaristaApp.state.user.name; BaristaApp.elements.profileEmail.value = BaristaApp.state.user.email; BaristaApp.modalManager._openModal(BaristaApp.elements.profileModal, BaristaApp.elements.profileName); },
                closeProfile: () => BaristaApp.modalManager._closeModal(BaristaApp.elements.profileModal),
                showLeaderboard: () => { BaristaApp.ui.updateLeaderboardDisplay(); BaristaApp.modalManager._openModal(BaristaApp.elements.leaderboardModal); },
                closeLeaderboard: () => BaristaApp.modalManager._closeModal(BaristaApp.elements.leaderboardModal),
                showGlossary: () => { BaristaApp.ui.populateGlossary(); BaristaApp.modalManager._openModal(BaristaApp.elements.glossaryModal, BaristaApp.elements.glossarySearch); },
                closeGlossary: () => BaristaApp.modalManager._closeModal(BaristaApp.elements.glossaryModal),
                showDonationModal: () => { BaristaApp.modalManager._openModal(BaristaApp.elements.donationModal); BaristaApp.util.trackAnalytics("Viewed Donation Modal"); },
                closeDonationModal: () => BaristaApp.modalManager._closeModal(BaristaApp.elements.donationModal)
            },
            lessonManager: {
                 openPage: (day) => {
                    BaristaApp.state.currentDay = day; const dayData = CONTENT.days[day - 1];
                    if (!dayData || !BaristaApp.elements.lessonPage || !BaristaApp.elements.dashboard || !BaristaApp.elements.certificate || !BaristaApp.elements.lessonTitle) { BaristaApp.util.showError("Core page elements missing or lesson data not found."); return; }
                    BaristaApp.elements.lessonTitle.textContent = `Day ${day}: ${dayData.theory.title}`;
                    // --- ADSENSE POLICY CHANGE ---
                    BaristaApp.ui.ads.manageContentAdsVisibility(null); // Hide any existing content ads. Decision to show lesson ad will be in setActiveTab.
                    // --- END ADSENSE POLICY CHANGE ---
                    BaristaApp.elements.dashboard.classList.add("hidden"); BaristaApp.elements.dashboard.classList.remove("active");
                    BaristaApp.elements.certificate.classList.add("hidden"); BaristaApp.elements.certificate.classList.remove("active");
                    BaristaApp.elements.lessonPage.classList.remove("hidden"); BaristaApp.elements.lessonPage.classList.add("active");
                    gsap.fromTo(BaristaApp.elements.lessonPage.querySelector(".glass"), {opacity:0, y:30, scale: 0.98}, {opacity:1, y:0, scale: 1, duration:0.5, ease: "power3.out"});
                    BaristaApp.lessonManager.setActiveTab("theory");
                    BaristaApp.util.trackAnalytics(`Opened Day ${day}: ${dayData.theory.title}`); BaristaApp.ui.populateDays(BaristaApp.elements.search?.value || ""); window.scrollTo({ top: 0, behavior: 'smooth' });
                },
                setActiveTab: (tab) => {
                    const tabs = [BaristaApp.elements.theoryTab, BaristaApp.elements.practicalTab, BaristaApp.elements.quizTab, BaristaApp.elements.notesTab];
                    tabs.forEach(el => { if (el) el.classList.remove("active"); });
                    if (!BaristaApp.elements.lessonContent) { console.error("Lesson content element not found."); return; }
                    BaristaApp.elements.lessonContent.innerHTML = ""; let contentGenerated = false; let contentHTML = "";
                    try {
                        if (tab === "theory" && BaristaApp.elements.theoryTab) { BaristaApp.elements.theoryTab.classList.add("active"); contentHTML = BaristaApp.lessonManager.generateTheoryContent(BaristaApp.state.currentDay); contentGenerated = true; }
                        else if (tab === "practical" && BaristaApp.elements.practicalTab) { BaristaApp.elements.practicalTab.classList.add("active"); contentHTML = BaristaApp.lessonManager.generatePracticalContent(BaristaApp.state.currentDay); contentGenerated = true; }
                        else if (tab === "quiz" && BaristaApp.elements.quizTab) { BaristaApp.elements.quizTab.classList.add("active"); BaristaApp.quizManager.openModal(BaristaApp.state.currentDay); contentHTML = `<p class="text-center text-gray-400 p-8">Quiz opening...</p>`; contentGenerated = true; }
                        else if (tab === "notes" && BaristaApp.elements.notesTab) { BaristaApp.elements.notesTab.classList.add("active"); contentHTML = BaristaApp.lessonManager.generateNotesContent(BaristaApp.state.currentDay); contentGenerated = true; }
                    } catch (error) { console.error(`Error for tab '${tab}', day ${BaristaApp.state.currentDay}:`, error); BaristaApp.util.showError("Could not load tab content."); contentHTML = "<p>Error loading content.</p>"; contentGenerated = true; }

                    if (contentGenerated) {
                        BaristaApp.elements.lessonContent.innerHTML = contentHTML;
                        BaristaApp.lessonManager.setupInteractiveContent(BaristaApp.state.currentDay, tab);

                        // --- ADSENSE POLICY CHANGE ---
                        if (tab === "theory" || tab === "practical") {
                            BaristaApp.ui.animateLessonContentLoaded(BaristaApp.elements.lessonContent); // This will call manageContentAdsVisibility
                        } else if (tab === "notes" || tab === "quiz") {
                            BaristaApp.ui.ads.manageContentAdsVisibility(null); // Explicitly hide ads for Notes/Quiz tabs
                            console.log(`AdSense: Lesson page ad hidden for ${tab} tab.`);
                            BaristaApp.ui.animateLessonContentLoaded(BaristaApp.elements.lessonContent); // Still animate content if any
                        }
                        // --- END ADSENSE POLICY CHANGE ---
                    }
                },
                generateTheoryContent: (day) => { const d=CONTENT.days[day-1];if(!d||!d.theory)return"<p>Theory N/A</p>";let h=d.theory.content;if(d.theory.objectives?.length)h+=`<div class="prose-enhanced mt-8 pt-6 border-t border-gray-700/70"><h4 class="!mt-0">Learning Objectives:</h4><ul>${d.theory.objectives.map(o=>`<li class="gsap-fade-in">${o}</li>`).join("")}</ul></div>`;if(d.theory.resources?.length)h+=`<div class="prose-enhanced mt-6"><h4 class="!mt-0">Additional Resources:</h4><ul>${d.theory.resources.map(r=>{let t=r.name;if(r.isAffiliate)t+=' <span class="text-xs text-gray-500">(Affiliate Link)</span>';return`<li class="gsap-fade-in"><a href="${r.url}" target="_blank" rel="noopener noreferrer">${t}</a></li>`}).join("")}</ul></div>`;h+=`<div class="mt-10 pt-6 border-t border-gray-700/70"><h4 id="feedback-heading">Lesson Feedback</h4><p class="text-sm text-gray-400 mb-3">Rate this theory lesson?</p><div class="flex space-x-2 items-center" role="radiogroup" aria-labelledby="feedback-heading">${[1,2,3,4,5].map(i=>`<button onclick="BaristaApp.dataManager.submitFeedback(${d.day},${i})" class="text-3xl ${BaristaApp.state.feedback[d.day]?.rating>=i?'text-yellow-400':'text-gray-500'} hover:text-yellow-300" aria-label="Rate ${i}/5" role="radio" aria-checked="${BaristaApp.state.feedback[d.day]?.rating===i}">${BaristaApp.state.feedback[d.day]?.rating>=i?'★':'☆'}</button>`).join("")}${BaristaApp.state.feedback[d.day]?.rating?`<span class="text-sm text-yellow-300 ml-3">${BaristaApp.state.feedback[d.day].rating} star(s).</span>`:'<span class="text-sm text-gray-400 ml-3">No rating.</span>'}</div></div>`;return h;},
                generatePracticalContent: (day) => { const d=CONTENT.days[day-1];if(!d||!d.practical)return"<p>Practical N/A</p>";const p=d.practical;return`<article class="prose-enhanced"><h3>${p.title}</h3><p class="gsap-fade-in">${p.content}</p><h4 class="mt-6 mb-2">Tasks:</h4><ol>${p.tasks.map((t,idx)=>`<li class="gsap-slide-in-left" style="animation-delay:${idx*0.1}s;">${t}</li>`).join("")}</ol></article><div id="practicalInteractiveContent" class="mt-8 space-y-8"></div>`;},
                generateNotesContent: (day) => { const t=CONTENT.translations[BaristaApp.state.language]||CONTENT.translations.en,n=BaristaApp.state.notes[day]||"";return`<div class="prose-enhanced"><h3>Notes for Day ${day}</h3><p class="text-sm text-gray-400 mb-3">${t.notes}</p><textarea id="notesInput" class="w-full h-60 p-3 bg-gray-700 text-gray-200 rounded-md focus:ring-2 focus:ring-amber-500 border border-gray-600" placeholder="${t.notesPlaceholder}">${n}</textarea><button onclick="BaristaApp.dataManager.saveNotes(${day},this)" class="interactive-button mt-4"><span class="button-text">Save Notes</span><i class="fas fa-spinner fa-spin ml-2 hidden spinner"></i></button></div>`;},
                setupInteractiveContent: (day, tab) => { const c = document.getElementById('practicalInteractiveContent'); if (tab === 'practical' && c) { c.innerHTML = ''; try { const f = `setupDay${day}`; if (BaristaApp.practicalInteractions[f] && typeof BaristaApp.practicalInteractions[f] === 'function') BaristaApp.practicalInteractions[f](); else { console.warn(`Practical func ${f} not found.`); c.innerHTML = `<p>Interactive exercises for Day ${day} unavailable.</p>`;} if (c.children.length > 0) gsap.from(Array.from(c.children), { opacity: 0, y: 20, stagger: 0.1, duration: 0.45, ease: "power2.out" }); } catch (err) { console.error(`Practical content error Day ${day}:`, err); c.innerHTML = `<p>Error loading exercises.</p>`; } } },
                continueToNextLesson: () => { const i = BaristaApp.state.progress.findIndex(p => !p); if (i !== -1) { const d = CONTENT.days[i]; if(d) BaristaApp.lessonManager.openPage(d.day); } else { if (BaristaApp.elements.dashboard?.classList.contains('hidden')) { BaristaApp.elements.lessonPage?.classList.add("hidden"); BaristaApp.elements.lessonPage?.classList.remove("active"); BaristaApp.elements.certificate?.classList.add("hidden"); BaristaApp.elements.certificate?.classList.remove("active"); BaristaApp.elements.dashboard?.classList.remove("hidden"); BaristaApp.elements.dashboard?.classList.add("active"); BaristaApp.ui.animateDashboardElements(); } BaristaApp.util.showSuccess(CONTENT.translations[BaristaApp.state.language].allLessonsCompleted); if (BaristaApp.elements.certificate?.classList.contains('hidden')) BaristaApp.ui.showCertificate(); } }
            },
           
            dataManager: {
                addPoints: (a) => { BaristaApp.state.user.points+=a; if(BaristaApp.elements.points)BaristaApp.elements.points.textContent=`Points: ${BaristaApp.state.user.points}`; localStorage.setItem("baristaIO_user",JSON.stringify(BaristaApp.state.user)); BaristaApp.dataManager.updateLeaderboardStorage(); },
                updateLeaderboardStorage: () => { const e=BaristaApp.state.user.email||`anon_${Date.now()}@barista.io`,i=BaristaApp.state.leaderboard.findIndex(entry=>entry.name===BaristaApp.state.user.name&&entry.email===e); if(i>-1)BaristaApp.state.leaderboard[i].points=BaristaApp.state.user.points; else BaristaApp.state.leaderboard.push({name:BaristaApp.state.user.name,email:e,points:BaristaApp.state.user.points}); BaristaApp.state.leaderboard.sort((a,b)=>b.points-a.points); BaristaApp.state.leaderboard=BaristaApp.state.leaderboard.slice(0,10); localStorage.setItem("baristaIO_leaderboard",JSON.stringify(BaristaApp.state.leaderboard)); if(BaristaApp.elements.leaderboardModal&&!BaristaApp.elements.leaderboardModal.classList.contains("hidden"))BaristaApp.ui.updateLeaderboardDisplay(); },
                completeOnboarding: () => {
                    if(!BaristaApp.elements.onboardingName || !BaristaApp.elements.onboardingEmail || !BaristaApp.elements.onboardingModal || !BaristaApp.elements.onboardingModal.querySelector(".modal-content-area")) {
                        BaristaApp.util.showError("Onboarding elements not found. Cannot complete onboarding.");
                        return;
                    }
                    const n=BaristaApp.elements.onboardingName.value.trim(),e=BaristaApp.elements.onboardingEmail.value.trim(); if(!n){BaristaApp.util.showError("Name empty.");BaristaApp.elements.onboardingName.focus();return;} if(!e||!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)){BaristaApp.util.showError("Valid email please.");BaristaApp.elements.onboardingEmail.focus();return;}
                    BaristaApp.state.user.name=n;BaristaApp.state.user.email=e;localStorage.setItem("baristaIO_user",JSON.stringify(BaristaApp.state.user));localStorage.setItem("baristaIO_visited","true");BaristaApp.state.isFirstVisit=false;
                    if(BaristaApp.elements.userName)BaristaApp.elements.userName.textContent=n;
                    if(BaristaApp.elements.traineeName)BaristaApp.elements.traineeName.textContent=n;
                    gsap.to(BaristaApp.elements.onboardingModal.querySelector(".modal-content-area"),{opacity:0,y:10,scale:0.95,duration:0.3,ease:"back.in(1.7)",
                        onComplete:()=>{
                            BaristaApp.elements.onboardingModal.classList.add("hidden");BaristaApp.elements.onboardingModal.classList.remove("flex");
                            BaristaApp.ui.ads.restoreAdsAfterModal(); // This will call manageContentAdsVisibility which checks content
                            BaristaApp.ui.animateDashboardElements(); // This also calls manageContentAdsVisibility on complete
                        }
                    });
                    BaristaApp.util.trackAnalytics("Completed Onboarding");BaristaApp.dataManager.updateLeaderboardStorage();
                 },
                saveProfile: () => { if(!BaristaApp.elements.profileName||!BaristaApp.elements.profileEmail)return;const oN=BaristaApp.state.user.name,oE=BaristaApp.state.user.email,n=BaristaApp.elements.profileName.value.trim(),e=BaristaApp.elements.profileEmail.value.trim();if(!n){BaristaApp.util.showError("Name empty.");return;}if(!e||!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)){BaristaApp.util.showError("Valid email.");return;}BaristaApp.state.user.name=n;BaristaApp.state.user.email=e;localStorage.setItem("baristaIO_user",JSON.stringify(BaristaApp.state.user));if(BaristaApp.elements.userName)BaristaApp.elements.userName.textContent=n;if(BaristaApp.elements.traineeName)BaristaApp.elements.traineeName.textContent=n;BaristaApp.modalManager.closeProfile();BaristaApp.util.trackAnalytics("Updated Profile");BaristaApp.util.showSuccess("Profile saved.");if(oN!==n||oE!==e)BaristaApp.state.leaderboard=BaristaApp.state.leaderboard.filter(entry=>!(entry.name===oN&&entry.email===oE));BaristaApp.dataManager.updateLeaderboardStorage(); },
                resetProgress: () => { if(confirm("Reset all progress?")){BaristaApp.state.progress=Array(BaristaApp.state.totalDays).fill(false);BaristaApp.state.user.points=0;BaristaApp.state.notes={};BaristaApp.state.feedback={};localStorage.removeItem("baristaIO_progress");localStorage.removeItem("baristaIO_notes");localStorage.removeItem("baristaIO_feedback");localStorage.setItem("baristaIO_user",JSON.stringify(BaristaApp.state.user));BaristaApp.ui.updateProgressDisplay();BaristaApp.ui.populateDays(BaristaApp.elements.search?.value||"");if(BaristaApp.elements.points)BaristaApp.elements.points.textContent=`Points: ${BaristaApp.state.user.points}`;if(BaristaApp.elements.dashboard?.classList.contains('hidden')){BaristaApp.elements.certificate?.classList.add("hidden");BaristaApp.elements.certificate?.classList.remove("active");BaristaApp.elements.lessonPage?.classList.add("hidden");BaristaApp.elements.lessonPage?.classList.remove("active");BaristaApp.elements.dashboard?.classList.remove("hidden");BaristaApp.elements.dashboard?.classList.add("active");BaristaApp.ui.animateDashboardElements();}BaristaApp.dataManager.updateLeaderboardStorage();BaristaApp.util.showSuccess("Progress reset.");BaristaApp.util.trackAnalytics("Reset Progress");} },
                exportProgress: () => { const d={user:BaristaApp.state.user,progress:BaristaApp.state.progress,notes:BaristaApp.state.notes,feedback:BaristaApp.state.feedback,timestamp:new Date().toISOString()},s=JSON.stringify(d,null,2),b=new Blob([s],{type:"application/json"}),u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download=`BaristaIO_Progress_${BaristaApp.state.user.name.replace(/\s/g,'_')||'Trainee'}.json`;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);BaristaApp.util.showSuccess("Progress exported!");BaristaApp.util.trackAnalytics("Exported Progress"); },
                saveNotes: (day, btn) => { if(btn){btn.disabled=true;const t=btn.querySelector('.button-text'),s=btn.querySelector('.spinner');if(t)t.textContent='Saving...';if(s)s.classList.remove('hidden');} setTimeout(()=>{const i=document.getElementById("notesInput");if(i){BaristaApp.state.notes[day]=i.value;localStorage.setItem("baristaIO_notes",JSON.stringify(BaristaApp.state.notes));BaristaApp.util.showSuccess("Notes saved!");BaristaApp.util.trackAnalytics(`Saved Notes Day ${day}`);}else BaristaApp.util.showError("Notes field not found.");if(btn){btn.disabled=false;const t=btn.querySelector('.button-text'),s=btn.querySelector('.spinner');if(t)t.textContent='Save Notes';if(s)s.classList.add('hidden');}},500); },
                submitFeedback: (day, rating) => { BaristaApp.state.feedback[day]={rating,timestamp:new Date().toISOString()};localStorage.setItem("baristaIO_feedback",JSON.stringify(BaristaApp.state.feedback));if(BaristaApp.elements.lessonPage&&!BaristaApp.elements.lessonPage.classList.contains('hidden')&&BaristaApp.elements.theoryTab?.classList.contains('active')&&BaristaApp.state.currentDay===day){BaristaApp.elements.lessonContent.innerHTML=BaristaApp.lessonManager.generateTheoryContent(BaristaApp.state.currentDay);BaristaApp.ui.animateLessonContentLoaded(BaristaApp.elements.lessonContent);}BaristaApp.dataManager.addPoints(5);BaristaApp.util.trackAnalytics(`Feedback Day ${day}: ${rating} stars`);BaristaApp.util.showSuccess("Feedback saved! +5 points."); }
            },
            quizManager: {
                quizTimerValue: 30,
                startTimer: (day) => {
                    clearInterval(BaristaApp.state.quizTimerInterval);
                    BaristaApp.quizManager.quizTimerValue = 30;
                    const timerBar = document.getElementById('quizTimerBar');

                    if(BaristaApp.elements.quizTimer) {
                        BaristaApp.elements.quizTimer.textContent = BaristaApp.quizManager.quizTimerValue;
                        BaristaApp.elements.quizTimer.classList.remove("low-time");
                    }
                    if (timerBar) {
                        timerBar.style.width = "100%";
                        timerBar.style.transition = `width ${BaristaApp.quizManager.quizTimerValue}s linear`;
                        requestAnimationFrame(() => {
                            timerBar.style.width = "0%";
                        });
                    }
                    const t = CONTENT.translations[BaristaApp.state.language] || CONTENT.translations.en;

                    BaristaApp.state.quizTimerInterval = setInterval(() => {
                        BaristaApp.quizManager.quizTimerValue--;
                        if(BaristaApp.elements.quizTimer) BaristaApp.elements.quizTimer.textContent = BaristaApp.quizManager.quizTimerValue;

                        if (BaristaApp.quizManager.quizTimerValue <= 10 && BaristaApp.elements.quizTimer) {
                            BaristaApp.elements.quizTimer.classList.add("low-time");
                            if(BaristaApp.quizManager.quizTimerValue <=5 && BaristaApp.elements.quizModalFeedback) BaristaApp.elements.quizModalFeedback.textContent = t.lowTimeWarning;
                        }
                        if (BaristaApp.quizManager.quizTimerValue <= 0) {
                            clearInterval(BaristaApp.state.quizTimerInterval);
                            if(BaristaApp.elements.quizModalFeedback) BaristaApp.elements.quizModalFeedback.innerHTML = `<strong class="text-red-400">Time's up!</strong> Marking as incorrect.`;
                            BaristaApp.quizManager.submit(true);                   
                             }
                    }, 1000);
                },
                openModal: (day) => {
                    if (!BaristaApp.elements.quizModal || !BaristaApp.elements.quizModalContent || !BaristaApp.elements.quizModalTitle || !BaristaApp.elements.quizModalFeedback || !BaristaApp.elements.quizTimer || !BaristaApp.elements.quizDayIndicator || !BaristaApp.elements.submitQuizButton || !BaristaApp.elements.markDayCompleteButton) {
                        BaristaApp.util.showError("Quiz modal elements are missing. Cannot open quiz.");
                        return;
                    }
                    BaristaApp.state.quizDay = day;
                    const dayData = CONTENT.days[day - 1];
                    if (!dayData || !dayData.quiz) {
                        BaristaApp.util.showError("Quiz data not found for Day " + day + ".");
                        if (BaristaApp.elements.quizModalContent) BaristaApp.elements.quizModalContent.innerHTML = "<p>Quiz not available for this day.</p>";
                        return;
                    }
                    const t = CONTENT.translations[BaristaApp.state.language] || CONTENT.translations.en;

                    BaristaApp.elements.quizModalTitle.textContent = `${t.quizForDay} ${day}: ${dayData.theory.title.substring(0,35)}...`;
                    BaristaApp.elements.quizDayIndicator.textContent = `Day ${day}`;
                    BaristaApp.elements.quizModalContent.innerHTML = `
                        <p class="mb-3 text-lg">${dayData.quiz.question}</p>
                        <div class="space-y-2">
                            ${dayData.quiz.options.map((opt, index) => `
                                <div class="interactive-choice quiz-option p-3" data-index="${index}" role="radio" aria-checked="false" tabindex="0">
                                    ${String.fromCharCode(65 + index)}. ${opt}
                                </div>
                            `).join("")}
                        </div>`;
                    BaristaApp.elements.quizModalFeedback.innerHTML = "";
                    BaristaApp.elements.quizModalFeedback.className = 'mt-6 text-amber-400 font-medium';
                    BaristaApp.state.currentQuizAnswer = null;
                    BaristaApp.state.quizAnswered = false;

                    BaristaApp.elements.submitQuizButton.classList.remove('hidden');
                    BaristaApp.elements.submitQuizButton.disabled = false;
                    BaristaApp.elements.markDayCompleteButton.classList.add('hidden');

                    BaristaApp.elements.quizModalContent.querySelectorAll('.quiz-option').forEach(opt => {
                        opt.classList.remove('selected', 'correct', 'incorrect', 'disabled');
                        opt.setAttribute('aria-checked', 'false');
                        opt.onclick = function() {
                            if (BaristaApp.state.quizAnswered) return;
                            BaristaApp.elements.quizModalContent.querySelectorAll('.quiz-option').forEach(o => o.classList.remove('selected'));
                            this.classList.add('selected');
                            BaristaApp.state.currentQuizAnswer = parseInt(this.dataset.index);
                        };
                        opt.onkeydown = function(e) { // Added keydown for accessibility
                             if (e.key === 'Enter' || e.key === ' ') {
                                 e.preventDefault();
                                 this.click();
                             }
                        };
                    });

                    BaristaApp.modalManager._openModal(BaristaApp.elements.quizModal);
                    BaristaApp.quizManager.startTimer(day);
                    BaristaApp.util.trackAnalytics(`Opened Quiz for Day ${day}`);
                },
                closeModal: () => {
                    clearInterval(BaristaApp.state.quizTimerInterval);
                     const timerBar = document.getElementById('quizTimerBar');
                    if (timerBar) timerBar.style.transition = 'none';
                    BaristaApp.modalManager._closeModal(BaristaApp.elements.quizModal);
                    if(BaristaApp.elements.lessonPage && !BaristaApp.elements.lessonPage.classList.contains('hidden') && BaristaApp.elements.quizTab && BaristaApp.elements.quizTab.classList.contains('active')){
                        BaristaApp.lessonManager.setActiveTab('theory');
                    }
                },
                submit: (timeUp = false) => {
                    if (BaristaApp.state.quizAnswered && !timeUp) return;
                    BaristaApp.state.quizAnswered = true;
                    clearInterval(BaristaApp.state.quizTimerInterval);
                    const timerBar = document.getElementById('quizTimerBar');
                    if (timerBar) timerBar.style.transition = 'none';

                    if (!BaristaApp.elements.quizModalContent || !BaristaApp.elements.quizModalFeedback || !BaristaApp.elements.submitQuizButton || !BaristaApp.elements.markDayCompleteButton) {
                        BaristaApp.util.showError("Quiz submission elements missing.");
                        return;
                    }

                    const dayData = CONTENT.days[BaristaApp.state.quizDay - 1];
                    if (!dayData || !dayData.quiz) {
                        BaristaApp.util.showError("Quiz data missing for submission.");
                        return;
                    }

                    const optionsElements = BaristaApp.elements.quizModalContent.querySelectorAll('.quiz-option');
                    optionsElements.forEach(opt => opt.classList.add('disabled'));

                    let isCorrect = false;
                    if (timeUp) {
                        BaristaApp.elements.quizModalFeedback.innerHTML = `<strong class="text-red-400">Time's up!</strong> The correct answer was: ${String.fromCharCode(65 + dayData.quiz.correct)}. ${dayData.quiz.explanation}`;
                        BaristaApp.elements.quizModalFeedback.className = 'result-box incorrect-result mt-4';
                    } else if (BaristaApp.state.currentQuizAnswer === null) {
                        BaristaApp.elements.quizModalFeedback.textContent = "Please select an answer.";
                         BaristaApp.elements.quizModalFeedback.className = 'result-box incorrect-result mt-4';
                        BaristaApp.state.quizAnswered = false;
                        optionsElements.forEach(opt => opt.classList.remove('disabled'));
                        return;
                    } else {
                        isCorrect = BaristaApp.state.currentQuizAnswer === dayData.quiz.correct;
                        if (isCorrect) {
                            BaristaApp.elements.quizModalFeedback.innerHTML = `<strong class="text-green-300">Correct!</strong> ${dayData.quiz.explanation} (+15 points)`;
                            BaristaApp.elements.quizModalFeedback.className = 'result-box correct-result mt-4';
                            BaristaApp.dataManager.addPoints(15);
                        } else {
                            BaristaApp.elements.quizModalFeedback.innerHTML = `<strong class="text-red-400">Incorrect.</strong> The correct answer was: ${String.fromCharCode(65 + dayData.quiz.correct)}. ${dayData.quiz.explanation}`;
                            BaristaApp.elements.quizModalFeedback.className = 'result-box incorrect-result mt-4';
                        }
                    }

                    optionsElements.forEach((opt, idx) => {
                        if (idx === dayData.quiz.correct) {
                            opt.classList.add('correct');
                        } else if (idx === BaristaApp.state.currentQuizAnswer && !isCorrect) {
                            opt.classList.add('incorrect');
                        }
                    });

                    BaristaApp.elements.submitQuizButton.classList.add('hidden');
                    BaristaApp.elements.markDayCompleteButton.classList.remove('hidden');
                    BaristaApp.elements.markDayCompleteButton.disabled = false;

                    BaristaApp.util.trackAnalytics(`Quiz Day ${BaristaApp.state.quizDay} Submitted: ${isCorrect ? 'Correct' : 'Incorrect'}${timeUp ? ' (Time Up)' : ''}`);
                },
                markDayComplete: () => {
                    if (BaristaApp.state.quizDay > 0 && BaristaApp.state.quizDay <= BaristaApp.state.totalDays) {
                        if (!BaristaApp.state.progress[BaristaApp.state.quizDay - 1]) {
                            BaristaApp.state.progress[BaristaApp.state.quizDay - 1] = true;
                            BaristaApp.dataManager.addPoints(10);
                            BaristaApp.util.showSuccess(`Day ${BaristaApp.state.quizDay} marked as complete! +10 points.`);
                            BaristaApp.ui.updateProgressDisplay();
                            BaristaApp.ui.populateDays(BaristaApp.elements.search ? BaristaApp.elements.search.value : "");
                            BaristaApp.util.trackAnalytics(`Marked Day ${BaristaApp.state.quizDay} Complete`);
                        } else {
                            BaristaApp.util.showSuccess(`Day ${BaristaApp.state.quizDay} was already complete.`);
                        }
                    }
                    BaristaApp.quizManager.closeModal();
                }
            },

            practicalInteractions: {
                setupDay1: function() {
    const container = document.getElementById('practicalInteractiveContent');
    if (!container) {
        console.error("Day 1: Container #practicalInteractiveContent not found.");
        return;
    }


    const DAY1_CONFIG = {
        POINTS_AROMA_EXPLORE: 2,
        MAP_REGIONS: [
            {
                name: "South America",
                id: "sa",
                info: "South America (e.g., Brazil, Colombia) - Often nutty, chocolatey, with caramel notes and a full body. Colombian coffees can be very balanced with citrusy brightness.",
                position: "top-[55%] left-[20%] w-[20%] h-[30%]"
            },
            {
                name: "Africa",
                id: "af",
                info: "Africa (e.g., Ethiopia, Kenya) - Frequently bright, acidic, with floral, fruity (citrus, berry), or wine-like notes. Ethiopian Yirgacheffe is famously floral and tea-like.",
                position: "top-[35%] left-[45%] w-[20%] h-[35%]"
            },
            {
                name: "Asia/Pacific",
                id: "ap",
                info: "Asia/Pacific (e.g., Indonesia, Vietnam) - Can be earthy, spicy, woody, with a heavy body. Sumatran coffees often have a distinctive earthy, sometimes tobacco-like character.",
                position: "top-[30%] left-[68%] w-[25%] h-[40%]"
            }
        ],
        BEAN_STAGES: [
            {
                id: "cherry",
                alt: "Coffee Cherries",
                src: "images/coffee-cherry.jpg",
                info: "Coffee Cherry: The fruit of the coffee plant. Inside are typically two seeds (beans). Ripe cherries are vibrant red or yellow, indicating peak sweetness."
            },
            {
                id: "green-beans",
                alt: "Green Coffee Beans",
                src: "images/green-coffee-beans.jpg",
                info: "Green Coffee Beans: After cherries are processed (washed, natural, or honey methods) and dried, the seeds are hulled. These unroasted beans are hard, dense, and smell grassy."
            },
            {
                id: "roasted-beans",
                alt: "Roasted Coffee Beans",
                src: "images/roasted-coffee-beans.jpg",
                info: "Roasted Coffee Beans: Roasting transforms green beans through heat, causing Maillard reactions and caramelization. This develops the complex aromas, flavors, and rich brown color we love."
            }
        ],
        AROMAS: [
            { name: "Chocolatey", example: "dark cocoa powder", icon: "🍫", color: "bg-yellow-700", detail: "Rich, like dark chocolate, cocoa nibs, or even milk chocolate. Common in Central/South American coffees." },
            { name: "Fruity", example: "fresh berries", icon: "🍓", color: "bg-red-500", detail: "Can range from bright citrus (lemon, orange) to sweet berries (blueberry, strawberry) or stone fruit (peach, plum). Often found in African coffees." },
            { name: "Nutty", example: "toasted almonds", icon: "🥜", color: "bg-orange-500", detail: "Reminiscent of almonds, hazelnuts, peanuts, or walnuts. Frequently a characteristic of Brazilian coffees." },
            { name: "Floral", example: "jasmine flowers", icon: "🌸", color: "bg-pink-500", detail: "Delicate notes like jasmine, honeysuckle, rose, or lavender. A hallmark of some Ethiopian and Panamanian Gesha coffees." },
            { name: "Spicy", example: "cinnamon stick", icon: "🌶️", color: "bg-red-700", detail: "Warm spices like cinnamon, clove, cardamom, or even black pepper. Can appear in some Indonesian or aged coffees." }
        ]
    };

    const mapSection = BaristaApp.util.createInteractiveSection('The Coffee Belt');
    let mapHotspotHTML = '';
    DAY1_CONFIG.MAP_REGIONS.forEach(region => {
        mapHotspotHTML += `<button
                                class="absolute ${region.position} border-2 border-amber-400/0 hover:border-amber-400/70 rounded-md transition-all duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 focus:ring-offset-gray-800 group region-hotspot"
                                data-region-id="${region.id}"
                                aria-label="Select ${region.name} region">
                                <span class="absolute -top-3 -left-3 p-1.5 bg-gray-800 text-amber-300 text-xs rounded opacity-0 group-hover:opacity-100 group-focus:opacity-100 transition-opacity duration-300">${region.name}</span>
                             </button>`;
    });

    mapSection.innerHTML = `
        <p class="text-sm mb-3 text-gray-300">The 'Coffee Belt' (roughly between the Tropics of Cancer and Capricorn) is where the vast majority of the world's coffee is grown. Click on a highlighted region on the map to learn about its typical flavor profiles.</p>
        <div class="relative bg-gray-800/60 aspect-[16/7] rounded-lg shadow-xl p-2 flex items-center justify-center overflow-hidden border border-gray-700">
            <img src="images/world-map-coffee-belt.svg" alt="World Map highlighting the Coffee Belt" class="absolute inset-0 w-full h-full object-cover opacity-60">
            ${mapHotspotHTML}
             <div class="absolute bottom-0 left-0 right-0 p-3 bg-gradient-to-t from-gray-900/80 to-transparent">
                <div id="mapRegionInfo" class="result-box min-h-[4em] text-center" aria-live="polite">Explore the Coffee Belt by clicking a region.</div>
            </div>
        </div>`;
    container.appendChild(mapSection);

    const mapRegionInfoEl = mapSection.querySelector('#mapRegionInfo');
    mapSection.querySelectorAll('.region-hotspot').forEach(hotspot => {
        hotspot.addEventListener('click', () => {
            const regionId = hotspot.dataset.regionId;
            const regionData = DAY1_CONFIG.MAP_REGIONS.find(r => r.id === regionId);
            if (regionData && mapRegionInfoEl) {
                mapSection.querySelectorAll('.region-hotspot').forEach(hs => hs.classList.remove('border-amber-500', 'ring-2', 'ring-amber-500', 'bg-amber-500/10'));
                hotspot.classList.add('border-amber-500', 'ring-2', 'ring-amber-500', 'bg-amber-500/10');

                gsap.fromTo(mapRegionInfoEl, { opacity: 0, y: 10 }, { opacity: 1, y: 0, duration: 0.3, ease: "power2.out",
                    onStart: () => mapRegionInfoEl.innerHTML = `<strong class="text-amber-300">${regionData.name}:</strong> ${regionData.info}`
                });
                mapRegionInfoEl.className = 'result-box min-h-[4em] text-center';
            }
            BaristaApp.util.trackAnalytics(`Day 1: Clicked map region - ${regionData ? regionData.name : 'Unknown'}`);
        });
    });

    const gallerySection = BaristaApp.util.createInteractiveSection('From Cherry to Cup: The Bean\'s Journey');
    let galleryItemsHTML = '';
    DAY1_CONFIG.BEAN_STAGES.forEach(stage => {
        galleryItemsHTML += `
            <div class="gallery-item-container relative group cursor-pointer p-1 rounded-lg border-2 border-transparent hover:border-amber-400/50 transition-all duration-200 focus-within:border-amber-500 focus-within:ring-2 focus-within:ring-amber-500"
                 tabindex="0" data-stage-id="${stage.id}" aria-label="View details for ${stage.alt}">
                <img src="${stage.src}" alt="${stage.alt}" class="w-full h-48 object-cover rounded-md shadow-lg group-hover:scale-105 group-focus:scale-105 transition-transform duration-300 ease-out">
                <div class="absolute bottom-0 left-0 right-0 p-2 bg-black/60 text-center">
                    <h3 class="text-sm font-semibold text-amber-300">${stage.alt}</h3>
                </div>
            </div>`;
    });

    gallerySection.innerHTML = `
        <p class="text-sm mb-4 text-gray-300">Coffee beans undergo several transformations from the plant to your cup. Click an image to learn more about each critical stage.</p>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-4">
            ${galleryItemsHTML}
        </div>
        <div id="galleryImageInfo" class="result-box min-h-[5em]" aria-live="polite">Select an image to see its description.</div>`;
    container.appendChild(gallerySection);

    const galleryImageInfoEl = gallerySection.querySelector('#galleryImageInfo');
    gallerySection.querySelectorAll('.gallery-item-container').forEach(item => {
        const handleGallerySelection = () => {
            gallerySection.querySelectorAll('.gallery-item-container').forEach(i => i.classList.remove('selected-gallery-item', 'border-amber-500', 'ring-2', 'ring-amber-500'));
            item.classList.add('selected-gallery-item', 'border-amber-500', 'ring-2', 'ring-amber-500');

            const stageId = item.dataset.stageId;
            const stageData = DAY1_CONFIG.BEAN_STAGES.find(s => s.id === stageId);

            if (stageData && galleryImageInfoEl) {
                gsap.fromTo(galleryImageInfoEl, { opacity: 0, y: 10 }, { opacity: 1, y: 0, duration: 0.4, ease: "power2.out",
                    onStart: () => galleryImageInfoEl.innerHTML = `<strong class="text-amber-300">${stageData.alt}:</strong> ${stageData.info}`
                });
                 galleryImageInfoEl.className = 'result-box min-h-[5em]';
            }
            BaristaApp.util.trackAnalytics(`Day 1: Viewed image - ${stageData ? stageData.alt : 'Unknown'}`);
        };
        item.addEventListener('click', handleGallerySelection);
        item.addEventListener('keydown', (e) => { if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); handleGallerySelection(); }});
    });

 const aromaSection = BaristaApp.util.createInteractiveSection('Aroma Explorer');
    let aromaCardsHTML = '';
    DAY1_CONFIG.AROMAS.forEach(aroma => {
        aromaCardsHTML += `
            <div class="aroma-card group relative flex flex-col items-center p-4 rounded-lg shadow-lg cursor-pointer border-2 border-gray-700 hover:border-amber-500/70 transition-all duration-300 ease-in-out focus:outline-none focus-within:border-amber-500 focus-within:ring-2 focus-within:ring-amber-500 ${aroma.color}/70 hover:${aroma.color} min-h-[120px]"
                 tabindex="0" data-aroma-name="${aroma.name}" role="button" aria-label="Select aroma: ${aroma.name}">
                <span class="text-4xl mb-2 group-hover:scale-110 transition-transform duration-200">${aroma.icon}</span>
                <h4 class="text-md font-semibold text-white text-center">${aroma.name}</h4>
                <p class="text-xs text-gray-200 text-center hidden group-hover:block group-focus:block absolute bottom-2 left-2 right-2">e.g., ${aroma.example}</p>
            </div>`;
    });

    aromaSection.innerHTML = `
        <p class="text-sm mb-4 text-gray-300">Developing your coffee palate starts with recognizing common aromas. Click on an aroma card to learn more and see how it might be described.</p>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 mb-4">
            ${aromaCardsHTML}
        </div>
        <div id="aromaMatchResult" class="result-box min-h-[4em]" aria-live="polite">Explore the aromas above.</div>`;
    container.appendChild(aromaSection);

    const aromaMatchResultEl = aromaSection.querySelector('#aromaMatchResult');

    aromaSection.querySelectorAll('.aroma-card').forEach(card => {
        const handleAromaChoice = () => {
            aromaSection.querySelectorAll('.aroma-card').forEach(c => c.classList.remove('selected-aroma-card', 'ring-2', 'ring-offset-2', 'ring-offset-gray-800', 'ring-white', 'border-white/80'));
            card.classList.add('selected-aroma-card', 'ring-2', 'ring-offset-2', 'ring-offset-gray-800', 'ring-white', 'border-white/80');

            const aromaName = card.dataset.aromaName;
            const aromaData = DAY1_CONFIG.AROMAS.find(a => a.name === aromaName);

            if (aromaData && aromaMatchResultEl) {
                let message = `<strong class="text-amber-200">${aromaData.name}:</strong> ${aromaData.detail}`;
                if (!aromaSection.dataset.pointsAwarded) {
                    message += ` <span class="text-green-300 font-semibold">(+${DAY1_CONFIG.POINTS_AROMA_EXPLORE} points for exploring!)</span>`;
                    BaristaApp.dataManager.addPoints(DAY1_CONFIG.POINTS_AROMA_EXPLORE);
                    aromaSection.dataset.pointsAwarded = 'true';
                }

                gsap.fromTo(aromaMatchResultEl, { opacity: 0, y: 10 }, { opacity: 1, y: 0, duration: 0.3, ease: "power2.out",
                    onStart: () => aromaMatchResultEl.innerHTML = message
                });
                aromaMatchResultEl.className = 'result-box min-h-[4em] correct-result';
            }
            BaristaApp.util.trackAnalytics(`Day 1: Explored aroma - ${aromaData ? aromaData.name : 'Unknown'}`);
        };
        card.addEventListener('click', handleAromaChoice);
        card.addEventListener('keydown', (e) => { if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); handleAromaChoice(); }});
    });
},
setupDay2: function () {
    const container = document.getElementById('practicalInteractiveContent');
    if (!container) return;

    const addInteractiveListener = (element, callback) => {
        element.addEventListener('click', callback);
        element.addEventListener('keydown', e => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                callback();
            }
        });
    };


    const createResetButton = (id, defaultMessage, interactiveSelector, infoBoxId) => {
        const button = document.createElement('button');
        button.id = id;
        button.className = 'reset-button mt-3 py-1 px-3 bg-gray-600 hover:bg-gray-500 text-white text-xs rounded shadow interactive-button'; // Added interactive-button
        button.textContent = "Reset Selection";
        button.addEventListener('click', () => {
            document.querySelectorAll(interactiveSelector).forEach(item =>
                item.classList.remove('selected', 'selected-img', 'border-sky-400', 'border-sky-500', 'bg-sky-500') // ensure all selection classes are removed
            );
            const infoBox = document.getElementById(infoBoxId);
            if (infoBox) {
                infoBox.textContent = defaultMessage;
                infoBox.className = 'result-box mt-3 p-3 bg-gray-700 rounded text-gray-200 min-h-[4em]'; // Reset class
            }

            if (id === 'resetMachineSelection') {
                const machineHighlighter = document.getElementById('machinePartHighlighter');
                if (machineHighlighter) machineHighlighter.style.display = 'none';
            } else if (id === 'resetGrinderSelection') {
                const grinderHighlighter = document.getElementById('grinderPartHighlighter');
                if (grinderHighlighter) grinderHighlighter.style.display = 'none';
            }
            if (interactiveSelector.includes('.image-gallery img')) {
                 grindVizSection.querySelectorAll('.image-gallery img').forEach(i => {
                    i.style.borderColor = 'transparent'; // Used for grind-viz-img
                });
            }
            if (typeof BaristaApp !== 'undefined' && BaristaApp.util && BaristaApp.util.trackAnalytics) {
                BaristaApp.util.trackAnalytics(`Reset selection in ${id}`);
            }
        });
        return button;
    };


    let modal = document.getElementById('imageModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'imageModal';
        modal.className = 'modal fixed inset-0 bg-black bg-opacity-85 flex items-center justify-center p-4 z-[1060]'; // Higher z-index
        modal.style.display = 'none';
        modal.innerHTML = `
            <div class="modal-content-area bg-gray-800 p-6 rounded-lg shadow-xl max-w-3xl max-h-[90vh] overflow-auto relative glass">
                <button class="modal-close absolute top-3 right-4 text-gray-400 hover:text-white text-3xl font-bold cursor-pointer focus:outline-none focus:ring-2 focus:ring-amber-500 rounded-full w-8 h-8 flex items-center justify-center bg-gray-700/50 hover:bg-gray-600/80" tabindex="0" aria-label="Close image modal">×</button>
                <img src="" alt="" class="modal-image max-w-full h-auto max-h-[75vh] object-contain mx-auto block rounded-md shadow-lg">
                <div class="modal-caption text-center text-gray-300 mt-4 text-sm"></div>
            </div>
        `;
        document.body.appendChild(modal);

        const closeModal = () => modal.style.display = 'none';

        modal.querySelector('.modal-close').addEventListener('click', closeModal);
        modal.querySelector('.modal-close').addEventListener('keydown', e => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                closeModal();
            }
        });

        window.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal.style.display !== 'none') { // Check display not 'none'
                closeModal();
            }
        });
    }


    const machineSection = BaristaApp.util.createInteractiveSection('Espresso Machine Explorer');

    const machineParts = {
        "Group Head": "The component where the portafilter locks in. Hot, pressurized water is dispersed evenly over the coffee grounds through the group head's shower screen.",
        "Portafilter": "A handle with a filter basket that holds tamped coffee grounds. It's locked into the group head for brewing.",
        "Steam Wand": "A nozzle that releases high-pressure steam, used for heating and texturing milk to create microfoam for lattes, cappuccinos, etc.",
        "Steam Valve": "A knob or lever that controls the flow and intensity of steam released from the steam wand.",
        "Drip Tray": "A removable tray located beneath the group heads and steam wand to collect excess water, coffee drips, and purged steam, keeping the workspace clean.",
        "Control Panel/Buttons": "Contains switches and buttons to operate the machine, including power, shot programming (dose buttons), manual brew, and hot water dispensing.",
        "Pressure Gauge": "Displays the pressure within the boiler (steam pressure) and/or the pump pressure at the group head during extraction. Crucial for consistency.",
        "Hot Water Dispenser": "A dedicated spout that dispenses hot water from the boiler, often used for making Americanos, tea, or pre-heating cups."
    };

    const machinePartCoordinates = { // Scaled to a 300px wide image roughly
    "Group Head":          { x: 180/1.5, y: 63/1.5, width: 35/1.5, height: 15/1.5 },
    "Portafilter":         { x: 180/1.5, y: 80/1.5, width: 35/1.5, height: 25/1.5 },
    "Steam Wand":          { x:260/1.5, y: 80/1.5, width: 15/1.5, height: 50/1.5 },
    "Steam Valve":         { x: 250/1.5, y: 35/1.5, width: 20/1.5, height: 20/1.5 },
    "Drip Tray":           { x: 25/1.5, y: 135/1.5, width: 230/1.5, height: 15/1.5 },
    "Control Panel/Buttons": { x: 70/1.5, y: 35/1.5, width: 60/1.5, height: 15/1.5 },
    "Pressure Gauge":      { x: 238/1.5, y: 95/1.5, width: 20/1.5, height: 20/1.5 },
    "Hot Water Dispenser": { x: 138/1.5, y: 60/1.5, width: 20/1.5, height: 40/1.5 }
};

    machineSection.insertAdjacentHTML('beforeend', `
        <p class="text-sm mb-2 text-gray-300">
            Click on a part name to learn its function. (Image is illustrative)
        </p>
        <div class="image-container relative inline-block mx-auto my-3 border border-gray-600 rounded-md shadow-lg">
            <img id="machineImage" src="images/espresso-machine-parts.jpg" alt="Espresso Machine Diagram" class="block rounded-md max-h-48 sm:max-h-64 object-contain" title="Double-click part name or image to enlarge">
            <div id="machinePartHighlighter" class="absolute border-2 border-red-500 pointer-events-none rounded" style="display: none; box-shadow: 0 0 10px rgba(255,0,0,0.7); transition: all 0.2s ease-out;"></div>
        </div>
    `);

    const machineImageElement = machineSection.querySelector('#machineImage');
    if (machineImageElement) {
        machineImageElement.addEventListener('dblclick', () => {
            const modalImage = modal.querySelector('.modal-image');
            const modalCaption = modal.querySelector('.modal-caption');
            modalImage.src = machineImageElement.src;
            modalImage.alt = machineImageElement.alt + ' - Enlarged';
            modalCaption.textContent = machineImageElement.alt;
            gsap.fromTo(modal, {autoAlpha: 0}, {autoAlpha: 1, duration: 0.3, onStart: () => modal.style.display = 'flex'});
            gsap.fromTo(modal.querySelector('.modal-content-area'), {scale: 0.7, opacity:0}, {scale:1, opacity:1, duration:0.4, ease:'back.out(1.7)'});
        });
    }

    const machineChoicesContainer = document.createElement('div');
    machineChoicesContainer.className = 'flex flex-wrap gap-2 justify-center mt-4'; // Increased mt

    Object.keys(machineParts).forEach(part => {
        const choiceDiv = document.createElement('button'); // Changed to button for better accessibility
        choiceDiv.className = 'interactive-choice machine-part py-2 px-3 text-sm'; // Removed explicit bg, color
        choiceDiv.dataset.part = part;
        choiceDiv.textContent = part;
        machineChoicesContainer.appendChild(choiceDiv);
    });
    machineSection.appendChild(machineChoicesContainer);

    machineSection.insertAdjacentHTML('beforeend', `
        <div id="machinePartInfo" class="result-box mt-4 min-h-[4.5em]">
            Click a part name above to learn more.
        </div>
    `);
    machineSection.appendChild(
        createResetButton('resetMachineSelection', 'Click a part name above to learn more.', '.machine-part', 'machinePartInfo')
    );
    container.appendChild(machineSection);

    machineSection.querySelectorAll('.machine-part').forEach(el => {
        const handleMachinePart = () => {
            machineSection.querySelectorAll('.machine-part').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');

            const infoBox = document.getElementById('machinePartInfo');
            if (infoBox) {
                infoBox.innerHTML = `<strong class="text-sky-400">${el.dataset.part}:</strong> ${machineParts[el.dataset.part]}`;
                infoBox.className = 'result-box mt-4 min-h-[4.5em]'; // Reset class for general info
            }

            const highlighter = document.getElementById('machinePartHighlighter');
            const coords = machinePartCoordinates[el.dataset.part];
            if (highlighter && coords) {
                const imgRect = machineImageElement.getBoundingClientRect();
                const containerRect = machineImageElement.parentElement.getBoundingClientRect();
                // Assuming image is scaled to fit, calculate scale factor if original dimensions known
                // For simplicity, let's assume the coordinates are relative to a 200px height image for now
                // This needs to be dynamic based on actual rendered image size vs coordinate system size
                const actualHeight = machineImageElement.offsetHeight;
                const coordSystemHeight = 133; // Approx height of coordinate system (160/1.5 + 35/1.5 offset)
                const scaleFactor = actualHeight / coordSystemHeight;


                gsap.to(highlighter, {
                    left: coords.x * scaleFactor,
                    top: coords.y * scaleFactor,
                    width: coords.width * scaleFactor,
                    height: coords.height * scaleFactor,
                    display: "block",
                    opacity:1,
                    duration:0.2
                });
            } else if (highlighter) {
                gsap.to(highlighter, {opacity:0, duration:0.2, onComplete: () => highlighter.style.display = "none"});
            }
            BaristaApp.util.trackAnalytics(`Day 2: Explored machine part - ${el.dataset.part}`);
        };
        addInteractiveListener(el, handleMachinePart);

        el.addEventListener('dblclick', () => {
            const modalImage = modal.querySelector('.modal-image');
            const modalCaption = modal.querySelector('.modal-caption');
            modalImage.src = machineSection.querySelector('#machineImage').src;
            modalImage.alt = 'Espresso Machine Diagram - Enlarged';
            modalCaption.innerHTML = `<strong class="text-sky-400">${el.dataset.part}:</strong> ${machineParts[el.dataset.part]}`;
            gsap.fromTo(modal, {autoAlpha: 0}, {autoAlpha: 1, duration: 0.3, onStart: () => modal.style.display = 'flex'});
            gsap.fromTo(modal.querySelector('.modal-content-area'), {scale: 0.7, opacity:0}, {scale:1, opacity:1, duration:0.4, ease:'back.out(1.7)'});
        });
    });

    const grinderSection = BaristaApp.util.createInteractiveSection('Grinder Explorer');
    const grinderParts = {
        "Hopper": "Holds the whole coffee beans before they are fed into the burrs for grinding.",
        "Burrs (Conical or Flat)": "Two abrasive surfaces that grind the coffee beans to the desired consistency. Burr grinders are preferred for consistency.",
        "Grind Adjustment Dial/Collar": "Allows the user to change the distance between burrs, controlling the fineness or coarseness of the coffee grounds.",
        "Dosing Chamber/Chute": "Where the ground coffee collects or is dispensed from."
    };

    const grinderPartCoordinates = { // Scaled to a ~200px wide image
        "Hopper": { x: 10/1.2, y: 10/1.2, width: 40/1.2, height: 35/1.2 },
        "Burrs (Conical or Flat)": { x: 10/1.2, y: 50/1.2, width: 30/1.2, height: 10/1.2 },
        "Grind Adjustment Dial/Collar": { x: 10/1.2, y: 50/1.2, width: 30/1.2, height: 10/1.2 },
        "Dosing Chamber/Chute": { x: 20/1.2, y: 70/1.2, width: 20/1.2, height: 20/1.2 }
    };

    grinderSection.insertAdjacentHTML('beforeend', `
        <p class="text-sm mb-2 text-gray-300">
            Click on a grinder part name to learn more. (Image is illustrative)
        </p>
        <div class="image-container relative inline-block mx-auto my-3 border border-gray-600 rounded-md shadow-lg">
            <img id="grinderImage" src="images/d2-coffee-grinder-burr.jpg" alt="Coffee Grinder Diagram" class="block rounded-md max-h-40 sm:max-h-56 object-contain" title="Double-click part name or image to enlarge">
            <div id="grinderPartHighlighter" class="absolute border-2 border-blue-500 pointer-events-none rounded" style="display: none; box-shadow: 0 0 10px rgba(0,0,255,0.7); transition: all 0.2s ease-out;"></div>
        </div>
    `);

    const grinderImageElement = grinderSection.querySelector('#grinderImage');
    if (grinderImageElement) {
        grinderImageElement.addEventListener('dblclick', () => {
            const modalImage = modal.querySelector('.modal-image');
            const modalCaption = modal.querySelector('.modal-caption');
            modalImage.src = grinderImageElement.src;
            modalImage.alt = grinderImageElement.alt + ' - Enlarged';
            modalCaption.textContent = grinderImageElement.alt;
            gsap.fromTo(modal, {autoAlpha: 0}, {autoAlpha: 1, duration: 0.3, onStart: () => modal.style.display = 'flex'});
            gsap.fromTo(modal.querySelector('.modal-content-area'), {scale:
0.7, opacity:0}, {scale:1, opacity:1, duration:0.4, ease:'back.out(1.7)'});
        });
    }

    const grinderChoicesContainer = document.createElement('div');
    grinderChoicesContainer.className = 'flex flex-wrap gap-2 justify-center mt-4';

    Object.keys(grinderParts).forEach(part => {
        const choiceDiv = document.createElement('button'); // Changed to button
        choiceDiv.className = 'interactive-choice grinder-part py-2 px-3 text-sm';
        choiceDiv.dataset.part = part;
        choiceDiv.textContent = part;
        grinderChoicesContainer.appendChild(choiceDiv);
    });
    grinderSection.appendChild(grinderChoicesContainer);

    grinderSection.insertAdjacentHTML('beforeend', `
        <div id="grinderPartInfo" class="result-box mt-4 min-h-[4.5em]">
            Click a part name above to learn more.
        </div>
    `);
    grinderSection.appendChild(
        createResetButton('resetGrinderSelection', 'Click a part name above to learn more.', '.grinder-part', 'grinderPartInfo')
    );
    container.appendChild(grinderSection);

    grinderSection.querySelectorAll('.grinder-part').forEach(el => {
        const handleGrinderPart = () => {
            grinderSection.querySelectorAll('.grinder-part').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            const infoBox = document.getElementById('grinderPartInfo');
            if (infoBox) {
                infoBox.innerHTML = `<strong class="text-sky-400">${el.dataset.part}:</strong> ${grinderParts[el.dataset.part]}`;
                infoBox.className = 'result-box mt-4 min-h-[4.5em]';
            }

            const highlighter = document.getElementById('grinderPartHighlighter');
            const coords = grinderPartCoordinates[el.dataset.part];
            if (highlighter && coords) {
                const actualHeight = grinderImageElement.offsetHeight;
                const coordSystemHeight = 125; // Approx height of grinder coord system (110/1.2 + 40/1.2)
                const scaleFactor = actualHeight / coordSystemHeight;

                 gsap.to(highlighter, {
                    left: coords.x * scaleFactor,
                    top: coords.y * scaleFactor,
                    width: coords.width * scaleFactor,
                    height: coords.height * scaleFactor,
                    display: "block",
                    opacity:1,
                    duration:0.2
                });
            } else if (highlighter) {
                gsap.to(highlighter, {opacity:0, duration:0.2, onComplete: () => highlighter.style.display = "none"});
            }
            BaristaApp.util.trackAnalytics(`Day 2: Explored grinder part - ${el.dataset.part}`);
        };
        addInteractiveListener(el, handleGrinderPart);

        el.addEventListener('dblclick', () => {
            const modalImage = modal.querySelector('.modal-image');
            const modalCaption = modal.querySelector('.modal-caption');
            modalImage.src = grinderSection.querySelector('#grinderImage').src;
            modalImage.alt = 'Coffee Grinder Diagram - Enlarged';
            modalCaption.innerHTML = `<strong class="text-sky-400">${el.dataset.part}:</strong> ${grinderParts[el.dataset.part]}`;
            gsap.fromTo(modal, {autoAlpha: 0}, {autoAlpha: 1, duration: 0.3, onStart: () => modal.style.display = 'flex'});
            gsap.fromTo(modal.querySelector('.modal-content-area'), {scale: 0.7, opacity:0}, {scale:1, opacity:1, duration:0.4, ease:'back.out(1.7)'});
        });
    });

    const grindVizSection = BaristaApp.util.createInteractiveSection('Grind Size Visualizer');
    grindVizSection.insertAdjacentHTML('beforeend', `
        <p class="text-sm mb-2 text-gray-300">
            See how different grind sizes look. Espresso needs a fine, consistent grind!
        </p>
        <div class="flex flex-wrap justify-around items-center image-gallery gap-3">
            <img src="images/d2-coarse-grind.jpg" alt="Coarse Grind" data-info="Too Coarse for Espresso: Looks like breadcrumbs. Water flows too quickly, leading to under-extraction and a sour taste. Ideal for French Press." class="grind-viz-img h-24 w-24 object-cover rounded-md border-2 border-transparent hover:border-sky-500 cursor-pointer transition-all" title="Click for details; double-click to enlarge">
            <img src="images/d2-fine-espresso-grind.jpg" alt="Espresso Grind" data-info="Ideal for Espresso: Resembles table salt or fine sand. Provides the right resistance for balanced extraction." class="grind-viz-img h-24 w-24 object-cover rounded-md border-2 border-transparent hover:border-sky-500 cursor-pointer transition-all" title="Click for details; double-click to enlarge">
            <img src="images/d2-powdered-turkish-grind.jpg" alt="Too Fine / Powdered" data-info="Too Fine for Espresso: Like flour or powder. Water struggles to pass through, leading to over-extraction and a bitter taste. Used for Turkish coffee." class="grind-viz-img h-24 w-24 object-cover rounded-md border-2 border-transparent hover:border-sky-500 cursor-pointer transition-all" title="Click for details; double-click to enlarge">
        </div>
        <div id="grindVizInfo" class="result-box mt-4 min-h-[4.5em]">
            Click an image to see details.
        </div>
    `);
    grindVizSection.appendChild(
        createResetButton('resetGrindViz', 'Click an image to see details.', '.image-gallery img.grind-viz-img', 'grindVizInfo')
    );
    container.appendChild(grindVizSection);

    grindVizSection.querySelectorAll('.image-gallery img.grind-viz-img').forEach(img => {
        const handleGrindImgInteraction = () => {
            grindVizSection.querySelectorAll('.image-gallery img.grind-viz-img').forEach(i => {
                i.classList.remove('selected-img');
                i.style.borderColor = 'transparent'; // Use this for non-selected state for this specific gallery
            });
            img.classList.add('selected-img');
            img.style.borderColor = 'var(--accent-secondary)'; // Use CSS var for selection highlight
            const infoBox = document.getElementById('grindVizInfo');
            if (infoBox) {
                infoBox.innerHTML = `<strong class="text-sky-400">${img.alt}:</strong> ${img.dataset.info}`;
                infoBox.className = 'result-box mt-4 min-h-[4.5em]';
            }
            BaristaApp.util.trackAnalytics(`Day 2: Viewed grind size - ${img.alt}`);
        };

        addInteractiveListener(img, handleGrindImgInteraction);
        img.setAttribute('role', 'button');

        img.addEventListener('dblclick', () => {
            const modalImage = modal.querySelector('.modal-image');
            const modalCaption = modal.querySelector('.modal-caption');
            modalImage.src = img.src;
            modalImage.alt = `${img.alt} - Enlarged`;
            modalCaption.innerHTML = `<strong class="text-sky-400">${img.alt}:</strong> ${img.dataset.info}`;
            gsap.fromTo(modal, {autoAlpha: 0}, {autoAlpha: 1, duration: 0.3, onStart: () => modal.style.display = 'flex'});
            gsap.fromTo(modal.querySelector('.modal-content-area'), {scale:
0.7, opacity:0}, {scale:1, opacity:1, duration:0.4, ease:'back.out(1.7)'});
        });
    });
},

setupDay3: function() {
    const container = document.getElementById('practicalInteractiveContent');
    if (!container) return;

    const grinderAdjSection = BaristaApp.util.createInteractiveSection('Virtual Grinder Adjuster');
    grinderAdjSection.innerHTML += `<p class="text-sm mb-2 text-gray-300">Select the 'Espresso' setting for the optimal grind consistency.</p>
        <div id="grindSettings" class="flex flex-col space-y-2">
            <div class="interactive-choice grind-setting" data-setting="Coarse (French Press)" role="button" tabindex="0">Coarse (e.g., for French Press)</div>
            <div class="interactive-choice grind-setting" data-setting="Medium (Pour Over)" role="button" tabindex="0">Medium (e.g., for Pour Over)</div>
            <div class="interactive-choice grind-setting" data-setting="Fine (Espresso)" role="button" tabindex="0">Fine (e.g., for Espresso)</div>
        </div>
        <div id="grinderAdjResult" class="result-box mt-3">Select a setting.</div>`;
    container.appendChild(grinderAdjSection);
    grinderAdjSection.querySelectorAll('.grind-setting').forEach(el => {
        const handleGrindSelect = () => {
            const resultEl = document.getElementById('grinderAdjResult');
            if (!resultEl) return;
            grinderAdjSection.querySelectorAll('.grind-setting').forEach(e => e.classList.remove('selected', 'correct', 'incorrect'));
            el.classList.add('selected');
            if (el.dataset.setting === "Fine (Espresso)") {
                resultEl.textContent = "Correct! Espresso requires a fine, consistent grind, similar to table salt. (+5 points)";
                resultEl.className = 'result-box mt-3 correct-result'; el.classList.add('correct'); BaristaApp.dataManager.addPoints(5);
            } else {
                resultEl.textContent = `Not quite for espresso. A ${el.dataset.setting.split('(')[0].toLowerCase()} grind is usually for other brew methods. Try again!`;
                resultEl.className = 'result-box mt-3 incorrect-result'; el.classList.add('incorrect');
            }
            BaristaApp.util.trackAnalytics(`Day 3: Grinder setting selected - ${el.dataset.setting}`);
        };
        el.addEventListener('click', handleGrindSelect);
        el.addEventListener('keydown', (e) => { if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); handleGrindSelect(); }});
    });

    const dosingSection = BaristaApp.util.createInteractiveSection('Virtual Dosing Challenge');
    dosingSection.innerHTML += `<p class="text-sm mb-2 text-gray-300">Use the slider to conceptually fill the portafilter basket to the 'Ideal Dose' line (around 70% on slider).</p>
        <label for="doseSlider" class="sr-only">Dose Amount</label>
        <input type="range" id="doseSlider" min="0" max="100" value="50" class="w-full accent-amber-500 my-3 h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
        <div class="h-12 bg-gray-700 rounded relative my-2 border border-gray-500 overflow-hidden flex items-center justify-center text-xs text-gray-400">
            <div id="doseFill" class="h-full bg-amber-700 absolute left-0 top-0 transition-all duration-150 ease-linear" style="width: 50%;"></div>
            <div class="absolute border-l-2 border-dashed border-green-400 h-full z-10" style="left: 70%; top:0;" title="Ideal Dose Mark"></div>
            <span class="z-20 relative" id="doseFillPercentage">50%</span>
        </div>
        <button id="checkDoseBtn" class="interactive-button">Check Dose</button>
        <div id="dosingResult" class="result-box mt-3">Adjust slider to simulate dosing and then check.</div>`;
    container.appendChild(dosingSection);
    const doseSlider = document.getElementById('doseSlider');
    const doseFill = document.getElementById('doseFill');
    const doseFillPercentage = document.getElementById('doseFillPercentage');
    if(doseSlider && doseFill && doseFillPercentage) {
        doseSlider.addEventListener('input', () => {
            doseFill.style.width = `${doseSlider.value}%`;
            doseFillPercentage.textContent = `${doseSlider.value}%`;
        });
    }
    const checkDoseBtn = document.getElementById('checkDoseBtn');
    if(checkDoseBtn && doseSlider){
        checkDoseBtn.addEventListener('click', () => {
            const doseValue = parseInt(doseSlider.value);
            const resultEl = document.getElementById('dosingResult');
            if (!resultEl) return;
            if (doseValue >= 68 && doseValue <= 72) {
                resultEl.textContent = "Excellent! Looks like a good conceptual dose, filling the basket appropriately. (+5 points)";
                resultEl.className = 'result-box mt-3 correct-result'; BaristaApp.dataManager.addPoints(5);
            } else if (doseValue < 68) {
                resultEl.textContent = "A bit too low. This might lead to an under-extracted, watery shot. Try adding more (conceptually).";
                resultEl.className = 'result-box mt-3 incorrect-result';
            } else {
                resultEl.textContent = "A bit too high. This could make it hard to lock in the portafilter or cause over-extraction. Try a little less (conceptually).";
                resultEl.className = 'result-box mt-3 incorrect-result';
            }
            BaristaApp.util.trackAnalytics(`Day 3: Dosing challenge attempt - ${doseValue}%`);
        });
    }

    const tamperSection = BaristaApp.util.createInteractiveSection('Virtual Tamper');
    tamperSection.innerHTML += `<p class="text-sm mb-2 text-gray-300">Click to 'Tamp'. Aim for a level and evenly compressed coffee bed.</p>
        <div class="h-24 bg-gray-600 rounded p-3 flex items-center justify-center my-3 relative border border-gray-500">
            <div id="coffeeBed" class="w-3/4 h-1/2 bg-yellow-900/70 rounded-sm transition-all duration-300 ease-in-out flex items-center justify-center text-sm text-yellow-200" style="transform: skewY(0deg) translateY(10px);">Untamped Grounds</div>
        </div>
        <button id="tampBtn" class="interactive-button">Tamp Coffee</button>
        <div id="tampResult" class="result-box mt-3">Click 'Tamp Coffee'.</div>`;
    container.appendChild(tamperSection);
    const tampBtn = document.getElementById('tampBtn');
    if (tampBtn) {
        tampBtn.addEventListener('click', () => {
            const coffeeBed = document.getElementById('coffeeBed');
            const resultEl = document.getElementById('tampResult');
            if (!coffeeBed || !resultEl) return;

            const isLevel = Math.random() > 0.25;
            const randomSkew = isLevel ? 0 : (Math.random() > 0.5 ? 1 : -1) * (Math.random() * 2 + 1);

            gsap.to(coffeeBed, {
                duration: 0.3,
                skewY: `${randomSkew}deg`,
                translateY: 0,
                backgroundColor: '#654321', // Darker brown for tamped coffee
                onComplete: () => {
                    coffeeBed.textContent = isLevel ? "Level Tamp" : "Uneven Tamp";
                }
            });

            if (isLevel) {
                resultEl.textContent = "Nice and level tamp (conceptually)! This is crucial for even extraction. (+5 points)";
                resultEl.className = 'result-box mt-3 correct-result'; BaristaApp.dataManager.addPoints(5);
            } else {
                resultEl.textContent = `Oops, a bit uneven (skewed by ${randomSkew.toFixed(1)}deg). An uneven tamp can lead to channeling. Try to keep it perfectly level next time!`;
                resultEl.className = 'result-box mt-3 incorrect-result';
            }
             BaristaApp.util.trackAnalytics(`Day 3: Tamp attempt - ${isLevel ? 'level' : 'uneven'}`);
        });
    }
},
setupDay4: function() {
    const container = document.getElementById('practicalInteractiveContent');
    if (!container) {
        console.error("Day 4: Container #practicalInteractiveContent not found.");
        return;
    }

    const SIM_DEFAULTS = {
        DOSE: 18, MIN_DOSE: 10, MAX_DOSE: 25,
        GRIND_FINENESS: 50, MIN_GRIND: 0, MAX_GRIND: 100,
        DOSE_TO_YIELD_RATIO: 2,
        GRIND_MIDPOINT_FOR_BASE_FLOW: 50,
        GRIND_SENSITIVITY_DIVISOR: 75,
        BASE_FLOW_TARGET_TIME_SECONDS: 28,
        MAX_SHOT_DURATION_SECONDS: 45,
        IDEAL_TIME_WINDOW: { START: 25, END: 30 },
        YIELD_TOLERANCE_PERCENTAGE: 0.10,
        VISUALS: {
            CUP_MAX_FILL_HEIGHT_PX: 60,
            LIQUID_BOTTOM_Y_SVG: 100,
            LIQUID_X_LEFT_SVG: 23,
            LIQUID_WIDTH_SVG: 54,
            CREMA_HEIGHT_PX: 7,
            STREAM_ANIM_DURATION: 0.2,
            LIQUID_ANIM_DURATION: 0.1,
            STEAM_OPACITY: 0.3,
            GRIND_PARTICLE_AREA_SIZE: 24,
        },
        SCORING: {
            EXCELLENT_SHOT: 10,
            ALMOST_THERE_SHOT: 5,
            ATTEMPTED_SHOT: 3,
            CORRECT_CREMA: 5,
        },
        PROGRESS_BAR_IDEAL_START_MARKER_PERCENT: (25 / 45) * 100,
        PROGRESS_BAR_IDEAL_END_MARKER_PERCENT: (30 / 45) * 100,
    };

    class EspressoSimulator {
        constructor(config, domElements, onShotEndCallback) {
            this.config = config;
            this.elements = domElements;
            this.onShotEnd = onShotEndCallback;
            this.steamTimeline = null;

            this.state = {
                startTime: 0,
                currentTimeSeconds: 0,
                currentYieldGrams: 0,
                animationFrameId: null,
                isRunning: false,
                currentDose: this.config.DOSE,
                currentGrind: this.config.GRIND_FINENESS,
            };
            this._init();
        }

        _init() {
            this.elements.doseInput.value = this.state.currentDose;
            this.elements.grindFineness.value = this.state.currentGrind;
            this.elements.doseInput.min = this.config.MIN_DOSE;
            this.elements.doseInput.max = this.config.MAX_DOSE;
            this.elements.grindFineness.min = this.config.MIN_GRIND;
            this.elements.grindFineness.max = this.config.MAX_GRIND;

            this.elements.doseInput.addEventListener('input', this._handleDoseChange.bind(this));
            this.elements.grindFineness.addEventListener('input', this._handleGrindChange.bind(this));

            this._updateTargetYieldDisplay();
            this._updateGrindFinenessLabelAndVisual();
            this._updateVisuals();
            this._initSteamAnimation();
        }

        _handleDoseChange() {
            this.state.currentDose = Math.max(this.config.MIN_DOSE, Math.min(this.config.MAX_DOSE, parseInt(this.elements.doseInput.value) || this.config.DOSE));
            this.elements.doseInput.value = this.state.currentDose;
            this._updateTargetYieldDisplay();
        }

        _handleGrindChange() {
            this.state.currentGrind = parseInt(this.elements.grindFineness.value);
            this._updateGrindFinenessLabelAndVisual();
        }

        _updateTargetYieldDisplay() {
            const targetYield = this.state.currentDose * this.config.DOSE_TO_YIELD_RATIO;
            this.elements.targetYieldEl.textContent = `${targetYield.toFixed(0)}g`;
        }

        _updateGrindFinenessLabelAndVisual() {
            const val = this.state.currentGrind;
            let label = "Medium";
            if (val < 33) label = "Coarse";
            else if (val > 66) label = "Fine";
            this.elements.grindFinenessValueEl.textContent = `${label} (${val})`;
            this._drawGrindParticles(val);
        }


_drawGrindParticles(grindValue) {
            const svgNS = "http://www.w3.org/2000/svg";
            const svg = this.elements.grindVisualIndicator;
            const areaSize = this.config.VISUALS.GRIND_PARTICLE_AREA_SIZE;
            svg.innerHTML = '';

            let numParticles, particleRadius, particleColor;

            if (grindValue < 33) { // Coarse
                numParticles = 5 + Math.floor(Math.random() * 3);
                particleRadius = 1.8;
                particleColor = "#a1887f";
            } else if (grindValue > 66) { // Fine
                numParticles = 35 + Math.floor(Math.random() * 10);
                particleRadius = 0.7;
                particleColor = "#5d4037";
            } else { // Medium
                numParticles = 15 + Math.floor(Math.random() * 5);
                particleRadius = 1.1;
                particleColor = "#795548";
            }

            for (let i = 0; i < numParticles; i++) {
                const circle = document.createElementNS(svgNS, "circle");
                circle.setAttribute("cx", (Math.random() * (areaSize - particleRadius * 2)) + particleRadius);
                circle.setAttribute("cy", (Math.random() * (areaSize - particleRadius * 2)) + particleRadius);
                circle.setAttribute("r", particleRadius * (0.8 + Math.random() * 0.4));
                circle.setAttribute("fill", particleColor);
                circle.setAttribute("opacity", (0.7 + Math.random() * 0.3).toFixed(2) );
                svg.appendChild(circle);
            }
        }

        _initSteamAnimation() {
            if (!this.elements.steamPath1 || !this.elements.steamPath2 || !this.elements.steamPath3) return;

            this.steamTimeline = gsap.timeline({ paused: true, repeat: -1 });
            const steamDuration = 4;
            const steamY = -25;

            this.steamTimeline
                .fromTo([this.elements.steamPath1, this.elements.steamPath2, this.elements.steamPath3],
                    { y: 0, opacity: 0 },
                    {
                        y: (i) => steamY - (i * 4),
                        opacity: (i) => this.config.VISUALS.STEAM_OPACITY - (i * 0.05),
                        duration: steamDuration,
                        ease: "sine.inOut",
                        stagger: { each: 0.5, from: "start" }
                    }, 0)
                .to([this.elements.steamPath1, this.elements.steamPath2, this.elements.steamPath3],
                    {
                        opacity: 0,
                        duration: steamDuration * 0.6,
                        ease: "sine.in",
                        stagger: { each: 0.5, from: "start" }
                    }, `-=${steamDuration * 0.4}`);
        }

        _manageSteamVisibility() {
            if (!this.steamTimeline) return;
            const hasSignificantLiquid = this.state.currentYieldGrams > (this.state.currentDose * this.config.DOSE_TO_YIELD_RATIO * 0.1);

            if (hasSignificantLiquid) {
                if (this.steamTimeline.paused()) this.steamTimeline.play();
            } else {
                if (this.steamTimeline.isActive()) {
                    this.steamTimeline.pause().progress(0);
                    gsap.set([this.elements.steamPath1, this.elements.steamPath2, this.elements.steamPath3], {opacity: 0, y:0});
                }
            }
        }

        _updateVisuals() {
            const CVIS = this.config.VISUALS;
            const targetYield = this.state.currentDose * this.config.DOSE_TO_YIELD_RATIO;
            const visualYieldCap = targetYield * 1.2;
            const yieldPercentage = Math.min(this.state.currentYieldGrams / visualYieldCap, 1);

            let actualLiquidHeightSvgUnits = yieldPercentage * CVIS.CUP_MAX_FILL_HEIGHT_PX;
            actualLiquidHeightSvgUnits = Math.max(0, actualLiquidHeightSvgUnits);

            const y_liquid_bottom_relative = CVIS.LIQUID_BOTTOM_Y_SVG;
            let y_surface_relative = y_liquid_bottom_relative - actualLiquidHeightSvgUnits;

            const x_left_relative = CVIS.LIQUID_X_LEFT_SVG;
            const x_right_relative = CVIS.LIQUID_X_LEFT_SVG + CVIS.LIQUID_WIDTH_SVG;
            const x_mid_relative = CVIS.LIQUID_X_LEFT_SVG + CVIS.LIQUID_WIDTH_SVG / 2;

            let liquid_d;
            let y_surface_control_relative = y_surface_relative;

            if (actualLiquidHeightSvgUnits < 0.1) {
                liquid_d = `M${x_mid_relative} ${y_liquid_bottom_relative} L${x_mid_relative} ${y_liquid_bottom_relative} Q${x_mid_relative} ${y_liquid_bottom_relative} ${x_mid_relative} ${y_liquid_bottom_relative} L${x_mid_relative} ${y_liquid_bottom_relative} Z`;
                y_surface_relative = y_liquid_bottom_relative;
            } else {
                if (this.state.isRunning && actualLiquidHeightSvgUnits > CVIS.CREMA_HEIGHT_PX / 3) {
                    y_surface_control_relative = y_surface_relative + 1.5;
                } else if (actualLiquidHeightSvgUnits > 1) {
                    y_surface_control_relative = y_surface_relative - 1;
                }
                liquid_d = `M${x_left_relative} ${y_liquid_bottom_relative} L${x_left_relative} ${y_surface_relative} Q${x_mid_relative} ${y_surface_control_relative} ${x_right_relative} ${y_surface_relative} L${x_right_relative} ${y_liquid_bottom_relative} Z`;
            }

            gsap.to(this.elements.espressoLiquidFill, {
                attr: { d: liquid_d },
                duration: CVIS.LIQUID_ANIM_DURATION,
                ease: "linear"
            });

            const cremaHeightSvgUnits = CVIS.CREMA_HEIGHT_PX;
            let crema_cy_relative = y_surface_relative - (cremaHeightSvgUnits / 2);
            let crema_ry = 0;
            let crema_opacity = 0;

            if (actualLiquidHeightSvgUnits > cremaHeightSvgUnits / 2.5) {
                crema_ry = cremaHeightSvgUnits / 2;
                crema_opacity = 0.92;
                if (y_surface_control_relative > y_surface_relative) {
                    crema_cy_relative = y_surface_control_relative - cremaHeightSvgUnits * 0.6;
                } else {
                    crema_cy_relative = y_surface_control_relative - cremaHeightSvgUnits * 0.4;
                }
            }
            if (!this.state.isRunning && this.state.currentYieldGrams > 0 && actualLiquidHeightSvgUnits > cremaHeightSvgUnits / 2.5) {
                crema_opacity = 0.92;
                y_surface_control_relative = y_surface_relative - 1;
                crema_cy_relative = y_surface_control_relative - cremaHeightSvgUnits * 0.4;
            }

            gsap.to(this.elements.espressoCremaLayer, {
                attr: {
                    cx: x_mid_relative,
                    cy: crema_cy_relative,
                    rx: (CVIS.LIQUID_WIDTH_SVG / 2) * 0.98,
                    ry: crema_ry
                },
                opacity: crema_opacity,
                duration: CVIS.LIQUID_ANIM_DURATION,
                ease: "linear"
            });

            this.elements.timerEl.textContent = this.state.currentTimeSeconds.toFixed(0);
            this.elements.currentYieldEl.textContent = this.state.currentYieldGrams.toFixed(1);
            const progressPercent = Math.min((this.state.currentTimeSeconds / this.config.MAX_SHOT_DURATION_SECONDS) * 100, 100);
            this.elements.progressBar.style.width = `${progressPercent}%`;

            this._manageSteamVisibility();
        }

        _simulationStep() {
            if (!this.state.isRunning) return;
            this.state.currentTimeSeconds = (Date.now() - this.state.startTime) / 1000;
            const targetYield = this.state.currentDose * this.config.DOSE_TO_YIELD_RATIO;
            const speedModifier = 1 - (this.state.currentGrind - this.config.GRIND_MIDPOINT_FOR_BASE_FLOW) / this.config.GRIND_SENSITIVITY_DIVISOR;
            const baseFlowRatePerSecond = targetYield / this.config.BASE_FLOW_TARGET_TIME_SECONDS;
            const adjustedFlowRatePerSecond = baseFlowRatePerSecond * speedModifier;
            this.state.currentYieldGrams = Math.min(adjustedFlowRatePerSecond * this.state.currentTimeSeconds, targetYield * 1.8);
            this._updateVisuals();
            if (this.state.currentTimeSeconds >= this.config.MAX_SHOT_DURATION_SECONDS) this.stop(true);
            else this.state.animationFrameId = requestAnimationFrame(this._simulationStep.bind(this));
        }
        start() {
            if (this.state.isRunning) return;
            this.state.isRunning = true;
            this.elements.startBtn.classList.add('hidden');
            this.elements.stopBtn.classList.remove('hidden');
            this.elements.startBtn.disabled = true; this.elements.stopBtn.disabled = false;
            this.elements.doseInput.disabled = true; this.elements.grindFineness.disabled = true;
            this.elements.resultEl.textContent = "Extracting... Observe time and yield!";
            this.elements.resultEl.className = 'result-box mt-6 p-4 text-center';
            gsap.to(this.elements.espressoStream, { height: "60px", opacity: 0.8, duration: this.config.VISUALS.STREAM_ANIM_DURATION, ease: "power1.out" });
            if (this.steamTimeline) this.steamTimeline.pause().progress(0);
            gsap.set([this.elements.steamPath1, this.elements.steamPath2, this.elements.steamPath3], {opacity: 0, y:0});
            this.state.startTime = Date.now(); this.state.currentTimeSeconds = 0; this.state.currentYieldGrams = 0;
            this._updateVisuals();
            if (this.state.animationFrameId) cancelAnimationFrame(this.state.animationFrameId);
            this.state.animationFrameId = requestAnimationFrame(this._simulationStep.bind(this));
        }
        stop(autoStopped = false) {
            if (!this.state.isRunning && !autoStopped) return;
            this.state.isRunning = false;
            if (this.state.animationFrameId) cancelAnimationFrame(this.state.animationFrameId);
            this.elements.startBtn.classList.remove('hidden'); this.elements.stopBtn.classList.add('hidden');
            this.elements.startBtn.disabled = false; this.elements.stopBtn.disabled = true;
            this.elements.doseInput.disabled = false; this.elements.grindFineness.disabled = false;
            gsap.to(this.elements.espressoStream, { height: 0, opacity: 0, duration: this.config.VISUALS.STREAM_ANIM_DURATION + 0.1, ease: "power1.in" });
            const finalTime = parseFloat(this.state.currentTimeSeconds.toFixed(0));
            const finalYield = parseFloat(this.state.currentYieldGrams.toFixed(1));
            const targetYield = this.state.currentDose * this.config.DOSE_TO_YIELD_RATIO;
            if (this.onShotEnd) this.onShotEnd({ dose: this.state.currentDose, grind: this.state.currentGrind, time: finalTime, yield: finalYield, targetYield: targetYield, autoStopped: autoStopped });
            this._updateVisuals();
        }
    }

    const shotSimSection = BaristaApp.util.createInteractiveSection('Espresso Shot Simulator');
    shotSimSection.innerHTML = `
        <p class="text-sm mb-3 text-gray-300">Master the art of extraction. Adjust dose and grind, then pull the perfect shot. Aim for a 1:${SIM_DEFAULTS.DOSE_TO_YIELD_RATIO} ratio (e.g., ${SIM_DEFAULTS.DOSE}g in, ${SIM_DEFAULTS.DOSE * SIM_DEFAULTS.DOSE_TO_YIELD_RATIO}g out) in ${SIM_DEFAULTS.IDEAL_TIME_WINDOW.START}-${SIM_DEFAULTS.IDEAL_TIME_WINDOW.END} seconds.</p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center mb-6 p-4 bg-gray-700/30 rounded-lg shadow-md">
             <div class="flex flex-col items-center">
                <label for="simDoseInput" class="text-xs font-medium text-gray-400 block mb-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1 text-amber-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 8a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1zm0 4a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd" /><path d="M2 6a2 2 0 012-2h12a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zm14 0H4v8h12V6z" /></svg>
                    COFFEE DOSE (g)
                </label>
                <input type="number" id="simDoseInput" class="input-field bg-gray-600 p-2 rounded w-24 text-center border border-gray-500 focus:ring-amber-500 focus:border-amber-500 text-lg font-semibold">
                <p class="text-xs text-gray-400 mt-1">Target Yield: <strong id="simTargetYield" class="text-amber-300">N/Ag</strong></p>
            </div>
            <div class="flex flex-col items-center">
                <label for="simGrindFineness" class="text-xs font-medium text-gray-400 block mb-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1 text-amber-400" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 10-2 0v1.268a2 2 0 000 3.464V16a1 1 0 102 0V8.732a2 2 0 000-3.464V4zM16 3a1 1 0 011 1v7.268a2 2 0 010 3.464V16a1 1 0 11-2 0v-1.268a2 2 0 010-3.464V4a1 1 0 011-1z" /></svg>
                    GRIND FINENESS
                </label>
                <input type="range" id="simGrindFineness" class="w-full max-w-[150px] accent-amber-500 h-2.5 bg-gray-500 rounded-lg appearance-none cursor-pointer">
                <div class="flex items-center mt-1 space-x-2">
                    <svg id="grindVisualIndicator" width="${SIM_DEFAULTS.VISUALS.GRIND_PARTICLE_AREA_SIZE}" height="${SIM_DEFAULTS.VISUALS.GRIND_PARTICLE_AREA_SIZE}" class="bg-gray-800 rounded-sm"></svg>
                    <span id="simGrindFinenessValue" class="text-xs text-amber-300">Medium (N/A)</span>
                </div>
            </div>
            <div class="flex flex-col items-center md:items-start">
                <p class="text-sm text-gray-300 font-medium">TIME: <strong id="simTimer" class="text-2xl text-amber-400 tabular-nums">0</strong>s</p>
                <p class="text-sm text-gray-300 font-medium">YIELD: <strong id="simCurrentYield" class="text-2xl text-amber-400 tabular-nums">0.0</strong>g</p>
            </div>
        </div>

        <div class="flex justify-center items-end h-48 my-6 relative">
            <div id="espressoStream" class="absolute w-2 h-0 bg-gradient-to-b from-[#543a2a] via-[#6d4c41] to-transparent rounded-b-full" style="top: -20px; left: calc(50% - 4px); opacity:0; z-index: 10;"></div>

            <svg viewBox="0 0 100 135" class="w-36 h-auto absolute bottom-0 z-0">
                <defs>
                    <linearGradient id="cupBodyGradient" x1="0%" y1="0%" x2="100%" y2="50%">
                        <stop offset="0%" style="stop-color:#F5F5F5;"/>
                        <stop offset="60%" style="stop-color:#E0E0E0;"/>
                        <stop offset="100%" style="stop-color:#D5D5D5;"/>
                    </linearGradient>
                     <linearGradient id="saucerGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#E8E8E8;"/>
                        <stop offset="50%" style="stop-color:#DCDCDC;"/>
                        <stop offset="100%" style="stop-color:#D0D0D0;"/>
                    </linearGradient>
                    <linearGradient id="liquidFillGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#6D4C41;"/>
                        <stop offset="100%" style="stop-color:#533C30;"/>
                    </linearGradient>
                    <radialGradient id="cremaFillGradient" cx="50%" cy="50%" r="60%" fx="50%" fy="40%">
                        <stop offset="0%" style="stop-color:#E8D8C0; stop-opacity:0.95;"/>
                        <stop offset="50%" style="stop-color:#D7CCC8; stop-opacity:0.92;"/>
                        <stop offset="100%" style="stop-color:#C8B4A0; stop-opacity:0.9;"/>
                    </radialGradient>
                </defs>

                <ellipse cx="50" cy="123" rx="48" ry="11" fill="url(#saucerGradient)" stroke="#B0BEC5" stroke-width="1.5"/>
                <ellipse cx="50" cy="120" rx="22" ry="4.5" fill="#FFFFFF" opacity="0.2"/>

                <g transform="translate(0, -12)">
                    <path d="M20 100 C20 115, 80 115, 80 100 L78 35 Q78 20, 50 20 Q22 20, 22 35 Z"
                          fill="url(#cupBodyGradient)" stroke="#B0BEC5" stroke-width="2.5"/>
                    <path d="M78 50 C90 50, 90 75, 78 75"
                          stroke="url(#cupBodyGradient)" stroke-width="7" fill="none" stroke-linecap="round"/>
                     <path d="M78 50 C88 51, 88 74, 78 75"
                          stroke="#B0BEC5" stroke-width="2.5" fill="none"  stroke-linecap="round"/>

                    <path id="espressoLiquidFill" d="M50 100 L50 100 Q50 100 50 100 L50 100 Z" fill="url(#liquidFillGradient)" />
                    <ellipse id="espressoCremaLayer" cx="50" cy="100" rx="27" ry="0" fill="url(#cremaFillGradient)" style="opacity:0;"/>
                </g>

                <g id="steamGroup" transform="translate(50, 20)" style="pointer-events:none;">
                    <path id="steamPath1" d="M0 0 Q5 8 0 16 T0 32" stroke="#FFFFFF" stroke-width="1.5" fill="none" opacity="0"/>
                    <path id="steamPath2" d="M-3 0 Q2 10 -3 20 T-3 38" stroke="#FFFFFF" stroke-width="1.2" fill="none" opacity="0"/>
                    <path id="steamPath3" d="M3 0 Q-2 7 3 15 T3 30" stroke="#FFFFFF" stroke-width="1" fill="none" opacity="0"/>
                </g>
            </svg>
        </div>
        <div id="simProgressBarContainer" class="w-full h-2 bg-gray-600 rounded mt-1 mb-6 overflow-hidden border border-gray-500 relative">
            <div id="simProgressBar" class="h-full bg-gradient-to-r from-amber-600 to-amber-400 rounded" style="width: 0%; transition: width 0.2s linear;"></div>
            <div class="absolute top-0 left-[${SIM_DEFAULTS.PROGRESS_BAR_IDEAL_START_MARKER_PERCENT}%] h-full w-px bg-green-500/50" title="Ideal Start (${SIM_DEFAULTS.IDEAL_TIME_WINDOW.START}s)"></div>
            <div class="absolute top-0 left-[${SIM_DEFAULTS.PROGRESS_BAR_IDEAL_END_MARKER_PERCENT}%] h-full w-px bg-green-500/50" title="Ideal End (${SIM_DEFAULTS.IDEAL_TIME_WINDOW.END}s)"></div>
        </div>
        <div class="flex justify-center space-x-4 mt-4">
            <button id="startSimShotBtn" class="interactive-button px-8 py-3 text-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd" transform="rotate(90 10 10)"/></svg>
                Start Shot
            </button>
            <button id="stopSimShotBtn" class="interactive-button bg-red-600 hover:bg-red-700 px-8 py-3 text-lg hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v6a1 1 0 102 0V7z" clip-rule="evenodd" /></svg>
                Stop Shot
            </button>
        </div>
        <div id="shotSimResult" class="result-box mt-6 p-4 text-center" aria-live="polite">Enter dose, adjust grind, and start shot when ready.</div>`;
    container.appendChild(shotSimSection);

    const simElements = {
        doseInput: document.getElementById('simDoseInput'),
        grindFineness: document.getElementById('simGrindFineness'),
        grindFinenessValueEl: document.getElementById('simGrindFinenessValue'),
        grindVisualIndicator: document.getElementById('grindVisualIndicator'),
        targetYieldEl: document.getElementById('simTargetYield'),
        timerEl: document.getElementById('simTimer'),
        currentYieldEl: document.getElementById('simCurrentYield'),
        progressBar: document.getElementById('simProgressBar'),
        startBtn: document.getElementById('startSimShotBtn'),
        stopBtn: document.getElementById('stopSimShotBtn'),
        resultEl: document.getElementById('shotSimResult'),
        espressoLiquidFill: document.getElementById('espressoLiquidFill'),
        espressoCremaLayer: document.getElementById('espressoCremaLayer'),
        espressoStream: document.getElementById('espressoStream'),
        steamPath1: document.getElementById('steamPath1'),
        steamPath2: document.getElementById('steamPath2'),
        steamPath3: document.getElementById('steamPath3'),
    };

    const handleSimulatorShotEnd = (shotData) => {
        const { dose, grind, time, yield: finalYield, targetYield, autoStopped } = shotData;
        let message = autoStopped ? "SHOT AUTO-STOPPED (MAX TIME REACHED). <br/>" : `SHOT STOPPED. <br/>`;
        message += `Time: <strong class="text-amber-300">${time}s</strong> | Yield: <strong class="text-amber-300">${finalYield}g</strong> (Target: ${targetYield.toFixed(0)}g). <br/>`;
        let pointsAwarded = 0;
        let resultClass = 'incorrect-result';
        const yieldAchievedRatio = finalYield / targetYield;

        if (time >= SIM_DEFAULTS.IDEAL_TIME_WINDOW.START &&
            time <= SIM_DEFAULTS.IDEAL_TIME_WINDOW.END &&
            Math.abs(yieldAchievedRatio - 1) <= SIM_DEFAULTS.YIELD_TOLERANCE_PERCENTAGE) {
            message += "<span class='text-green-300'>EXCELLENT! Balanced extraction.</span>";
            pointsAwarded = SIM_DEFAULTS.SCORING.EXCELLENT_SHOT;
            resultClass = 'correct-result';
        } else {
            let tasteProfile = "";
            let advice = "";
            const isUnderExtracted = time < SIM_DEFAULTS.IDEAL_TIME_WINDOW.START - 3 || (yieldAchievedRatio < (1 - SIM_DEFAULTS.YIELD_TOLERANCE_PERCENTAGE - 0.05) && time < SIM_DEFAULTS.IDEAL_TIME_WINDOW.END + 3);
            const isOverExtracted = time > SIM_DEFAULTS.IDEAL_TIME_WINDOW.END + 3 || (yieldAchievedRatio > (1 + SIM_DEFAULTS.YIELD_TOLERANCE_PERCENTAGE + 0.05) && time > SIM_DEFAULTS.IDEAL_TIME_WINDOW.START - 3);

            if (isUnderExtracted) {
                tasteProfile = "<span class='text-red-400'>LIKELY UNDER-EXTRACTED (SOUR, WEAK).</span>";
                if (grind < 65) advice = "Try grinding finer."; else advice = "Flow too fast. Check dose/tamp if grind is fine.";
            } else if (isOverExtracted) {
                tasteProfile = "<span class='text-red-400'>LIKELY OVER-EXTRACTED (BITTER, HARSH).</span>";
                if (grind > 35) advice = "Try grinding coarser."; else advice = "Flow too slow. Check dose/tamp if grind is coarse.";
            } else {
                tasteProfile = "<span class='text-yellow-400'>ALMOST THERE!</span>";
                advice = "Small adjustments can perfect it.";
                pointsAwarded = SIM_DEFAULTS.SCORING.ALMOST_THERE_SHOT;
                resultClass = '';
            }
            message += `${tasteProfile} ${advice}`;
            if (pointsAwarded === 0 && !autoStopped) pointsAwarded = SIM_DEFAULTS.SCORING.ATTEMPTED_SHOT;
            else if (pointsAwarded === 0 && autoStopped) pointsAwarded = 1;
        }
        if (pointsAwarded > 0) {
            message += ` (+${pointsAwarded} points)`;
            BaristaApp.dataManager.addPoints(pointsAwarded);
        }
        simElements.resultEl.innerHTML = message;
        simElements.resultEl.className = `result-box mt-6 p-4 text-center ${resultClass}`;
        BaristaApp.util.trackAnalytics(`Day 4: Shot sim - D:${dose}g Grind:${grind} -> T:${time}s Y:${finalYield}g (Target Y:${targetYield.toFixed(0)}g) Pts:${pointsAwarded}`);
    };

    const espressoSim = new EspressoSimulator(SIM_DEFAULTS, simElements, handleSimulatorShotEnd);

    simElements.startBtn.addEventListener('click', () => espressoSim.start());
    simElements.stopBtn.addEventListener('click', () => espressoSim.stop(false));

    const cremaSection = BaristaApp.util.createInteractiveSection('Crema Quality Check');
    cremaSection.innerHTML = `<p class="text-sm mb-3 text-gray-300">A good crema is an indicator of freshness and proper extraction. Select the image depicting the ideal crema.</p>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 image-gallery">
            <div class="relative group cursor-pointer rounded-lg overflow-hidden border-4 border-transparent hover:border-amber-400 transition-all duration-200 focus-within:border-amber-500 focus-within:ring-2 focus-within:ring-amber-500 focus-within:ring-offset-2 focus-within:ring-offset-gray-800" tabindex="0" data-crema-img data-correct="true" aria-label="Select image A: Rich and Smooth Crema">
                <img src="images/d4-good-crema.jpg" alt="Good Crema: Rich, reddish-brown, smooth, persistent" class="w-full h-40 object-cover">
                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-opacity duration-200"></div>
                <p class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-60 text-white text-xs p-1.5 text-center">A. Rich & Smooth</p>
            </div>
            <div class="relative group cursor-pointer rounded-lg overflow-hidden border-4 border-transparent hover:border-amber-400 transition-all duration-200 focus-within:border-amber-500 focus-within:ring-2 focus-within:ring-amber-500 focus-within:ring-offset-2 focus-within:ring-offset-gray-800" tabindex="0" data-crema-img data-correct="false" aria-label="Select image B: Pale and Bubbly Crema">
                <img src="images/d4-bad-crema1.jpg" alt="Thin/Bubbly Crema: Pale, large bubbles, dissipates quickly" class="w-full h-40 object-cover">
                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-opacity duration-200"></div>
                <p class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-60 text-white text-xs p-1.5 text-center">B. Pale & Bubbly</p>
            </div>
            <div class="relative group cursor-pointer rounded-lg overflow-hidden border-4 border-transparent hover:border-amber-400 transition-all duration-200 focus-within:border-amber-500 focus-within:ring-2 focus-within:ring-amber-500 focus-within:ring-offset-2 focus-within:ring-offset-gray-800" tabindex="0" data-crema-img data-correct="false" aria-label="Select image C: Dark and Spotty Crema">
                <img src="images/d4-bad-crema2.jpg" alt="Too Dark/Spotty Crema: May indicate over-extraction or channeling" class="w-full h-40 object-cover">
                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-opacity duration-200"></div>
                <p class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-60 text-white text-xs p-1.5 text-center">C. Dark & Spotty</p>
            </div>
        </div>
        <div id="cremaResult" class="result-box mt-4 p-3 text-center" aria-live="polite">Select an image.</div>`;
    container.appendChild(cremaSection);
    const cremaResultEl = cremaSection.querySelector('#cremaResult');
    cremaSection.querySelectorAll('[data-crema-img]').forEach(imgContainer => {
        const handleCremaSelection = function() {
            if (cremaSection.dataset.answered === 'true' || !cremaResultEl) return;
            const isCorrect = this.dataset.correct === "true";
            const imgAlt = this.querySelector('img').alt;
            cremaSection.querySelectorAll('[data-crema-img]').forEach(el => {
                el.classList.remove('border-amber-500', 'ring-2', 'ring-amber-500', 'ring-offset-2', 'ring-offset-gray-800', 'border-green-500', 'border-red-500');
                el.classList.add('border-transparent', 'opacity-60'); el.style.pointerEvents = 'none'; el.setAttribute('aria-selected', 'false');
            });
            this.classList.remove('opacity-60');
            this.classList.add(isCorrect ? 'border-green-500' : 'border-red-500');
            this.classList.add('ring-2', isCorrect ? 'ring-green-500' : 'ring-red-500', 'ring-offset-2', 'ring-offset-gray-800');
            this.setAttribute('aria-selected', 'true');
            let pointsAwarded = 0;
            if (isCorrect) {
                cremaResultEl.innerHTML = `<strong>Correct!</strong> "${imgAlt}" shows excellent crema. (+${SIM_DEFAULTS.SCORING.CORRECT_CREMA} points)`;
                cremaResultEl.className = 'result-box mt-4 p-3 text-center correct-result';
                pointsAwarded = SIM_DEFAULTS.SCORING.CORRECT_CREMA;
            } else {
                cremaResultEl.innerHTML = `<strong>Not quite.</strong> "${imgAlt}" is not ideal. The best crema is rich, reddish-brown, and smooth.`;
                cremaResultEl.className = 'result-box mt-4 p-3 text-center incorrect-result';
                const correctImageDiv = cremaSection.querySelector('[data-crema-img][data-correct="true"]');
                if (correctImageDiv) { correctImageDiv.classList.remove('opacity-60', 'border-transparent'); correctImageDiv.classList.add('border-green-500', 'ring-2', 'ring-green-500'); }
            }
            if (pointsAwarded > 0) BaristaApp.dataManager.addPoints(pointsAwarded);
            BaristaApp.util.trackAnalytics(`Day 4: Crema check - selected "${imgAlt}", Correct: ${isCorrect}, Pts: ${pointsAwarded}`);
            cremaSection.dataset.answered = 'true';
        };
        imgContainer.addEventListener('click', handleCremaSelection);
        imgContainer.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); handleCremaSelection.call(imgContainer); } });
    });

},
setupDay5: function() {
const container = document.getElementById('practicalInteractiveContent');
if (!container) return;

const scenarios = [
    {
        desc: "Your espresso (18g in, 36g out) pulled in 15 seconds and tastes very sour and thin.",
        options: ["Grind Finer", "Grind Coarser", "Use More Coffee (Increase Dose)", "Use Less Coffee (Decrease Dose)"],
        correctAnswer: "Grind Finer",
        explanation: "Sourness and a fast shot (under-extraction) usually mean the water passed through too quickly. Grinding finer will increase resistance and slow down the shot, allowing for more extraction."
    },
    {
        desc: "Your espresso (18g in, 36g out) took 40 seconds to pull and tastes very bitter and harsh.",
        options: ["Grind Finer", "Grind Coarser", "Tamp Much Harder", "Use Hotter Water"],
        correctAnswer: "Grind Coarser",
        explanation: "Bitterness and a slow shot (over-extraction) often mean the water was in contact with the coffee for too long or the grind was too fine. Grinding coarser will reduce resistance and speed up the shot."
    },
    {
        desc: "Your espresso looks okay (28 seconds, 36g out from 18g in), but tastes a little weak and slightly sour. You've already tried grinding finer, but it made the shot too slow.",
        options: ["Grind even Finer", "Grind Coarser", "Slightly Increase Dose (e.g., to 18.5g)", "Slightly Decrease Dose (e.g., to 17.5g)"],
        correctAnswer: "Slightly Increase Dose (e.g., to 18.5g)",
        explanation: "If grind adjustments aren't hitting the mark, a slight increase in dose can sometimes add body and sweetness, reducing perceived sourness, assuming your extraction time is good."
    }
];

const troubleshootSection = BaristaApp.util.createInteractiveSection('Virtual Espresso Troubleshooting');
troubleshootSection.innerHTML += `<p class="text-sm mb-2 text-gray-300">Read each scenario and choose the MOST LIKELY primary adjustment to make. Focus on grind first, then dose if needed.</p><div id="troubleshootScenarios"></div>`;
container.appendChild(troubleshootSection);
const scenariosContainer = document.getElementById('troubleshootScenarios');
if(!scenariosContainer) return;

scenarios.forEach((scenario, index) => {
    let scenarioHTML = `<div class="mb-6 p-4 bg-gray-700/40 rounded-lg shadow">
                            <p class="font-semibold mb-3 text-gray-200">${index + 1}. ${scenario.desc}</p>
                            <div class="space-y-2">`;
    scenario.options.forEach(opt => {
        scenarioHTML += `<div class="interactive-choice troubleshoot-option" data-scenario-idx="${index}" data-option-text="${opt}" role="button" tabindex="0">${opt}</div>`;
    });
    scenarioHTML += `</div><div id="troubleshootResult-${index}" class="result-box mt-3 hidden"></div></div>`;
    scenariosContainer.innerHTML += scenarioHTML;
});

document.querySelectorAll('.troubleshoot-option').forEach(choice => {
    const handleTroubleshoot = () => {
        const scenarioIdx = parseInt(choice.dataset.scenarioIdx);
        const selectedOptionText = choice.dataset.optionText;
        const currentScenario = scenarios[scenarioIdx];
        const resultEl = document.getElementById(`troubleshootResult-${scenarioIdx}`);
        if(!resultEl || !choice.parentElement || choice.parentElement.dataset.answered === 'true') return; // Prevent re-answering

        choice.parentElement.querySelectorAll('.troubleshoot-option').forEach(opt => {
            opt.classList.remove('selected', 'correct', 'incorrect', 'disabled');
             opt.classList.add('disabled'); // Disable all options after one is chosen
        });
        choice.classList.add('selected');
        choice.parentElement.dataset.answered = 'true'; // Mark this scenario as answered

        if (selectedOptionText === currentScenario.correctAnswer) {
            resultEl.innerHTML = `<strong class="text-green-300">Correct!</strong> ${currentScenario.explanation} (+5 points).`;
            resultEl.className = 'result-box mt-3 correct-result';
            choice.classList.add('correct');
            BaristaApp.dataManager.addPoints(5);
        } else {
            resultEl.innerHTML = `<strong class="text-red-400">Not quite.</strong> While other adjustments might play a role, the primary fix is often related to grind or dose. The best answer here is: <em>${currentScenario.correctAnswer}</em>. ${currentScenario.explanation}`;
            resultEl.className = 'result-box mt-3 incorrect-result';
            choice.classList.add('incorrect');
            const correctOptEl = choice.parentElement.querySelector(`.troubleshoot-option[data-option-text="${currentScenario.correctAnswer}"]`);
            if(correctOptEl) correctOptEl.classList.add('correct');
        }
        resultEl.classList.remove('hidden');
        gsap.from(resultEl, {opacity: 0, height: 0, duration: 0.3, ease: "power1.out"});
        BaristaApp.util.trackAnalytics(`Day 5: Troubleshoot scenario ${scenarioIdx} - chose ${selectedOptionText}`);
    };
    choice.addEventListener('click', handleTroubleshoot);
    choice.addEventListener('keydown', (e) => { if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); handleTroubleshoot.call(choice); }});
});

const grindAdjVizSection = BaristaApp.util.createInteractiveSection('Grind Adjustment Visualizer');
grindAdjVizSection.innerHTML = `<p class="text-sm mb-2 text-gray-300">See how grind conceptually affects extraction time and taste.</p>
    <div class="flex flex-col sm:flex-row justify-around my-3 gap-3">
        <button class="interactive-button grind-sim-btn flex-1" data-grind="Coarse">Too Coarse</button>
        <button class="interactive-button grind-sim-btn flex-1 bg-green-600 hover:bg-green-700" data-grind="Ideal">Ideal (Espresso)</button>
        <button class="interactive-button grind-sim-btn flex-1" data-grind="Fine">Too Fine</button>
    </div>
    <div id="grindSimResult" class="result-box mt-3">Click a grind setting above.</div>`;
container.appendChild(grindAdjVizSection);

document.querySelectorAll('.grind-sim-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const grindType = this.dataset.grind;
        const resultEl = document.getElementById('grindSimResult');
        if(!resultEl) return;
        let message = "";
        if (grindType === "Coarse") {
            message = "<strong>Too Coarse:</strong> Water flows through very quickly (e.g., <15-20s). Likely results in a SOUR, thin, under-extracted shot.";
            resultEl.className = 'result-box mt-3 incorrect-result';
        } else if (grindType === "Ideal") {
            message = "<strong>Ideal Grind:</strong> Water flows at the right speed (e.g., 25-30s). Aims for a BALANCED, sweet shot with good body.";
            resultEl.className = 'result-box mt-3 correct-result';
        } else if (grindType === "Fine") {
            message = "<strong>Too Fine:</strong> Water flows very slowly or chokes the machine (e.g., >35-40s). Likely results in a BITTER, harsh, over-extracted shot.";
             resultEl.className = 'result-box mt-3 incorrect-result';
        }
        resultEl.innerHTML = message;
        BaristaApp.util.trackAnalytics(`Day 5: Grind sim viz - ${grindType}`);
    });
});
},
setupDay6: function() {
const container = document.getElementById('practicalInteractiveContent');
if (!container) return;

const milkGallerySection = BaristaApp.util.createInteractiveSection('Milk Gallery & Characteristics');
const milks = [
    { name: "Whole Dairy Milk", img: "images/d6-whole-milk.jpg", info: "Typically 3.25-3.5% fat. Excellent for steaming due to good balance of fats and proteins, creating creamy, stable microfoam. Naturally sweet." },
    { name: "Skim Dairy Milk", img: "images/d6-skim-milk.jpg", info: "Low/no fat. Can be harder to get velvety foam; often produces stiffer, drier foam. Less rich flavor." },
    { name: "Oat Milk (Barista Blend)", img: "images/d6-oat-milk.jpg", info: "Very popular. Steams exceptionally well, creating creamy microfoam. Flavor is relatively neutral and slightly sweet. Often formulated for coffee." },
    { name: "Soy Milk (Barista Blend)", img: "images/d6-soy-milk.jpg", info: "Good steaming capabilities, especially barista versions. Can have a distinct soy flavor. Check for unsweetened versions." },
    { name: "Almond Milk (Barista Blend)", img: "images/d6-almond-milk.jpg", info: "Can be tricky; lower protein/fat. Barista blends are better, designed to prevent splitting and improve foam. Nutty flavor." }
];
milkGallerySection.innerHTML += `<p class="text-sm mb-2 text-gray-300">Click on a milk type to learn about its characteristics for coffee.</p>
    <div class="flex flex-wrap justify-center image-gallery">
        ${milks.map(milk => `<img src="${milk.img}" alt="${milk.name}" data-info="${milk.info}" tabindex="0" role="button" aria-label="Select ${milk.name}">`).join('')}
    </div>
    <div id="milkGalleryInfo" class="result-box mt-3">Select a milk type.</div>`;
container.appendChild(milkGallerySection);
milkGallerySection.querySelectorAll('.image-gallery img').forEach(img => {
    const handleMilkSelect = () => {
        milkGallerySection.querySelectorAll('.image-gallery img').forEach(i => i.classList.remove('selected-img'));
        img.classList.add('selected-img');
        const milkGalleryInfoEl = document.getElementById('milkGalleryInfo');
        if(milkGalleryInfoEl) {
             milkGalleryInfoEl.textContent = `${img.alt}: ${img.dataset.info}`;
             milkGalleryInfoEl.className = 'result-box mt-3';
        }
        BaristaApp.util.trackAnalytics(`Day 6: Viewed milk type - ${img.alt}`);
    };
    img.addEventListener('click', handleMilkSelect);
    img.addEventListener('keydown', (e) => { if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); handleMilkSelect(); }});
});

const thermometerSection = BaristaApp.util.createInteractiveSection('Interactive Milk Thermometer');
thermometerSection.innerHTML += `<p class="text-sm mb-2 text-gray-300">Drag the slider to simulate milk temperature. Aim for the ideal sweetness range (55-65°C or 130-150°F).</p>
    <label for="milkTempSlider" class="sr-only">Milk Temperature</label>
    <input type="range" id="milkTempSlider" min="20" max="85" value="20" class="w-full accent-amber-500 my-3 h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
    <p class="text-center text-xl my-2 font-semibold"><span id="milkTempValue">20</span>°C (<span id="milkTempFahrenheit">68</span>°F)</p>
    <div id="milkTempFeedback" class="result-box mt-3">Adjust temperature to see feedback.</div>`;
container.appendChild(thermometerSection);
const tempSlider = document.getElementById('milkTempSlider');
const tempValueEl = document.getElementById('milkTempValue');
const tempFahrenheitEl = document.getElementById('milkTempFahrenheit');
const tempFeedbackEl = document.getElementById('milkTempFeedback');

const updateTempFeedback = () => {
    if(!tempSlider || !tempValueEl || !tempFahrenheitEl || !tempFeedbackEl) return;
    const tempC = parseInt(tempSlider.value);
    const tempF = Math.round(tempC * 9/5 + 32);
    tempValueEl.textContent = tempC;
    tempFahrenheitEl.textContent = tempF;

    let feedbackMsg = "";
    let feedbackClass = 'result-box mt-3';
    let pointsAwarded = 0;

    if (tempC < 50) {
        feedbackMsg = `Too Cold (${tempC}°C): Milk won't be sweet enough, texture will be poor, and drink will be lukewarm.`;
        feedbackClass += ' incorrect-result';
    } else if (tempC >= 50 && tempC < 55) {
        feedbackMsg = `Getting Warmer (${tempC}°C): Approaching ideal, but still a bit cool for optimal sweetness and texture.`;
    } else if (tempC >= 55 && tempC <= 65) {
        feedbackMsg = `Ideal Range! (${tempC}°C): Perfect for sweetness, texture, and drinkable temperature.`;
        feedbackClass += ' correct-result';
        if (!tempFeedbackEl.dataset.pointsAwardedInRange) {
             pointsAwarded = 5;
             tempFeedbackEl.dataset.pointsAwardedInRange = "true";
        }
    } else if (tempC > 65 && tempC <= 70) {
        feedbackMsg = `Getting Hot (${tempC}°C): Risk of losing sweetness and foam quality. Be careful!`;
         delete tempFeedbackEl.dataset.pointsAwardedInRange;
    } else {
        feedbackMsg = `Scalded! (${tempC}°C): Milk will taste burnt, proteins denature, and foam will be poor. Avoid this.`;
        feedbackClass += ' incorrect-result';
        delete tempFeedbackEl.dataset.pointsAwardedInRange;
    }

    if (pointsAwarded > 0) {
        feedbackMsg += ` (+${pointsAwarded} points)`;
        BaristaApp.dataManager.addPoints(pointsAwarded);
    }
    tempFeedbackEl.textContent = feedbackMsg;
    tempFeedbackEl.className = feedbackClass;
    BaristaApp.util.trackAnalytics(`Day 6: Milk temp slider at ${tempC}°C`);
};
if(tempSlider) tempSlider.addEventListener('input', updateTempFeedback);
updateTempFeedback();

const baristaBlendsSection = BaristaApp.util.createInteractiveSection('Why "Barista Blend" Plant Milks?');
baristaBlendsSection.innerHTML += `<p class="text-sm text-gray-300">You'll often see "Barista Blend" or "Barista Edition" on plant-based milks in cafes. Here's why:
    <ul class="list-disc list-inside text-sm mt-2 space-y-1 text-gray-400">
        <li><strong>Improved Steaming:</strong> They contain added fats, proteins, or stabilizers (like gellan gum or oils) to help them create better, more stable microfoam, similar to dairy milk.</li>
        <li><strong>Reduced Curdling:</strong> Coffee is acidic. Some regular plant milks can curdle or split when added to hot coffee. Barista blends are often formulated to be more stable at higher temperatures and with coffee's acidity.</li>
        <li><strong>Flavor Neutrality:</strong> Some are designed to have a more neutral flavor that doesn't overpower the coffee.</li>
    </ul></p>
    <p class="text-sm text-gray-300 mt-2">While you can steam regular plant milks, barista blends generally offer more consistent and superior results for coffee drinks.</p>`;
container.appendChild(baristaBlendsSection);
},
setupDay7: function() {
    const container = document.getElementById('practicalInteractiveContent');
    if (!container) return;

    const animWandSection = BaristaApp.util.createInteractiveSection('Animated Steam Wand Guide (Conceptual)');
    animWandSection.innerHTML = `<p class="text-sm mb-2 text-gray-300">Click buttons to see conceptual steam wand positions and milk movement for the two main steaming phases.</p>
        <div class="relative bg-gray-700/50 h-56 rounded-md p-3 my-3 flex items-center justify-center border border-gray-600 overflow-hidden"> <!-- Added overflow-hidden -->
            <img id="pitcherImg" src="images/d7-milk-pitcher.jpg" alt="Milk Pitcher with Milk" class="h-48 opacity-80">
            <div id="steamWandVisual" class="absolute w-2.5 h-28 bg-gray-400 rounded-t-full border-2 border-gray-300 shadow-md" style="bottom: 30px; left: 48%; transform-origin: top center;"></div>
            <div id="milkSurfaceVisual" class="absolute w-3/5 h-1 bg-blue-300/70" style="bottom: 90px; left: 20%;"></div>
            <div id="milkWhirlpoolVisual" class="absolute w-16 h-16 border-2 border-dashed border-blue-200/50 rounded-full opacity-0" style="bottom: 40px; left: calc(50% - 32px);"></div>
        </div>
        <div class="flex flex-col sm:flex-row justify-around my-3 gap-3">
            <button class="interactive-button steam-phase-btn flex-1" data-phase="stretch">1. Stretching Phase (Aeration)</button>
            <button class="interactive-button steam-phase-btn flex-1" data-phase="texture">2. Texturing Phase (Emulsification)</button>
        </div>
        <div id="steamWandInfo" class="result-box mt-3">Click a phase to see the conceptual animation and explanation.</div>`;
    container.appendChild(animWandSection);
    const steamWandVisual = document.getElementById('steamWandVisual');
    const milkSurfaceVisual = document.getElementById('milkSurfaceVisual');
    const milkWhirlpoolVisual = document.getElementById('milkWhirlpoolVisual');
    const steamWandInfo = document.getElementById('steamWandInfo');

    if(steamWandVisual && milkSurfaceVisual && milkWhirlpoolVisual && steamWandInfo){
        let whirlpoolAnimation; // To control the GSAP animation instance

        document.querySelectorAll('.steam-phase-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const phase = this.dataset.phase;
                if(whirlpoolAnimation) whirlpoolAnimation.kill(); // Kill previous animation
                gsap.killTweensOf([steamWandVisual, milkSurfaceVisual, milkWhirlpoolVisual]); // Kill other tweens

                if (phase === "stretch") {
                    steamWandInfo.innerHTML = "<strong>Stretching Phase:</strong> Wand tip is just below the milk surface, introducing air. You'd hear a gentle 'tearing paper' sound. Milk volume increases.";
                    gsap.to(steamWandVisual, { duration: 0.5, rotation: 10, y: -10, ease: "power1.inOut" });
                    gsap.to(milkSurfaceVisual, { duration: 0.5, y: -15, scaleY: 1.2, ease: "power1.inOut" });
                    gsap.to(milkWhirlpoolVisual, { duration: 0.3, opacity: 0, scale: 0.5 });
                } else if (phase === "texture") {
                    steamWandInfo.innerHTML = "<strong>Texturing Phase:</strong> Wand is submerged deeper, creating a whirlpool. This breaks down air bubbles into microfoam and heats the milk. Sound becomes quieter.";
                    gsap.to(steamWandVisual, { duration: 0.5, rotation: -5, y: 5, ease: "power1.inOut" });
                    gsap.to(milkSurfaceVisual, { duration: 0.5, y: 0, scaleY: 1, ease: "power1.inOut" });
                    gsap.set(milkWhirlpoolVisual, {rotation: 0}); // Reset rotation before starting
                    whirlpoolAnimation = gsap.to(milkWhirlpoolVisual, { duration: 0.8, opacity: 1, scale: 1, rotation: 360, repeat: -1, ease: "none" });
                }
                 steamWandInfo.className = 'result-box mt-3';
                BaristaApp.util.trackAnalytics(`Day 7: Steam wand viz - ${phase}`);
            });
        });
    }

    const qualitySortSection = BaristaApp.util.createInteractiveSection('Microfoam Quality Sort');
    const foamImages = [
        { src: "images/d7-good-microfoam.jpg", quality: "good", alt: "Good Microfoam: Smooth, velvety, like wet paint, no visible bubbles." },
        { src: "images/d7-bubbly-foam.jpg", quality: "bad", alt: "Bubbly Foam: Large, distinct air bubbles, not integrated." },
            { src: "images/d7-thin-foam.jpg", quality: "bad", alt: "Thin/Watery Foam: Under-aerated, not enough texture." },
        { src: "images/d7-dry-foam.jpg", quality: "bad_for_latte", alt: "Stiff/Dry Foam: Over-aerated, too thick for latte art, more like old-style cappuccino foam." }
    ];
    qualitySortSection.innerHTML = `<p class="text-sm mb-2 text-gray-300">Click the image that shows the BEST microfoam suitable for a latte.</p>
        <div class="flex flex-wrap justify-around image-gallery">
            ${foamImages.map(img => `<img src="${img.src}" alt="${img.alt}" data-quality="${img.quality}" tabindex="0" role="button" aria-label="Select image of ${img.alt}">`).join('')}
        </div>
        <div id="foamSortResult" class="result-box mt-3">Click an image to evaluate its microfoam quality.</div>`;
    container.appendChild(qualitySortSection);
    qualitySortSection.querySelectorAll('.image-gallery img').forEach(img => {
        const handleFoamSelect = () => {
             if (qualitySortSection.dataset.answered === 'true') return; // Prevent re-answering

            qualitySortSection.querySelectorAll('.image-gallery img').forEach(i => {
                i.classList.remove('selected-img', 'correct', 'incorrect');
                i.classList.add('opacity-50'); // Dim all images initially
            });
            img.classList.remove('opacity-50'); // Undim the selected one
            img.classList.add('selected-img');
            const resultEl = document.getElementById('foamSortResult');
            if(!resultEl) return;
            const quality = img.dataset.quality;
            let pointsAwarded = 0;

            if (quality === "good") {
                resultEl.innerHTML = `<strong>Correct!</strong> ${img.alt} This is ideal microfoam for lattes. (+5 points)`;
                resultEl.className = 'result-box mt-3 correct-result'; img.classList.add('correct');
                pointsAwarded = 5;
            } else if (quality === "bad_for_latte"){
                resultEl.innerHTML = `<strong>Not ideal for a latte.</strong> ${img.alt} While this foam might be used in some drinks, it's too stiff for typical latte art and velvety texture.`;
                resultEl.className = 'result-box mt-3 incorrect-result'; img.classList.add('incorrect');
            } else {
                 resultEl.innerHTML = `<strong>Needs Improvement.</strong> ${img.alt} This isn't the smooth, integrated microfoam we're aiming for.`;
                resultEl.className = 'result-box mt-3 incorrect-result'; img.classList.add('incorrect');
            }
            // Highlight correct answer regardless
             qualitySortSection.querySelector('img[data-quality="good"]').classList.remove('opacity-50');
             qualitySortSection.querySelector('img[data-quality="good"]').classList.add('correct');

            if(pointsAwarded > 0) BaristaApp.dataManager.addPoints(pointsAwarded);
            BaristaApp.util.trackAnalytics(`Day 7: Microfoam sort - selected ${img.alt}`);
            qualitySortSection.dataset.answered = 'true'; // Mark as answered
        };
        img.addEventListener('click', handleFoamSelect);
        img.addEventListener('keydown', (e) => {if(e.key === 'Enter' || e.key === ' ') {e.preventDefault(); handleFoamSelect();}});
    });

    const soundSection = BaristaApp.util.createInteractiveSection('Conceptual Steaming Sounds');
    soundSection.innerHTML = `<p class="text-sm mb-2 text-gray-300">Imagine the sounds of steaming. Click the description that matches the ideal 'stretching' phase.</p>
        <div class="flex flex-col space-y-2">
            <div class="interactive-choice sound-choice" data-sound-type="good_stretch" role="button" tabindex="0">A) Gentle, consistent 'tearing paper' or 'psst-psst' sound.</div>
            <div class="interactive-choice sound-choice" data-sound-type="bad_scream" role="button" tabindex="0">B) Loud, high-pitched 'screaming' or 'whistling' sound.</div>
            <div class="interactive-choice sound-choice" data-sound-type="bad_bubble" role="button" tabindex="0">C) Deep, aggressive 'glugging' or 'bubbling' sound.</div>
            <div class="interactive-choice sound-choice" data-sound-type="too_quiet" role="button" tabindex="0">D) Almost complete silence, just a faint hiss.</div>
        </div>
        <div id="soundResult" class="result-box mt-3">Select the sound description for good stretching.</div>`;
    container.appendChild(soundSection);
    soundSection.querySelectorAll('.sound-choice').forEach(choice => {
        const handleSoundChoice = () => {
            if (soundSection.dataset.answered === 'true') return; // Prevent re-answering
            soundSection.querySelectorAll('.sound-choice').forEach(c => c.classList.remove('selected','correct','incorrect', 'disabled'));
            choice.classList.add('selected');
            soundSection.dataset.answered = 'true'; // Mark as answered

            const resultEl = document.getElementById('soundResult');
            if(!resultEl) return;
            const soundType = choice.dataset.soundType;
            let pointsAwarded = 0;

            if (soundType === "good_stretch") {
                resultEl.innerHTML = `<strong>Correct!</strong> This sound indicates you're gently incorporating air. (+5 points)`;
                resultEl.className = 'result-box mt-3 correct-result'; choice.classList.add('correct');
                pointsAwarded = 5;
            } else if (soundType === "too_quiet") {
                 resultEl.innerHTML = `<strong>Incorrect.</strong> This sound usually means the wand is too deep and you're only heating, not texturing effectively during the stretching phase. The ideal stretching sound is a gentle 'tearing paper'.`;
                resultEl.className = 'result-box mt-3 incorrect-result'; choice.classList.add('incorrect');
            }
            else {
                resultEl.innerHTML = `<strong>Incorrect.</strong> This sound usually indicates poor technique (e.g., wand too deep or too shallow, creating large bubbles). The ideal stretching sound is a gentle 'tearing paper'.`;
                resultEl.className = 'result-box mt-3 incorrect-result'; choice.classList.add('incorrect');
            }
            // Highlight correct choice and disable others
            soundSection.querySelectorAll('.sound-choice').forEach(c => c.classList.add('disabled'));
            soundSection.querySelector('.sound-choice[data-sound-type="good_stretch"]').classList.remove('disabled');
            soundSection.querySelector('.sound-choice[data-sound-type="good_stretch"]').classList.add('correct');

             if(pointsAwarded > 0) BaristaApp.dataManager.addPoints(pointsAwarded);
            BaristaApp.util.trackAnalytics(`Day 7: Steaming sound choice - ${soundType}`);
        };
        choice.addEventListener('click', handleSoundChoice);
        choice.addEventListener('keydown', (e) => { if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); handleSoundChoice(); }});
    });
},
setupDay8: function() {
    const container = document.getElementById('practicalInteractiveContent');
    if (!container) return;

    const deconstructSection = BaristaApp.util.createInteractiveSection('Drink Deconstructor & Visuals');
    const drinks = {
        Americano: { layers: "Espresso + Hot Water (Crema often preserved on top).", visual: `<div class="w-16 h-24 border-2 border-gray-400 rounded-b-md flex flex-col items-center justify-end mx-auto shadow-inner bg-white"><div class="bg-amber-700 h-1/4 w-full"></div><div style="background:rgba(0,0,0,0.7);" class="h-3/4 w-full"></div></div>` },
        Latte: { layers: "Espresso + Steamed Milk + Thin (~0.5cm) Microfoam Layer (Often with latte art).", visual: `<div class="w-16 h-24 border-2 border-gray-400 rounded-b-md flex flex-col items-center justify-end mx-auto shadow-inner bg-white"><div class="bg-amber-100 h-1/6 w-full"></div><div class="bg-orange-300 h-4/6 w-full"></div><div class="bg-amber-700 h-1/6 w-full"></div></div>` },
        Cappuccino: { layers: "Espresso + Steamed Milk + Thicker (~1-2cm) Microfoam Layer (Distinct foam cap).", visual: `<div class="w-16 h-24 border-2 border-gray-400 rounded-b-md flex flex-col items-center justify-end mx-auto shadow-inner bg-white"><div class="bg-amber-100 h-2/5 w-full"></div><div class="bg-orange-300 h-2/5 w-full"></div><div class="bg-amber-700 h-1/5 w-full"></div></div>` }
    };
    deconstructSection.innerHTML = `<p class="text-sm mb-2 text-gray-300">Click a drink name to see its typical layers and visual representation.</p>
        <div class="flex flex-wrap justify-around my-3 gap-3">
            ${Object.keys(drinks).map(drinkName => `<button class="interactive-button drink-decon-btn flex-1" data-drink-name="${drinkName}">${drinkName}</button>`).join('')}
        </div>
        <div class="flex flex-col sm:flex-row items-center gap-4 mt-4 p-4 bg-gray-700/30 rounded-lg">
            <div id="drinkDeconVisual" class="w-20 h-28 flex items-center justify-center text-gray-400 text-xs">Select Drink</div>
            <div id="drinkLayersInfo" class="result-box flex-1">Drink composition will appear here.</div>
        </div>`;
    container.appendChild(deconstructSection);

deconstructSection.querySelectorAll('.drink-decon-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        deconstructSection.querySelectorAll('.drink-decon-btn').forEach(b => b.classList.remove('selected'));
        this.classList.add('selected');
        const drinkName = this.dataset.drinkName;
        const drinkDeconVisualEl = document.getElementById('drinkDeconVisual');
        const drinkLayersInfoEl = document.getElementById('drinkLayersInfo');

        if (drinks[drinkName]) {
            if(drinkDeconVisualEl) {
                gsap.fromTo(drinkDeconVisualEl, {opacity:0, scale:0.8}, {opacity:1, scale:1, duration:0.3, ease:'back.out(1.4)', onStart: () => drinkDeconVisualEl.innerHTML = drinks[drinkName].visual});
            }
            if(drinkLayersInfoEl) {
                gsap.fromTo(drinkLayersInfoEl, {opacity:0, y:10}, {opacity:1, y:0, duration:0.3, ease:'power1.out', onStart: () => {
                    drinkLayersInfoEl.innerHTML = `<strong>${drinkName}:</strong> ${drinks[drinkName].layers}`;
                    drinkLayersInfoEl.className = 'result-box flex-1';
                }});
            }
        } else {
            if(drinkDeconVisualEl) drinkDeconVisualEl.innerHTML = 'Select Drink';
            if(drinkLayersInfoEl) {
                drinkLayersInfoEl.innerHTML = 'Drink composition will appear here.';
                drinkLayersInfoEl.className = 'result-box flex-1';
            }
        }
        BaristaApp.util.trackAnalytics(`Day 8: Deconstructed ${drinkName}`);
    });
});


const buildSection = BaristaApp.util.createInteractiveSection('Virtual Drink Builder');
const components = [
    { name: "Espresso Shot", icon: "☕️<span class='text-xs'>Espresso</span>", id: "espresso", color: "bg-amber-800" },
    { name: "Hot Water", icon: "💧<span class='text-xs'>Water</span>", id: "water", color: "bg-blue-400" },
    { name: "Steamed Milk", icon: "🥛<span class='text-xs'>Milk</span>", id: "milk", color: "bg-orange-200" },
    { name: "Light Foam", icon: "☁️<span class='text-xs'>Foam L</span>", id: "lightfoam", color: "bg-gray-100" },
    { name: "Thick Foam", icon: "🍦<span class='text-xs'>Foam T</span>", id: "thickfoam", color: "bg-white" }
];
const targetDrinks = {
    Americano: { recipe: ["espresso", "water"], sequence: ["espresso", "water"] },
    Latte: { recipe: ["espresso", "milk", "lightfoam"], sequence: ["espresso", "milk", "lightfoam"] },
    Cappuccino: { recipe: ["espresso", "milk", "thickfoam"], sequence: ["espresso", "milk", "thickfoam"] }
};
let currentBuildIds = [];
let currentDrinkToBuild = "Latte";

buildSection.innerHTML = `
    <p class="text-sm mb-2 text-gray-300">Your customer wants a <strong id="drinkToBuildName" class="text-amber-400">${currentDrinkToBuild}</strong>. Click components in the correct order to add them to the cup.</p>
    <div class="flex flex-wrap my-3 gap-2 justify-center">
        ${components.map(c => `<button class="interactive-choice p-2 text-sm build-component-btn ${c.color} !text-black" data-component-id="${c.id}" data-component-color="${c.color}">${c.icon}</button>`).join('')}
    </div>
    <div class="flex items-center justify-center gap-4">
        <div id="virtualCup" class="h-36 w-28 bg-gray-200 rounded-b-lg border-2 border-gray-400 mx-auto my-2 flex flex-col-reverse items-center justify-start p-0.5 overflow-hidden relative text-black text-xs shadow-inner">
            <span class="text-gray-500 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">Cup</span>
        </div>
        <div class="flex flex-col gap-2">
            <button id="checkBuildBtn" class="interactive-button">Check My Drink</button>
            <button id="resetBuildBtn" class="interactive-button bg-red-600 hover:bg-red-700">Next Drink / Reset</button>
        </div>
    </div>
    <div id="buildResult" class="result-box mt-3">Click components to add them to the cup.</div>`;
container.appendChild(buildSection);

const virtualCup = document.getElementById('virtualCup');
const buildResultEl = document.getElementById('buildResult');
const drinkToBuildNameEl = document.getElementById('drinkToBuildName');

function resetBuild(newDrink = true) {
    currentBuildIds = [];
    if(virtualCup) virtualCup.innerHTML = '<span class="text-gray-500 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">Cup</span>';
    if(newDrink){
        const drinkNames = Object.keys(targetDrinks);
        currentDrinkToBuild = drinkNames[Math.floor(Math.random() * drinkNames.length)];
    }
    if(drinkToBuildNameEl) drinkToBuildNameEl.textContent = currentDrinkToBuild;
    if(buildResultEl) {
        buildResultEl.textContent = `Build a ${currentDrinkToBuild} by clicking components in order.`;
        buildResultEl.className = 'result-box mt-3';
    }
    document.querySelectorAll('.build-component-btn').forEach(btn => btn.disabled = false);
    document.getElementById('checkBuildBtn').disabled = false;
}

document.querySelectorAll('.build-component-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        if (!virtualCup || document.getElementById('checkBuildBtn').disabled) return; // Prevent adding if already checked/disabled
        if (virtualCup.querySelector('.text-gray-500')) {
            virtualCup.innerHTML = '';
        }
        const componentId = this.dataset.componentId;
        const componentColor = this.dataset.componentColor;
        currentBuildIds.push(componentId);

        const layerDiv = document.createElement('div');
        // Determine height based on component - very rough approximation
        let layerHeight = 'h-1/4'; // Default for espresso/water
        if(componentId.includes('milk')) layerHeight = 'h-2/5';
        if(componentId.includes('foam')) layerHeight = 'h-1/5';

        layerDiv.className = `w-full ${layerHeight} ${componentColor} text-black text-center text-xs flex items-center justify-center opacity-0`;
        layerDiv.textContent = componentId.charAt(0).toUpperCase() + componentId.slice(1,4);
        virtualCup.appendChild(layerDiv);
        gsap.fromTo(layerDiv, {opacity:0, y: -10}, {opacity:1, y:0, duration: 0.3});
    });
});

const resetBuildBtn = document.getElementById('resetBuildBtn');
if(resetBuildBtn) resetBuildBtn.addEventListener('click', () => resetBuild(true));

const checkBuildBtn = document.getElementById('checkBuildBtn');
if(checkBuildBtn && buildResultEl) {
    checkBuildBtn.addEventListener('click', () => {
        const targetData = targetDrinks[currentDrinkToBuild];
        const targetRecipeSorted = targetData.recipe.slice().sort();
        const currentBuildSorted = currentBuildIds.slice().sort();

        const ingredientsCorrect = targetRecipeSorted.length === currentBuildSorted.length && targetRecipeSorted.every((val, idx) => val === currentBuildSorted[idx]);
        let pointsAwarded = 0;

        if (ingredientsCorrect) {
            buildResultEl.innerHTML = `<strong>Perfect ${currentDrinkToBuild}!</strong> The components are correct. (+10 points). Next drink loading...`;
            buildResultEl.className = 'result-box mt-3 correct-result';
            pointsAwarded = 10;
            document.querySelectorAll('.build-component-btn').forEach(btn => btn.disabled = true);
            checkBuildBtn.disabled = true;
            setTimeout(() => resetBuild(true), 2000);
        } else {
            buildResultEl.innerHTML = `Not quite a ${currentDrinkToBuild}. Check the components. Missing: ${targetRecipeSorted.filter(c => !currentBuildSorted.includes(c)).join(', ') || 'None'}. Incorrectly added: ${currentBuildSorted.filter(c => !targetRecipeSorted.includes(c)).join(', ') || 'None'}. Click 'Reset' to try again or get a new drink.`;
            buildResultEl.className = 'result-box mt-3 incorrect-result';
            checkBuildBtn.disabled = true; // Disable check until reset
        }
        if (pointsAwarded > 0) BaristaApp.dataManager.addPoints(pointsAwarded);
        BaristaApp.util.trackAnalytics(`Day 8: Drink build for ${currentDrinkToBuild} - ${ingredientsCorrect ? 'correct' : 'incorrect'}`);
    });
}
resetBuild(true);

const diffSection = BaristaApp.util.createInteractiveSection('Spot the Difference: Latte vs. Cappuccino');
diffSection.innerHTML = `<p class="text-sm mb-2 text-gray-300">Click the image that more closely represents a <strong>Cappuccino</strong> (typically with a thicker, more distinct foam layer).</p>
    <div class="flex justify-around image-gallery">
        <img src="images/d8-latte-visual.jpg" alt="Drink A (Likely Latte: Thinner, integrated foam)" data-is-capp="false" tabindex="0" role="button">
        <img src="images/d8-cappuccino-visual.jpg" alt="Drink B (Likely Cappuccino: Thicker, distinct foam)" data-is-capp="true" tabindex="0" role="button">
    </div>
    <div id="spotDiffResult" class="result-box mt-3">Click an image.</div>`;
container.appendChild(diffSection);
diffSection.querySelectorAll('.image-gallery img').forEach(img => {
    const handleSpotDiff = () => {
        if (diffSection.dataset.answered === 'true') return; // Prevent re-answering
        diffSection.querySelectorAll('.image-gallery img').forEach(i => {
            i.classList.remove('selected-img', 'correct', 'incorrect');
             i.classList.add('opacity-50', 'disabled'); // Make all disabled appearance
        });
        img.classList.remove('opacity-50', 'disabled');
        img.classList.add('selected-img');
        diffSection.dataset.answered = 'true'; // Mark as answered

        const resultEl = document.getElementById('spotDiffResult');
        if(!resultEl) return;
        const isCapp = img.dataset.isCapp === "true";
        let pointsAwarded = 0;

        if (isCapp) {
            resultEl.innerHTML = `<strong>Correct!</strong> ${img.alt}. Cappuccinos usually feature a more substantial layer of foam. (+5 points)`;
            resultEl.className = 'result-box mt-3 correct-result';
            img.classList.add('correct');
            pointsAwarded = 5;
        } else {
             resultEl.innerHTML = `<strong>Incorrect.</strong> ${img.alt}. While this might have some foam, a cappuccino typically has a more defined and thicker foam layer. The other image was the cappuccino.`;
            resultEl.className = 'result-box mt-3 incorrect-result';
            img.classList.add('incorrect');
            const correctImg = diffSection.querySelector('img[data-is-capp="true"]');
            if (correctImg) {
                correctImg.classList.remove('opacity-50', 'disabled');
                correctImg.classList.add('correct', 'border-green-400'); // Re-highlight correct one
            }
        }
        if (pointsAwarded > 0) BaristaApp.dataManager.addPoints(pointsAwarded);
        BaristaApp.util.trackAnalytics(`Day 8: Spot diff - selected ${img.alt}, isCapp: ${isCapp}`);
    };
     img.addEventListener('click', handleSpotDiff);
     img.addEventListener('keydown', (e) => {if(e.key === 'Enter' || e.key === ' ') {e.preventDefault(); handleSpotDiff();}});
});
},

setupDay9: function() {
    const container = document.getElementById('practicalInteractiveContent');
    if (!container) return;

    const steamWandCleanSection = BaristaApp.util.createInteractiveSection('Steam Wand Clean-Up Sequence');
    const steamSteps = ["(Simulated Milk Steaming Complete)", "1. Purge Steam Wand (briefly)", "2. Wipe Wand with Damp Cloth", "3. Purge Wand Again (briefly)"];
    let currentSteamStep = 0;
    steamWandCleanSection.innerHTML = `<p class="text-sm mb-2 text-gray-300">After 'steaming milk,' click through the cleaning steps in the correct order. This is crucial for hygiene!</p>
        <div id="steamWandActionDisplay" class="h-20 bg-gray-700/50 rounded p-3 my-3 flex items-center justify-center text-lg font-semibold text-center border border-gray-600">
            ${steamSteps[0]}
        </div>
        <button id="nextSteamStepBtn" class="interactive-button">Perform Next Step</button>
        <div id="steamCleanResult" class="result-box mt-3">Start by clicking 'Perform Next Step' after (simulated) steaming.</div>`;
    container.appendChild(steamWandCleanSection);
    const nextSteamStepBtn = document.getElementById('nextSteamStepBtn');
    if (nextSteamStepBtn) {
        nextSteamStepBtn.addEventListener('click', () => {
            currentSteamStep++;
            const displayEl = document.getElementById('steamWandActionDisplay');
            const resultEl = document.getElementById('steamCleanResult');
            if(!displayEl || !resultEl) return;
            let pointsAwarded = 0;

            gsap.fromTo(displayEl, {opacity:0, y:10}, {opacity:1, y:0, duration:0.3});

            if (currentSteamStep < steamSteps.length) {
                displayEl.textContent = steamSteps[currentSteamStep];
                resultEl.textContent = `Good! Now performing: ${steamSteps[currentSteamStep]}.`;
                resultEl.className = 'result-box mt-3';
                nextSteamStepBtn.textContent = "Perform Next Step";
            } else {
                displayEl.textContent = "Steam Wand Clean & Ready!";
                resultEl.innerHTML = "<strong>Excellent!</strong> Steam wand cleaned properly following all steps. This is vital! (+10 points).";
                resultEl.className = 'result-box mt-3 correct-result';
                pointsAwarded = 10;
                nextSteamStepBtn.textContent = "Restart Sequence";
                currentSteamStep = -1;
            }
            if (pointsAwarded > 0) BaristaApp.dataManager.addPoints(pointsAwarded);
            BaristaApp.util.trackAnalytics(`Day 9: Steam wand clean step ${currentSteamStep === -1 ? steamSteps.length : currentSteamStep}`);
        });
    }

    const portafilterSection = BaristaApp.util.createInteractiveSection('Portafilter Puck Knock & Rinse (Conceptual)');
    portafilterSection.innerHTML = `<p class="text-sm mb-2 text-gray-300">This animation conceptually shows knocking out used grounds and rinsing the portafilter basket.</p>
        <div class="bg-gray-700/50 h-auto min-h-[8rem] rounded p-3 my-3 flex flex-col items-center justify-center text-gray-400 italic border border-gray-600">
            <p class="mb-2 text-sm">(Conceptual Animation/Steps)</p>
            <img src="images/d9-portafilter-cleaning.gif" alt="Portafilter cleaning animation" class="my-2 h-20 w-auto rounded border border-gray-500 shadow-md">
            <ol class="list-decimal list-inside text-xs text-left text-gray-300 mt-2">
                <li>Firmly knock portafilter on knock box bar to dislodge coffee puck.</li>
                <li>Inspect basket for remaining grounds.</li>
                <li>Rinse basket thoroughly with hot water (from group head or tap).</li>
                <li>Wipe basket dry or leave in group head to stay warm.</li>
            </ol>
        </div>
        <p class="result-box mt-3">This keeps your portafilter clean and ready for the next perfect shot!</p>`;
    container.appendChild(portafilterSection);

    const groupHeadSection = BaristaApp.util.createInteractiveSection('Group Head Flush & Clean');
    groupHeadSection.innerHTML = `<p class="text-sm mb-2 text-gray-300">Click to simulate flushing and brushing the group head.</p>
        <button id="flushGroupBtn" class="interactive-button">Flush & Brush Group Head</button>
        <div id="flushResult" class="result-box mt-3">Click the button.</div>`;
    container.appendChild(groupHeadSection);
    const flushGroupBtn = document.getElementById('flushGroupBtn');
    if(flushGroupBtn) {
        flushGroupBtn.addEventListener('click', () => {
            const resultEl = document.getElementById('flushResult');
            if(!resultEl || flushGroupBtn.disabled) return;
            resultEl.innerHTML = "<strong>Water flushed! Group head brushed!</strong> This removes old coffee particles and oils from the shower screen and gasket. Good job! (+3 points)";
            resultEl.className = 'result-box mt-3 correct-result';
            BaristaApp.dataManager.addPoints(3);
            BaristaApp.util.trackAnalytics(`Day 9: Flushed & brushed group head`);
            flushGroupBtn.disabled = true;
            gsap.to(flushGroupBtn, {opacity:0.5, duration:0.3});
        });
    }

    const hotspotsSection = BaristaApp.util.createInteractiveSection('Daily Cleaning Hotspots Checklist');
    const initialHotspots = {
        "Steam Wand (Purge & Wipe Immediately)": false,
        "Group Head (Flush & Brush Regularly)": false,
        "Portafilter & Basket (Rinse After Each Shot)": false,
        "Drip Tray (Empty & Clean As Needed)": false,
        "Machine Exterior (Wipe Down Regularly)": false
    };

    hotspotsSection.innerHTML = `<p class="text-sm mb-2 text-gray-300">Check off the parts of an espresso machine that need daily cleaning attention.</p>
        <div id="hotspotChecklist" class="space-y-2 my-3">
            ${Object.keys(initialHotspots).map(spot => `
                <label class="flex items-center interactive-choice p-3">
                    <input type="checkbox" class="h-5 w-5 rounded text-amber-600 focus:ring-amber-500 border-gray-400 bg-gray-600 mr-3 hotspot-checkbox accent-amber-500" data-spot="${spot}">
                    <span class="text-sm text-gray-200">${spot}</span>
                </label>
            `).join('')}
        </div>
        <button id="checkHotspotsBtn" class="interactive-button">Verify Checklist</button>
        <div id="hotspotsResult" class="result-box mt-3">Check all items you believe need daily cleaning.</div>`;
    container.appendChild(hotspotsSection);
    const checkHotspotsBtn = document.getElementById('checkHotspotsBtn');
    if (checkHotspotsBtn) {
        checkHotspotsBtn.addEventListener('click', () => {
             if(checkHotspotsBtn.disabled) return;
            let allCorrectlyChecked = true;
            let checkedCount = 0;
            hotspotsSection.querySelectorAll('.hotspot-checkbox').forEach(checkbox => {
                if (checkbox.checked) {
                    checkedCount++;
                } else {
                    allCorrectlyChecked = false;
                }
            });

            const resultEl = document.getElementById('hotspotsResult');
            if(!resultEl) return;
            let pointsAwarded = 0;
            if (checkedCount === Object.keys(initialHotspots).length && allCorrectlyChecked) {
                resultEl.innerHTML = "<strong>Fantastic!</strong> You've identified all key daily cleaning hotspots. This is essential for great coffee! (+5 points)";
                resultEl.className = 'result-box mt-3 correct-result';
                pointsAwarded = 5;
                checkHotspotsBtn.disabled = true;
                 hotspotsSection.querySelectorAll('.hotspot-checkbox').forEach(cb => { cb.disabled = true; cb.closest('label').classList.add('disabled', 'opacity-70')});
                 gsap.to(checkHotspotsBtn, {opacity:0.5, duration:0.3});
            } else if (checkedCount > 0) {
                resultEl.innerHTML = `You've got some! Remember, all listed items are important daily cleaning tasks. Ensure all are checked for full points.`;
                resultEl.className = 'result-box mt-3 incorrect-result';
            } else {
                resultEl.textContent = `Please check off the daily cleaning tasks.`;
                resultEl.className = 'result-box mt-3';
            }
            if (pointsAwarded > 0) BaristaApp.dataManager.addPoints(pointsAwarded);
            BaristaApp.util.trackAnalytics(`Day 9: Hotspots checklist verified - ${checkedCount} checked, All Correct: ${allCorrectlyChecked}`);
        });
    }
},
setupDay10: function() {
    const container = document.getElementById('practicalInteractiveContent');
    if (!container) return;

    const equipMatchSection = BaristaApp.util.createInteractiveSection('Pour-Over Equipment Match');
    const poEquipment = {
        Dripper: {name: "Dripper (e.g., V60, Kalita)", imgKey: "images/d10-v60-dripper.jpg", desc:"Holds the filter and coffee grounds, shaping the brew bed."},
        "Paper Filter": {name: "Paper Filter", imgKey: "images/d10-coffee-filter.jpg", desc:"Lines the dripper, holds the grounds, and filters the coffee liquid."},
        "Gooseneck Kettle": {name: "Gooseneck Kettle", imgKey: "images/d10-gooseneck-kettle.jpg", desc:"Provides precise control over water flow rate and placement for even saturation."},
        "Burr Grinder": {name: "Burr Grinder", imgKey: "images/d10-burr-grinder.jpg", desc: "Essential for consistent medium-fine grounds suitable for pour-over."}
    };
    equipMatchSection.innerHTML = `<p class="text-sm mb-2 text-gray-300">Match the equipment image to its correct name and description by clicking the image then the corresponding text box.</p>
        <div class="flex flex-wrap justify-around my-3 image-gallery" id="poImagesContainer">
            ${Object.keys(poEquipment).map(key => `<img src="${poEquipment[key].imgKey}" alt="${poEquipment[key].name}" class="m-1 border-2 border-transparent p-1 po-image-item rounded-lg shadow-md" data-target-key="${key}" tabindex="0" role="button">`).join('')}
        </div>
        <div class="space-y-2 my-3" id="poDropTargets">
            ${Object.keys(poEquipment).map(key => `<div class="interactive-choice p-3 po-drop-target" data-key="${key}" role="button" tabindex="0"><strong>${poEquipment[key].name}:</strong> <span class="text-gray-400 text-xs">${poEquipment[key].desc}</span> (Click image then here)</div>`).join('')}
        </div>
        <div id="poMatchResult" class="result-box mt-3">Select an image, then click its matching description box.</div>`;
    container.appendChild(equipMatchSection);

    let selectedPOImageKey = null;
    let matchedPOItems = 0;
    let poMatchAttempts = {};

    equipMatchSection.querySelectorAll('.po-image-item').forEach(img => {
        img.addEventListener('keydown', (e) => {if(e.key === 'Enter' || e.key === ' ') {e.preventDefault(); img.click();}});
        img.addEventListener('click', function() {
            if (this.classList.contains('opacity-50')) return;
            equipMatchSection.querySelectorAll('.po-image-item').forEach(i => i.classList.remove('selected-img'));
            this.classList.add('selected-img');
            selectedPOImageKey = this.dataset.targetKey;
            const poMatchResultEl = document.getElementById('poMatchResult');
            if(poMatchResultEl && poEquipment[selectedPOImageKey]) {
                 poMatchResultEl.textContent = `Selected ${poEquipment[selectedPOImageKey].name}. Now click its description.`;
                 poMatchResultEl.className = 'result-box mt-3';
            }
        });
    });
    equipMatchSection.querySelectorAll('.po-drop-target').forEach(target => {
        const targetKey = target.dataset.key;
        poMatchAttempts[targetKey] = 0;

        const handleDropTarget = () => {
            const resultEl = document.getElementById('poMatchResult');
            if(!resultEl || target.classList.contains('correct')) return;

            if (selectedPOImageKey && poEquipment[selectedPOImageKey] && selectedPOImageKey === targetKey) {
                target.classList.remove('interactive-choice');
                target.classList.add('correct', 'pointer-events-none', 'opacity-70');
                target.innerHTML = `<strong>${poEquipment[selectedPOImageKey].name}:</strong> ${poEquipment[selectedPOImageKey].desc} <span class="text-green-300 font-bold ml-2">✓ Matched!</span>`;

                const matchedImg = equipMatchSection.querySelector(`.po-image-item[data-target-key="${selectedPOImageKey}"]`);
                if(matchedImg) {
                    matchedImg.classList.add('opacity-50', 'pointer-events-none');
                    matchedImg.classList.remove('selected-img');
                }

                resultEl.textContent = `Matched ${poEquipment[selectedPOImageKey].name}! (+3 points).`;
                resultEl.className = 'result-box mt-3 correct-result';
                if (poMatchAttempts[targetKey] === 0) {
                    BaristaApp.dataManager.addPoints(3);
                }
                poMatchAttempts[targetKey]++;
                matchedPOItems++;
                selectedPOImageKey = null;
                if (matchedPOItems === Object.keys(poEquipment).length) {
                    resultEl.innerHTML = "<strong>All equipment matched! Excellent work!</strong>";
                }
            } else if (selectedPOImageKey && poEquipment[selectedPOImageKey]) {
                resultEl.textContent = `Not a match for ${poEquipment[selectedPOImageKey].name}. Try again.`;
                 resultEl.className = 'result-box mt-3 incorrect-result';
                 poMatchAttempts[targetKey]++;
                 gsap.fromTo(target, {x:-5}, {x:5, duration:0.05, repeat:3, yoyo:true, clearProps:"x"}); // Shake animation
            } else if (!target.classList.contains('correct')) {
                resultEl.textContent = `First click an image, then click its matching description box.`;
                 resultEl.className = 'result-box mt-3';
            }
            BaristaApp.util.trackAnalytics(`Day 10: PO equip match attempt for ${targetKey}`);
        };
        target.addEventListener('click', handleDropTarget);
        target.addEventListener('keydown', (e) => {if(e.key === 'Enter' || e.key === ' ') {e.preventDefault(); handleDropTarget();}});
    });

    const poAnimSection = BaristaApp.util.createInteractiveSection('Conceptual Pour-Over Brew Steps');
    const poSteps = [
        "1. Place filter in dripper, rinse thoroughly with hot water (removes paper taste, preheats). Discard rinse water.",
        "2. Add medium-fine ground coffee to filter. Level the bed gently.",
        "3. Start timer. Pour ~2x coffee weight of hot water (90-96°C) for the 'Bloom'. Ensure all grounds are wet. Wait 30-45s.",
        "4. Continue pouring in slow, controlled circles or pulses, keeping water level consistent. Avoid pouring on filter walls.",
        "5. Aim for total brew time of 2-4 minutes (varies by batch size/grind). Coffee should finish dripping."
    ];
    let currentPOStep = -1;
    let poAnimCompletedOnce = false;
    poAnimSection.innerHTML = `<p class="text-sm mb-2 text-gray-300">Click 'Next Step' to walk through the conceptual pour-over brewing process.</p>
        <div id="poStepDisplay" class="min-h-[6rem] bg-gray-700/50 rounded p-3 my-3 flex items-center justify-center text-md text-center border border-gray-600">
            Ready to start brewing pour-over (conceptually)?
        </div>
        <button id="nextPOStepBtn" class="interactive-button">Start / Next Step</button>
        <div id="poAnimResult" class="result-box mt-3">Follow the steps to understand the pour-over flow.</div>`;
    container.appendChild(poAnimSection);
    const nextPOStepBtn = document.getElementById('nextPOStepBtn');
    if (nextPOStepBtn) {
        nextPOStepBtn.addEventListener('click', () => {
            currentPOStep++;
            const displayEl = document.getElementById('poStepDisplay');
            const resultEl = document.getElementById('poAnimResult');
            if(!displayEl || !resultEl) return;
            let pointsAwarded = 0;

            gsap.fromTo(displayEl, {opacity:0, y:10}, {opacity:1, y:0, duration:0.3});


            if (currentPOStep < poSteps.length) {
                displayEl.innerHTML = `<strong class="block mb-1">Step ${currentPOStep + 1}:</strong> ${poSteps[currentPOStep]}`;
                resultEl.textContent = `Now performing: ${poSteps[currentPOStep].substring(0, 50)}...`;
                resultEl.className = 'result-box mt-3';
                nextPOStepBtn.textContent = "Next Step";
            } else {
                displayEl.textContent = "Pour-Over Brew Complete (Conceptually)!";
                resultEl.innerHTML = "<strong>Great!</strong> You've seen all the key pour-over steps. Understanding this process helps appreciate the craft." + (!poAnimCompletedOnce ? " (+5 points)." : ".");
                resultEl.className = 'result-box mt-3 correct-result';
                if (!poAnimCompletedOnce) {
                    pointsAwarded = 5;
                    poAnimCompletedOnce = true;
                }
                currentPOStep = -1;
                nextPOStepBtn.textContent = "Restart Sequence";
            }
            if (pointsAwarded > 0) BaristaApp.dataManager.addPoints(pointsAwarded);
            BaristaApp.util.trackAnalytics(`Day 10: PO anim step ${currentPOStep === -1 ? poSteps.length : currentPOStep + 1}`);
        });
    }

    const rinseFilterSection = BaristaApp.util.createInteractiveSection('Why Rinse the Paper Filter?');
    rinseFilterSection.innerHTML = `<p class="text-sm text-gray-300">Rinsing the paper filter with hot water before adding coffee grounds is a small but crucial step in pour-over brewing. It achieves two main things:
        <ul class="list-disc list-inside text-sm mt-2 space-y-1 text-gray-400">
            <li><strong>Removes Papery Taste:</strong> Paper filters can impart a slight papery or woody taste to the coffee. Rinsing helps to wash this away.</li>
            <li><strong>Preheats Equipment:</strong> The hot water preheats the dripper and the brewing vessel (carafe or mug). This helps maintain a stable brew temperature throughout the extraction process, leading to a more balanced cup.</li>
        </ul></p>
        <p class="result-box mt-3">This simple step makes a noticeable difference in the final cup!</p>`;
    container.appendChild(rinseFilterSection);
},
setupDay11: function() {
    const container = document.getElementById('practicalInteractiveContent');
    if (!container) return;

    const fpPartsSection = BaristaApp.util.createInteractiveSection('French Press Parts Identifier');
    const fpParts = {
        Beaker: {name: "Beaker/Carafe", desc:"The main cylindrical container, usually glass or stainless steel, that holds the coffee and water."},
        Lid: {name: "Lid Assembly", desc:"Fits on top of the beaker and holds the plunger rod."},
        Plunger: {name: "Plunger Rod & Knob", desc:"The rod that connects to the filter assembly, with a knob on top for pressing."},
        "Mesh Filter": {name: "Filter Assembly (Mesh Screen)", desc:"A multi-layer fine mesh filter (often with a spring-loaded plate) that separates the grounds from the liquid coffee when pressed."}
    };
    fpPartsSection.innerHTML = `<p class="text-sm mb-2 text-gray-300">Click a part name to learn its function. (Image is illustrative)</p>
                                              <img src="images/d11-french-press-exploded.jpg" alt="French Press Diagram" class="mx-auto my-3 rounded-md h-56 object-contain border border-gray-600 shadow-md">
                                              <div class="flex flex-col space-y-2 mt-2">`;
    Object.keys(fpParts).forEach(key => {
        fpPartsSection.innerHTML += `<div class="interactive-choice fp-part" data-part-key="${key}" role="button" tabindex="0">${fpParts[key].name}</div>`;
    });
    fpPartsSection.innerHTML += `</div><div id="fpPartInfo" class="result-box mt-3">Click a part above.</div>`;
    container.appendChild(fpPartsSection);
    fpPartsSection.querySelectorAll('.fp-part').forEach(el => {
        const handleFPPart = () => {
            fpPartsSection.querySelectorAll('.fp-part').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            const partKey = el.dataset.partKey;
            const fpPartInfoEl = document.getElementById('fpPartInfo');
            if(fpPartInfoEl && fpParts[partKey]) {
                fpPartInfoEl.textContent = `${fpParts[partKey].name}: ${fpParts[partKey].desc}`;
                fpPartInfoEl.className = 'result-box mt-3';
            }
            BaristaApp.util.trackAnalytics(`Day 11: FP part - ${fpParts[partKey] ? fpParts[partKey].name : 'Unknown'}`);
        };
        el.addEventListener('click', handleFPPart);
        el.addEventListener('keydown', (e) => {if(e.key === 'Enter' || e.key === ' ') {e.preventDefault(); handleFPPart();}});
    });

    const fpAnimSection = BaristaApp.util.createInteractiveSection('Conceptual French Press Brew Steps');
    const fpSteps = [
        "1. Preheat French Press beaker with hot water, then discard.",
        "2. Add coarse coffee grounds (like breadcrumbs) to the empty beaker.",
        "3. Start timer. Pour hot water (90-96°C, just off boil) over grounds, ensuring all are saturated. Some like to stir gently.",
        "4. Place lid on top with plunger pulled all the way up. Let steep for ~4 minutes.",
        "5. Slowly and steadily press the plunger all the way down. Avoid pressing too fast.",
        "6. Serve immediately to prevent over-extraction. Enjoy your full-bodied coffee!"
    ];
    let currentFPStep = -1;
    let fpAnimCompletedOnce = false;
    fpAnimSection.innerHTML = `<p class="text-sm mb-2 text-gray-300">Click 'Next Step' to walk through the conceptual French Press brewing process.</p>
        <div id="fpStepDisplay" class="min-h-[6rem] bg-gray-700/50 rounded p-3 my-3 flex items-center justify-center text-md text-center border border-gray-600">
            Ready to brew with the French Press (conceptually)?
        </div>
        <button id="nextFPStepBtn" class="interactive-button">Start / Next Step</button>
        <div id="fpAnimResult" class="result-box mt-3">Follow the steps to understand the French Press flow.</div>`;
    container.appendChild(fpAnimSection);
    const nextFPStepBtn = document.getElementById('nextFPStepBtn');
    if (nextFPStepBtn) {
        nextFPStepBtn.addEventListener('click', () => {
            currentFPStep++;
            const displayEl = document.getElementById('fpStepDisplay');
            const resultEl = document.getElementById('fpAnimResult');
            if(!displayEl || !resultEl) return;
            let pointsAwarded = 0;

            gsap.fromTo(displayEl, {opacity:0, y:10}, {opacity:1, y:0, duration:0.3});


            if (currentFPStep < fpSteps.length) {
                displayEl.innerHTML = `<strong class="block mb-1">Step ${currentFPStep + 1}:</strong> ${fpSteps[currentFPStep]}`;
                resultEl.textContent = `Now performing: ${fpSteps[currentFPStep].substring(0, 50)}...`;
                resultEl.className = 'result-box mt-3';
                nextFPStepBtn.textContent = "Next Step";
            } else {
                displayEl.textContent = "French Press Brew Complete (Conceptually)!";
                resultEl.innerHTML = "<strong>Excellent!</strong> You've seen all the French Press steps. This method gives a rich, full-bodied cup." + (!fpAnimCompletedOnce ? " (+5 points)." : ".");
                resultEl.className = 'result-box mt-3 correct-result';
                if (!fpAnimCompletedOnce) {
                    pointsAwarded = 5;
                    fpAnimCompletedOnce = true;
                }
                currentFPStep = -1;
                nextFPStepBtn.textContent = "Restart Sequence";
            }
            if (pointsAwarded > 0) BaristaApp.dataManager.addPoints(pointsAwarded);
            BaristaApp.util.trackAnalytics(`Day 11: FP anim step ${currentFPStep === -1 ? fpSteps.length : currentFPStep + 1}`);
        });
    }

    const fpGrindSection = BaristaApp.util.createInteractiveSection('Grind Size for French Press');
    fpGrindSection.innerHTML = `<p class="text-sm mb-2 text-gray-300">French Press requires a <strong>coarse grind</strong>, similar to breadcrumbs or coarse sea salt. Here's why:</p>
        <ul class="list-disc list-inside text-sm mt-2 space-y-1 text-gray-400">
            <li><strong>Prevents Over-extraction:</strong> During the 3-5 minute steep time, a fine grind would extract too many bitter compounds.</li>
            <li><strong>Avoids a Muddy Cup:</strong> Fine particles can easily pass through the metal mesh filter, creating unpleasant sediment.</li>
            <li><strong>Easier Plunging:</strong> A coarse grind makes it much easier to press the plunger down smoothly. Fine grinds can create too much resistance.</li>
        </ul>
        <img src="images/d11-fp-coarse-grind.jpg" class="my-3 mx-auto rounded-md border border-gray-600 h-32 object-contain shadow-md" alt="Coarse Grind for French Press">
        <p class="result-box mt-3">Using the correct coarse grind is key to a clean and tasty French Press brew.</p>`;
    container.appendChild(fpGrindSection);
},


setupDay12: function() {
    const container = document.getElementById('practicalInteractiveContent');
    if (!container) return;

    const aromaMatchSection = BaristaApp.util.createInteractiveSection('');
    const aromaObjectsData = [
        { aroma: "Chocolatey", object: "dark chocolate bar", imgKey: "images/d12-chocolate.jpg" },
        { aroma: "Fruity/Citrus", object: "fresh lemon or berries", imgKey: "images/d12-lemon-berries.jpg" },
        { aroma: "Floral", object: "jasmine or rose flowers", imgKey: "images/d12-jasmine.jpg" },
        { aroma: "Spicy", object: "cinnamon sticks or cloves", imgKey: "images/d12-cinnamon.jpg" },
        { aroma: "Nutty", object: "roasted almonds or hazelnuts", imgKey: "images/d12-almonds.jpg" }
    ];
    let currentAromaTargetIndex = 0;
    let aromaMatchCorrectAnswers = 0;

    function loadAromaMatchQuestion() {
        if (!aromaMatchSection) return;
        aromaMatchSection.innerHTML = '';
        const titleEl = document.createElement('h4');
        titleEl.className = "text-xl font-semibold mb-4 text-amber-400";
        titleEl.textContent = "Match the Aroma to the Object";
        aromaMatchSection.appendChild(titleEl);

        if (currentAromaTargetIndex >= aromaObjectsData.length) {
             aromaMatchSection.innerHTML += `<p class="text-lg text-green-300 font-semibold p-4">All aromas matched! You got ${aromaMatchCorrectAnswers}/${aromaObjectsData.length} correct. Great job developing your sensory connections!</p>`;
             return;
        }
        const currentTarget = aromaObjectsData[currentAromaTargetIndex];

        let optionsForDisplay = [currentTarget];
        let otherOptions = aromaObjectsData.filter(item => item.aroma !== currentTarget.aroma);
        otherOptions.sort(() => 0.5 - Math.random());
        optionsForDisplay.push(...otherOptions.slice(0, Math.min(3, otherOptions.length)));
        optionsForDisplay.sort(() => 0.5 - Math.random());

        aromaMatchSection.innerHTML += `
            <p class="text-sm mb-2 text-gray-300">Which image best represents something that would smell <strong>${currentTarget.aroma}</strong> in coffee?</p>
            <div class="flex flex-wrap justify-around image-gallery my-3">
                ${optionsForDisplay.map((item, idx) => `<img src="${item.imgKey}" alt="${item.object}" data-aroma-key="${item.aroma}" data-idx="${idx}" tabindex="0" role="button" aria-label="Select image for ${item.object}">`).join('')}
            </div>
            <div id="aromaObjectResult" class="result-box mt-3">Click an image that matches the target aroma: <strong>${currentTarget.aroma}</strong>.</div>`;

        aromaMatchSection.querySelectorAll('.image-gallery img').forEach(img => {
             const handleAromaObjectSelect = () => {
                const clickedAroma = img.dataset.aromaKey;
                const resultEl = document.getElementById('aromaObjectResult');
                if(!resultEl || aromaMatchSection.dataset.answeredThisRound === 'true') return;

                aromaMatchSection.dataset.answeredThisRound = 'true'; // Prevent multiple clicks on same question

                aromaMatchSection.querySelectorAll('.image-gallery img').forEach(i => {
                     i.classList.add('opacity-50', 'disabled');
                     i.classList.remove('selected-img');
                });
                img.classList.remove('opacity-50', 'disabled');
                img.classList.add('selected-img');


                let pointsAwarded = 0;
                if (clickedAroma === currentTarget.aroma) {
                    resultEl.innerHTML = `<strong>Correct!</strong> ${currentTarget.aroma} coffee notes can indeed remind you of ${currentTarget.object}. (+5 points). Moving to next aroma...`;
                    resultEl.className = 'result-box mt-3 correct-result';
                    pointsAwarded = 5;
                    aromaMatchCorrectAnswers++;
                } else {
                    resultEl.innerHTML = `<strong>Not quite for ${currentTarget.aroma}.</strong> ${img.alt} might not be the best fit. The aroma of ${currentTarget.aroma} is often associated with ${currentTarget.object}. Moving on.`;
                    resultEl.className = 'result-box mt-3 incorrect-result';
                     const correctImgEl = aromaMatchSection.querySelector(`img[data-aroma-key="${currentTarget.aroma}"]`);
                    if (correctImgEl) correctImgEl.classList.add('border-green-500', 'selected-img'); // Highlight correct
                }
                if (pointsAwarded > 0) BaristaApp.dataManager.addPoints(pointsAwarded);
                BaristaApp.util.trackAnalytics(`Day 12: Aroma match - Target: ${currentTarget.aroma}, Clicked: ${clickedAroma}`);
                currentAromaTargetIndex++;
                setTimeout(() => {
                     delete aromaMatchSection.dataset.answeredThisRound;
                     loadAromaMatchQuestion();
                 }, 2500);
            };
            img.addEventListener('click', handleAromaObjectSelect);
            img.addEventListener('keydown', (e) => {if(e.key === 'Enter' || e.key === ' ') {e.preventDefault(); handleAromaObjectSelect();}});
        });
    }
    loadAromaMatchQuestion();
    container.appendChild(aromaMatchSection);

    const describeCoffeeSection = BaristaApp.util.createInteractiveSection('');
    const virtualCoffees = [
        { name: "Ethiopian Yirgacheffe", desc: "This coffee presents a delicate, tea-like body. Its aroma is distinctly floral, like jasmine, with bright citrus notes of lemon and bergamot. The flavor is clean with a sweet, lingering finish.", keywords: ["Floral", "Citrus", "Bright", "Light Body", "Sweet"] },
        { name: "Sumatran Mandheling", desc: "A bold and heavy-bodied coffee. It features earthy and woody aromas, with hints of dark chocolate and a touch of spice. The flavor is rich and intense, with low acidity and a long, smoky aftertaste.", keywords: ["Earthy", "Chocolatey", "Spicy", "Heavy Body", "Smoky", "Low Acidity"] },
        { name: "Brazilian Santos", desc: "A classic, smooth coffee with medium body. Notes of nuts (like peanut or almond) and milk chocolate are common, with a mild acidity and a sweet, often caramel-like finish.", keywords: ["Nutty", "Chocolatey", "Medium Body", "Sweet", "Caramel"] }

    ];
    let currentVirtualCoffeeIndex = 0;
    const allKeywords = ["Floral", "Citrus", "Bright", "Light Body", "Sweet", "Earthy", "Chocolatey", "Spicy", "Heavy Body", "Smoky", "Low Acidity", "Nutty", "Fruity", "Caramel", "Bitter", "Roasty"];

    function loadDescribeCoffeeChallenge() {
        if (!describeCoffeeSection) return;
        describeCoffeeSection.innerHTML = '';
        const titleEl = document.createElement('h4');
        titleEl.className = "text-xl font-semibold mb-4 text-amber-400";
        titleEl.textContent = "Describe this Virtual Coffee";
        describeCoffeeSection.appendChild(titleEl);

        if (currentVirtualCoffeeIndex >= virtualCoffees.length) {
            describeCoffeeSection.innerHTML += `<p class="text-lg text-green-300 font-semibold p-4">All virtual coffees described! Well done!</p>`;
            return;
        }

        const currentVCoffee = virtualCoffees[currentVirtualCoffeeIndex];
        describeCoffeeSection.innerHTML += `
            <p class="text-sm mb-1 text-gray-300">Read the description for the <strong class="text-amber-400">${currentVCoffee.name}</strong>:</p>
            <p class="text-sm italic text-gray-400 mb-3 p-3 bg-gray-700/20 rounded-md">${currentVCoffee.desc}</p>
            <p class="text-sm my-2 text-gray-300">Click 3-4 keywords below that best describe this coffee:</p>
            <div id="keywordChoices" class="flex flex-wrap gap-2">
                ${allKeywords.sort(() => 0.5 - Math.random()).map(kw => `<button class="interactive-choice p-2 text-xs keyword-btn" data-keyword="${kw}">${kw}</button>`).join('')}
            </div>
            <button id="checkKeywordsBtn" class="interactive-button mt-4">Check My Descriptors</button>
            <div id="describeResult" class="result-box mt-3">Select keywords then check.</div>`;

        let selectedKeywords = [];
        describeCoffeeSection.querySelectorAll('.keyword-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                if(document.getElementById('checkKeywordsBtn').disabled) return; // If already checked
                this.classList.toggle('selected');
                if (this.classList.contains('selected')) {
                    if(selectedKeywords.length < 4) {
                        selectedKeywords.push(this.dataset.keyword);
                    } else {
                        this.classList.remove('selected');
                        BaristaApp.util.showError("You can select a maximum of 4 keywords.");
                    }
                } else {
                    selectedKeywords = selectedKeywords.filter(kw => kw !== this.dataset.keyword);
                }
            });
        });
        const checkKeywordsBtn = document.getElementById('checkKeywordsBtn');
        if(checkKeywordsBtn) {
            checkKeywordsBtn.addEventListener('click', () => {
                const resultEl = document.getElementById('describeResult');
                if(!resultEl || checkKeywordsBtn.disabled) return;
                let correctCount = 0;
                selectedKeywords.forEach(kw => {
                    if (currentVCoffee.keywords.includes(kw)) correctCount++;
                });
                let pointsAwarded = 0;
                let allCorrectKeywords = currentVCoffee.keywords.join(', ');

                if (selectedKeywords.length < 2) {
                    resultEl.innerHTML = `Please select at least 2 keywords to describe the coffee. Correct keywords were: ${allCorrectKeywords}.`;
                    resultEl.className = 'result-box mt-3 incorrect-result';
                    return;
                }

                if (correctCount >= Math.min(2, currentVCoffee.keywords.length)) {
                    pointsAwarded = correctCount * 2;
                    resultEl.innerHTML = `<strong>Good job!</strong> You picked ${correctCount} out of ${selectedKeywords.length} keywords correctly. (+${pointsAwarded} points). <br/>Correct descriptors for ${currentVCoffee.name}: ${allCorrectKeywords}. Next coffee...`;
                    resultEl.className = 'result-box mt-3 correct-result';
                    if (pointsAwarded > 0) BaristaApp.dataManager.addPoints(pointsAwarded);
                } else {
                    resultEl.innerHTML = `You picked ${correctCount} matching word(s). Aim for keywords that closely match the description. Correct descriptors for ${currentVCoffee.name}: ${allCorrectKeywords}. Try the next one!`;
                    resultEl.className = 'result-box mt-3 incorrect-result';
                }
                checkKeywordsBtn.disabled = true;
                describeCoffeeSection.querySelectorAll('.keyword-btn').forEach(btn => btn.disabled = true);
                BaristaApp.util.trackAnalytics(`Day 12: Describe coffee ${currentVCoffee.name} - Selected: ${selectedKeywords.join(',')}, Correct: ${correctCount}`);
                currentVirtualCoffeeIndex++;
                setTimeout(loadDescribeCoffeeChallenge, 3500); // Increased timeout for reading
            });
        }
    }
    loadDescribeCoffeeChallenge();
    container.appendChild(describeCoffeeSection);

    const bodyScaleSection = BaristaApp.util.createInteractiveSection('Coffee Body Scale Visualizer');
    bodyScaleSection.innerHTML = `<p class="text-sm mb-2 text-gray-300">'Body' or 'mouthfeel' refers to the perceived weight and texture of the coffee in your mouth. Here's a conceptual scale:</p>
        <div class="flex justify-around items-end mt-4 p-4 bg-gray-700/30 rounded-lg h-40">
            <div class="text-center w-1/3">
                <div class="h-12 w-12 mx-auto bg-blue-300/30 rounded-full flex items-center justify-center border-2 border-blue-400 shadow-md">💧</div>
                <p class="text-xs mt-1 text-blue-300"><strong>Light Body</strong><br>(e.g., like tea, skim milk, watery)</p>
            </div>
            <div class="text-center w-1/3">
                <div class="h-20 w-20 mx-auto bg-orange-300/40 rounded-full flex items-center justify-center border-2 border-orange-400 shadow-md">🥛</div>
                <p class="text-xs mt-1 text-orange-300"><strong>Medium Body</strong><br>(e.g., like whole milk, smooth)</p>
            </div>
            <div class="text-center w-1/3">
                 <div class="h-28 w-28 mx-auto bg-yellow-800/50 rounded-full flex items-center justify-center border-2 border-yellow-700 shadow-md">🍯</div>
                <p class="text-xs mt-1 text-yellow-600"><strong>Heavy/Full Body</strong><br>(e.g., like cream, syrupy, rich)</p>
            </div>
        </div>
        <div class="result-box mt-3">Consider how different coffees feel in your mouth. This is an important tasting characteristic!</div>`;
    container.appendChild(bodyScaleSection);
},
setupDay13: function() {
    const container = document.getElementById('practicalInteractiveContent');
    if (!container) return;

    const greetingSection = BaristaApp.util.createInteractiveSection('');
    const greetingScenarios = [
        { scenario: "A customer walks in looking happy and relaxed.", options: ["Hey there. What can I get for you?", "Good morning! Welcome in. How can I help you today?", "Yeah?"], correct: 1, feedback: "A warm, welcoming greeting sets a positive tone."},
        { scenario: "A customer seems rushed and is looking at their watch.", options: ["Hi, what can I get for you quickly?", "Take your time, no rush at all.", "Hello! Ready to order when you are, or need a moment?"], correct: 0, feedback: "Acknowledging their pace ('quickly') while remaining polite is key here. Option C is also good, but A is slightly more direct for someone rushed."},
        { scenario: "A customer looks confused by the menu board.", options: ["Everything is pretty standard here.", "Can I help you find something? We have lattes, cappuccinos...", "Just let me know when you've figured it out."], correct: 1, feedback: "Proactively offering help and simple suggestions is great service."}
    ];
    let currentGreetingScenarioIdx = 0;
    let greetingCorrectCount = 0;

    function loadGreetingScenario() {
        if (!greetingSection) return;
        greetingSection.innerHTML = '';

        const sectionTitle = document.createElement('h4');
        sectionTitle.className = "text-xl font-semibold mb-4 text-amber-400";
        sectionTitle.textContent = "Choose the Best Greeting/Response";
        greetingSection.appendChild(sectionTitle);

        if (currentGreetingScenarioIdx >= greetingScenarios.length) {
            greetingSection.innerHTML += `<p class="text-lg text-green-300 font-semibold p-4">All greeting scenarios completed! You got ${greetingCorrectCount}/${greetingScenarios.length} correct. Remember, a positive first impression is key!</p>`;
            return;
        }

        const currentScenario = greetingScenarios[currentGreetingScenarioIdx];
        greetingSection.innerHTML += `
            <p class="text-sm mb-1 text-gray-300">Scenario: <strong class="text-amber-400">${currentScenario.scenario}</strong></p>
            <p class="text-xs mb-3 text-gray-400">Select the most appropriate response:</p>
            <div id="greetingOptionsContainer" class="flex flex-col space-y-2">
                ${currentScenario.options.map((opt, idx) => `<div class="interactive-choice greeting-option" data-option-idx="${idx}" role="button" tabindex="0">${String.fromCharCode(65 + idx)}. ${opt}</div>`).join('')}
            </div>
            <div id="greetingResult" class="result-box mt-3">Choose a response.</div>`;

        greetingSection.querySelectorAll('.greeting-option').forEach(choice => {
            const handleGreetingSelect = () => {
                 if (greetingSection.dataset.answeredThisRound === 'true') return;
                 greetingSection.dataset.answeredThisRound = 'true';

                const selectedIdx = parseInt(choice.dataset.optionIdx);
                const resultEl = document.getElementById('greetingResult');
                if (!resultEl) return;

                greetingSection.querySelectorAll('.greeting-option').forEach(opt => {
                    opt.classList.remove('selected', 'correct', 'incorrect');
                    opt.classList.add('disabled'); // Disable all options after one is chosen
                });
                choice.classList.remove('disabled'); // Re-enable the selected one for styling
                choice.classList.add('selected');

                let pointsAwarded = 0;
                if (selectedIdx === currentScenario.correct) {
                    resultEl.innerHTML = `<strong>Excellent Choice!</strong> ${currentScenario.feedback} (+5 points).`;
                    resultEl.className = 'result-box mt-3 correct-result'; choice.classList.add('correct');
                    pointsAwarded = 5;
                    greetingCorrectCount++;
                } else {
                    resultEl.innerHTML = `<strong>Consider another approach.</strong> While not terrible, option ${String.fromCharCode(65 + currentScenario.correct)} ("${currentScenario.options[currentScenario.correct]}") is often better because ${currentScenario.feedback}.`;
                    resultEl.className = 'result-box mt-3 incorrect-result'; choice.classList.add('incorrect');
                    const correctOptEl = greetingSection.querySelector(`.greeting-option[data-option-idx="${currentScenario.correct}"]`);
                    if (correctOptEl) { correctOptEl.classList.remove('disabled'); correctOptEl.classList.add('correct'); }
                }
                if (pointsAwarded > 0) BaristaApp.dataManager.addPoints(pointsAwarded);
                BaristaApp.util.trackAnalytics(`Day 13: Greeting scenario ${currentGreetingScenarioIdx}, chose ${selectedIdx}`);

                currentGreetingScenarioIdx++;
                setTimeout(() => {
                    delete greetingSection.dataset.answeredThisRound;
                    loadGreetingScenario();
                }, 3000); // Increased timeout
            };
            choice.addEventListener('click', handleGreetingSelect);
            choice.addEventListener('keydown', (e) => {if(e.key === 'Enter' || e.key === ' ') {e.preventDefault(); handleGreetingSelect();}});
        });
    }
    loadGreetingScenario();
    container.appendChild(greetingSection);

const orderSimSection = BaristaApp.util.createInteractiveSection('');

const mockOrders = [
    { text: "Can I get a medium caramel macchiato with whole milk and a slice of banana bread?", components: ["Medium", "Macchiato", "Syrup Caramel", "Whole Milk", "Banana Bread"] },
    { text: "I'd love a small iced Americano with an extra shot and a chocolate chip muffin.", components: ["Small", "Americano", "Extra Shot", "Blueberry Muffin"] },
    { text: "Could I get a large mocha with hazelnut syrup and a pecan tart?", components: ["Large", "Mocha", "Syrup Hazelnut", "Raspberry Tart"] },
    { text: "I'll take a medium flat white with oat milk and a cinnamon scone.", components: ["Medium", "Flat White", "Oat Milk", "Cranberry Scone"] },
    { text: "Can I get a small vanilla latte with almond milk and a cherry Danish?", components: ["Small", "Latte", "Syrup Vanilla", "Almond Milk", "Cherry Danish"] },
    { text: "I'd like a large cold brew with caramel syrup and a blueberry scone.", components: ["Large", "Cold Brew", "Syrup Caramel", "Blueberry Scone"] },
    { text: "Could I have a medium chai latte with coconut milk and a sesame bagel?", components: ["Medium", "Chai Latte", "Coconut Milk", "Sesame Bagel"] },
    { text: "I'll go for a small espresso macchiato with skim milk and a chocolate croissant.", components: ["Small", "Macchiato", "Skim Milk", "Chocolate Croissant"] },
    { text: "Can I get a large golden turmeric latte with soy milk and a lemon pound cake?", components: ["Large", "Golden Turmeric Latte", "Soy Milk", "Lemon Pound Cake"] },
    { text: "I'd love a medium hazelnut cappuccino with whole milk and a macadamia cookie.", components: ["Medium", "Cappuccino", "Syrup Hazelnut", "Whole Milk", "Macadamia Cookie"] },
    { text: "Could I have a small coconut latte and a raspberry tart?", components: ["Small", "Latte", "Coconut Milk", "Raspberry Tart"] },
    { text: "I'll take a large iced vanilla cold brew with almond milk and a butter croissant.", components: ["Large", "Cold Brew", "Syrup Vanilla", "Almond Milk", "Butter Croissant"] },
    { text: "Can I get a medium latte with oat milk and a cranberry scone?", components: ["Medium", "Latte", "Oat Milk", "Cranberry Scone"] },
    { text: "I'd like a small caramel mocha with coconut milk and a peanut butter cookie.", components: ["Small", "Mocha", "Syrup Caramel", "Coconut Milk", "Peanut Butter Cookie"] },
    { text: "Could I get a large chai latte with almond milk and a honey-glazed donut?", components: ["Large", "Chai Latte", "Almond Milk", "Honey-Glazed Donut"] },
    { text: "I'll take a medium double espresso and a macadamia cookie.", components: ["Medium", "Espresso", "Extra Shot", "Macadamia Cookie"] },
    { text: "Can I get a small hazelnut cold brew with skim milk and a lemon tart?", components: ["Small", "Cold Brew", "Syrup Hazelnut", "Skim Milk", "Lemon Tart"] },
    { text: "I'd love a large dark roast coffee, black, and a cinnamon bun.", components: ["Large", "Dark Roast Coffee", "Cinnamon Bun"] },
    { text: "Could I have a medium cappuccino with vanilla syrup and a strawberry Danish?", components: ["Medium", "Cappuccino", "Syrup Vanilla", "Strawberry Danish"] },
    { text: "I'll go for a small iced mocha with caramel drizzle and a slice of pecan pie.", components: ["Small", "Mocha", "Caramel Drizzle", "Pecan Pie Slice"] }
];


let currentMockOrderIdx = 0;

const allOrderComponents = [
    "Small", "Medium", "Large", "Espresso", "Americano", "Latte", "Cappuccino", "Flat White",
    "Mocha", "Cold Brew", "Macchiato", "Chai Latte", "Golden Turmeric Latte", "Dark Roast Coffee",
    "Whole Milk", "Skim Milk", "Oat Milk", "Soy Milk", "Almond Milk", "Coconut Milk",
    "Extra Shot", "Decaf", "Syrup Vanilla", "Syrup Caramel", "Syrup Hazelnut", "Caramel Drizzle",
    "Plain Croissant", "Chocolate Croissant", "Blueberry Muffin", "Cookie", "Macadamia Cookie",
    "Peanut Butter Cookie", "Butter Croissant", "Raspberry Tart", "Cherry Danish", "Pumpkin Loaf",
    "Banana Bread", "Sesame Bagel", "Cranberry Scone", "Honey-Glazed Donut", "Lemon Pound Cake",
    "Blueberry Scone", "Cinnamon Bun", "Lemon Tart", "Strawberry Danish", "Pecan Pie Slice"
].sort(); // Sort for easier finding

    let currentOrderBuild = [];

    function loadOrderSim() {
        if (!orderSimSection) return;
        orderSimSection.innerHTML = '';

        const sectionTitle = document.createElement('h4');
        sectionTitle.className = "text-xl font-semibold mb-4 text-amber-400";
        sectionTitle.textContent = "Order Taking Simulator";
        orderSimSection.appendChild(sectionTitle);

        if (currentMockOrderIdx >= mockOrders.length) {
            orderSimSection.innerHTML += `<p class="text-lg text-green-300 font-semibold p-4">All customer orders processed! Great practice!</p>`;
            return;
        }

        const currentOrder = mockOrders[currentMockOrderIdx];
        orderSimSection.innerHTML += `
            <p class="text-sm mb-1 text-gray-300">Customer says: "<strong id="customerOrderText" class="text-amber-400">${currentOrder.text}</strong>"</p>
            <p class="text-xs my-2 text-gray-400">Click buttons below to build the order as you hear it. Then confirm.</p>
            <div id="orderComponentChoices" class="flex flex-wrap gap-2 my-3">
                ${allOrderComponents.map(comp => `<button class="interactive-choice p-1.5 px-2.5 text-xs order-comp-btn" data-component="${comp}">${comp}</button>`).join('')}
            </div>
            <div class="my-3 p-3 bg-gray-700/50 rounded min-h-[3.5rem] border border-gray-600">
                <strong>Order Confirmation:</strong> <span id="orderConfirmationText" class="text-gray-300"></span>
            </div>
            <div class="flex gap-3 mt-4">
                <button id="confirmOrderBtn" class="interactive-button flex-1">Confirm Order</button>
                <button id="resetOrderBuildBtn" class="interactive-button bg-red-600 hover:bg-red-700 flex-1">Clear / Next Customer</button>
            </div>
            <div id="orderSimResult" class="result-box mt-3">Build the order based on what the customer says.</div>`;

        currentOrderBuild = [];
        updateOrderConfirmationDisplay();
        orderSimSection.dataset.answeredThisOrder = 'false'; // Reset answered flag

        orderSimSection.querySelectorAll('.order-comp-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                 if (orderSimSection.dataset.answeredThisOrder === 'true') return;
                const component = this.dataset.component;
                if (currentOrderBuild.includes(component)) {
                    currentOrderBuild = currentOrderBuild.filter(c => c !== component);
                    this.classList.remove('selected');
                } else {
                    currentOrderBuild.push(component);
                    this.classList.add('selected');
                }
                updateOrderConfirmationDisplay();
            });
        });

        const resetBtn = orderSimSection.querySelector('#resetOrderBuildBtn');
        if(resetBtn) {
            resetBtn.addEventListener('click', () => {
                orderSimSection.dataset.answeredThisOrder = 'false';
                currentOrderBuild = [];
                updateOrderConfirmationDisplay();
                orderSimSection.querySelectorAll('.order-comp-btn').forEach(btn => btn.classList.remove('selected'));
                const resultEl = document.getElementById('orderSimResult');
                if (resultEl) {
                    resultEl.textContent = 'Order cleared. Ready for the next customer or re-try current.';
                    resultEl.className = 'result-box mt-3';
                }
                const confirmButton = orderSimSection.querySelector('#confirmOrderBtn');
                if (confirmButton) confirmButton.disabled = false;
                orderSimSection.querySelectorAll('.order-comp-btn').forEach(el => el.disabled = false);
                 currentMockOrderIdx = (currentMockOrderIdx + 1) % mockOrders.length; // Cycle through orders
                 loadOrderSim(); // Load new or current order based on logic above.
            });
        }

        const confirmBtn = orderSimSection.querySelector('#confirmOrderBtn');
        if(confirmBtn) {
            confirmBtn.addEventListener('click', () => {
                if (orderSimSection.dataset.answeredThisOrder === 'true') return;
                orderSimSection.dataset.answeredThisOrder = 'true';


                const targetComponents = currentOrder.components.slice().sort();
                const builtComponentsSorted = currentOrderBuild.slice().sort();
                const resultEl = document.getElementById('orderSimResult');
                if (!resultEl) return;
                let pointsAwarded = 0;

                const isCorrect = targetComponents.length === builtComponentsSorted.length && targetComponents.every((comp, idx) => comp === builtComponentsSorted[idx]);

                if (isCorrect) {
                    resultEl.innerHTML = `<strong>Perfect!</strong> Order confirmed accurately. This is key to happy customers and efficiency. (+10 points). Next customer loading...`;
                    resultEl.className = 'result-box mt-3 correct-result';
                    pointsAwarded = 10;
                    orderSimSection.querySelectorAll('.order-comp-btn, #confirmOrderBtn').forEach(el => el.disabled = true);
                    currentMockOrderIdx = (currentMockOrderIdx + 1) % mockOrders.length; // Cycle
                    setTimeout(loadOrderSim, 2500);
                } else {
                    resultEl.innerHTML = `<strong>Oops, something's not quite right.</strong> Double check the customer's order against what you've selected. Accuracy is crucial! <br/>Expected: ${targetComponents.join(', ')}. <br/>You had: ${currentOrderBuild.join(', ')}. Click 'Clear / Next Customer' to try again or move on.`;
                    resultEl.className = 'result-box mt-3 incorrect-result';
                    orderSimSection.querySelectorAll('.order-comp-btn').forEach(el => el.disabled = true); // Disable components but not reset
                    confirmBtn.disabled = true;
                }
                if (pointsAwarded > 0) BaristaApp.dataManager.addPoints(pointsAwarded);
                BaristaApp.util.trackAnalytics(`Day 13: Order sim attempt for "${currentOrder.text}" - ${isCorrect ? 'correct' : 'incorrect'}`);
            });
        }
    }

    function updateOrderConfirmationDisplay() {
        const confirmationTextEl = document.getElementById('orderConfirmationText');
        if (confirmationTextEl) {
            confirmationTextEl.textContent = currentOrderBuild.length > 0 ? currentOrderBuild.join(' + ') : '(No items selected)';
        }
    }
    loadOrderSim();
    container.appendChild(orderSimSection);
},
setupDay14: function() {
    const container = document.getElementById('practicalInteractiveContent');
    if (!container) return;

    const capstoneQuizSection = BaristaApp.util.createInteractiveSection('Barista Basics Capstone Quiz');
    capstoneQuizSection.innerHTML = `<p class="text-sm mb-2 text-gray-300">This capstone quiz covers key concepts from the entire 14-day program. Good luck!</p>
        <button onclick="BaristaApp.quizManager.openModal(14)" class="interactive-button">Start Capstone Quiz</button>
        <p class="text-xs text-gray-400 mt-2">(The quiz will appear in a pop-up. If it was already completed for Day 14, you can review your previous result or choose to retake for practice if the system allows.)</p>`;
    container.appendChild(capstoneQuizSection);

    const termMatchSection = BaristaApp.util.createInteractiveSection('Equipment, Terminology & Concepts Match-Up');
    const termsToMatch = [
        { term: "Portafilter", desc: "Holds coffee grounds for espresso.", type: "equipment" },
        { term: "Crema", desc: "Reddish-brown foam on espresso.", type: "concept" },
        { term: "Microfoam", desc: "Velvety steamed milk for lattes.", type: "concept" },
        { term: "Dripper (V60/Kalita)", desc: "Device for pour-over brewing.", type: "equipment" },
        { term: "Under-extraction", desc: "Results in sour espresso.", type: "concept" },
        { term: "Bloom (Pour-Over)", desc: "Initial wetting of grounds to release CO2.", type: "concept" },
        { term: "Tamping", desc: "Compressing grounds evenly in portafilter.", type: "action" },
        { term: "Grind Size", desc: "Fineness/coarseness of coffee particles.", type: "concept" }
    ];
    const shuffledTerms = [...termsToMatch].sort(() => 0.5 - Math.random());
    const shuffledDescs = [...termsToMatch].sort(() => 0.5 - Math.random());

    let selectedTermElement = null;
    let matchedTermCount = 0;
    let termMatchAttempts = {};

    termMatchSection.innerHTML += `<p class="text-sm mb-2 text-gray-300">Match the term on the left with its correct description on the right. Click a term, then click its matching description.</p>
        <div class="flex flex-col md:flex-row gap-4 md:gap-8">
            <div id="termMatchTerms" class="flex-1 space-y-2">
                <h5 class="text-md font-semibold text-amber-300 mb-1">Terms</h5>
                ${shuffledTerms.map(item => `<div class="interactive-choice term-match-item term-option p-2 text-sm" data-term="${item.term}" tabindex="0" role="button">${item.term}</div>`).join('')}
            </div>
            <div id="termMatchDescs" class="flex-1 space-y-2">
                <h5 class="text-md font-semibold text-amber-300 mb-1">Descriptions</h5>
                ${shuffledDescs.map(item => `<div class="interactive-choice term-match-item desc-option p-2 text-sm" data-term-original="${item.term}" tabindex="0" role="button">${item.desc}</div>`).join('')}
            </div>
        </div>
        <div id="termMatchResult" class="result-box mt-4">Select a term, then its description.</div>`;
    container.appendChild(termMatchSection);

    termsToMatch.forEach(item => termMatchAttempts[item.term] = 0);

    termMatchSection.querySelectorAll('.term-option').forEach(termEl => {
        const handleTermSelect = () => {
             if (termEl.classList.contains('matched') || termEl.classList.contains('disabled')) return;
            termMatchSection.querySelectorAll('.term-option.selected').forEach(el => el.classList.remove('selected'));
            termEl.classList.add('selected');
            selectedTermElement = termEl;
            const resultEl = document.getElementById('termMatchResult');
            if(resultEl) {
                resultEl.textContent = `Selected term: "${termEl.dataset.term}". Now click its matching description.`;
                resultEl.className = 'result-box mt-4';
            }
        };
        termEl.addEventListener('click', handleTermSelect);
        termEl.addEventListener('keydown', (e) => {if(e.key === 'Enter' || e.key === ' ') {e.preventDefault(); handleTermSelect();}});
    });

    termMatchSection.querySelectorAll('.desc-option').forEach(descEl => {
        const handleDescSelect = () => {
            const resultEl = document.getElementById('termMatchResult');
            if(!resultEl || descEl.classList.contains('matched') || descEl.classList.contains('disabled')) return;

            if (!selectedTermElement) {
                resultEl.textContent = "Please select a term from the left column first.";
                resultEl.className = 'result-box mt-4';
                return;
            }

            const originalTermForDesc = descEl.dataset.termOriginal;
            const selectedTerm = selectedTermElement.dataset.term;
            let pointsAwarded = 0;

            if (selectedTerm === originalTermForDesc) {
                descEl.classList.add('matched', 'correct', 'opacity-70', 'disabled');
                descEl.innerHTML += ' <span class="text-green-300 font-bold">✓</span>';
                selectedTermElement.classList.add('matched', 'correct', 'opacity-70', 'disabled');
                selectedTermElement.innerHTML += ' <span class="text-green-300 font-bold">✓</span>';
                selectedTermElement.classList.remove('selected');

                resultEl.innerHTML = `<strong>Correct!</strong> "${selectedTerm}" matches.` + (termMatchAttempts[selectedTerm] === 0 ? " (+3 points)" : "");
                resultEl.className = 'result-box mt-4 correct-result';
                if (termMatchAttempts[selectedTerm] === 0) {
                    pointsAwarded = 3;
                    BaristaApp.dataManager.addPoints(pointsAwarded);
                }
                termMatchAttempts[selectedTerm]++;
                matchedTermCount++;
                if (matchedTermCount === termsToMatch.length) {
                    resultEl.innerHTML = "<strong>All terms matched! Fantastic job!</strong>";
                }
            } else {
                resultEl.innerHTML = `<strong>Incorrect.</strong> "${selectedTerm}" does not match this description. Try again.`;
                resultEl.className = 'result-box mt-4 incorrect-result';
                gsap.fromTo(descEl, {x:-5}, {x:5, duration:0.05, repeat:3, yoyo:true, clearProps:"x"}); // Shake effect
                 termMatchAttempts[selectedTerm]++;
            }
            // Don't deselect term on wrong attempt, allow user to try another description.
            // selectedTermElement = null; // Only deselect on correct match or if they click another term
            BaristaApp.util.trackAnalytics(`Day 14: Term match - Term: ${selectedTerm}, Desc For: ${originalTermForDesc}`);
        };
         descEl.addEventListener('click', handleDescSelect);
         descEl.addEventListener('keydown', (e) => {if(e.key === 'Enter' || e.key === ' ') {e.preventDefault(); handleDescSelect();}});
    });

    const reflectionSection = BaristaApp.util.createInteractiveSection('My Coffee Journey Next Steps (Reflection)');
    reflectionSection.innerHTML = `<p class="text-sm mb-2 text-gray-300">Congratulations on completing the foundational course! Take a moment to reflect on what you've learned and what you'd like to explore next in your coffee journey.</p>
        <textarea id="reflectionText" class="w-full h-40 p-3 bg-gray-700 text-gray-200 rounded-md focus:ring-2 focus:ring-amber-500 border border-gray-600 placeholder-gray-500" placeholder="e.g., - Practice steaming milk for better microfoam.\n- Try tasting single-origin coffees from different regions.\n- Experiment with pour-over brewing variables.">${localStorage.getItem("baristaIO_reflection_D14") || ""}</textarea>
        <button id="saveReflectionBtnD14" class="interactive-button mt-3">Save Reflection</button>
        <p class="text-xs text-gray-400 mt-1">(This is for your personal reflection. Saving is conceptual for this exercise, but text will be stored locally.)</p>`;
    container.appendChild(reflectionSection);
    const saveReflectionBtnD14 = document.getElementById('saveReflectionBtnD14');
    if (saveReflectionBtnD14) {
        saveReflectionBtnD14.addEventListener('click', () => {
            const reflectionTextEl = document.getElementById('reflectionText');
            if (reflectionTextEl && reflectionTextEl.value.trim()){
                localStorage.setItem("baristaIO_reflection_D14", reflectionTextEl.value.trim());
                BaristaApp.util.showSuccess('Reflection noted and saved locally!');
                BaristaApp.util.trackAnalytics('Day 14: Saved Reflection');
            } else {
                BaristaApp.util.showError('Please write something in your reflection before saving.');
            }
        });
    }
}

            }, // End of practicalInteractions

               init: () => {
                BaristaApp.elements = {
                    appBody: document.getElementById("appBody"), sidebar: document.getElementById("sidebar"), dayList: document.getElementById("dayList"), dashboard: document.getElementById("dashboard"),
                    lessonPage: document.getElementById("lessonPage"), certificate: document.getElementById("certificate"), quizModal: document.getElementById("quizModal"),
                    profileModal: document.getElementById("profileModal"), onboardingModal: document.getElementById("onboardingModal"), leaderboardModal: document.getElementById("leaderboardModal"),
                    glossaryModal: document.getElementById("glossaryModal"), donationModal: document.getElementById("donationModal"),
                    lessonTitle: document.getElementById("lessonTitle"), lessonContent: document.getElementById("lessonContent"),
                    backButton: document.getElementById("backButton"), theoryTab: document.getElementById("theoryTab"), practicalTab: document.getElementById("practicalTab"),
                    quizTab: document.getElementById("quizTab"), notesTab: document.getElementById("notesTab"), userName: document.getElementById("userName"),
                    traineeName: document.getElementById("trainee-name"), certDate: document.getElementById("cert-date"), certPoints: document.getElementById("cert-points"),
                    progress: document.getElementById("progress"), progressBarFill: document.getElementById("progressBarFill"), points: document.getElementById("points"), search: document.getElementById("search"),
                    languageToggle: document.getElementById("languageToggle"), themeToggle: document.getElementById("themeToggle"), profileButton: document.getElementById("profileButton"),
                    quizTimer: document.getElementById("quizTimer"), quizDayIndicator: document.getElementById("quizDayIndicator"), quizModalTitle: document.getElementById("quizModalTitle"),
                    quizModalContent: document.getElementById("quizModalContent"), quizModalFeedback: document.getElementById("quizModalFeedback"), submitQuizButton: document.getElementById("submitQuizButton"),
                    markDayCompleteButton: document.getElementById("markDayCompleteButton"), quizCloseButton: document.getElementById("quizCloseButton"),
                    onboardingName: document.getElementById("onboardingName"), onboardingEmail: document.getElementById("onboardingEmail"),
                    profileName: document.getElementById("profileName"), profileEmail: document.getElementById("profileEmail"), lottieProgress: document.getElementById("lottieProgress"),
                    lottieCertificate: document.getElementById("lottieCertificate"), leaderboardList: document.getElementById("leaderboardList"), glossaryButtonSidebar: document.getElementById("glossaryButtonSidebar"),
                    donationButtonSidebar: document.getElementById("donationButtonSidebar"), glossaryList: document.getElementById("glossaryList"), glossarySearch: document.getElementById("glossarySearch"),
                    hamburgerMenu: document.getElementById("hamburgerMenu"), nextLessonInfo: document.getElementById("nextLessonInfo"), funFact: document.getElementById("funFact"),
                    closeSidebarButton: document.getElementById("closeSidebar")
                };
                BaristaApp.state.totalDays = CONTENT.days.length;
                BaristaApp.state.progress = JSON.parse(localStorage.getItem("baristaIO_progress")) || Array(BaristaApp.state.totalDays).fill(false);
                BaristaApp.state.user = JSON.parse(localStorage.getItem("baristaIO_user")) || { name: "Trainee", email: "", points: 0 };
                BaristaApp.state.language = localStorage.getItem("baristaIO_language") || "en";
                BaristaApp.state.theme = localStorage.getItem("baristaIO_theme") || "dark";
                BaristaApp.state.analytics = JSON.parse(localStorage.getItem("baristaIO_analytics")) || [];
                BaristaApp.state.notes = JSON.parse(localStorage.getItem("baristaIO_notes")) || {};
                BaristaApp.state.feedback = JSON.parse(localStorage.getItem("baristaIO_feedback")) || {};
                BaristaApp.state.isFirstVisit = !localStorage.getItem("baristaIO_visited");
                BaristaApp.state.leaderboard = JSON.parse(localStorage.getItem("baristaIO_leaderboard")) || [];

                          if (BaristaApp.elements.userName) BaristaApp.elements.userName.textContent = BaristaApp.state.user.name;
                if (BaristaApp.elements.traineeName) BaristaApp.elements.traineeName.textContent = BaristaApp.state.user.name;
                if (BaristaApp.elements.points) BaristaApp.elements.points.textContent = `Points: ${BaristaApp.state.user.points}`;
                if (BaristaApp.elements.languageToggle) BaristaApp.elements.languageToggle.value = BaristaApp.state.language;
                BaristaApp.ui.applyTheme();
                if (BaristaApp.elements.themeToggle) BaristaApp.elements.themeToggle.textContent = BaristaApp.state.theme === "dark" ? "🌙" : "☀️";
                BaristaApp.ui.updateTranslations(); BaristaApp.ui.updateProgressDisplay(); BaristaApp.ui.populateDays();
                BaristaApp.setupEventListeners(); BaristaApp.ui.loadLottieAnimations(); BaristaApp.ui.updateLeaderboardDisplay();

                if (typeof adsbygoogle !== 'undefined') { BaristaApp.state.adsInitialized = true; console.log("AdSense library detected."); BaristaApp.ui.ads.initSidebarAd(); }
                else { console.warn("AdSense library not loaded. Ads will not display."); }

                if (BaristaApp.state.isFirstVisit && BaristaApp.elements.onboardingModal) { BaristaApp.ui.ads.hideAdsForModal(); BaristaApp.modalManager.showOnboarding(); }
                else { BaristaApp.ui.animateDashboardElements(); } // This will call manageContentAdsVisibility

                if (typeof gsap !== 'undefined' && typeof ScrollTrigger !== 'undefined') { gsap.registerPlugin(ScrollTrigger); } else { console.error("GSAP or ScrollTrigger not loaded."); }
            },
            setupEventListeners: () => {
                if (BaristaApp.elements.backButton) {
                    BaristaApp.elements.backButton.addEventListener("click", () => {
                        BaristaApp.elements.lessonPage?.classList.add("hidden"); BaristaApp.elements.lessonPage?.classList.remove("active");
                        BaristaApp.elements.certificate?.classList.add("hidden"); BaristaApp.elements.certificate?.classList.remove("active");
                        BaristaApp.elements.dashboard?.classList.remove("hidden"); BaristaApp.elements.dashboard?.classList.add("active");
                         // --- ADSENSE POLICY CHANGE ---
                        BaristaApp.ui.ads.manageContentAdsVisibility('#dashboardAd'); // Show dashboard ad if conditions met
                        // --- END ADSENSE POLICY CHANGE ---
                        BaristaApp.state.currentDay = 0;
                        BaristaApp.ui.populateDays(BaristaApp.elements.search?.value || "");
                        BaristaApp.ui.animateDashboardElements();
                        BaristaApp.util.trackAnalytics("Navigated Back to Dashboard");
                    });
                }
                const tabs = [ { element: BaristaApp.elements.theoryTab, tab: "theory" }, { element: BaristaApp.elements.practicalTab, tab: "practical" }, { element: BaristaApp.elements.quizTab, tab: "quiz" }, { element: BaristaApp.elements.notesTab, tab: "notes" }];
                tabs.forEach(({ element, tab }) => { if (element) element.addEventListener("click", () => BaristaApp.lessonManager.setActiveTab(tab)); });
                if (BaristaApp.elements.submitQuizButton) BaristaApp.elements.submitQuizButton.addEventListener("click", () => BaristaApp.quizManager.submit(false));
                if (BaristaApp.elements.markDayCompleteButton) BaristaApp.elements.markDayCompleteButton.addEventListener("click", BaristaApp.quizManager.markDayComplete);
                if (BaristaApp.elements.quizCloseButton) BaristaApp.elements.quizCloseButton.addEventListener("click", BaristaApp.quizManager.closeModal);
                if (BaristaApp.elements.profileButton) BaristaApp.elements.profileButton.addEventListener("click", BaristaApp.modalManager.showProfile);
                if (BaristaApp.elements.glossaryButtonSidebar) BaristaApp.elements.glossaryButtonSidebar.addEventListener("click", BaristaApp.modalManager.showGlossary);
                if (BaristaApp.elements.donationButtonSidebar) BaristaApp.elements.donationButtonSidebar.addEventListener("click", BaristaApp.modalManager.showDonationModal);
                if (BaristaApp.elements.glossarySearch) { let t; BaristaApp.elements.glossarySearch.addEventListener("input", e => { clearTimeout(t); t = setTimeout(() => { BaristaApp.ui.populateGlossary(e.target.value); BaristaApp.util.trackAnalytics(`Glossary Search: ${e.target.value}`); }, 300); }); }
                if (BaristaApp.elements.themeToggle) { BaristaApp.elements.themeToggle.addEventListener("click", () => { BaristaApp.state.theme = BaristaApp.state.theme === "dark" ? "light" : "dark"; BaristaApp.ui.applyTheme(); gsap.to(BaristaApp.elements.themeToggle, { rotation: "+=360", duration: 0.5, ease: "power2.out" }); BaristaApp.elements.themeToggle.textContent = BaristaApp.state.theme === "dark" ? "🌙" : "☀️"; localStorage.setItem("baristaIO_theme", BaristaApp.state.theme); BaristaApp.util.trackAnalytics(`Changed Theme to ${BaristaApp.state.theme}`); BaristaApp.ui.populateDays(BaristaApp.elements.search?.value || ""); }); }
                if (BaristaApp.elements.languageToggle) { BaristaApp.elements.languageToggle.addEventListener("change", e => { BaristaApp.state.language = e.target.value; localStorage.setItem("baristaIO_language", BaristaApp.state.language); BaristaApp.ui.updateTranslations(); BaristaApp.util.trackAnalytics(`Changed Language to ${BaristaApp.state.language}`); }); }
                if (BaristaApp.elements.search) { let t; BaristaApp.elements.search.addEventListener("input", e => { clearTimeout(t); t = setTimeout(() => { BaristaApp.ui.populateDays(e.target.value); BaristaApp.util.trackAnalytics(`Searched: ${e.target.value}`); }, 300); }); }
                if (BaristaApp.elements.hamburgerMenu && BaristaApp.elements.sidebar) { BaristaApp.elements.hamburgerMenu.addEventListener("click", e => { e.stopPropagation(); const o = BaristaApp.elements.sidebar.classList.toggle("sidebar-open"), t = BaristaApp.elements.hamburgerMenu.querySelector("i"); t && (t.classList.toggle("fa-bars", !o), t.classList.toggle("fa-times", o)); BaristaApp.util.trackAnalytics(`Toggled Sidebar to ${o?"Open":"Closed"}`); }); }
                if (BaristaApp.elements.closeSidebarButton && BaristaApp.elements.sidebar) { BaristaApp.elements.closeSidebarButton.addEventListener("click", e => { e.stopPropagation(); BaristaApp.elements.sidebar.classList.remove("sidebar-open"); const o = BaristaApp.elements.hamburgerMenu?.querySelector("i"); o && o.classList.replace("fa-times", "fa-bars"); BaristaApp.util.trackAnalytics("Closed Sidebar via Close Button"); }); }
                document.addEventListener("click", e => { if (BaristaApp.elements.sidebar?.classList.contains("sidebar-open") && !BaristaApp.elements.sidebar.contains(e.target) && BaristaApp.elements.hamburgerMenu && !BaristaApp.elements.hamburgerMenu.contains(e.target)) { BaristaApp.elements.sidebar.classList.remove("sidebar-open"); const o = BaristaApp.elements.hamburgerMenu.querySelector("i"); o && o.classList.replace("fa-times", "fa-bars"); BaristaApp.util.trackAnalytics("Closed Sidebar via Click Outside"); } });
                document.addEventListener("keydown", e => {
                    if (e.key === "Escape") {
                        const modals = [BaristaApp.elements.profileModal, BaristaApp.elements.quizModal, BaristaApp.elements.leaderboardModal, BaristaApp.elements.glossaryModal, BaristaApp.elements.donationModal];
                        if (BaristaApp.elements.onboardingModal && !BaristaApp.elements.onboardingModal.classList.contains("hidden")) { /* No action for onboarding */ }
                        else { for (const modal of modals) { if (modal && !modal.classList.contains("hidden")) { BaristaApp.modalManager._closeModal(modal); return; } } }
                        const imageModal = document.getElementById("imageModal"); if (imageModal?.style.display === "flex") { imageModal.style.display = "none"; return; }
                        if (BaristaApp.elements.sidebar?.classList.contains("sidebar-open")) { BaristaApp.elements.sidebar.classList.remove("sidebar-open"); const icon = BaristaApp.elements.hamburgerMenu?.querySelector("i"); if (icon) icon.classList.replace("fa-times", "fa-bars"); BaristaApp.util.trackAnalytics("Closed Sidebar via Escape Key"); }
                    }
                });
            }
        }; // End of BaristaApp Object

        window.onerror = (message, source, lineno, colno, error) => {
            const errorDetails = error ? error.stack || error.toString() : 'No error object.';
            const sourceFile = source ? source.split('/').pop() : 'unknown';
            console.error(`Unhandled Error: ${message}\nSource: ${sourceFile}\nLine: ${lineno}:${colno}\nDetails: ${errorDetails}`);
            if (BaristaApp?.util?.showError) { BaristaApp.util.showError(`Unexpected error. Check console.`); BaristaApp.util.trackAnalytics(`JS Error: ${message} at ${sourceFile}:${lineno}`); }
            return true;
        };

        document.addEventListener("DOMContentLoaded", () => {
            BaristaApp.init();
        });
    </script>
</body>
</html>